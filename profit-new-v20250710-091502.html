<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="profit.title">获利 - AlwaysControl</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/standard-layout.css">
    <link rel="stylesheet" href="components/pagination.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/user-menu-link.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/user-menu.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/pagination.js"></script>
    <script src="fix-profit-page.js" defer></script>
    <style>
        /* Profit page specific styles - most styles now inherit from common-styles.css */

        /* Unified Time Selector Module */
        .time-selector-module {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--color-bg-card);
            border-radius: 24px;
            border: 1px solid var(--color-border);
        }

        .time-input {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
            min-width: 150px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .time-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: transparent;
            color: var(--color-text-secondary);
        }

        .time-input[type="number"] {
            min-width: 100px;
        }
        
        /* Region selector specific styles */
        select.time-input {
            background: var(--color-bg-card);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }
        
        select.time-input:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: var(--color-primary);
        }
        
        select.time-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.2);
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Tab-style view switcher */
        .page-view-tabs {
            display: inline-flex;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .page-tab {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .page-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            font-weight: 600;
        }

        .page-tab.active::before {
            display: none;
        }

        /* Ensure container width is maintained */
        .container {
            max-width: 95%;
            padding: 100px 10px 24px;
            margin: 0 auto;
        }

        /* Specific styles for profit page layout */
        
        /* Page header alignment */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
        }
        
        /* Page title to match other pages */
        .page-title {
            font-size: 48px;
            font-weight: 500;
            color: var(--color-text);
            margin: 0;
            letter-spacing: -2px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-text);
            letter-spacing: -0.5px;
        }

        .stat-change {
            font-size: 13px;
            color: var(--color-success);
            font-weight: 400;
        }

        .stat-change.negative {
            color: var(--color-danger);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }

        .chart-container {
            padding: 24px;
            min-height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--color-text);
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        /* Tables */
        .table-section {
            margin-bottom: 40px;
        }

        .table-container {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .data-table th {
            color: var(--color-text-secondary);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .data-table td {
            font-size: 14px;
        }

        .status-active {
            color: var(--color-primary);
        }

        .status-inactive {
            color: #ff6b6b;
        }

        .profit-positive {
            color: var(--color-primary);
        }

        .profit-negative {
            color: #ff6b6b;
        }

        /* Table status styles */
        .status-active {
            color: var(--color-primary) !important;
            font-weight: 500;
        }

        .status-inactive {
            color: #ffd93d !important;
            font-weight: 500;
        }

        .status-not-participating {
            color: #ff6b6b !important;
            font-weight: 500;
        }

        /* Table styling improvements */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--color-text);
        }

        .data-table th {
            background: var(--color-bg);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
            position: relative;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.2s ease;
        }

        .data-table tr:hover {
            background: var(--color-bg);
        }

        /* 排序按钮样式 - 优化设计 */
        .sort-buttons {
            margin-left: 6px;
            display: inline-flex;
            flex-direction: column;
            gap: 2px;  /* 增加上下按钮间距 */
            vertical-align: middle;
            position: relative;
            top: -2px;
        }

        .sort-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            width: 16px;
            height: 14px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.8;
        }

        .sort-btn:hover {
            color: rgba(255, 255, 255, 0.8);
            opacity: 1;
            transform: scale(1.2);
        }

        .sort-btn.active {
            color: var(--color-primary);
            opacity: 1;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
        }

        .sort-btn.sort-asc {
            transform: translateY(2px);
        }

        .sort-btn.sort-desc {
            transform: translateY(-2px);
        }

        .sort-btn.active.sort-asc {
            transform: translateY(2px) scale(1.2);
        }

        .sort-btn.active.sort-desc {
            transform: translateY(-2px) scale(1.2);
        }

        .table-section {
            margin-bottom: 40px;
        }

        .table-container {
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-filters {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-filters .filter-tab {
            padding: 6px 14px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 18px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .status-filters .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
            transform: translateY(-1px);
            box-shadow: var(--color-shadow);
        }

        .status-filters .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
            transform: translateY(-1px);
        }

        .export-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--color-primary);
            border-radius: 6px;
            color: var(--color-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .export-btn:hover {
            background: var(--color-primary);
            color: #000;
            transform: translateY(-1px);
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 185, 107, 0.2);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination-info {
            color: var(--color-text-secondary);
            font-size: 12px;
            margin-right: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .pagination-btn:hover,
        .pagination-btn.active {
            background: var(--color-primary);
            color: #fff;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Chart controls for profit ranking */
        .chart-controls {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .chart-controls .filter-tab {
            padding: 6px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 15px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .chart-controls .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
        }

        .chart-controls .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
        }

        /* Hide built-in time selector */
        /* Time selector container removed - using inline input now */

        /* Legend styles for charts */
        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Test mode button */
        .test-mode-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: var(--color-danger);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s;
        }

        .test-mode-btn:hover {
            transform: scale(1.05);
        }

        /* Responsive grid adjustments */
        @media (max-width: 1200px) {
            .container {
                max-width: 98%;
                padding: 120px 8px 40px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .charts-section {
                gap: 24px;
            }
            
            .chart-container {
                padding: 24px;
                min-height: 380px;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 120px 5px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .chart-title {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                padding: 120px 3px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Header Component -->
    <!-- Header Container for HeaderNav Component -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle" data-i18n-key="profit.pageTitle">获利</h1>
            <!-- View Mode Tabs -->
            <div class="page-view-tabs">
                <button class="page-tab active" onclick="switchViewMode('chart', this)" id="chartTab">
                    📊 <span data-i18n-key="profit.views.chart">图表视图</span>
                </button>
                <button class="page-tab" onclick="switchViewMode('table', this)" id="tableTab">
                    📋 <span data-i18n-key="profit.views.table">表格视图</span>
                </button>
            </div>
        </div>
        
        <!-- Time Pills -->
        <!-- Unified Time Selector Module -->
        <div class="time-selector-module" id="profitTimeSelectorModule">
            <select id="regionSelector" class="time-input" onchange="handleRegionChange()" style="min-width: 120px; margin-right: 12px; margin-left: 0; display: inline-block;">
                <option value="all">全部地区</option>
                <option value="NSW">NSW</option>
                <option value="QLD">QLD</option>
                <option value="VIC">VIC</option>
                <option value="SA">SA</option>
                <option value="TAS">TAS</option>
            </select>
            <button class="time-pill active" onclick="switchTimePeriod('day', this)" data-i18n-key="dayReport">日</button>
            <button class="time-pill" onclick="switchTimePeriod('month', this)" data-i18n-key="monthReport">月</button>
            <button class="time-pill" onclick="switchTimePeriod('year', this)" data-i18n-key="yearReport">年</button>
            <button class="time-pill" onclick="switchTimePeriod('total', this)" data-i18n-key="totalReport">累计</button>
            <input type="date" id="timeSelector" class="time-input" onchange="handleTimeInputChange()">
            <button class="refresh-btn" onclick="refreshData()" data-i18n-key="refresh" title="刷新数据">🔄 刷新</button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.userCount">用户数量</div>
                <div class="stat-value" id="userCount">1,234</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">比昨日</span> ↑ 12</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.totalRevenue">累计收益</div>
                <div class="stat-value" id="totalRevenue">$457,000</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">比昨日</span> ↑ $2,000</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.avgProfit">人均获利</div>
                <div class="stat-value" id="avgProfit">$370</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">比昨日</span> ↑ $5</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.maxStationProfit">最大获利 (电站)</div>
                <div class="stat-value" id="maxStationProfit">$5,00</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">比昨日</span> ↑ $200</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.minStationProfit">最小获利 (电站)</div>
                <div class="stat-value" id="minStationProfit">$10</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">比昨日</span> ↑ $1</div>
            </div>
        </div>

        <!-- Chart View Content -->
        <div id="chartViewContent">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- User Management Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.userManagement">用户管理</div>
                    </div>
                    <div id="userManagementChart" style="width: 100%; height: 300px;"></div>
                </div>

                <!-- Revenue Distribution Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.revenueDistribution">收益分布</div>
                    </div>
                    <div id="revenueDistributionChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>

            <!-- Secondary Charts Section -->
            <div class="charts-section">
                <!-- Power and Revenue Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.dischargeAndProfit">放电与获利</div>
                    </div>
                    <div id="powerRevenueChart" style="width: 100%; height: 350px;"></div>
                </div>

                <!-- Top 5 Profit Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.profitRanking">获利排名</div>
                        <div class="chart-controls">
                            <button class="filter-tab active" onclick="switchProfitView('top5', this)" id="top5Tab" data-i18n-key="profit.ranking.top5">前五</button>
                            <button class="filter-tab" onclick="switchProfitView('bottom5', this)" id="bottom5Tab" data-i18n-key="profit.ranking.bottom5">后五</button>
                        </div>
                    </div>
                    <div id="profitRankingChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Table View Content -->
        <div id="tableViewContent" style="display: none;">

            <!-- User Participation Table -->
            <div class="table-section">
                <div class="table-container card">
                    <div class="table-header">
                        <div class="table-title" data-i18n-key="profit.table.userParticipation">用户参与情况</div>
                        <div class="table-controls">
                            <!-- 状态筛选 -->
                            <div class="status-filters">
                                <button class="filter-tab active" onclick="filterByStatus('all', this)" id="statusAll" data-i18n-key="profit.filters.all">全部</button>
                                <button class="filter-tab" onclick="filterByStatus('active', this)" id="statusActive" data-i18n-key="profit.filters.active">活跃</button>
                                <button class="filter-tab" onclick="filterByStatus('inactive', this)" id="statusInactive" data-i18n-key="profit.filters.inactive">非活跃</button>
                                <button class="filter-tab" onclick="filterByStatus('notParticipating', this)" id="statusNotParticipating" data-i18n-key="profit.filters.notParticipating">未参与</button>
                            </div>
                            <!-- 导出功能 -->
                            <button class="export-btn" onclick="exportTableData()">
                                📥 <span data-i18n-key="profit.buttons.exportData">导出数据</span>
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n-key="profit.table.date">日期</th>
                                <th data-i18n-key="profit.table.user">用户</th>
                                <th data-i18n-key="profit.table.status">性质</th>
                                <th>
                                    <span data-i18n-key="profit.table.dischargeAmount">实际放电量 (kWh)</span>
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('discharge', 'asc', this)" title="升序">▲</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('discharge', 'desc', this)" title="降序">▼</button>
                                    </span>
                                </th>
                                <th>
                                    <span data-i18n-key="profit.table.profit">获利 ($)</span>
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('profit', 'asc', this)" title="升序">▲</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('profit', 'desc', this)" title="降序">▼</button>
                                    </span>
                                </th>
                                <th data-i18n-key="profit.table.dailyAvg" id="avgHeader">日均
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('dailyAvg', 'asc', this)" title="升序">▲</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('dailyAvg', 'desc', this)" title="降序">▼</button>
                                    </span>
                                </th>
                                <th data-i18n-key="profit.table.compareDaily" id="compareHeader">对比日均 ($)
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('comparison', 'asc', this)" title="升序">▲</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('comparison', 'desc', this)" title="降序">▼</button>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="userParticipationTableBody">
                            <!-- Table data will be loaded dynamically -->
                        </tbody>
                    </table>
                    
                    <div id="paginationContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add profit chart fix script -->

    <script>
        // Global chart variables
        let userManagementChart, revenueDistributionChart, powerRevenueChart, profitRankingChart;
        let currentViewMode = 'chart';
        let currentProfitView = 'top5';
        let currentTimePeriod = 'day';
        
        // Table view variables
        let tableData = [];
        let filteredTableData = [];
        let currentPage = 1;
        let pageSize = 10;
        let pagination = null;
        let currentFilter = 'all';

        // Performance utilities 
        function throttle(func, limit) {
            let inThrottle;
            let lastFunc;
            let lastRan;
            
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    lastRan = Date.now();
                    inThrottle = true;
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, Math.max(limit - (Date.now() - lastRan), 0));
                }
                
                setTimeout(() => {
                    inThrottle = false;
                }, limit);
            };
        }

        // Data cache class
        class DataCache {
            constructor(ttl = 5 * 60 * 1000, maxSize = 100) {
                this.cache = new Map();
                this.ttl = ttl;
                this.maxSize = maxSize;
            }
            
            set(key, data) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.data;
            }
        }

        // Chart manager with caching
        class ChartManager {
            constructor() {
                this.cache = new DataCache();
                this.charts = new Map();
            }
            
            createChart(containerId, options, useCache = true) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn(`Container ${containerId} not found`);
                    return null;
                }
                
                if (useCache) {
                    const cached = this.cache.get(containerId);
                    if (cached) {
                        const chart = echarts.init(container);
                        chart.setOption(cached);
                        this.charts.set(containerId, chart);
                        return chart;
                    }
                }
                
                const chart = echarts.init(container);
                chart.setOption(options);
                
                if (useCache) {
                    this.cache.set(containerId, options);
                }
                
                this.charts.set(containerId, chart);
                return chart;
            }
            
            getChart(containerId) {
                return this.charts.get(containerId);
            }
            
            resizeAll() {
                this.charts.forEach(chart => {
                    if (chart && !chart.isDisposed()) {
                        chart.resize();
                    }
                });
            }
        }

        const chartManager = new ChartManager();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Initialize header navigation
                if (typeof HeaderNav !== 'undefined') {
                    window.headerNav = new HeaderNav({
                        containerId: 'headerContainer',
                        currentPage: 'profit'
                    });
                }

                // Check region selector
                const regionSelector = document.getElementById('regionSelector');
                console.log('Region selector element:', regionSelector);
                if (!regionSelector) {
                    console.error('Region selector NOT found in DOM!');
                } else {
                    console.log('Region selector found, value:', regionSelector.value);
                    console.log('Region selector style display:', window.getComputedStyle(regionSelector).display);
                    console.log('Region selector parent class:', regionSelector.parentElement.className);
                }
                
                // Initialize time selector with default day + today
                const today = new Date();
                const timeInput = document.getElementById('timeSelector');
                if (timeInput) {
                    timeInput.type = 'date';
                    timeInput.value = today.toISOString().split('T')[0];
                }

                // Initialize charts
                initAllCharts();
                
                // 诊断图表问题
                setTimeout(() => {
                    const chartContainers = ['userManagementChart', 'revenueDistributionChart', 'powerRevenueChart', 'profitRankingChart'];
                    chartContainers.forEach(id => {
                        const container = document.getElementById(id);
                        if (container) {
                            const rect = container.getBoundingClientRect();
                            console.log(`Chart container ${id}: width=${rect.width}, height=${rect.height}`);
                            if (rect.width === 0 || rect.height === 0) {
                                console.warn(`Chart container ${id} has zero size!`);
                                // 强制设置高度
                                container.style.height = '300px';
                                container.style.minHeight = '300px';
                            }
                        } else {
                            console.error(`Chart container ${id} not found!`);
                        }
                    });
                    
                    // 重新初始化图表
                    chartManager.resizeAll();
                }, 500);
                
                // Initialize table data even if not visible
                generateTableData();

                // Listen for language changes
                if (window.i18n) {
                    window.i18n.addObserver(() => {
                        updateTexts();
                        refreshCharts();
                    });
                }

                // Window resize listener
                window.addEventListener('resize', throttle(() => {
                    chartManager.resizeAll();
                }, 250));
            }, 200);
        });

        // Time change handler
        function handleTimeChange() {
            const timeInput = document.getElementById('timeSelector');
            const selectedDate = timeInput.value;
            const period = currentTimePeriod;
            console.log('Time period changed:', period, selectedDate);
            refreshCharts();
        }
        
        // Update table headers based on time period
        function updateTableHeaders(period) {
            const avgHeader = document.getElementById('avgHeader');
            const compareHeader = document.getElementById('compareHeader');
            
            if (avgHeader && compareHeader) {
                switch(period) {
                    case 'day':
                        avgHeader.innerHTML = '日均' +
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'dailyAvg\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'dailyAvg\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        compareHeader.innerHTML = '对比日均 ($)' + 
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'comparison\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'comparison\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        break;
                    case 'month':
                        avgHeader.innerHTML = '月均' +
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'dailyAvg\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'dailyAvg\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        compareHeader.innerHTML = '对比月均 ($)' + 
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'comparison\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'comparison\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        break;
                    case 'year':
                        avgHeader.innerHTML = '年均' +
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'dailyAvg\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'dailyAvg\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        compareHeader.innerHTML = '对比年均 ($)' + 
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'comparison\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'comparison\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        break;
                    case 'total':
                        avgHeader.innerHTML = '历史均值' +
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'dailyAvg\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'dailyAvg\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        compareHeader.innerHTML = '对比历史均值 ($)' + 
                            '<span class="sort-buttons">' +
                            '<button class="sort-btn sort-asc" onclick="sortTable(\'comparison\', \'asc\', this)" title="升序">▲</button>' +
                            '<button class="sort-btn sort-desc" onclick="sortTable(\'comparison\', \'desc\', this)" title="降序">▼</button>' +
                            '</span>';
                        break;
                }
            }
        }

        // Region change handling
        function handleRegionChange() {
            const regionSelector = document.getElementById('regionSelector');
            const selectedRegion = regionSelector.value;
            console.log('[handleRegionChange] Selected region:', selectedRegion);
            
            // Simply refresh all data with new region
            refreshData();
        }
        
        // Update charts data based on region
        function updateChartsData(region = 'all') {
            refreshCharts(region);
        }
        
        // Update stats cards based on region
        function updateStatsCards(region = 'all') {
            updateStats(region);
        }
        
        // Update table data based on region
        function updateTableData(region = 'all') {
            refreshTableData(region);
        }

        // Time period switching
        function switchTimePeriod(period, element) {
            console.log('[switchTimePeriod] ========== SWITCHING TIME PERIOD ==========');
            console.log('[switchTimePeriod] From:', currentTimePeriod, 'To:', period);
            console.log('[switchTimePeriod] Current view mode:', currentViewMode);
            currentTimePeriod = period;
            
            // Update pill states
            document.querySelectorAll('.time-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            element.classList.add('active');
            
            // Handle time input based on period
            const timeInput = document.getElementById('timeSelector');
            const today = new Date();
            
            if (period === 'total') {
                // Total模式：隐藏时间选择器
                timeInput.style.display = 'none';
                timeInput.disabled = true;
                timeInput.value = '';
                
                // 移动刷新按钮到累计按钮后面
                const refreshBtn = document.querySelector('.refresh-btn');
                const totalBtn = element;
                if (refreshBtn && totalBtn) {
                    totalBtn.insertAdjacentElement('afterend', refreshBtn);
                }
            } else {
                // 其他模式：显示时间选择器并设置相应的默认值
                timeInput.style.display = 'block';
                timeInput.disabled = false;
                
                // 恢复刷新按钮到原位置（时间选择器后面）
                const refreshBtn = document.querySelector('.refresh-btn');
                if (refreshBtn && timeInput) {
                    timeInput.insertAdjacentElement('afterend', refreshBtn);
                }
                
                switch(period) {
                    case 'day':
                        // 日模式：设置为今日
                        timeInput.type = 'date';
                        timeInput.value = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        // 月模式：设置为本月
                        timeInput.type = 'month';
                        timeInput.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                        break;
                    case 'year':
                        // 年模式：设置为今年
                        timeInput.type = 'number';
                        timeInput.min = 2020;
                        timeInput.max = 2030;
                        timeInput.value = today.getFullYear();
                        break;
                }
            }
            
            // Force refresh data - both stats and table
            console.log('[switchTimePeriod] Forcing data refresh');
            
            // Update table headers based on period
            updateTableHeaders(period);
            
            // Reset sort state when switching time period
            currentSortColumn = null;
            currentSortDirection = null;
            
            // Force regenerate table data when time period changes
            generateTableData();
            
            // If table view is active, update it immediately
            const tableViewContent = document.getElementById('tableViewContent');
            if (tableViewContent && tableViewContent.style.display !== 'none') {
                console.log('[switchTimePeriod] Table view is active, updating table');
                
                // 重置当前页
                currentPage = 1;
                
                // 清空表格
                const tbody = document.getElementById('userParticipationTableBody');
                if (tbody) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">加载中...</td></tr>';
                }
                
                // 延迟加载新数据，确保UI更新
                setTimeout(() => {
                    if (pagination) {
                        // 重新初始化分页
                        pagination = new Pagination({
                            containerId: 'paginationContainer',
                            currentPage: 1,
                            pageSize: pageSize,
                            totalItems: tableData.length,
                            onPageChange: (page, size) => {
                                currentPage = page;
                                loadTableData();
                            },
                            onPageSizeChange: (size) => {
                                pageSize = size;
                                currentPage = 1;
                                loadTableData();
                            }
                        });
                    }
                    loadTableData();
                }, 50);
            }
            
            // Also refresh other data
            setTimeout(() => {
                refreshData();
            }, 100);
        }

        function handleTimeInputChange() {
            console.log('Time input changed, refreshing all data...');
            handleTimeChange();
            refreshData();
        }

        // Refresh data when time changes
        function refreshData() {
            console.log('[refreshData] Current view mode:', currentViewMode);
            console.log('[refreshData] Current time period:', currentTimePeriod);
            
            // Get selected region
            const regionSelector = document.getElementById('regionSelector');
            const selectedRegion = regionSelector ? regionSelector.value : 'all';
            console.log('[refreshData] Selected region:', selectedRegion);
            
            // Update stats
            updateStats(selectedRegion);
            
            // Check if table view is visible
            const tableViewContent = document.getElementById('tableViewContent');
            const isTableVisible = tableViewContent && tableViewContent.style.display !== 'none';
            
            console.log('[refreshData] Is table visible?', isTableVisible);
            
            // Always refresh table data if table view is active
            if (currentViewMode === 'table' || isTableVisible) {
                // Refresh table data
                console.log('[refreshData] Refreshing table view');
                refreshTableData(selectedRegion);
            } else {
                // Refresh charts
                refreshCharts(selectedRegion);
            }
        }
        
        // Refresh table data specifically
        function refreshTableData() {
            console.log('[refreshTableData] Starting table refresh');
            
            // Generate new data based on current time selection
            generateTableData();
            console.log('[refreshTableData] Generated', tableData.length, 'rows');
            
            // Reset to first page
            currentPage = 1;
            
            // Update pagination if it exists
            if (pagination) {
                console.log('[refreshTableData] Recreating pagination');
                // 重新创建分页组件
                pagination = new Pagination({
                    containerId: 'paginationContainer',
                    currentPage: 1,
                    pageSize: pageSize,
                    totalItems: tableData.length,
                    onPageChange: (page, size) => {
                        currentPage = page;
                        loadTableData();
                    },
                    onPageSizeChange: (size) => {
                        pageSize = size;
                        currentPage = 1;
                        loadTableData();
                    }
                });
            }
            
            // Reload table
            console.log('[refreshTableData] Loading table data');
            loadTableData();
        }

        // Update stats based on current time period and region
        function updateStats(region = 'all') {
            // This would normally fetch data from an API
            // For now, using demo data with region multipliers
            const regionMultipliers = {
                'all': 1,
                'NSW': 0.35,
                'QLD': 0.25,
                'VIC': 0.20,
                'SA': 0.15,
                'TAS': 0.05
            };
            
            const multiplier = regionMultipliers[region] || 1;
            
            const stats = {
                day: {
                    userCount: '1,234',
                    totalRevenue: '$457,000',
                    avgProfit: '$370',
                    maxProfit: '$5,000',
                    minProfit: '$10'
                },
                month: {
                    userCount: '12,345',
                    totalRevenue: '$4,570,000',
                    avgProfit: '$370',
                    maxProfit: '$50,000',
                    minProfit: '$100'
                },
                year: {
                    userCount: '123,456',
                    totalRevenue: '$45,700,000',
                    avgProfit: '$370',
                    maxProfit: '$500,000',
                    minProfit: '$1,000'
                },
                cumulative: {
                    userCount: '234,567',
                    totalRevenue: '$457,000,000',
                    avgProfit: '$1,950',
                    maxProfit: '$5,000,000',
                    minProfit: '$10,000'
                },
                total: {
                    userCount: '234,567',
                    totalRevenue: '$457,000,000',
                    avgProfit: '$1,950',
                    maxProfit: '$5,000,000',
                    minProfit: '$10,000'
                }
            };
            
            const currentStats = stats[currentTimePeriod] || stats.day;
            
            // Apply region multiplier to numeric values
            const userCount = Math.round(parseInt(currentStats.userCount.replace(/,/g, '')) * multiplier).toLocaleString();
            const totalRevenue = '$' + Math.round(parseInt(currentStats.totalRevenue.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            const avgProfit = currentStats.avgProfit; // Keep average the same
            const maxProfit = '$' + Math.round(parseInt(currentStats.maxProfit.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            const minProfit = '$' + Math.round(parseInt(currentStats.minProfit.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            
            document.getElementById('userCount').textContent = userCount;
            document.getElementById('totalRevenue').textContent = totalRevenue;
            document.getElementById('avgProfit').textContent = avgProfit;
            document.getElementById('maxStationProfit').textContent = maxProfit;
            document.getElementById('minStationProfit').textContent = minProfit;
        }

        // Toggle test mode
        function toggleTestMode() {
            console.log('Toggling test mode');
            // TODO: Implement test mode functionality
        }
        
        // Manually add region selector
        function addRegionSelector() {
            const timeSelectorModule = document.querySelector('.time-selector-module');
            if (timeSelectorModule) {
                // Check if region selector already exists
                let regionSelector = document.getElementById('regionSelector');
                if (!regionSelector) {
                    console.log('Creating region selector...');
                    
                    // Create the select element
                    regionSelector = document.createElement('select');
                    regionSelector.id = 'regionSelector';
                    regionSelector.className = 'time-input';
                    regionSelector.style.minWidth = '120px';
                    regionSelector.style.marginRight = '12px';
                    regionSelector.style.marginLeft = '0';
                    regionSelector.style.display = 'inline-block';
                    regionSelector.onchange = function() { handleRegionChange(); };
                    
                    // Add options
                    const regions = [
                        { value: 'all', text: '全部地区' },
                        { value: 'NSW', text: 'NSW' },
                        { value: 'QLD', text: 'QLD' },
                        { value: 'VIC', text: 'VIC' },
                        { value: 'SA', text: 'SA' },
                        { value: 'TAS', text: 'TAS' }
                    ];
                    
                    regions.forEach(region => {
                        const option = document.createElement('option');
                        option.value = region.value;
                        option.textContent = region.text;
                        regionSelector.appendChild(option);
                    });
                    
                    // Insert at the beginning of time-selector-module
                    const firstChild = timeSelectorModule.firstElementChild;
                    timeSelectorModule.insertBefore(regionSelector, firstChild);
                    
                    console.log('Region selector created successfully');
                    alert('地区选择器已添加！');
                } else {
                    console.log('Region selector already exists');
                    alert('地区选择器已存在！');
                }
            }
        }

        // View mode switching
        function switchViewMode(mode, element) {
            currentViewMode = mode;
            
            // Update tab states
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update content visibility
            if (mode === 'chart') {
                document.getElementById('chartViewContent').style.display = 'block';
                document.getElementById('tableViewContent').style.display = 'none';
                refreshCharts();
            } else {
                document.getElementById('chartViewContent').style.display = 'none';
                document.getElementById('tableViewContent').style.display = 'block';
                
                // Initialize table when switching to table view
                if (!pagination) {
                    updateTableHeaders(currentTimePeriod);
                    generateTableData();
                    initializePagination();
                } else {
                    // Refresh table data
                    updateTableHeaders(currentTimePeriod);
                    refreshTableData();
                }
            }
        }

        // Profit view switching
        function switchProfitView(view, element) {
            currentProfitView = view;
            
            // Update tab states
            document.querySelectorAll('.chart-controls .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update chart
            updateProfitRankingChart();
        }

        // Status filtering
        function filterByStatus(status, element) {
            // Update tab states
            document.querySelectorAll('.status-filters .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Reset sort state when filtering
            currentSortColumn = null;
            currentSortDirection = null;
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Re-generate data with filter
            generateTableData();
            
            if (status !== 'all') {
                tableData = tableData.filter(item => item.status === status);
            }
            
            // Update pagination
            if (pagination) {
                // 重新创建分页组件
                pagination = new Pagination({
                    containerId: 'paginationContainer',
                    currentPage: 1,
                    pageSize: pageSize,
                    totalItems: tableData.length,
                    onPageChange: (page, size) => {
                        currentPage = page;
                        loadTableData();
                    },
                    onPageSizeChange: (size) => {
                        pageSize = size;
                        currentPage = 1;
                        loadTableData();
                    }
                });
            }
            currentPage = 1;
            
            // Reload table
            loadTableData();
        }

        // Initialize all charts
        function initAllCharts(region = 'all') {
            initUserManagementChart(region);
            initRevenueDistributionChart(region);
            initPowerRevenueChart(region);
            initProfitRankingChart(region);
        }

        function initUserManagementChart(region = 'all') {
            // Apply region multiplier for data
            const regionMultipliers = {
                'all': 1,
                'NSW': 0.35,
                'QLD': 0.25,
                'VIC': 0.20,
                'SA': 0.15,
                'TAS': 0.05
            };
            const multiplier = regionMultipliers[region] || 1;
            const options = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center',
                    itemGap: 20,
                    textStyle: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 14
                    },
                    icon: 'circle'
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit.charts.userManagement') : '用户管理',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '20',
                            fontWeight: 'bold',
                            color: '#fff',
                            textBorderWidth: 0,
                            textBorderColor: 'transparent',
                            textShadowBlur: 0
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        { 
                            value: Math.round(1048 * multiplier), 
                            name: window.i18n ? window.i18n.getText('profit.filters.active') : '活跃用户',
                            itemStyle: { color: '#00ff88' }
                        },
                        { 
                            value: Math.round(735 * multiplier), 
                            name: window.i18n ? window.i18n.getText('profit.filters.inactive') : '非活跃用户',
                            itemStyle: { color: '#ffd93d' }
                        },
                        { 
                            value: Math.round(580 * multiplier), 
                            name: window.i18n ? window.i18n.getText('profit.filters.notParticipating') : '未参与用户',
                            itemStyle: { color: '#ff6b6b' }
                        }
                    ]
                }]
            };
            
            userManagementChart = chartManager.createChart('userManagementChart', options);
        }

        function initRevenueDistributionChart() {
            // Generate scatter data
            const scatterData = [];
            for (let i = 0; i < 50; i++) {
                scatterData.push([
                    Math.random() * 100,
                    20 + Math.random() * 100
                ]);
            }
            
            const options = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const userLabel = window.i18n ? window.i18n.getText('profit.charts.users') : '用户';
                        const profitLabel = window.i18n ? window.i18n.getText('profit.charts.revenue') : '收益';
                        return `${userLabel}: ${params.data[0].toFixed(0)}<br/>${profitLabel}: $${params.data[1].toFixed(0)}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('profit.charts.users') : '用户',
                    nameLocation: 'end',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 12
                    },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '$',
                    nameLocation: 'end',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 12
                    },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit.charts.revenueDistribution') : '收益分布',
                    type: 'scatter',
                    data: scatterData,
                    symbolSize: 8,
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    emphasis: {
                        scale: 1.5,
                        itemStyle: {
                            color: '#00ff88',
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 255, 136, 0.5)'
                        }
                    }
                }]
            };
            
            revenueDistributionChart = chartManager.createChart('revenueDistributionChart', options);
        }

        function initPowerRevenueChart() {
            const options = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'var(--color-text-secondary)'
                        }
                    }
                },
                legend: {
                    data: [window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量', window.i18n ? window.i18n.getText('profit') : '获利'],
                    textStyle: { color: 'var(--color-text-secondary)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0', '6', '12', '18', '24'],
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'var(--color-text-secondary)' }
                },
                yAxis: [{
                    type: 'value',
                    name: 'kWh',
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: 'var(--color-text-secondary)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                }, {
                    type: 'value',
                    name: '$',
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: 'var(--color-text-secondary)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    }
                }],
                series: [{
                    name: window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量',
                    type: 'bar',
                    data: [100, 120, 240, 80, 110],
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    barWidth: '40%'
                }, {
                    name: window.i18n ? window.i18n.getText('profit') : '获利',
                    type: 'line',
                    yAxisIndex: 1,
                    data: [150, 180, 240, 120, 165],
                    lineStyle: {
                        width: 3,
                        color: '#ffd700'
                    },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 8,
                    smooth: true
                }]
            };
            
            powerRevenueChart = chartManager.createChart('powerRevenueChart', options);
        }

        function initProfitRankingChart() {
            updateProfitRankingChart();
        }

        function updateProfitRankingChart() {
            const isTop5 = currentProfitView === 'top5';
            // Use i18n for user names
            const userNames = [
                window.i18n ? window.i18n.getText('userName1') : 'John Zhang',
                window.i18n ? window.i18n.getText('userName2') : 'Henry Li',
                window.i18n ? window.i18n.getText('userName3') : 'William Wang',
                window.i18n ? window.i18n.getText('userName5') : 'Sam Zhang',
                window.i18n ? window.i18n.getText('userName6') : 'Tom Li',
                window.i18n ? window.i18n.getText('userName7') : 'Tony Zhou',
                window.i18n ? window.i18n.getText('userName8') : 'Amy Wu',
                window.i18n ? window.i18n.getText('userName9') : 'Eric Zheng',
                window.i18n ? window.i18n.getText('userName10') : 'Linda Lin',
                '刘强'
            ];
            
            const data = isTop5 
                ? [
                    { value: 4850, name: userNames[0] },
                    { value: 4320, name: userNames[1] },
                    { value: 3980, name: userNames[2] },
                    { value: 3650, name: userNames[3] },
                    { value: 3420, name: userNames[4] }
                ]
                : [
                    { value: 280, name: userNames[5] },
                    { value: 250, name: userNames[6] },
                    { value: 220, name: userNames[7] },
                    { value: 180, name: userNames[8] },
                    { value: 150, name: userNames[9] }
                ];

            const options = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        return `${params[0].name}: $${params[0].value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '15%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: 0,
                        rotate: -45,
                        fontSize: 12,
                        margin: 8
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: function(value) {
                            return '$' + value;
                        }
                    },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit') : '获利 ($)',
                    type: 'bar',
                    data: data.map(item => item.value),
                    label: {
                        show: true,
                        position: 'top',
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: function(params) {
                            return '$' + params.value;
                        }
                    },
                    itemStyle: {
                        color: function(params) {
                            // Different colors for top5 and bottom5
                            return isTop5 ? '#00ff88' : '#ff6b6b';
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    barWidth: '50%'
                }]
            };

            if (profitRankingChart) {
                profitRankingChart.setOption(options);
            } else {
                profitRankingChart = chartManager.createChart('profitRankingChart', options);
            }
        }

        // Table sorting with cancel functionality
        let currentSortColumn = null;
        let currentSortDirection = null;
        
        function sortTable(column, direction, element) {
            // Check if clicking the same sort button
            const isCurrentSort = currentSortColumn === column && currentSortDirection === direction;
            
            // Remove active class from all sort buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (isCurrentSort) {
                // Cancel sort - restore original order
                currentSortColumn = null;
                currentSortDirection = null;
                
                // Regenerate data in original order
                generateTableData();
                
                // Reset pagination
                if (pagination) {
                    currentPage = 1;
                    pagination = new Pagination({
                        containerId: 'paginationContainer',
                        currentPage: 1,
                        pageSize: pageSize,
                        totalItems: tableData.length,
                        onPageChange: (page, size) => {
                            currentPage = page;
                            loadTableData();
                        },
                        onPageSizeChange: (size) => {
                            pageSize = size;
                            currentPage = 1;
                            loadTableData();
                        }
                    });
                }
            } else {
                // Apply new sort
                currentSortColumn = column;
                currentSortDirection = direction;
                
                // Add active class to clicked button
                element.classList.add('active');
                
                // Sort the data
                tableData.sort((a, b) => {
                    let aVal, bVal;
                    
                    switch(column) {
                        case 'discharge':
                            aVal = a.discharge;
                            bVal = b.discharge;
                            break;
                        case 'profit':
                            aVal = a.profit;
                            bVal = b.profit;
                            break;
                        case 'dailyAvg':
                            aVal = a.dailyAvg;
                            bVal = b.dailyAvg;
                            break;
                        case 'comparison':
                            aVal = a.comparison;
                            bVal = b.comparison;
                            break;
                        default:
                            return 0;
                    }
                    
                    if (direction === 'asc') {
                        return aVal - bVal;
                    } else {
                        return bVal - aVal;
                    }
                });
            }
            
            // Reload table
            loadTableData();
        }

        // Export functionality
        function exportTableData() {
            console.log('Exporting table data...');
            // Implementation for data export
        }
        
        // Initialize pagination
        function initializePagination() {
            pagination = new Pagination({
                containerId: 'paginationContainer',
                currentPage: currentPage,
                pageSize: pageSize,
                totalItems: tableData.length,
                onPageChange: (page, size) => {
                    currentPage = page;
                    loadTableData();
                },
                onPageSizeChange: (size) => {
                    pageSize = size;
                    currentPage = 1;
                    loadTableData();
                }
            });
            
            // Load initial data
            loadTableData();
        }
        
        // Generate table data function that is called by other functions
        function generateTableData() {
            console.log('[generateTableData] Called, current time period:', currentTimePeriod);
            const timeSelector = document.getElementById('timeSelector');
            console.log('[generateTableData] Time selector value:', timeSelector ? timeSelector.value : 'null');
            console.log('[generateTableData] Time selector type:', timeSelector ? timeSelector.type : 'null');
            tableData = generateUserParticipationData();
            console.log('[generateTableData] Generated', tableData.length, 'rows of data');
            if (tableData.length > 0) {
                console.log('[generateTableData] First row date:', tableData[0].date);
            }
        }
        
        // 生成表格数据 - 完全重写
        function generateUserParticipationData() {
            const users = ['Harvey Lee', 'Lucas Wang', 'David Zhang', 'Fiona Liu', 
                          'Michael Chen', 'Lisa Zhao', 'John Sun', '周敏', '吴强', '郑华'];
            const statuses = ['active', 'inactive', 'notParticipating'];
            const data = [];
            
            // 获取时间选择器的值
            const timeSelector = document.getElementById('timeSelector');
            const selectedTime = timeSelector ? timeSelector.value : '';
            
            console.log('[generateUserParticipationData] Period:', currentTimePeriod, 'Selected time:', selectedTime);
            
            switch (currentTimePeriod) {
                case 'day': {
                    // 日报 - 显示选定日期
                    const date = selectedTime ? new Date(selectedTime) : new Date();
                    const dateStr = formatDate(date);
                    
                    // 生成5-8个用户数据
                    const userCount = 5 + Math.floor(Math.random() * 4);
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i % users.length], dateStr, statuses, 'day'));
                    }
                    break;
                }
                
                case 'month': {
                    // 月报 - 显示整月汇总数据
                    let year, month;
                    if (selectedTime && selectedTime.includes('-')) {
                        [year, month] = selectedTime.split('-');
                    } else {
                        year = new Date().getFullYear();
                        month = String(new Date().getMonth() + 1).padStart(2, '0');
                    }
                    
                    // 为每个用户生成该月的汇总数据
                    const dateStr = `${year}年${parseInt(month)}月`;
                    const userCount = 8 + Math.floor(Math.random() * 3);
                    
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i % users.length], dateStr, statuses, 'month'));
                    }
                    break;
                }
                
                case 'year': {
                    // 年报 - 显示全年汇总数据
                    const year = timeSelector && timeSelector.type === 'number' ? timeSelector.value : new Date().getFullYear();
                    
                    // 为每个用户生成该年的汇总数据
                    const dateStr = `${year}年`;
                    const userCount = 10;  // 显示所有10个用户
                    
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i], dateStr, statuses, 'year'));
                    }
                    break;
                }
                
                case 'total': {
                    // 累计 - 显示所有用户累计数据
                    users.forEach(user => {
                        data.push(createUserData(user, '累计', statuses, 'total'));
                    });
                    break;
                }
            }
            
            return data;
        }
        
        // 创建单个用户数据
        function createUserData(user, date, statuses, period) {
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            let discharge = 0;
            let dailyAvg = 50;
            
            if (status !== 'notParticipating') {
                switch (period) {
                    case 'day':
                        discharge = 20 + Math.floor(Math.random() * 40);
                        dailyAvg = 50;
                        break;
                    case 'month':
                        discharge = 600 + Math.floor(Math.random() * 600);  // 月度汇总
                        dailyAvg = 1500;
                        break;
                    case 'year':
                        discharge = 7000 + Math.floor(Math.random() * 5000);  // 年度汇总
                        dailyAvg = 18000;
                        break;
                    case 'total':
                        discharge = 10000 + Math.floor(Math.random() * 5000);
                        dailyAvg = 500;
                        break;
                }
            }
            
            const profit = status === 'notParticipating' ? 0 : Math.floor(discharge * 1.8);
            
            return {
                date: date,
                user: user,
                status: status,
                discharge: discharge,
                profit: profit,
                dailyAvg: dailyAvg,
                comparison: profit - dailyAvg
            };
        }
        
        // 格式化日期
        function formatDate(date) {
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }
        
        // Load table data into the table
        function loadTableData() {
            console.log('[loadTableData] Starting with time period:', currentTimePeriod);
            
            const tbody = document.getElementById('userParticipationTableBody');
            if (!tbody) {
                console.error('[loadTableData] Table body not found');
                return;
            }
            
            // Clear table
            tbody.innerHTML = '';
            
            // Check if we have data
            if (!tableData || tableData.length === 0) {
                console.log('[loadTableData] No data to display, generating new data...');
                generateTableData();
                
                if (!tableData || tableData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">暂无数据</td></tr>';
                    return;
                }
            }
            
            console.log('[loadTableData] Loading', tableData.length, 'rows for period:', currentTimePeriod);
            
            // Get current page data
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, tableData.length);
            const pageData = tableData.slice(startIndex, endIndex);
            
            // Group by date
            const groupedData = {};
            pageData.forEach(item => {
                if (!groupedData[item.date]) {
                    groupedData[item.date] = [];
                }
                groupedData[item.date].push(item);
            });
            
            // Render rows
            Object.entries(groupedData).forEach(([date, rows]) => {
                rows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // Add date cell for first row of each date
                    if (index === 0) {
                        const dateCell = document.createElement('td');
                        dateCell.rowSpan = rows.length;
                        dateCell.style.verticalAlign = 'middle';
                        dateCell.style.fontWeight = '500';
                        dateCell.textContent = date;
                        tr.appendChild(dateCell);
                    }
                    
                    // Add data cells
                    tr.innerHTML += `
                        <td>${row.user}</td>
                        <td class="status-${row.status === 'notParticipating' ? 'not-participating' : row.status}">${getStatusText(row.status)}</td>
                        <td>${row.discharge.toFixed(1)}</td>
                        <td class="${row.profit > 0 ? 'profit-positive' : 'profit-negative'}">${row.profit}</td>
                        <td>${row.dailyAvg}</td>
                        <td class="${row.comparison >= 0 ? 'profit-positive' : 'profit-negative'}">${row.comparison >= 0 ? '+' : ''}${row.comparison}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            });
            
            // Add total row on last page
            if (endIndex === tableData.length && tableData.length > 0) {
                const totalDischarge = tableData.reduce((sum, item) => sum + item.discharge, 0);
                const totalProfit = tableData.reduce((sum, item) => sum + item.profit, 0);
                
                const totalRow = document.createElement('tr');
                totalRow.style.borderTop = '2px solid var(--color-border)';
                totalRow.style.background = 'var(--color-bg)';
                totalRow.innerHTML = `
                    <td colspan="3" style="text-align: center; font-weight: 600; color: var(--color-primary);">合计</td>
                    <td style="font-weight: 600;">${totalDischarge.toFixed(1)}</td>
                    <td class="profit-positive" style="font-weight: 600;">${totalProfit}</td>
                    <td>-</td>
                    <td>-</td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Get status text
        function getStatusText(status) {
            if (window.i18n) {
                const key = `profit.status.${status}`;
                return window.i18n.getText(key);
            }
            
            switch(status) {
                case 'active': return '活跃';
                case 'inactive': return '非活跃';
                case 'notParticipating': return '未参与';
                default: return status;
            }
        }

        // Refresh functions
        function refreshCharts(region = 'all') {
            if (currentViewMode === 'chart') {
                setTimeout(() => {
                    initAllCharts(region);
                }, 100);
            }
        }

        function updateTexts() {
            // Update chart titles and legends when language changes
            if (window.i18n) {
                refreshCharts();
            }
        }

        // Add i18n translations for common time periods if not exist
        if (window.i18n && window.i18n.translations) {
            // Add common time translations if missing
            if (!window.i18n.translations.zh.common) {
                window.i18n.translations.zh.common = {};
            }
            if (!window.i18n.translations.en.common) {
                window.i18n.translations.en.common = {};
            }
            
            // Add time translations
            window.i18n.translations.zh.common.time = {
                day: '日报',
                month: '月报',
                year: '年报',
                cumulative: '累计',
                select: '选择时间'
            };
            
            window.i18n.translations.en.common.time = {
                day: 'Daily',
                month: 'Monthly',
                year: 'Yearly',
                cumulative: 'Cumulative',
                select: 'Select Time'
            };
            
            // Add common translations
            window.i18n.translations.zh.common.testMode = '测试筛选';
            window.i18n.translations.en.common.testMode = 'Test Filter';
            
            // Add profit chart translations if missing
            if (!window.i18n.translations.zh.profit.charts) {
                window.i18n.translations.zh.profit.charts = {};
            }
            if (!window.i18n.translations.en.profit.charts) {
                window.i18n.translations.en.profit.charts = {};
            }
            
            window.i18n.translations.zh.profit.charts.users = '用户';
            window.i18n.translations.zh.profit.charts.revenue = '收益';
            window.i18n.translations.en.profit.charts.users = 'Users';
            window.i18n.translations.en.profit.charts.revenue = 'Revenue';
            
            window.i18n.translations.zh.actualDischarge = '实时放电量';
            window.i18n.translations.zh.profit = '获利';
            window.i18n.translations.en.actualDischarge = 'Actual Discharge';
            window.i18n.translations.en.profit = 'Profit';
        }
    </script>
    
    <!-- Force create region selector -->
    <script>
        // Ensure region selector is created
        window.addEventListener('load', function() {
            setTimeout(() => {
                const timeSelectorModule = document.querySelector('.time-selector-module');
                if (timeSelectorModule) {
                    // Check if region selector already exists
                    let regionSelector = document.getElementById('regionSelector');
                    if (!regionSelector) {
                        console.log('Creating region selector...');
                        
                        // Create the select element
                        regionSelector = document.createElement('select');
                        regionSelector.id = 'regionSelector';
                        regionSelector.className = 'time-input';
                        regionSelector.style.minWidth = '120px';
                        regionSelector.style.marginRight = '12px';
                        regionSelector.style.marginLeft = '0';
                        regionSelector.style.display = 'inline-block';
                        regionSelector.onchange = function() { handleRegionChange(); };
                        
                        // Add options
                        const regions = [
                            { value: 'all', text: '全部地区' },
                            { value: 'NSW', text: 'NSW' },
                            { value: 'QLD', text: 'QLD' },
                            { value: 'VIC', text: 'VIC' },
                            { value: 'SA', text: 'SA' },
                            { value: 'TAS', text: 'TAS' }
                        ];
                        
                        regions.forEach(region => {
                            const option = document.createElement('option');
                            option.value = region.value;
                            option.textContent = region.text;
                            regionSelector.appendChild(option);
                        });
                        
                        // Insert at the beginning of time-selector-module
                        const firstChild = timeSelectorModule.firstElementChild;
                        timeSelectorModule.insertBefore(regionSelector, firstChild);
                        
                        console.log('Region selector created successfully');
                    } else {
                        console.log('Region selector already exists');
                    }
                }
            }, 500);
        });
    </script>
</body>
</html>