<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="profit.title">Ëé∑Âà© - AlwaysControl</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/standard-layout.css">
    <link rel="stylesheet" href="components/pagination.css">
    <script src="components/time-selector.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/pagination.js"></script>
    <style>
        /* Profit page specific styles - most styles now inherit from common-styles.css */

        /* Unified Time Selector Module */
        .time-selector-module {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--color-bg-card);
            border-radius: 24px;
            border: 1px solid var(--color-border);
        }

        .time-input {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
            min-width: 150px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .time-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: transparent;
            color: var(--color-text-secondary);
        }

        .time-input[type="number"] {
            min-width: 100px;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Tab-style view switcher */
        .page-view-tabs {
            display: inline-flex;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .page-tab {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .page-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            font-weight: 600;
        }

        .page-tab.active::before {
            display: none;
        }

        /* Ensure container width is maintained */
        .container {
            max-width: 95%;
            padding: 100px 10px 24px;
            margin: 0 auto;
        }

        /* Specific styles for profit page layout */
        
        /* Page header alignment */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
        }
        
        /* Page title to match other pages */
        .page-title {
            font-size: 48px;
            font-weight: 500;
            color: var(--color-text);
            margin: 0;
            letter-spacing: -2px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-text);
            letter-spacing: -0.5px;
        }

        .stat-change {
            font-size: 13px;
            color: var(--color-success);
            font-weight: 400;
        }

        .stat-change.negative {
            color: var(--color-danger);
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }

        .chart-container {
            padding: 24px;
            min-height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--color-text);
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        /* Tables */
        .table-section {
            margin-bottom: 40px;
        }

        .table-container {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .table-title {
            font-size: 16px;
            font-weight: 600;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .data-table th {
            color: var(--color-text-secondary);
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .data-table td {
            font-size: 14px;
        }

        .status-active {
            color: var(--color-primary);
        }

        .status-inactive {
            color: #ff6b6b;
        }

        .profit-positive {
            color: var(--color-primary);
        }

        .profit-negative {
            color: #ff6b6b;
        }

        /* Table status styles */
        .status-active {
            color: var(--color-primary) !important;
            font-weight: 500;
        }

        .status-inactive {
            color: #ffd93d !important;
            font-weight: 500;
        }

        .status-not-participating {
            color: #ff6b6b !important;
            font-weight: 500;
        }

        /* Table styling improvements */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--color-text);
        }

        .data-table th {
            background: var(--color-bg);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.2s ease;
        }

        .data-table tr:hover {
            background: var(--color-bg);
        }

        /* ÊéíÂ∫èÊåâÈíÆÊ†∑Âºè */
        .sort-buttons {
            margin-left: 8px;
            display: inline-flex;
            gap: 4px;
            vertical-align: middle;
        }

        .sort-btn {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);
            width: 20px;
            height: 20px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
        }

        .sort-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }

        .sort-btn.active {
            background: var(--color-primary);
            color: #fff;
            border-color: var(--color-primary);
            box-shadow: 0 0 5px rgba(0, 185, 107, 0.5);
        }

        .table-section {
            margin-bottom: 40px;
        }

        .table-container {
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-filters {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-filters .filter-tab {
            padding: 6px 14px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 18px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .status-filters .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
            transform: translateY(-1px);
            box-shadow: var(--color-shadow);
        }

        .status-filters .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
            transform: translateY(-1px);
        }

        .export-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--color-primary);
            border-radius: 6px;
            color: var(--color-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .export-btn:hover {
            background: var(--color-primary);
            color: #000;
            transform: translateY(-1px);
        }

        .export-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 185, 107, 0.2);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
        }

        .pagination-info {
            color: var(--color-text-secondary);
            font-size: 12px;
            margin-right: 20px;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .pagination-btn:hover,
        .pagination-btn.active {
            background: var(--color-primary);
            color: #fff;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Chart controls for profit ranking */
        .chart-controls {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .chart-controls .filter-tab {
            padding: 6px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 15px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .chart-controls .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
        }

        .chart-controls .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
        }

        /* Hide built-in time selector */
        /* Time selector container removed - using inline input now */

        /* Legend styles for charts */
        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 16px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        /* Test mode button */
        .test-mode-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: var(--color-danger);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s;
        }

        .test-mode-btn:hover {
            transform: scale(1.05);
        }

        /* Responsive grid adjustments */
        @media (max-width: 1200px) {
            .container {
                max-width: 98%;
                padding: 120px 8px 40px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .charts-section {
                gap: 24px;
            }
            
            .chart-container {
                padding: 24px;
                min-height: 380px;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 120px 5px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .chart-title {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                padding: 120px 3px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Header Component -->
    <!-- Header Container for HeaderNav Component -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle" data-i18n-key="profit.pageTitle">Ëé∑Âà©</h1>
            <!-- View Mode Tabs -->
            <div class="page-view-tabs">
                <button class="page-tab active" onclick="switchViewMode('chart', this)" id="chartTab">
                    üìä <span data-i18n-key="profit.views.chart">ÂõæË°®ËßÜÂõæ</span>
                </button>
                <button class="page-tab" onclick="switchViewMode('table', this)" id="tableTab">
                    üìã <span data-i18n-key="profit.views.table">Ë°®Ê†ºËßÜÂõæ</span>
                </button>
            </div>
        </div>
        
        <!-- Time Pills -->
        <!-- Unified Time Selector Module -->
        <div class="time-selector-module">
            <button class="time-pill active" onclick="switchTimePeriod('day', this)" data-i18n-key="dayReport">Êó•</button>
            <button class="time-pill" onclick="switchTimePeriod('month', this)" data-i18n-key="monthReport">Êúà</button>
            <button class="time-pill" onclick="switchTimePeriod('year', this)" data-i18n-key="yearReport">Âπ¥</button>
            <button class="time-pill" onclick="switchTimePeriod('total', this)" data-i18n-key="totalReport">Á¥ØËÆ°</button>
            <input type="date" id="timeSelector" class="time-input" onchange="handleTimeInputChange()">
            <button class="refresh-btn" onclick="refreshData()" data-i18n-key="refresh">üîÑ</button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.userCount">Áî®Êà∑Êï∞Èáè</div>
                <div class="stat-value" id="userCount">1,234</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">ÊØîÊò®Êó•</span> ‚Üë 12</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.totalRevenue">Á¥ØËÆ°Êî∂Áõä</div>
                <div class="stat-value" id="totalRevenue">$457,000</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">ÊØîÊò®Êó•</span> ‚Üë $2,000</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.avgProfit">‰∫∫ÂùáËé∑Âà©</div>
                <div class="stat-value" id="avgProfit">$370</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">ÊØîÊò®Êó•</span> ‚Üë $5</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.maxStationProfit">ÊúÄÂ§ßËé∑Âà© (ÁîµÁ´ô)</div>
                <div class="stat-value" id="maxStationProfit">$5,00</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">ÊØîÊò®Êó•</span> ‚Üë $200</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n-key="profit.stats.minStationProfit">ÊúÄÂ∞èËé∑Âà© (ÁîµÁ´ô)</div>
                <div class="stat-value" id="minStationProfit">$10</div>
                <div class="stat-change"><span data-i18n-key="profit.stats.comparedYesterday">ÊØîÊò®Êó•</span> ‚Üë $1</div>
            </div>
        </div>

        <!-- Chart View Content -->
        <div id="chartViewContent">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- User Management Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.userManagement">Áî®Êà∑ÁÆ°ÁêÜ</div>
                    </div>
                    <div id="userManagementChart" style="width: 100%; height: 300px;"></div>
                </div>

                <!-- Revenue Distribution Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.revenueDistribution">Êî∂ÁõäÂàÜÂ∏É</div>
                    </div>
                    <div id="revenueDistributionChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>

            <!-- Secondary Charts Section -->
            <div class="charts-section">
                <!-- Power and Revenue Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.dischargeAndProfit">ÊîæÁîµ‰∏éËé∑Âà©</div>
                    </div>
                    <div id="powerRevenueChart" style="width: 100%; height: 350px;"></div>
                </div>

                <!-- Top 5 Profit Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n-key="profit.charts.profitRanking">Ëé∑Âà©ÊéíÂêç</div>
                        <div class="chart-controls">
                            <button class="filter-tab active" onclick="switchProfitView('top5', this)" id="top5Tab" data-i18n-key="profit.ranking.top5">Ââç‰∫î</button>
                            <button class="filter-tab" onclick="switchProfitView('bottom5', this)" id="bottom5Tab" data-i18n-key="profit.ranking.bottom5">Âêé‰∫î</button>
                        </div>
                    </div>
                    <div id="profitRankingChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Table View Content -->
        <div id="tableViewContent" style="display: none;">

            <!-- User Participation Table -->
            <div class="table-section">
                <div class="table-container card">
                    <div class="table-header">
                        <div class="table-title" data-i18n-key="profit.table.userParticipation">Áî®Êà∑ÂèÇ‰∏éÊÉÖÂÜµ</div>
                        <div class="table-controls">
                            <!-- Áä∂ÊÄÅÁ≠õÈÄâ -->
                            <div class="status-filters">
                                <button class="filter-tab active" onclick="filterByStatus('all', this)" id="statusAll" data-i18n-key="profit.filters.all">ÂÖ®ÈÉ®</button>
                                <button class="filter-tab" onclick="filterByStatus('active', this)" id="statusActive" data-i18n-key="profit.filters.active">Ê¥ªË∑É</button>
                                <button class="filter-tab" onclick="filterByStatus('inactive', this)" id="statusInactive" data-i18n-key="profit.filters.inactive">ÈùûÊ¥ªË∑É</button>
                                <button class="filter-tab" onclick="filterByStatus('notParticipating', this)" id="statusNotParticipating" data-i18n-key="profit.filters.notParticipating">Êú™ÂèÇ‰∏é</button>
                            </div>
                            <!-- ÂØºÂá∫ÂäüËÉΩ -->
                            <button class="export-btn" onclick="exportTableData()">
                                üì• <span data-i18n-key="profit.buttons.exportData">ÂØºÂá∫Êï∞ÊçÆ</span>
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n-key="profit.table.date">Êó•Êúü</th>
                                <th data-i18n-key="profit.table.user">Áî®Êà∑</th>
                                <th data-i18n-key="profit.table.status">ÊÄßË¥®</th>
                                <th data-i18n-key="profit.table.dischargeAmount">ÂÆûÈôÖÊîæÁîµÈáè (kwh)
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('discharge', 'asc', this)" title="ÂçáÂ∫è">‚Üë</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('discharge', 'desc', this)" title="ÈôçÂ∫è">‚Üì</button>
                                    </span>
                                </th>
                                <th data-i18n-key="profit.table.profit">Ëé∑Âà© ($)
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('profit', 'asc', this)" title="ÂçáÂ∫è">‚Üë</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('profit', 'desc', this)" title="ÈôçÂ∫è">‚Üì</button>
                                    </span>
                                </th>
                                <th data-i18n-key="profit.table.dailyAvg">Êó•Âùá</th>
                                <th data-i18n-key="profit.table.compareDaily">ÂØπÊØîÊó•Âùá ($)
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('comparison', 'asc', this)" title="ÂçáÂ∫è">‚Üë</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('comparison', 'desc', this)" title="ÈôçÂ∫è">‚Üì</button>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="userParticipationTableBody">
                            <!-- Table data will be loaded dynamically -->
                        </tbody>
                    </table>
                    
                    <div id="paginationContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add profit chart fix script -->
    <script src="profit-chart-fix.js"></script>

    <script>
        // Global chart variables
        let userManagementChart, revenueDistributionChart, powerRevenueChart, profitRankingChart;
        let currentViewMode = 'chart';
        let currentProfitView = 'top5';
        let currentTimePeriod = 'day';
        
        // Table view variables
        let tableData = [];
        let filteredTableData = [];
        let currentPage = 1;
        let pageSize = 10;
        let pagination = null;
        let currentFilter = 'all';

        // Performance utilities 
        function throttle(func, limit) {
            let inThrottle;
            let lastFunc;
            let lastRan;
            
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    lastRan = Date.now();
                    inThrottle = true;
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, Math.max(limit - (Date.now() - lastRan), 0));
                }
                
                setTimeout(() => {
                    inThrottle = false;
                }, limit);
            };
        }

        // Data cache class
        class DataCache {
            constructor(ttl = 5 * 60 * 1000, maxSize = 100) {
                this.cache = new Map();
                this.ttl = ttl;
                this.maxSize = maxSize;
            }
            
            set(key, data) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            get(key) {
                const item = this.cache.get(key);
                if (!item) return null;
                
                if (Date.now() - item.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return item.data;
            }
        }

        // Chart manager with caching
        class ChartManager {
            constructor() {
                this.cache = new DataCache();
                this.charts = new Map();
            }
            
            createChart(containerId, options, useCache = true) {
                const container = document.getElementById(containerId);
                if (!container) {
                    console.warn(`Container ${containerId} not found`);
                    return null;
                }
                
                if (useCache) {
                    const cached = this.cache.get(containerId);
                    if (cached) {
                        const chart = echarts.init(container);
                        chart.setOption(cached);
                        this.charts.set(containerId, chart);
                        return chart;
                    }
                }
                
                const chart = echarts.init(container);
                chart.setOption(options);
                
                if (useCache) {
                    this.cache.set(containerId, options);
                }
                
                this.charts.set(containerId, chart);
                return chart;
            }
            
            getChart(containerId) {
                return this.charts.get(containerId);
            }
            
            resizeAll() {
                this.charts.forEach(chart => {
                    if (chart && !chart.isDisposed()) {
                        chart.resize();
                    }
                });
            }
        }

        const chartManager = new ChartManager();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Initialize header navigation
                if (typeof HeaderNav !== 'undefined') {
                    window.headerNav = new HeaderNav({
                        containerId: 'headerContainer',
                        currentPage: 'profit'
                    });
                }

                // Initialize time selector with default day + today
                const today = new Date();
                const timeInput = document.getElementById('timeSelector');
                if (timeInput) {
                    timeInput.type = 'date';
                    timeInput.value = today.toISOString().split('T')[0];
                }

                // Initialize charts
                initAllCharts();

                // Listen for language changes
                if (window.i18n) {
                    window.i18n.addObserver(() => {
                        updateTexts();
                        refreshCharts();
                    });
                }

                // Window resize listener
                window.addEventListener('resize', throttle(() => {
                    chartManager.resizeAll();
                }, 250));
            }, 200);
        });

        // Time change handler
        function handleTimeChange() {
            const timeInput = document.getElementById('timeSelector');
            const selectedDate = timeInput.value;
            const period = currentTimePeriod;
            console.log('Time period changed:', period, selectedDate);
            refreshCharts();
        }

        // Time period switching
        function switchTimePeriod(period, element) {
            console.log('[switchTimePeriod] Switching to:', period);
            currentTimePeriod = period;
            
            // Update pill states
            document.querySelectorAll('.time-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            element.classList.add('active');
            
            // Handle time input based on period
            const timeInput = document.getElementById('timeSelector');
            const today = new Date();
            
            if (period === 'total') {
                // TotalÊ®°ÂºèÔºöÈöêËóèÊó∂Èó¥ÈÄâÊã©Âô®
                timeInput.style.display = 'none';
                timeInput.disabled = true;
                timeInput.value = '';
                
                // ÁßªÂä®Âà∑Êñ∞ÊåâÈíÆÂà∞Á¥ØËÆ°ÊåâÈíÆÂêéÈù¢
                const refreshBtn = document.querySelector('.refresh-btn');
                const totalBtn = element;
                if (refreshBtn && totalBtn) {
                    totalBtn.insertAdjacentElement('afterend', refreshBtn);
                }
            } else {
                // ÂÖ∂‰ªñÊ®°ÂºèÔºöÊòæÁ§∫Êó∂Èó¥ÈÄâÊã©Âô®Âπ∂ËÆæÁΩÆÁõ∏Â∫îÁöÑÈªòËÆ§ÂÄº
                timeInput.style.display = 'block';
                timeInput.disabled = false;
                
                // ÊÅ¢Â§çÂà∑Êñ∞ÊåâÈíÆÂà∞Âéü‰ΩçÁΩÆÔºàÊó∂Èó¥ÈÄâÊã©Âô®ÂêéÈù¢Ôºâ
                const refreshBtn = document.querySelector('.refresh-btn');
                if (refreshBtn && timeInput) {
                    timeInput.insertAdjacentElement('afterend', refreshBtn);
                }
                
                switch(period) {
                    case 'day':
                        // Êó•Ê®°ÂºèÔºöËÆæÁΩÆ‰∏∫‰ªäÊó•
                        timeInput.type = 'date';
                        timeInput.value = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        // ÊúàÊ®°ÂºèÔºöËÆæÁΩÆ‰∏∫Êú¨Êúà
                        timeInput.type = 'month';
                        timeInput.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                        break;
                    case 'year':
                        // Âπ¥Ê®°ÂºèÔºöËÆæÁΩÆ‰∏∫‰ªäÂπ¥
                        timeInput.type = 'number';
                        timeInput.min = 2020;
                        timeInput.max = 2030;
                        timeInput.value = today.getFullYear();
                        break;
                }
            }
            
            // Force refresh data - both stats and table
            console.log('[switchTimePeriod] Forcing data refresh');
            setTimeout(() => {
                refreshData();
            }, 100);
        }

        function handleTimeInputChange() {
            console.log('Time input changed, refreshing all data...');
            handleTimeChange();
            refreshData();
        }

        // Refresh data when time changes
        function refreshData() {
            console.log('[refreshData] Current view mode:', currentViewMode);
            
            // Update stats
            updateStats();
            
            // Check if table view is visible
            const tableViewContent = document.getElementById('tableViewContent');
            const isTableVisible = tableViewContent && tableViewContent.style.display !== 'none';
            
            console.log('[refreshData] Is table visible?', isTableVisible);
            
            if (isTableVisible) {
                // Refresh table data
                console.log('[refreshData] Refreshing table view');
                refreshTableData();
            } else {
                // Refresh charts
                refreshCharts();
            }
        }
        
        // Refresh table data specifically
        function refreshTableData() {
            console.log('[refreshTableData] Starting table refresh');
            
            // Generate new data based on current time selection
            generateTableData();
            console.log('[refreshTableData] Generated', tableData.length, 'rows');
            
            // Reset to first page
            currentPage = 1;
            
            // Update pagination if it exists
            if (pagination) {
                console.log('[refreshTableData] Updating pagination');
                pagination.updateTotalItems(tableData.length);
                pagination.goToPage(1);
            }
            
            // Reload table
            console.log('[refreshTableData] Loading table data');
            loadTableData();
        }

        // Update stats based on current time period
        function updateStats() {
            // This would normally fetch data from an API
            // For now, using demo data
            const stats = {
                day: {
                    userCount: '1,234',
                    totalRevenue: '$457,000',
                    avgProfit: '$370',
                    maxProfit: '$5,000',
                    minProfit: '$10'
                },
                month: {
                    userCount: '12,345',
                    totalRevenue: '$4,570,000',
                    avgProfit: '$370',
                    maxProfit: '$50,000',
                    minProfit: '$100'
                },
                year: {
                    userCount: '123,456',
                    totalRevenue: '$45,700,000',
                    avgProfit: '$370',
                    maxProfit: '$500,000',
                    minProfit: '$1,000'
                },
                cumulative: {
                    userCount: '234,567',
                    totalRevenue: '$457,000,000',
                    avgProfit: '$1,950',
                    maxProfit: '$5,000,000',
                    minProfit: '$10,000'
                }
            };
            
            const currentStats = stats[currentTimePeriod] || stats.day;
            document.getElementById('userCount').textContent = currentStats.userCount;
            document.getElementById('totalRevenue').textContent = currentStats.totalRevenue;
            document.getElementById('avgProfit').textContent = currentStats.avgProfit;
            document.getElementById('maxStationProfit').textContent = currentStats.maxProfit;
            document.getElementById('minStationProfit').textContent = currentStats.minProfit;
        }

        // Toggle test mode
        function toggleTestMode() {
            console.log('Toggling test mode');
            // TODO: Implement test mode functionality
        }

        // View mode switching
        function switchViewMode(mode, element) {
            currentViewMode = mode;
            
            // Update tab states
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update content visibility
            if (mode === 'chart') {
                document.getElementById('chartViewContent').style.display = 'block';
                document.getElementById('tableViewContent').style.display = 'none';
                refreshCharts();
            } else {
                document.getElementById('chartViewContent').style.display = 'none';
                document.getElementById('tableViewContent').style.display = 'block';
                
                // Initialize table when switching to table view
                if (!pagination) {
                    generateTableData();
                    initializePagination();
                } else {
                    // Refresh table data
                    refreshTableData();
                }
            }
        }

        // Profit view switching
        function switchProfitView(view, element) {
            currentProfitView = view;
            
            // Update tab states
            document.querySelectorAll('.chart-controls .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Update chart
            updateProfitRankingChart();
        }

        // Status filtering
        function filterByStatus(status, element) {
            // Update tab states
            document.querySelectorAll('.status-filters .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // Re-generate data with filter
            generateTableData();
            
            if (status !== 'all') {
                tableData = tableData.filter(item => item.status === status);
            }
            
            // Update pagination
            if (pagination) {
                pagination.updateTotalItems(tableData.length);
                currentPage = 1;
            }
            
            // Reload table
            loadTableData();
        }

        // Initialize all charts
        function initAllCharts() {
            initUserManagementChart();
            initRevenueDistributionChart();
            initPowerRevenueChart();
            initProfitRankingChart();
        }

        function initUserManagementChart() {
            const options = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center',
                    itemGap: 20,
                    textStyle: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 14
                    },
                    icon: 'circle'
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit.charts.userManagement') : 'Áî®Êà∑ÁÆ°ÁêÜ',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    avoidLabelOverlap: false,
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '20',
                            fontWeight: 'bold',
                            color: '#fff',
                            textBorderWidth: 0,
                            textBorderColor: 'transparent',
                            textShadowBlur: 0
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: [
                        { 
                            value: 1048, 
                            name: window.i18n ? window.i18n.getText('profit.filters.active') : 'Ê¥ªË∑ÉÁî®Êà∑',
                            itemStyle: { color: '#00ff88' }
                        },
                        { 
                            value: 735, 
                            name: window.i18n ? window.i18n.getText('profit.filters.inactive') : 'ÈùûÊ¥ªË∑ÉÁî®Êà∑',
                            itemStyle: { color: '#ffd93d' }
                        },
                        { 
                            value: 580, 
                            name: window.i18n ? window.i18n.getText('profit.filters.notParticipating') : 'Êú™ÂèÇ‰∏éÁî®Êà∑',
                            itemStyle: { color: '#ff6b6b' }
                        }
                    ]
                }]
            };
            
            userManagementChart = chartManager.createChart('userManagementChart', options);
        }

        function initRevenueDistributionChart() {
            // Generate scatter data
            const scatterData = [];
            for (let i = 0; i < 50; i++) {
                scatterData.push([
                    Math.random() * 100,
                    20 + Math.random() * 100
                ]);
            }
            
            const options = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const userLabel = window.i18n ? window.i18n.getText('profit.charts.users') : 'Áî®Êà∑';
                        const profitLabel = window.i18n ? window.i18n.getText('profit.charts.revenue') : 'Êî∂Áõä';
                        return `${userLabel}: ${params.data[0].toFixed(0)}<br/>${profitLabel}: $${params.data[1].toFixed(0)}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('profit.charts.users') : 'Áî®Êà∑',
                    nameLocation: 'end',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 12
                    },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                yAxis: {
                    type: 'value',
                    name: '$',
                    nameLocation: 'end',
                    nameTextStyle: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 12
                    },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit.charts.revenueDistribution') : 'Êî∂ÁõäÂàÜÂ∏É',
                    type: 'scatter',
                    data: scatterData,
                    symbolSize: 8,
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    emphasis: {
                        scale: 1.5,
                        itemStyle: {
                            color: '#00ff88',
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 255, 136, 0.5)'
                        }
                    }
                }]
            };
            
            revenueDistributionChart = chartManager.createChart('revenueDistributionChart', options);
        }

        function initPowerRevenueChart() {
            const options = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'var(--color-text-secondary)'
                        }
                    }
                },
                legend: {
                    data: [window.i18n ? window.i18n.getText('actualDischarge') : 'ÂÆûÊó∂ÊîæÁîµÈáè', window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©'],
                    textStyle: { color: 'var(--color-text-secondary)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0', '6', '12', '18', '24'],
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'var(--color-text-secondary)' }
                },
                yAxis: [{
                    type: 'value',
                    name: 'kWh',
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: 'var(--color-text-secondary)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                }, {
                    type: 'value',
                    name: '$',
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: 'var(--color-text-secondary)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    }
                }],
                series: [{
                    name: window.i18n ? window.i18n.getText('actualDischarge') : 'ÂÆûÊó∂ÊîæÁîµÈáè',
                    type: 'bar',
                    data: [100, 120, 240, 80, 110],
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    barWidth: '40%'
                }, {
                    name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà©',
                    type: 'line',
                    yAxisIndex: 1,
                    data: [150, 180, 240, 120, 165],
                    lineStyle: {
                        width: 3,
                        color: '#ffd700'
                    },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 8,
                    smooth: true
                }]
            };
            
            powerRevenueChart = chartManager.createChart('powerRevenueChart', options);
        }

        function initProfitRankingChart() {
            updateProfitRankingChart();
        }

        function updateProfitRankingChart() {
            const isTop5 = currentProfitView === 'top5';
            // Use i18n for user names
            const userNames = [
                window.i18n ? window.i18n.getText('userName1') : 'John Zhang',
                window.i18n ? window.i18n.getText('userName2') : 'Henry Li',
                window.i18n ? window.i18n.getText('userName3') : 'William Wang',
                window.i18n ? window.i18n.getText('userName5') : 'Sam Zhang',
                window.i18n ? window.i18n.getText('userName6') : 'Tom Li',
                window.i18n ? window.i18n.getText('userName7') : 'Tony Zhou',
                window.i18n ? window.i18n.getText('userName8') : 'Amy Wu',
                window.i18n ? window.i18n.getText('userName9') : 'Eric Zheng',
                window.i18n ? window.i18n.getText('userName10') : 'Linda Lin',
                'ÂàòÂº∫'
            ];
            
            const data = isTop5 
                ? [
                    { value: 4850, name: userNames[0] },
                    { value: 4320, name: userNames[1] },
                    { value: 3980, name: userNames[2] },
                    { value: 3650, name: userNames[3] },
                    { value: 3420, name: userNames[4] }
                ]
                : [
                    { value: 280, name: userNames[5] },
                    { value: 250, name: userNames[6] },
                    { value: 220, name: userNames[7] },
                    { value: 180, name: userNames[8] },
                    { value: 150, name: userNames[9] }
                ];

            const options = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        return `${params[0].name}: $${params[0].value}`;
                    }
                },
                grid: {
                    left: '3%',
                    right: '15%',
                    bottom: '3%',
                    top: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: 0,
                        rotate: -45,
                        fontSize: 12,
                        margin: 8
                    }
                },
                yAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: function(value) {
                            return '$' + value;
                        }
                    },
                    splitLine: { 
                        lineStyle: { 
                            color: 'rgba(255, 255, 255, 0.08)',
                            type: 'dashed'
                        } 
                    }
                },
                series: [{
                    name: window.i18n ? window.i18n.getText('profit') : 'Ëé∑Âà© ($)',
                    type: 'bar',
                    data: data.map(item => item.value),
                    label: {
                        show: true,
                        position: 'top',
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: function(params) {
                            return '$' + params.value;
                        }
                    },
                    itemStyle: {
                        color: function(params) {
                            // Different colors for top5 and bottom5
                            return isTop5 ? '#00ff88' : '#ff6b6b';
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    barWidth: '50%'
                }]
            };

            if (profitRankingChart) {
                profitRankingChart.setOption(options);
            } else {
                profitRankingChart = chartManager.createChart('profitRankingChart', options);
            }
        }

        // Table sorting
        function sortTable(column, direction, element) {
            // Remove active class from all sort buttons
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            element.classList.add('active');
            
            // Sort the data
            tableData.sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'discharge':
                        aVal = a.discharge;
                        bVal = b.discharge;
                        break;
                    case 'profit':
                        aVal = a.profit;
                        bVal = b.profit;
                        break;
                    case 'comparison':
                        aVal = a.comparison;
                        bVal = b.comparison;
                        break;
                    default:
                        return 0;
                }
                
                if (direction === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            // Reload table
            loadTableData();
        }

        // Export functionality
        function exportTableData() {
            console.log('Exporting table data...');
            // Implementation for data export
        }
        
        // Initialize pagination
        function initializePagination() {
            pagination = new Pagination({
                containerId: 'paginationContainer',
                currentPage: currentPage,
                pageSize: pageSize,
                totalItems: tableData.length,
                onPageChange: (page, size) => {
                    currentPage = page;
                    loadTableData();
                },
                onPageSizeChange: (size) => {
                    pageSize = size;
                    currentPage = 1;
                    loadTableData();
                }
            });
            
            // Load initial data
            loadTableData();
        }
        
        // ÁîüÊàêË°®Ê†ºÊï∞ÊçÆ - ÂÆåÂÖ®ÈáçÂÜô
        function generateUserParticipationData() {
            const users = ['Harvey Lee', 'Lucas Wang', 'David Zhang', 'Fiona Liu', 
                          'Michael Chen', 'Lisa Zhao', 'John Sun', 'Âë®Êïè', 'Âê¥Âº∫', 'ÈÉëÂçé'];
            const statuses = ['active', 'inactive', 'notParticipating'];
            const data = [];
            
            // Ëé∑ÂèñÊó∂Èó¥ÈÄâÊã©Âô®ÁöÑÂÄº
            const timeSelector = document.getElementById('timeSelector');
            const selectedTime = timeSelector ? timeSelector.value : '';
            
            switch (currentTimePeriod) {
                case 'day': {
                    // Êó•Êä• - ÊòæÁ§∫ÈÄâÂÆöÊó•Êúü
                    const date = selectedTime ? new Date(selectedTime) : new Date();
                    const dateStr = formatDate(date);
                    
                    // ÁîüÊàê5-8‰∏™Áî®Êà∑Êï∞ÊçÆ
                    const userCount = 5 + Math.floor(Math.random() * 4);
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i % users.length], dateStr, statuses, 'day'));
                    }
                    break;
                }
                
                case 'month': {
                    // ÊúàÊä• - ÊòæÁ§∫Êï¥ÊúàÊï∞ÊçÆ
                    const [year, month] = selectedTime ? selectedTime.split('-') : [new Date().getFullYear(), String(new Date().getMonth() + 1).padStart(2, '0')];
                    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
                    
                    // ÊØèÂ§©ÁîüÊàê2-4‰∏™Áî®Êà∑Êï∞ÊçÆ
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}Âπ¥${parseInt(month)}Êúà${day}Êó•`;
                        const dayUsers = 2 + Math.floor(Math.random() * 3);
                        
                        for (let j = 0; j < dayUsers; j++) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            data.push(createUserData(randomUser, dateStr, statuses, 'month'));
                        }
                    }
                    break;
                }
                
                case 'year': {
                    // Âπ¥Êä• - ÊòæÁ§∫ÂÖ®Âπ¥Êï∞ÊçÆ
                    const year = timeSelector && timeSelector.type === 'number' ? timeSelector.value : new Date().getFullYear();
                    
                    // ÊØèÊúàÁîüÊàê3-5‰∏™Áî®Êà∑Êï∞ÊçÆ
                    for (let month = 1; month <= 12; month++) {
                        const dateStr = `${year}Âπ¥${month}Êúà`;
                        const monthUsers = 3 + Math.floor(Math.random() * 3);
                        
                        for (let j = 0; j < monthUsers; j++) {
                            const randomUser = users[Math.floor(Math.random() * users.length)];
                            data.push(createUserData(randomUser, dateStr, statuses, 'year'));
                        }
                    }
                    break;
                }
                
                case 'total': {
                    // Á¥ØËÆ° - ÊòæÁ§∫ÊâÄÊúâÁî®Êà∑Á¥ØËÆ°Êï∞ÊçÆ
                    users.forEach(user => {
                        data.push(createUserData(user, 'ÂéÜÂè≤Á¥ØËÆ°', statuses, 'total'));
                    });
                    break;
                }
            }
            
            return data;
        }
        
        // ÂàõÂª∫Âçï‰∏™Áî®Êà∑Êï∞ÊçÆ
        function createUserData(user, date, statuses, period) {
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            let discharge = 0;
            let dailyAvg = 50;
            
            if (status !== 'notParticipating') {
                switch (period) {
                    case 'day':
                        discharge = 20 + Math.floor(Math.random() * 40);
                        dailyAvg = 50;
                        break;
                    case 'month':
                        discharge = 20 + Math.floor(Math.random() * 40);
                        dailyAvg = 50;
                        break;
                    case 'year':
                        discharge = 500 + Math.floor(Math.random() * 500);
                        dailyAvg = 1500;
                        break;
                    case 'total':
                        discharge = 10000 + Math.floor(Math.random() * 5000);
                        dailyAvg = 500;
                        break;
                }
            }
            
            const profit = status === 'notParticipating' ? 0 : Math.floor(discharge * 1.8);
            
            return {
                date: date,
                user: user,
                status: status,
                discharge: discharge,
                profit: profit,
                dailyAvg: dailyAvg,
                comparison: profit - dailyAvg
            };
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date) {
            return `${date.getFullYear()}Âπ¥${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
        }
        
        // Load table data into the table
        function loadTableData() {
            console.log('[loadTableData] Starting');
            
            const tbody = document.getElementById('userParticipationTableBody');
            if (!tbody) {
                console.error('[loadTableData] Table body not found');
                return;
            }
            
            // Clear table
            tbody.innerHTML = '';
            
            // Check if we have data
            if (!tableData || tableData.length === 0) {
                console.log('[loadTableData] No data to display');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">ÊöÇÊó†Êï∞ÊçÆ</td></tr>';
                return;
            }
            
            console.log('[loadTableData] Loading', tableData.length, 'rows');
            
            // Get current page data
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, tableData.length);
            const pageData = tableData.slice(startIndex, endIndex);
            
            // Group by date
            const groupedData = {};
            pageData.forEach(item => {
                if (!groupedData[item.date]) {
                    groupedData[item.date] = [];
                }
                groupedData[item.date].push(item);
            });
            
            // Render rows
            Object.entries(groupedData).forEach(([date, rows]) => {
                rows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // Add date cell for first row of each date
                    if (index === 0) {
                        const dateCell = document.createElement('td');
                        dateCell.rowSpan = rows.length;
                        dateCell.style.verticalAlign = 'middle';
                        dateCell.style.fontWeight = '500';
                        dateCell.textContent = date;
                        tr.appendChild(dateCell);
                    }
                    
                    // Add data cells
                    tr.innerHTML += `
                        <td>${row.user}</td>
                        <td class="status-${row.status === 'notParticipating' ? 'not-participating' : row.status}">${getStatusText(row.status)}</td>
                        <td>${row.discharge.toFixed(1)}</td>
                        <td class="${row.profit > 0 ? 'profit-positive' : 'profit-negative'}">${row.profit}</td>
                        <td>${row.dailyAvg}</td>
                        <td class="${row.comparison >= 0 ? 'profit-positive' : 'profit-negative'}">${row.comparison >= 0 ? '+' : ''}${row.comparison}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            });
            
            // Add total row on last page
            if (endIndex === tableData.length && tableData.length > 0) {
                const totalDischarge = tableData.reduce((sum, item) => sum + item.discharge, 0);
                const totalProfit = tableData.reduce((sum, item) => sum + item.profit, 0);
                
                const totalRow = document.createElement('tr');
                totalRow.style.borderTop = '2px solid var(--color-border)';
                totalRow.style.background = 'var(--color-bg)';
                totalRow.innerHTML = `
                    <td colspan="3" style="text-align: center; font-weight: 600; color: var(--color-primary);">ÂêàËÆ°</td>
                    <td style="font-weight: 600;">${totalDischarge.toFixed(1)}</td>
                    <td class="profit-positive" style="font-weight: 600;">${totalProfit}</td>
                    <td>-</td>
                    <td>-</td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Get status text
        function getStatusText(status) {
            if (window.i18n) {
                const key = `profit.status.${status}`;
                return window.i18n.getText(key);
            }
            
            switch(status) {
                case 'active': return 'Ê¥ªË∑É';
                case 'inactive': return 'ÈùûÊ¥ªË∑É';
                case 'notParticipating': return 'Êú™ÂèÇ‰∏é';
                default: return status;
            }
        }

        // Refresh functions
        function refreshCharts() {
            if (currentViewMode === 'chart') {
                setTimeout(() => {
                    initAllCharts();
                }, 100);
            }
        }

        function updateTexts() {
            // Update chart titles and legends when language changes
            if (window.i18n) {
                refreshCharts();
            }
        }

        // Add i18n translations for common time periods if not exist
        if (window.i18n && window.i18n.translations) {
            // Add common time translations if missing
            if (!window.i18n.translations.zh.common) {
                window.i18n.translations.zh.common = {};
            }
            if (!window.i18n.translations.en.common) {
                window.i18n.translations.en.common = {};
            }
            
            // Add time translations
            window.i18n.translations.zh.common.time = {
                day: 'Êó•Êä•',
                month: 'ÊúàÊä•',
                year: 'Âπ¥Êä•',
                cumulative: 'Á¥ØËÆ°',
                select: 'ÈÄâÊã©Êó∂Èó¥'
            };
            
            window.i18n.translations.en.common.time = {
                day: 'Daily',
                month: 'Monthly',
                year: 'Yearly',
                cumulative: 'Cumulative',
                select: 'Select Time'
            };
            
            // Add common translations
            window.i18n.translations.zh.common.testMode = 'ÊµãËØïÁ≠õÈÄâ';
            window.i18n.translations.en.common.testMode = 'Test Filter';
            
            // Add profit chart translations if missing
            if (!window.i18n.translations.zh.profit.charts) {
                window.i18n.translations.zh.profit.charts = {};
            }
            if (!window.i18n.translations.en.profit.charts) {
                window.i18n.translations.en.profit.charts = {};
            }
            
            window.i18n.translations.zh.profit.charts.users = 'Áî®Êà∑';
            window.i18n.translations.zh.profit.charts.revenue = 'Êî∂Áõä';
            window.i18n.translations.en.profit.charts.users = 'Users';
            window.i18n.translations.en.profit.charts.revenue = 'Revenue';
            
            window.i18n.translations.zh.actualDischarge = 'ÂÆûÊó∂ÊîæÁîµÈáè';
            window.i18n.translations.zh.profit = 'Ëé∑Âà©';
            window.i18n.translations.en.actualDischarge = 'Actual Discharge';
            window.i18n.translations.en.profit = 'Profit';
        }
    </script>
</body>
</html>