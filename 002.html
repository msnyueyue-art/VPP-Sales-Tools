<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="profit.title">è·åˆ© - AlwaysControl</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/standard-layout.css">
    <link rel="stylesheet" href="components/pagination.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/user-menu-link.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/user-menu.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/pagination.js"></script>
    <style>
        /* æ—¶é—´é€‰æ‹©å™¨æ¨¡å—æ ·å¼ */
        .time-selector-module {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 4px;
            background: var(--color-bg-card);
            border-radius: 24px;
            border: 1px solid var(--color-border);
        }

        .time-input {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            font-size: 14px;
            min-width: 150px;
            margin-left: 8px;
            transition: all 0.3s ease;
        }

        .time-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: transparent;
            color: var(--color-text-secondary);
        }

        .time-input[type="number"] {
            min-width: 100px;
        }
        
        select.time-input {
            width: 180px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23fff' fill-opacity='0.5' d='M6 8.5L1.5 4h9z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 36px;
        }
        
        select.time-input:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        select.time-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(0, 255, 136, 0.5);
        }
        
        select.time-input option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        .refresh-btn {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            padding: 8px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            margin-left: 8px;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* è§†å›¾åˆ‡æ¢æ ‡ç­¾æ ·å¼ */
        .page-view-tabs {
            display: inline-flex;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 4px;
            gap: 4px;
        }

        .page-tab {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .page-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .page-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
            font-weight: 600;
        }

        .container {
            max-width: 95%;
            padding: 100px 10px 24px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 36px;
        }
        
        .page-title {
            font-size: 48px;
            font-weight: 500;
            color: var(--color-text);
            margin: 0;
            letter-spacing: -2px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 24px;
            margin-bottom: 48px;
        }

        .stat-card {
            padding: 24px;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 12px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--color-text);
            letter-spacing: -0.5px;
        }

        .stat-change {
            font-size: 13px;
            color: var(--color-success);
            font-weight: 400;
        }

        .stat-change.negative {
            color: var(--color-danger);
        }

        /* å›¾è¡¨åŒºåŸŸç½‘æ ¼ */
        .charts-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-bottom: 48px;
        }

        .chart-container {
            padding: 24px;
            min-height: 400px;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            color: var(--color-text);
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .chart-controls .filter-tab {
            padding: 6px 12px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 15px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .chart-controls .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
        }

        .chart-controls .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
        }

        /* è¡¨æ ¼æ ·å¼ */
        .table-section {
            margin-bottom: 40px;
        }

        .table-container {
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .table-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }

        .table-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-filters {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .status-filters .filter-tab {
            padding: 6px 14px;
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 18px;
            color: var(--color-text-secondary);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .status-filters .filter-tab:hover {
            background: var(--color-border);
            border-color: var(--color-primary);
            color: var(--color-text);
            transform: translateY(-1px);
            box-shadow: var(--color-shadow);
        }

        .status-filters .filter-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #000;
            font-weight: 600;
            transform: translateY(-1px);
        }

        .export-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid var(--color-primary);
            border-radius: 6px;
            color: var(--color-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }

        .export-btn:hover {
            background: var(--color-primary);
            color: #000;
            transform: translateY(-1px);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            color: var(--color-text);
        }

        .data-table th {
            background: var(--color-bg);
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-secondary);
            border-bottom: 1px solid var(--color-border);
            white-space: nowrap;
            position: relative;
        }

        .data-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--color-border);
            transition: background-color 0.2s ease;
        }

        .data-table tr:hover {
            background: var(--color-bg);
        }

        .sort-buttons {
            margin-left: 6px;
            display: inline-flex;
            flex-direction: column;
            gap: 2px;
            vertical-align: middle;
            position: relative;
            top: -2px;
        }

        .sort-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            width: 16px;
            height: 14px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.8;
        }

        .sort-btn:hover {
            color: rgba(255, 255, 255, 0.8);
            opacity: 1;
            transform: scale(1.2);
        }

        .sort-btn.active {
            color: var(--color-primary);
            opacity: 1;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
        }

        .status-active {
            color: var(--color-primary) !important;
            font-weight: 500;
        }

        .status-inactive {
            color: #ffd93d !important;
            font-weight: 500;
        }

        .status-not-participating {
            color: #ff6b6b !important;
            font-weight: 500;
        }

        .profit-positive {
            color: var(--color-primary);
        }

        .profit-negative {
            color: #ff6b6b;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .container {
                max-width: 98%;
                padding: 120px 8px 40px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 20px;
            }
            
            .charts-section {
                gap: 24px;
            }
            
            .chart-container {
                padding: 24px;
                min-height: 380px;
            }
        }

        @media (max-width: 768px) {
            .container {
                max-width: 100%;
                padding: 120px 5px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
                gap: 16px;
            }
            
            .charts-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .stat-value {
                font-size: 28px;
            }
            
            .chart-title {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
                padding: 120px 3px 40px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }
    </style>
</head>
<body class="theme-dark">
    <!-- Header Container -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title" id="pageTitle" data-i18n="profit.pageTitle">è·åˆ©</h1>
            <!-- View Mode Tabs -->
            <div class="page-view-tabs">
                <button class="page-tab active" onclick="switchViewMode('chart', this)" id="chartTab">
                    ğŸ“Š <span data-i18n="profit.views.chart">å›¾è¡¨è§†å›¾</span>
                </button>
                <button class="page-tab" onclick="switchViewMode('table', this)" id="tableTab">
                    ğŸ“‹ <span data-i18n="profit.views.table">è¡¨æ ¼è§†å›¾</span>
                </button>
            </div>
        </div>
        
        <!-- Time Selector Module -->
        <div class="time-selector-module" id="profitTimeSelectorModule">
            <select id="regionSelector" class="time-input" onchange="handleRegionChange()" style="min-width: 120px; margin-right: 12px; margin-left: 0; display: inline-block;">
                <option value="all" data-i18n="allRegions">å…¨éƒ¨åœ°åŒº</option>
                <option value="NSW">NSW-æ–°å—å¨å°”å£«å·</option>
                <option value="QLD">QLD-æ˜†å£«å…°å·</option>
                <option value="VIC">VIC-ç»´å¤šåˆ©äºšå·</option>
                <option value="SA">SA-å—æ¾³å¤§åˆ©äºšå·</option>
                <option value="TAS">TAS-å¡”æ–¯é©¬å°¼äºšå·</option>
            </select>
            <button class="time-pill active" onclick="switchTimePeriod('day', this)" data-i18n="dayReport">æ—¥</button>
            <button class="time-pill" onclick="switchTimePeriod('month', this)" data-i18n="monthReport">æœˆ</button>
            <button class="time-pill" onclick="switchTimePeriod('year', this)" data-i18n="yearReport">å¹´</button>
            <button class="time-pill" onclick="switchTimePeriod('total', this)" data-i18n="totalReport">ç´¯è®¡</button>
            <input type="date" id="timeSelector" class="time-input" onchange="handleTimeInputChange()">
            <button class="refresh-btn" onclick="refreshData()" data-i18n="refresh" title="åˆ·æ–°æ•°æ®">ğŸ”„ <span data-i18n="refresh">åˆ·æ–°</span></button>
        </div>

        <!-- Stats Cards Grid -->
        <div class="stats-grid">
            <div class="stat-card card">
                <div class="stat-label" data-i18n="profit.stats.userCount">ç”¨æˆ·æ•°é‡</div>
                <div class="stat-value" id="userCount">1,234</div>
                <div class="stat-change" id="userCountChange"><span class="compare-text" data-i18n="profit.stats.comparedYesterday">æ¯”æ˜¨æ—¥</span> â†‘ 12</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="profit.stats.totalRevenue">ç´¯è®¡è·åˆ©</div>
                <div class="stat-value" id="totalRevenue">$457,000</div>
                <div class="stat-change" id="totalRevenueChange"><span class="compare-text" data-i18n="profit.stats.comparedYesterday">æ¯”æ˜¨æ—¥</span> â†‘ $2,000</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="profit.stats.avgProfit">äººå‡è·åˆ©</div>
                <div class="stat-value" id="avgProfit">$370</div>
                <div class="stat-change" id="avgProfitChange"><span class="compare-text" data-i18n="profit.stats.comparedYesterday">æ¯”æ˜¨æ—¥</span> â†‘ $5</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="profit.stats.maxStationProfit">æœ€å¤§è·åˆ© (å®¶åº­)</div>
                <div class="stat-value" id="maxStationProfit">$5,00</div>
                <div class="stat-change" id="maxProfitChange"><span class="compare-text" data-i18n="profit.stats.comparedYesterday">æ¯”æ˜¨æ—¥</span> â†‘ $200</div>
            </div>
            <div class="stat-card card">
                <div class="stat-label" data-i18n="profit.stats.minStationProfit">æœ€å°è·åˆ© (å®¶åº­)</div>
                <div class="stat-value" id="minStationProfit">$10</div>
                <div class="stat-change" id="minProfitChange"><span class="compare-text" data-i18n="profit.stats.comparedYesterday">æ¯”æ˜¨æ—¥</span> â†‘ $1</div>
            </div>
        </div>

        <!-- Chart View Content -->
        <div id="chartViewContent">
            <!-- Charts Section -->
            <div class="charts-section">
                <!-- User Management Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n="profit.charts.userManagement">ç”¨æˆ·ç®¡ç†</div>
                    </div>
                    <div id="userManagementChart" style="width: 100%; height: 300px;"></div>
                </div>

                <!-- Revenue Distribution Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n="profit.charts.revenueDistribution">æ”¶ç›Šåˆ†å¸ƒ</div>
                    </div>
                    <div id="revenueDistributionChart" style="width: 100%; height: 300px;"></div>
                </div>
            </div>

            <!-- Secondary Charts Section -->
            <div class="charts-section">
                <!-- Power and Revenue Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n="profit.charts.dischargeAndProfit">æ”¾ç”µä¸è·åˆ©</div>
                    </div>
                    <div id="powerRevenueChart" style="width: 100%; height: 350px;"></div>
                </div>

                <!-- Top 5 Profit Chart -->
                <div class="chart-container card">
                    <div class="chart-header">
                        <div class="chart-title" data-i18n="profit.charts.profitRanking">è·åˆ©æ’å</div>
                        <div class="chart-controls">
                            <button class="filter-tab active" onclick="switchProfitView('top5', this)" id="top5Tab" data-i18n="profit.ranking.top5">å‰äº”</button>
                            <button class="filter-tab" onclick="switchProfitView('bottom5', this)" id="bottom5Tab" data-i18n="profit.ranking.bottom5">åäº”</button>
                        </div>
                    </div>
                    <div id="profitRankingChart" style="width: 100%; height: 350px;"></div>
                </div>
            </div>
        </div>

        <!-- Table View Content -->
        <div id="tableViewContent" style="display: none;">
            <!-- User Participation Table -->
            <div class="table-section">
                <div class="table-container card">
                    <div class="table-header">
                        <div class="table-title" data-i18n="profit.table.userParticipation">ç”¨æˆ·å‚ä¸æƒ…å†µ</div>
                        <div class="table-controls">
                            <!-- çŠ¶æ€ç­›é€‰ -->
                            <div class="status-filters">
                                <button class="filter-tab active" onclick="filterByStatus('all', this)" id="statusAll" data-i18n="profit.filters.all">å…¨éƒ¨</button>
                                <button class="filter-tab" onclick="filterByStatus('active', this)" id="statusActive" data-i18n="profit.filters.active">æ´»è·ƒ</button>
                                <button class="filter-tab" onclick="filterByStatus('inactive', this)" id="statusInactive" data-i18n="profit.filters.inactive">éæ´»è·ƒ</button>
                            </div>
                            <!-- å¯¼å‡ºåŠŸèƒ½ -->
                            <button class="export-btn" onclick="exportTableData()">
                                ğŸ“¥ <span data-i18n="profit.buttons.exportData">å¯¼å‡ºæ•°æ®</span>
                            </button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th data-i18n="profit.table.date">æ—¥æœŸ</th>
                                <th data-i18n="profit.table.user">ç”¨æˆ·</th>
                                <th data-i18n="profit.table.status">æ€§è´¨</th>
                                <th>
                                    <span data-i18n="profit.table.dischargeAmount">å®é™…æ”¾ç”µé‡ (kWh)</span>
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('discharge', 'asc', this)" title="å‡åº">â–²</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('discharge', 'desc', this)" title="é™åº">â–¼</button>
                                    </span>
                                </th>
                                <th>
                                    <span data-i18n="profit.table.profitPerKwh">æ¯kWhè·åˆ© ($)</span>
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('profitPerKwh', 'asc', this)" title="å‡åº">â–²</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('profitPerKwh', 'desc', this)" title="é™åº">â–¼</button>
                                    </span>
                                </th>
                                <th>
                                    <span data-i18n="profit.table.profit">è·åˆ© ($)</span>
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('profit', 'asc', this)" title="å‡åº">â–²</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('profit', 'desc', this)" title="é™åº">â–¼</button>
                                    </span>
                                </th>
                                <th data-i18n="profit.table.dailyAvg" id="avgHeader">æ—¥å‡
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('dailyAvg', 'asc', this)" title="å‡åº">â–²</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('dailyAvg', 'desc', this)" title="é™åº">â–¼</button>
                                    </span>
                                </th>
                                <th data-i18n="profit.table.compareDaily" id="compareHeader">å¯¹æ¯”æ—¥å‡ ($)
                                    <span class="sort-buttons">
                                        <button class="sort-btn sort-asc" onclick="sortTable('comparison', 'asc', this)" title="å‡åº">â–²</button>
                                        <button class="sort-btn sort-desc" onclick="sortTable('comparison', 'desc', this)" title="é™åº">â–¼</button>
                                    </span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="userParticipationTableBody">
                            <!-- Table data will be loaded dynamically -->
                        </tbody>
                    </table>
                    
                    <div id="paginationContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let userManagementChart, revenueDistributionChart, powerRevenueChart, profitRankingChart;
        let currentViewMode = 'chart';
        let currentProfitView = 'top5';
        let currentTimePeriod = 'day';
        let currentRegion = 'all';
        
        // è¡¨æ ¼å˜é‡
        let tableData = [];
        let currentPage = 1;
        let pageSize = 10;
        let pagination = null;
        let currentFilter = 'all';
        let currentSortColumn = null;
        let currentSortDirection = null;

        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // åˆå§‹åŒ–Headerå¯¼èˆª
                if (typeof HeaderNav !== 'undefined') {
                    window.headerNav = new HeaderNav({
                        containerId: 'headerContainer',
                        currentPage: 'profit'
                    });
                }

                // åˆå§‹åŒ–æ—¶é—´é€‰æ‹©å™¨
                const today = new Date();
                const timeInput = document.getElementById('timeSelector');
                if (timeInput) {
                    timeInput.type = 'date';
                    timeInput.value = today.toISOString().split('T')[0];
                }

                // åˆå§‹åŒ–å›¾è¡¨
                initAllCharts();
                
                // åˆå§‹åŒ–è¡¨æ ¼æ•°æ®
                generateTableData();

                // ç›‘å¬è¯­è¨€å˜åŒ–
                if (window.i18n) {
                    window.i18n.addObserver(() => {
                        updateTexts();
                        refreshCharts();
                        loadTableData();
                    });
                    
                    // åˆå§‹æ–‡æœ¬æ›´æ–°
                    setTimeout(() => {
                        updateTexts();
                        if (window.i18n && window.i18n.updatePageTexts) {
                            window.i18n.updatePageTexts();
                        }
                    }, 100);
                }

                // çª—å£å¤§å°å˜åŒ–ç›‘å¬
                window.addEventListener('resize', () => {
                    Object.values({userManagementChart, revenueDistributionChart, powerRevenueChart, profitRankingChart}).forEach(chart => {
                        if (chart && !chart.isDisposed()) {
                            chart.resize();
                        }
                    });
                });
            }, 200);
        });

        // åœ°åŒºå˜åŒ–å¤„ç†
        function handleRegionChange() {
            const regionSelector = document.getElementById('regionSelector');
            currentRegion = regionSelector.value;
            refreshData();
        }

        // æ—¶é—´å‘¨æœŸåˆ‡æ¢
        function switchTimePeriod(period, element) {
            currentTimePeriod = period;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.time-pill').forEach(pill => {
                pill.classList.remove('active');
            });
            element.classList.add('active');
            
            // å¤„ç†æ—¶é—´è¾“å…¥æ¡†
            const timeInput = document.getElementById('timeSelector');
            const today = new Date();
            
            if (period === 'total') {
                timeInput.style.display = 'none';
                timeInput.disabled = true;
                timeInput.value = '';
            } else {
                timeInput.style.display = 'block';
                timeInput.disabled = false;
                
                switch(period) {
                    case 'day':
                        timeInput.type = 'date';
                        timeInput.value = today.toISOString().split('T')[0];
                        break;
                    case 'month':
                        timeInput.type = 'month';
                        timeInput.value = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
                        break;
                    case 'year':
                        timeInput.type = 'number';
                        timeInput.min = 2020;
                        timeInput.max = 2030;
                        timeInput.value = today.getFullYear();
                        break;
                }
            }
            
            updateTableHeaders(period);
            generateTableData();
            refreshData();
            updateComparisonText();
        }

        function handleTimeInputChange() {
            refreshData();
        }

        // è§†å›¾æ¨¡å¼åˆ‡æ¢
        function switchViewMode(mode, element) {
            currentViewMode = mode;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.page-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // åˆ‡æ¢å†…å®¹
            if (mode === 'chart') {
                document.getElementById('chartViewContent').style.display = 'block';
                document.getElementById('tableViewContent').style.display = 'none';
                setTimeout(() => refreshCharts(), 100);
            } else {
                document.getElementById('chartViewContent').style.display = 'none';
                document.getElementById('tableViewContent').style.display = 'block';
                
                if (!pagination) {
                    updateTableHeaders(currentTimePeriod);
                    generateTableData();
                    initializePagination();
                } else {
                    updateTableHeaders(currentTimePeriod);
                    refreshTableData();
                }
            }
        }

        // è·åˆ©è§†å›¾åˆ‡æ¢
        function switchProfitView(view, element) {
            currentProfitView = view;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.chart-controls .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // æ›´æ–°å›¾è¡¨
            updateProfitRankingChart();
        }

        // çŠ¶æ€ç­›é€‰
        function filterByStatus(status, element) {
            currentFilter = status;
            
            // æ›´æ–°æ ‡ç­¾çŠ¶æ€
            document.querySelectorAll('.status-filters .filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // é‡ç½®æ’åºçŠ¶æ€
            currentSortColumn = null;
            currentSortDirection = null;
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // é‡æ–°ç”Ÿæˆæ•°æ®å¹¶åŠ è½½
            generateTableData();
            loadTableData();
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            updateStats();
            
            if (currentViewMode === 'chart') {
                refreshCharts();
            } else {
                refreshTableData();
            }
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats() {
            const regionMultipliers = {
                'all': 1,
                'NSW': 0.35,
                'QLD': 0.25,
                'VIC': 0.20,
                'SA': 0.15,
                'TAS': 0.05
            };
            
            const multiplier = regionMultipliers[currentRegion] || 1;
            
            const stats = {
                day: { userCount: '1,234', totalRevenue: '$457,000', avgProfit: '$370', maxProfit: '$5,000', minProfit: '$10' },
                month: { userCount: '12,345', totalRevenue: '$4,570,000', avgProfit: '$370', maxProfit: '$50,000', minProfit: '$100' },
                year: { userCount: '123,456', totalRevenue: '$45,700,000', avgProfit: '$370', maxProfit: '$500,000', minProfit: '$1,000' },
                total: { userCount: '234,567', totalRevenue: '$457,000,000', avgProfit: '$1,950', maxProfit: '$5,000,000', minProfit: '$10,000' }
            };
            
            const currentStats = stats[currentTimePeriod] || stats.day;
            
            const userCount = Math.round(parseInt(currentStats.userCount.replace(/,/g, '')) * multiplier).toLocaleString();
            const totalRevenue = '$' + Math.round(parseInt(currentStats.totalRevenue.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            const avgProfit = currentStats.avgProfit;
            const maxProfit = '$' + Math.round(parseInt(currentStats.maxProfit.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            const minProfit = '$' + Math.round(parseInt(currentStats.minProfit.replace(/[$,]/g, '')) * multiplier).toLocaleString();
            
            document.getElementById('userCount').textContent = userCount;
            document.getElementById('totalRevenue').textContent = totalRevenue;
            document.getElementById('avgProfit').textContent = avgProfit;
            document.getElementById('maxStationProfit').textContent = maxProfit;
            document.getElementById('minStationProfit').textContent = minProfit;
            
            // æ›´æ–°å¯¹æ¯”æ–‡æœ¬
            updateComparisonText();
        }

        // æ›´æ–°å¯¹æ¯”æ–‡æœ¬
        function updateComparisonText() {
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
            
            // å®šä¹‰ä¸åŒæ—¶é—´å‘¨æœŸçš„å¯¹æ¯”æ–‡æœ¬
            const comparisonTexts = {
                zh: {
                    day: 'æ¯”æ˜¨æ—¥',
                    month: 'æ¯”ä¸Šæœˆ',
                    year: 'æ¯”å»å¹´',
                    total: ''  // ç´¯è®¡æ—¶ä¸æ˜¾ç¤ºå¯¹æ¯”
                },
                en: {
                    day: 'vs Yesterday',
                    month: 'vs Last Month',
                    year: 'vs Last Year',
                    total: ''  // ç´¯è®¡æ—¶ä¸æ˜¾ç¤ºå¯¹æ¯”
                }
            };
            
            const compareText = comparisonTexts[currentLang][currentTimePeriod];
            const compareElements = document.querySelectorAll('.compare-text');
            
            // æ›´æ–°æ‰€æœ‰å¯¹æ¯”æ–‡æœ¬
            compareElements.forEach(element => {
                element.textContent = compareText;
            });
            
            // å¦‚æœæ˜¯ç´¯è®¡æ¨¡å¼ï¼Œéšè—æ•´ä¸ªå¯¹æ¯”è¡Œ
            const changeElements = document.querySelectorAll('.stat-change');
            changeElements.forEach(element => {
                if (currentTimePeriod === 'total') {
                    element.style.display = 'none';
                } else {
                    element.style.display = 'block';
                }
            });
        }
        
        // åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
        function initAllCharts() {
            initUserManagementChart();
            initRevenueDistributionChart();
            initPowerRevenueChart();
            initProfitRankingChart();
        }

        function initUserManagementChart() {
            const chartDom = document.getElementById('userManagementChart');
            const chart = echarts.init(chartDom);
            
            const regionMultipliers = {
                'all': 1, 'NSW': 0.35, 'QLD': 0.25, 'VIC': 0.20, 'SA': 0.15, 'TAS': 0.05
            };
            const multiplier = regionMultipliers[currentRegion] || 1;
            
            // è·å–å½“å‰è¯­è¨€
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
            const userTypes = {
                zh: {
                    active: 'æ´»è·ƒç”¨æˆ·',
                    inactive: 'éæ´»è·ƒç”¨æˆ·'
                },
                en: {
                    active: 'Active Users',
                    inactive: 'Inactive Users'
                }
            };
            
            const option = {
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: '{b}: {c} ({d}%)'
                },
                legend: {
                    orient: 'vertical',
                    left: 'left',
                    top: 'center',
                    itemGap: 20,
                    textStyle: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 14
                    },
                    icon: 'circle'
                },
                series: [{
                    name: currentLang === 'en' ? 'User Management' : 'ç”¨æˆ·ç®¡ç†',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '50%'],
                    avoidLabelOverlap: false,
                    label: { show: false, position: 'center' },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: '20',
                            fontWeight: 'bold',
                            color: '#fff'
                        }
                    },
                    labelLine: { show: false },
                    data: [
                        { 
                            value: Math.round(1048 * multiplier), 
                            name: userTypes[currentLang].active,
                            itemStyle: { color: '#00ff88' }
                        },
                        { 
                            value: Math.round(1315 * multiplier),  // Combined inactive + not participating (735 + 580)
                            name: userTypes[currentLang].inactive,
                            itemStyle: { color: '#ffd93d' }
                        }
                    ]
                }]
            };
            
            chart.setOption(option);
            userManagementChart = chart;
        }

        function initRevenueDistributionChart() {
            const chartDom = document.getElementById('revenueDistributionChart');
            const chart = echarts.init(chartDom);
            
            // è·å–å½“å‰è¯­è¨€
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
            
            // ç”Ÿæˆç”¨æˆ·æ”¶ç›Šåˆ†å¸ƒæ•°æ® - é€‚åˆå¤§é‡ç”¨æˆ·çš„åˆ†ç»„æŸ±çŠ¶å›¾
            const revenueRanges = ['<$0', '$0-10', '$10-20', '$20-30', '$30-40', '$40-50', '$50-60', '$60-70', '$70-80', '$80-90', '$90-100', '>$100'];
            
            // æ¨¡æ‹Ÿå¤§é‡ç”¨æˆ·çš„æ”¶ç›Šåˆ†å¸ƒæ•°æ®ï¼ˆæ­£æ€åˆ†å¸ƒåå·¦ï¼Œç¬¦åˆå®é™…æƒ…å†µï¼‰
            const userCounts = [
                320,   // <$0 (äºæŸç”¨æˆ·)
                2850,  // $0-10
                3420,  // $10-20
                2680,  // $20-30
                1950,  // $30-40
                1420,  // $40-50
                980,   // $50-60
                650,   // $60-70
                420,   // $70-80
                280,   // $80-90
                180,   // $90-100
                150    // >$100
            ];
            
            // è®¡ç®—æ€»æ•°
            const total = userCounts.reduce((a, b) => a + b, 0);
            
            // å¤šè¯­è¨€æ–‡æœ¬
            const labels = {
                zh: {
                    userCount: 'ç”¨æˆ·æ•°',
                    users: 'äºº',
                    percentage: 'å æ¯”'
                },
                en: {
                    userCount: 'User Count',
                    users: 'users',
                    percentage: 'Percentage'
                }
            };
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        const bar = params[0];
                        const percentage = ((bar.value / total) * 100).toFixed(1);
                        return `${bar.name}<br/>` +
                               `${labels[currentLang].userCount}: ${bar.value.toLocaleString()} ${labels[currentLang].users}<br/>` +
                               `${labels[currentLang].percentage}: ${percentage}%`;
                    },
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                grid: {
                    left: '10%',
                    right: '10%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: revenueRanges,
                    axisLine: {
                        lineStyle: { color: 'rgba(255,255,255,0.2)' }
                    },
                    axisLabel: {
                        color: 'rgba(255,255,255,0.7)',
                        fontSize: 11,
                        rotate: 45,
                        interval: 0
                    },
                    axisTick: {
                        alignWithLabel: true
                    }
                },
                yAxis: {
                    type: 'value',
                    name: labels[currentLang].userCount,
                    nameTextStyle: {
                        color: 'rgba(255,255,255,0.7)',
                        fontSize: 12
                    },
                    axisLine: {
                        show: true,
                        lineStyle: { color: 'rgba(255,255,255,0.2)' }
                    },
                    axisLabel: {
                        color: 'rgba(255,255,255,0.7)',
                        fontSize: 11,
                        formatter: '{value}'
                    },
                    splitLine: {
                        lineStyle: {
                            color: 'rgba(255,255,255,0.1)'
                        }
                    }
                },
                series: [{
                    name: labels[currentLang].userCount,
                    type: 'bar',
                    data: userCounts,
                    itemStyle: {
                        color: function(params) {
                            // æ ¹æ®æ”¶ç›ŠåŒºé—´è®¾ç½®ä¸åŒé¢œè‰²
                            if (params.dataIndex === 0) return '#ff6b6b'; // äºæŸ - çº¢è‰²
                            if (params.dataIndex <= 2) return '#ffd93d'; // ä½æ”¶ç›Š - é»„è‰²
                            if (params.dataIndex <= 5) return '#6bcf7f'; // ä¸­æ”¶ç›Š - ç»¿è‰²
                            if (params.dataIndex <= 8) return '#00ff88'; // é«˜æ”¶ç›Š - äº®ç»¿è‰²
                            return '#00ccff'; // è¶…é«˜æ”¶ç›Š - è“è‰²
                        },
                        borderRadius: [4, 4, 0, 0]
                    },
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(0, 255, 136, 0.5)'
                        }
                    },
                    label: {
                        show: true,
                        position: 'top',
                        color: 'rgba(255,255,255,0.7)',
                        fontSize: 10,
                        formatter: function(params) {
                            if (params.value > 1000) {
                                return (params.value / 1000).toFixed(1) + 'k';
                            }
                            return params.value;
                        }
                    }
                }]
            };
            
            chart.setOption(option);
            revenueDistributionChart = chart;
        }

        function initPowerRevenueChart() {
            const chartDom = document.getElementById('powerRevenueChart');
            const chart = echarts.init(chartDom);
            
            // è·å–å½“å‰è¯­è¨€
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
            const seriesNames = {
                zh: {
                    discharge: 'å®æ—¶æ”¾ç”µé‡',
                    profit: 'è·åˆ©'
                },
                en: {
                    discharge: 'Actual Discharge',
                    profit: 'Profit'
                }
            };
            
            // Yè½´åç§°é…ç½®
            const yAxisNames = {
                zh: {
                    left: 'ç”µé‡',
                    right: 'è·åˆ©'
                },
                en: {
                    left: 'Power',
                    right: 'Profit'
                }
            };
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: { color: 'var(--color-text-secondary)' }
                    }
                },
                legend: {
                    data: [seriesNames[currentLang].discharge, seriesNames[currentLang].profit],
                    textStyle: { color: 'var(--color-text-secondary)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0', '6', '12', '18', '24'],
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'var(--color-text-secondary)' }
                },
                yAxis: [{
                    type: 'value',
                    name: yAxisNames[currentLang].left,
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: '#ffffff' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { 
                        lineStyle: { color: 'rgba(255, 255, 255, 0.08)', type: 'dashed' } 
                    }
                }, {
                    type: 'value',
                    name: yAxisNames[currentLang].right,
                    min: 0,
                    max: 250,
                    interval: 50,
                    nameTextStyle: { color: '#ffffff' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '{value}'
                    }
                }],
                series: [{
                    name: seriesNames[currentLang].discharge,
                    type: 'bar',
                    data: [100, 120, 240, 80, 110],
                    itemStyle: { color: '#00ff88', opacity: 0.8 },
                    barWidth: '40%'
                }, {
                    name: seriesNames[currentLang].profit,
                    type: 'line',
                    yAxisIndex: 1,
                    data: [150, 180, 240, 120, 165],
                    lineStyle: { width: 3, color: '#ffd700' },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 8,
                    smooth: true
                }]
            };
            
            chart.setOption(option);
            powerRevenueChart = chart;
        }

        function initProfitRankingChart() {
            updateProfitRankingChart();
        }

        function updateProfitRankingChart() {
            const chartDom = document.getElementById('profitRankingChart');
            if (!profitRankingChart) {
                profitRankingChart = echarts.init(chartDom);
            }
            
            const isTop5 = currentProfitView === 'top5';
            const userNames = ['John Zhang', 'Henry Li', 'William Wang', 'Sam Zhang', 'Tom Li', 'Tony Zhou', 'Amy Wu', 'Eric Zheng', 'Linda Lin', 'åˆ˜å¼º'];
            
            const data = isTop5 
                ? [
                    { value: 4850, name: userNames[0] },
                    { value: 4320, name: userNames[1] },
                    { value: 3980, name: userNames[2] },
                    { value: 3650, name: userNames[3] },
                    { value: 3420, name: userNames[4] }
                ]
                : [
                    { value: 150, name: userNames[9] },
                    { value: 180, name: userNames[8] },
                    { value: 220, name: userNames[7] },
                    { value: 250, name: userNames[6] },
                    { value: 280, name: userNames[5] }
                ];
            
            // åè½¬æ•°æ®é¡ºåºï¼Œä½¿æœ€é«˜å€¼/æœ€ä½å€¼åœ¨é¡¶éƒ¨
            data.reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        return `${params[0].name}: $${params[0].value}`;
                    }
                },
                grid: {
                    left: '5%',
                    right: '15%',
                    bottom: '5%',
                    top: '5%',
                    containLabel: true
                },
                xAxis: {
                    type: 'value',
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: function(value) { return '$' + value; }
                    },
                    splitLine: { 
                        lineStyle: { color: 'rgba(255, 255, 255, 0.08)', type: 'dashed' } 
                    }
                },
                yAxis: {
                    type: 'category',
                    data: data.map(item => item.name),
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.08)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        fontSize: 12
                    },
                    axisTick: {
                        show: false
                    }
                },
                series: [{
                    name: 'è·åˆ© ($)',
                    type: 'bar',
                    data: data.map(item => item.value),
                    label: {
                        show: true,
                        position: 'right',
                        color: 'rgba(255, 255, 255, 0.8)',
                        formatter: function(params) { return '$' + params.value; },
                        fontSize: 11
                    },
                    itemStyle: {
                        color: function(params) {
                            if (isTop5) {
                                // å‰äº”åä½¿ç”¨æ¸å˜ç»¿è‰²
                                return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.3)' },
                                    { offset: 1, color: '#00ff88' }
                                ]);
                            } else {
                                // åäº”åä½¿ç”¨æ¸å˜çº¢è‰²
                                return new echarts.graphic.LinearGradient(0, 0, 1, 0, [
                                    { offset: 0, color: 'rgba(255, 107, 107, 0.3)' },
                                    { offset: 1, color: '#ff6b6b' }
                                ]);
                            }
                        },
                        borderRadius: [0, 4, 4, 0]
                    },
                    barWidth: '60%',
                    emphasis: {
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: isTop5 ? 'rgba(0, 255, 136, 0.5)' : 'rgba(255, 107, 107, 0.5)'
                        }
                    }
                }]
            };

            profitRankingChart.setOption(option);
        }

        // åˆ·æ–°å›¾è¡¨
        function refreshCharts() {
            if (currentViewMode === 'chart') {
                setTimeout(() => {
                    initAllCharts();
                }, 100);
            }
        }

        // è¡¨æ ¼æ’åº
        function sortTable(column, direction, element) {
            const isCurrentSort = currentSortColumn === column && currentSortDirection === direction;
            
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (isCurrentSort) {
                currentSortColumn = null;
                currentSortDirection = null;
                generateTableData();
            } else {
                currentSortColumn = column;
                currentSortDirection = direction;
                element.classList.add('active');
                
                tableData.sort((a, b) => {
                    let aVal, bVal;
                    switch(column) {
                        case 'discharge': aVal = a.discharge; bVal = b.discharge; break;
                        case 'sellPrice': aVal = a.sellPrice; bVal = b.sellPrice; break;
                        case 'costPrice': aVal = a.costPrice; bVal = b.costPrice; break;
                        case 'profit': aVal = a.profit; bVal = b.profit; break;
                        case 'profitPerKwh': 
                            aVal = a.discharge > 0 ? a.profit / a.discharge : 0;
                            bVal = b.discharge > 0 ? b.profit / b.discharge : 0;
                            break;
                        case 'dailyAvg': aVal = a.dailyAvg; bVal = b.dailyAvg; break;
                        case 'comparison': aVal = a.comparison; bVal = b.comparison; break;
                        default: return 0;
                    }
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                });
            }
            
            loadTableData();
        }

        // å¯¼å‡ºè¡¨æ ¼æ•°æ®
        function exportTableData() {
            console.log('å¯¼å‡ºè¡¨æ ¼æ•°æ®...');
        }

        // åˆå§‹åŒ–åˆ†é¡µ
        function initializePagination() {
            pagination = new Pagination({
                containerId: 'paginationContainer',
                currentPage: currentPage,
                pageSize: pageSize,
                totalItems: tableData.length,
                onPageChange: (page, size) => {
                    currentPage = page;
                    loadTableData();
                },
                onPageSizeChange: (size) => {
                    pageSize = size;
                    currentPage = 1;
                    loadTableData();
                }
            });
            
            loadTableData();
        }

        // ç”Ÿæˆè¡¨æ ¼æ•°æ®
        function generateTableData() {
            const users = ['Harvey Lee', 'Lucas Wang', 'David Zhang', 'Fiona Liu', 
                          'Michael Chen', 'Lisa Zhao', 'John Sun', 'å‘¨æ•', 'å´å¼º', 'éƒ‘å'];
            const statuses = ['active', 'inactive'];
            const data = [];
            
            const timeSelector = document.getElementById('timeSelector');
            const selectedTime = timeSelector ? timeSelector.value : '';
            
            switch (currentTimePeriod) {
                case 'day': {
                    const date = selectedTime ? new Date(selectedTime) : new Date();
                    const dateStr = formatDate(date);
                    const userCount = 5 + Math.floor(Math.random() * 4);
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i % users.length], dateStr, statuses, 'day'));
                    }
                    break;
                }
                case 'month': {
                    let year, month;
                    if (selectedTime && selectedTime.includes('-')) {
                        [year, month] = selectedTime.split('-');
                    } else {
                        year = new Date().getFullYear();
                        month = String(new Date().getMonth() + 1).padStart(2, '0');
                    }
                    const dateStr = `${year}å¹´${parseInt(month)}æœˆ`;
                    const userCount = 8 + Math.floor(Math.random() * 3);
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i % users.length], dateStr, statuses, 'month'));
                    }
                    break;
                }
                case 'year': {
                    const year = timeSelector && timeSelector.type === 'number' ? timeSelector.value : new Date().getFullYear();
                    const dateStr = `${year}å¹´`;
                    const userCount = 10;
                    for (let i = 0; i < userCount; i++) {
                        data.push(createUserData(users[i], dateStr, statuses, 'year'));
                    }
                    break;
                }
                case 'total': {
                    users.forEach(user => {
                        data.push(createUserData(user, 'ç´¯è®¡', statuses, 'total'));
                    });
                    break;
                }
            }
            
            tableData = data;
            
            // åº”ç”¨ç­›é€‰
            if (currentFilter !== 'all') {
                tableData = tableData.filter(item => item.status === currentFilter);
            }
        }

        // åˆ›å»ºç”¨æˆ·æ•°æ®
        function createUserData(user, date, statuses, period) {
            const status = statuses[Math.floor(Math.random() * statuses.length)];
            let discharge = 0;
            let dailyAvg = 50;
            
            if (status === 'active' || status === 'inactive') {
                switch (period) {
                    case 'day':
                        discharge = 20 + Math.floor(Math.random() * 40);
                        dailyAvg = 50;
                        break;
                    case 'month':
                        discharge = 600 + Math.floor(Math.random() * 600);
                        dailyAvg = 1500;
                        break;
                    case 'year':
                        discharge = 7000 + Math.floor(Math.random() * 5000);
                        dailyAvg = 18000;
                        break;
                    case 'total':
                        discharge = 10000 + Math.floor(Math.random() * 5000);
                        dailyAvg = 500;
                        break;
                }
            }
            
            const sellPrice = status === 'active' || status === 'inactive' ? (0.3 + Math.random() * 0.2).toFixed(3) : 0;
            const costPrice = status === 'active' || status === 'inactive' ? (0.1 + Math.random() * 0.05).toFixed(3) : 0;
            const profit = status === 'active' || status === 'inactive' ? Math.floor(discharge * (sellPrice - costPrice)) : 0;
            
            return {
                date: date,
                user: user,
                status: status,
                discharge: discharge,
                sellPrice: parseFloat(sellPrice),
                costPrice: parseFloat(costPrice),
                profit: profit,
                dailyAvg: dailyAvg,
                comparison: profit - dailyAvg
            };
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }

        // åŠ è½½è¡¨æ ¼æ•°æ®
        function loadTableData() {
            const tbody = document.getElementById('userParticipationTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (!tableData || tableData.length === 0) {
                generateTableData();
                if (!tableData || tableData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
            }
            
            // è·å–å½“å‰é¡µæ•°æ®
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, tableData.length);
            const pageData = tableData.slice(startIndex, endIndex);
            
            // æŒ‰æ—¥æœŸåˆ†ç»„
            const groupedData = {};
            pageData.forEach(item => {
                if (!groupedData[item.date]) {
                    groupedData[item.date] = [];
                }
                groupedData[item.date].push(item);
            });
            
            // æ¸²æŸ“è¡Œ
            Object.entries(groupedData).forEach(([date, rows]) => {
                rows.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    
                    // ä¸ºæ¯ä¸ªæ—¥æœŸçš„ç¬¬ä¸€è¡Œæ·»åŠ æ—¥æœŸå•å…ƒæ ¼
                    if (index === 0) {
                        const dateCell = document.createElement('td');
                        dateCell.rowSpan = rows.length;
                        dateCell.style.verticalAlign = 'middle';
                        dateCell.style.fontWeight = '500';
                        dateCell.textContent = date;
                        tr.appendChild(dateCell);
                    }
                    
                    // æ·»åŠ æ•°æ®å•å…ƒæ ¼
                    const profitPerKwh = row.discharge > 0 ? (row.profit / row.discharge).toFixed(2) : '0.00';
                    tr.innerHTML += `
                        <td>${row.user}</td>
                        <td class="status-${row.status === 'notParticipating' ? 'not-participating' : row.status}">${getStatusText(row.status)}</td>
                        <td>${row.discharge.toFixed(1)}</td>
                        <td class="${profitPerKwh > 0 ? 'profit-positive' : ''}">${profitPerKwh}</td>
                        <td class="${row.profit > 0 ? 'profit-positive' : 'profit-negative'}">${row.profit}</td>
                        <td>${row.dailyAvg}</td>
                        <td class="${row.comparison >= 0 ? 'profit-positive' : 'profit-negative'}">${row.comparison >= 0 ? '+' : ''}${row.comparison}</td>
                    `;
                    
                    tbody.appendChild(tr);
                });
            });
            
            // æ·»åŠ æ€»è®¡è¡Œï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ•°æ®çš„åˆè®¡ï¼‰
            if (tableData.length > 0) {
                const totalDischarge = tableData.reduce((sum, item) => sum + item.discharge, 0);
                const totalProfit = tableData.reduce((sum, item) => sum + item.profit, 0);
                
                // è·å–å½“å‰è¯­è¨€
                const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
                const totalText = currentLang === 'en' ? 'Total' : 'åˆè®¡';
                
                const avgProfitPerKwh = totalDischarge > 0 ? (totalProfit / totalDischarge).toFixed(2) : '0.00';
                const totalRow = document.createElement('tr');
                totalRow.style.borderTop = '2px solid var(--color-border)';
                totalRow.style.background = 'var(--color-bg)';
                totalRow.innerHTML = `
                    <td colspan="3" style="text-align: center; font-weight: 600; color: var(--color-primary);">${totalText}</td>
                    <td style="font-weight: 600;">${totalDischarge.toFixed(1)}</td>
                    <td class="profit-positive" style="font-weight: 600;">${avgProfitPerKwh}</td>
                    <td class="profit-positive" style="font-weight: 600;">${totalProfit}</td>
                    <td colspan="2"></td>
                `;
                tbody.appendChild(totalRow);
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
            const statusTexts = {
                zh: {
                    active: 'æ´»è·ƒ',
                    inactive: 'éæ´»è·ƒ'
                },
                en: {
                    active: 'Active',
                    inactive: 'Inactive'
                }
            };
            return statusTexts[currentLang][status] || status;
        }

        // åˆ·æ–°è¡¨æ ¼æ•°æ®
        function refreshTableData() {
            generateTableData();
            currentPage = 1;
            
            if (pagination) {
                pagination = new Pagination({
                    containerId: 'paginationContainer',
                    currentPage: 1,
                    pageSize: pageSize,
                    totalItems: tableData.length,
                    onPageChange: (page, size) => {
                        currentPage = page;
                        loadTableData();
                    },
                    onPageSizeChange: (size) => {
                        pageSize = size;
                        currentPage = 1;
                        loadTableData();
                    }
                });
            }
            
            loadTableData();
        }

        // æ›´æ–°è¡¨æ ¼æ ‡é¢˜æ ¹æ®æ—¶é—´å‘¨æœŸ
        function updateTableHeaders(period) {
            const avgHeader = document.getElementById('avgHeader');
            const compareHeader = document.getElementById('compareHeader');
            
            if (avgHeader && compareHeader) {
                // è·å–å½“å‰è¯­è¨€
                const currentLang = window.i18n ? window.i18n.currentLanguage : 'zh';
                
                const periodTexts = {
                    zh: {
                        day: { avg: 'æ—¥å‡', compare: 'å¯¹æ¯”æ—¥å‡ ($)' },
                        month: { avg: 'æœˆå‡', compare: 'å¯¹æ¯”æœˆå‡ ($)' },
                        year: { avg: 'å¹´å‡', compare: 'å¯¹æ¯”å¹´å‡ ($)' },
                        total: { avg: 'å†å²å‡å€¼', compare: 'å¯¹æ¯”å†å²å‡å€¼ ($)' }
                    },
                    en: {
                        day: { avg: 'Daily Avg', compare: 'Compare Daily ($)' },
                        month: { avg: 'Monthly Avg', compare: 'Compare Monthly ($)' },
                        year: { avg: 'Yearly Avg', compare: 'Compare Yearly ($)' },
                        total: { avg: 'Historical Avg', compare: 'Compare Historical ($)' }
                    }
                };
                
                const texts = periodTexts[currentLang][period] || periodTexts.zh.day;
                
                avgHeader.innerHTML = texts.avg +
                    '<span class="sort-buttons">' +
                    '<button class="sort-btn sort-asc" onclick="sortTable(\'dailyAvg\', \'asc\', this)" title="å‡åº">â–²</button>' +
                    '<button class="sort-btn sort-desc" onclick="sortTable(\'dailyAvg\', \'desc\', this)" title="é™åº">â–¼</button>' +
                    '</span>';
                compareHeader.innerHTML = texts.compare + 
                    '<span class="sort-buttons">' +
                    '<button class="sort-btn sort-asc" onclick="sortTable(\'comparison\', \'asc\', this)" title="å‡åº">â–²</button>' +
                    '<button class="sort-btn sort-desc" onclick="sortTable(\'comparison\', \'desc\', this)" title="é™åº">â–¼</button>' +
                    '</span>';
            }
        }

        // æ›´æ–°æ–‡æœ¬ï¼ˆç”¨äºå›½é™…åŒ–ï¼‰
        function updateTexts() {
            if (window.i18n) {
                refreshCharts();
                
                // æ›´æ–°åœ°åŒºé€‰æ‹©å™¨é€‰é¡¹
                const regionSelector = document.getElementById('regionSelector');
                if (regionSelector) {
                    const allRegionOption = regionSelector.querySelector('option[value="all"]');
                    if (allRegionOption) {
                        allRegionOption.textContent = window.i18n.getText('allRegions') || 'å…¨éƒ¨åœ°åŒº';
                    }
                }
                
                // å¼ºåˆ¶æ›´æ–°æ—¶é—´æŒ‰é’®æ–‡æœ¬
                const timePills = document.querySelectorAll('.time-pill');
                timePills.forEach(pill => {
                    const dataI18n = pill.getAttribute('data-i18n');
                    if (dataI18n && window.i18n) {
                        pill.textContent = window.i18n.getText(dataI18n) || pill.textContent;
                    }
                });
            }
        }
    </script>
</body>
</html>