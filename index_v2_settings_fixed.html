<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源管理中心</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/drawer-component.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/drawer-component.js"></script>
    <script src="fix-charts-dom-ready.js" defer></script>
    <style>
        /* 强制抽屉组件在最顶层 */
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        /* 确保抽屉组件使用正确的字体和大小 */
        #deviceResponseDrawerComponent .drawer-container {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .detail-label {
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .detail-value {
            font-size: 14px !important;
        }
        
        #deviceResponseDrawerComponent .stat-value {
            font-size: 24px !important;
        }
        
        #deviceResponseDrawerComponent .stat-label {
            font-size: 12px !important;
        }
        
        /* 确保抽屉容器在所有元素之上 */
        #homeOperationDrawer {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        #homeOperationDrawer * {
            z-index: inherit !important;
        }
        
        /* 确保所有抽屉相关元素都在最顶层 */
        [id*="Drawer"], [class*="drawer"] {
            z-index: 2147483647 !important;
            position: relative !important;
        }
        
        /* Override for homepage specific styles */
        html {
            height: auto;
            overflow-x: hidden;
        }
        
        body {
            background: #000 !important;
            overflow-x: hidden;
            position: relative;
            margin: 0;
            padding: 0;
            height: auto;
            min-height: 100vh;
        }
        
        /* Fixed region selector */
        .region-selector-fixed {
            position: fixed;
            top: 100px; /* Increased spacing from header */
            left: 0;
            right: 0;
            z-index: 999;
            background: transparent;
            padding: 0 20px;
        }
        
        /* Scrollable main content */
        .main-content-scrollable {
            margin-top: 200px; /* 60px spacing from region selector */
            padding: 0 20px;
            padding-bottom: 100px; /* 确保底部有足够空间 */
        }
        
        .container {
            background: transparent;
            padding-top: 0 !important;
            padding-bottom: 100px !important;
            max-width: 1440px;
            margin: 0 auto;
            min-height: auto;
            height: auto;
            overflow: visible !important;
        }
        .btn {
            background: var(--color-primary);
            color: #fff;
            border-radius: 22px;
            border: none;
            padding: 0 24px;
            height: 44px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            background: var(--color-accent);
        }
        .input {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 0 12px;
            height: 40px;
            color: var(--color-text);
            font-size: 16px;
        }
        /* 主题切换按钮 */
        .theme-toggle-btn {
            position: absolute;
            right: 32px;
            top: 24px;
            z-index: 100;
            background: var(--color-bg-card);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--color-shadow);
            transition: background 0.3s, color 0.3s;
        }
        .theme-toggle-btn:hover {
            background: var(--color-primary);
            color: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass morphism effects */
        .glass {
            background: var(--color-bg-card, rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: var(--radius, 20px);
            color: var(--color-text);
        }

        /* Pulse animation for status indicators */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }



        .language-selector {
            position: relative;
            cursor: pointer;
        }

        .language-current {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            transition: all 0.3s;
        }

        .language-current:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            min-width: 120px;
        }

        .language-option {
            padding: 8px 16px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00aaff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* Period Dropdown Styles */
        .period-dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px !important;
            transition: all 0.3s ease;
        }

        .period-dropdown:hover {
            background-color: rgba(255,255,255,0.12) !important;
            border-color: rgba(255,255,255,0.25) !important;
        }

        .period-dropdown:focus {
            background-color: rgba(255,255,255,0.15) !important;
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 2px rgba(0,185,107,0.2);
        }

        .period-dropdown option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        /* Main Container */
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 120px 10px 100px; /* 添加底部padding确保内容可见 */
            height: auto;
            display: flex;
            flex-direction: column;
            overflow: visible;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
        }

        /* Top Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: 490px 930px;
            gap: 20px;
            margin-bottom: 20px;
            padding-right: 0;
            height: auto;
            min-height: 600px;
            position: relative;
            overflow: visible;
            align-items: stretch;
            max-width: 1440px;
        }

        /* Market Section */
        .market-section {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .market-section .price-cards {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .market-section .price-card {
            flex: 1;
            min-width: 0;
        }

        /* Power Station Management Styles */
        .power-station-container {
            display: flex;
            flex-direction: column;
            padding: 12px;
            height: auto;
            min-height: 600px;
            overflow: visible;
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
        }

        .station-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .highest-price-region {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Price Circle Layout */
        .price-circle-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }

        .price-side-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .side-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            white-space: nowrap;
        }

        .side-price {
            font-size: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Main Price Circle */
        .main-price-circle {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .circle-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00aa66);
            opacity: 0.9;
            transition: all 0.3s ease;
        }
        
        /* 充电状态脉冲动画 */
        @keyframes chargePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(0, 255, 136, 0);
            }
        }
        
        /* 放电状态脉冲动画 */
        @keyframes dischargePulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(255, 215, 0, 0);
            }
        }
        
        /* 待机状态呼吸动画 */
        @keyframes breathe {
            0%, 100% {
                opacity: 0.9;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.02);
            }
        }
        
        .circle-background.charging {
            animation: chargePulse 2s ease-in-out infinite;
        }
        
        .circle-background.discharging {
            animation: dischargePulse 2s ease-in-out infinite;
        }
        
        .circle-background.idle {
            animation: breathe 3s ease-in-out infinite;
        }

        /* Water Wave Effect */
        .water-wave-container {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(180deg, #666666 0%, #555555 50%, #444444 100%);
        }

        .water-wave {
            position: absolute;
            bottom: 0;
            left: -50%;
            width: 200%;
            height: 30%;
            background: linear-gradient(180deg, rgba(75, 123, 255, 0.9) 0%, rgba(75, 123, 255, 0.7) 100%);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            animation: horizontalWaveAnimation 2s ease-in-out infinite;
            transform-origin: center bottom;
        }


        @keyframes horizontalWaveAnimation {
            0%, 100% {
                transform: translateX(0) translateY(0);
                border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            }
            25% {
                transform: translateX(-5px) translateY(-1px);
                border-radius: 45% 55% 0 0 / 95% 105% 0 0;
            }
            50% {
                transform: translateX(0) translateY(1px);
                border-radius: 55% 45% 0 0 / 105% 95% 0 0;
            }
            75% {
                transform: translateX(5px) translateY(-1px);
                border-radius: 50% 50% 0 0 / 100% 100% 0 0;
            }
        }
        /* Wave flow animation */
        @keyframes waveFlow {
            0%, 100% {
                clip-path: polygon(0% 100%, 0% 20%, 15% 15%, 30% 25%, 45% 18%, 60% 22%, 75% 12%, 90% 20%, 100% 15%, 100% 100%);
            }
            33% {
                clip-path: polygon(0% 100%, 0% 15%, 15% 22%, 30% 18%, 45% 25%, 60% 15%, 75% 20%, 90% 12%, 100% 20%, 100% 100%);
            }
            66% {
                clip-path: polygon(0% 100%, 0% 25%, 15% 18%, 30% 12%, 45% 20%, 60% 25%, 75% 18%, 90% 22%, 100% 12%, 100% 100%);
            }
        }
        
        @keyframes chargeCirclePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 255, 136, 0.4); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 8px rgba(0, 255, 136, 0.1); }
        }
        
        @keyframes dischargeCirclePulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.4); }
            50% { transform: scale(1.03); box-shadow: 0 0 0 10px rgba(255, 193, 7, 0.1); }
        }
        
        @keyframes softWaveFlow {
            0%, 100% {
                clip-path: polygon(0% 100%, 0% 22%, 12% 18%, 25% 24%, 38% 20%, 52% 26%, 65% 18%, 78% 22%, 88% 19%, 100% 23%, 100% 100%);
            }
            33% {
                clip-path: polygon(0% 100%, 0% 18%, 15% 24%, 28% 16%, 42% 22%, 55% 18%, 68% 25%, 82% 19%, 95% 21%, 100% 17%, 100% 100%);
            }
            66% {
                clip-path: polygon(0% 100%, 0% 26%, 18% 21%, 32% 19%, 45% 25%, 58% 22%, 71% 16%, 85% 24%, 92% 18%, 100% 20%, 100% 100%);
            }
        }

        .circle-content {
            position: relative;
            z-index: 3;
            text-align: center;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .price-range {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            margin: 4px 0;
            line-height: 1.2;
        }

        .price-percentage {
            font-size: 14px;
            color: #00ff88;
            font-weight: 600;
            margin-top: 2px;
        }

        /* Stop Circle Overlay */
        .stop-circle-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff4757, #c44569);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
        }

        .main-price-circle.manual-operation:hover .stop-circle-overlay {
            opacity: 1;
        }

        .stop-circle-overlay:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(255, 71, 87, 0.4);
        }

        .stop-text {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            pointer-events: none;
        }

        /* Circle Action Buttons */
        .circle-action-btn {
            width: 100%;
            height: 80px;
            border-radius: 16px;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .circle-action-btn.charge-btn {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .circle-action-btn.charge-btn:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .circle-action-btn.discharge-btn {
            background: linear-gradient(135deg, #ff9500, #e67e22);
            color: #fff;
        }

        .circle-action-btn.discharge-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 0, 0.3);
        }

        /* Disabled state for circle action buttons */
        .circle-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }



        .current-price {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .price-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .charge-btn {
            background: linear-gradient(135deg, #00D67A, #00FF88) !important;
            border: 2px solid rgba(0, 255, 136, 0.3) !important;
            color: #000 !important;
        }

        .charge-btn:hover {
            transform: translateY(-2px);
            background: #00E070 !important;
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4) !important;
            border-color: rgba(0, 255, 136, 0.6) !important;
        }

        .discharge-btn {
            background: linear-gradient(135deg, #FFC107, #FFD700) !important;
            border: 2px solid rgba(255, 193, 7, 0.3) !important;
            color: #000 !important;
        }

        .discharge-btn:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #FFB300, #FFC107) !important;
            box-shadow: 0 8px 20px rgba(255, 193, 7, 0.4) !important;
            border-color: rgba(255, 193, 7, 0.6) !important;
        }
        
        /* 停止按钮样式 */
        .stop-btn {
            background: linear-gradient(135deg, #ff4444, #ff6b6b) !important;
            border: 2px solid rgba(255, 68, 68, 0.3) !important;
            flex: 1 !important;
            margin: 0 !important;
            color: #fff !important;
            padding: 12px 24px !important;
            border-radius: 32px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .stop-btn:hover {
            box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4) !important;
            border-color: rgba(255, 68, 68, 0.6) !important;
        }
        
        /* 操作中的按钮容器样式 */
        .action-buttons.operating {
            justify-content: center !important;
        }
        
        .action-buttons.operating .action-btn:not(.stop-btn) {
            display: none !important;
        }
        
        .action-buttons.operating .stop-btn {
            flex: 1 !important;
            max-width: 200px !important;
        }

        /* Stats Compact Grid */
        .stats-compact-grid {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 4px 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: #1a1a1a;
            border-radius: 8px;
            height: calc(100% / 4 - 3px);
        }

        .stat-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
            opacity: 0.9;
        }

        .stat-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Stats Grid */
        .bottom-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .bottom-stat-card {
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bottom-stat-title {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 3px;
        }

        .bottom-stat-value {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .bottom-stat-change {
            font-size: 8px;
            font-weight: 500;
        }

        .bottom-stat-change.positive {
            color: #00ff88;
        }

        .bottom-stat-change.negative {
            color: #8A4AFF;
        }

        /* Legacy: Electricity Cost Circle for backward compatibility */
        .cost-circle-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .cost-circle {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .circle-bg {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #00ff88 0deg, #00ff88 144deg, rgba(255, 255, 255, 0.1) 144deg);
            padding: 3px;
            mask: radial-gradient(farthest-side, transparent calc(100% - 20px), #000 calc(100% - 20px));
        }

        .circle-inner {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .cost-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .cost-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Price Range Display */
        .price-range {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            gap: 20px;
        }

        .price-stat {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .price-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .price-high {
            color: #8A4AFF;
        }

        .price-low {
            color: #00ff88;
        }

        .cost-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #00ff88;
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #8A4AFF;
            color: #fff;
            border: 1px solid #8A4AFF;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        /* Panel Tabs */
        .panel-tabs {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .panel-tab {
            padding: 8px 20px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .panel-tab:hover {
            color: #fff;
        }

        .panel-tab.active {
            color: #00ff88;
        }

        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }

        .auto-switch-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00ff88;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Panel Content */
        .panel-content { display: none; }
        .panel-content.active { display: flex; flex-direction: column; flex: 1; height: 100%; overflow: hidden; }

        /* Region Tabs */
        .region-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .region-tab {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .region-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .region-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        /* Price Cards */
        .price-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            height: 80px; /* 固定高度 */
        }

        .price-card {
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 0;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--color-bg-card, rgba(255,255,255,0.03));
            border-radius: var(--radius, 8px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
        }

        .price-card-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .price-card-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Demand Generation Card */
        .demand-gen-card {
            padding: 12px !important;
            gap: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        .demand-gen-row {
            display: flex;
            align-items: center;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            height: 50%;
            justify-content: space-between;
        }

        .demand-gen-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .demand-gen-value {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .demand-row {
            background: linear-gradient(90deg, rgba(76, 217, 100, 0.2), rgba(76, 217, 100, 0.15));
        }

        .demand-row .demand-gen-value {
            color: #4CD964;
        }

        .generation-row {
            background: linear-gradient(90deg, rgba(30, 144, 255, 0.2), rgba(30, 144, 255, 0.15));
        }

        .generation-row .demand-gen-value {
            color: #1E90FF;
        }

        @media (max-width: 768px) {
            .price-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .price-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            padding: 20px;
            height: 605.2px; /* 固定高度，与地图卡片一致 */
            display: flex;
            flex-direction: column;
            width: calc(100% - 30px); /* 减去左侧gap的宽度 */
            margin-left: auto;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 18px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 6px 16px;
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .chart-area {
            flex: 1;
            width: 100%;
            height: calc(100% - 60px); /* 减去头部的高度 */
            min-height: 0; /* 防止内容溢出 */
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-card {
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .info-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: calc(100% - 30px);
            margin-left: auto;
        }

        .stat-overview-card {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 120px;
            justify-content: center;
        }

        .stat-overview-icon {
            font-size: 20px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .stat-overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-bottom: 4px;
        }

        .stat-overview-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .data-table {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .data-value {
            font-size: 18px;
            font-weight: 500;
        }

        /* Region Selection Layer Styles */
        .region-select-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--color-text) !important;
        }
        
        .region-select-tab.active {
            background: var(--color-primary) !important;
            color: #000 !important;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }
        
        /* Enhanced readability for selected region status badges */
        .region-select-tab.active .region-status-badge {
            background: rgba(0, 0, 0, 0.15) !important;
            color: #000 !important;
            border-color: rgba(0, 0, 0, 0.3) !important;
            font-weight: 700 !important;
        }
        
        /* Status badge base styles */
        .region-status-badge {
            transition: all 0.3s ease;
            font-size: 13px;
            font-weight: 700;
            padding: 6px 12px;
            border-radius: 20px;
            border-width: 1px;
        }
        
        /* Responsive Layout */
        @media (min-width: 1441px) {
            /* Large screens */
            .container {
                max-width: 98%;
                padding: 100px 20px 20px;
            }
            
            .stats-row {
                height: auto;
                min-height: 700px;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: 700px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 700px;
            }
        }
        
        @media (max-width: 1440px) and (min-width: 1201px) {
            /* Medium-large screens */
            .container {
                max-width: 98%;
                padding: 100px 15px 20px;
            }
            
            .stats-row {
                height: auto;
                min-height: 600px;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: 600px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px;
            }
        }
        
        @media (max-width: 1200px) {
            /* Tablet and small desktop */
            .container {
                max-width: 100%;
                padding: 100px 10px 20px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                height: auto;
                gap: 20px;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: 600px !important;
                margin-bottom: 20px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px !important;
            }
            
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-price-circle {
                width: 120px;
                height: 120px;
            }
            
            .current-price {
                font-size: 28px;
            }
            
            .price-range {
                font-size: 9px;
            }
            
            .price-percentage {
                font-size: 12px;
            }
            
            .circle-action-btn {
                height: 60px;
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile devices */
            .container {
                max-width: 100%;
                padding: 100px 8px 20px;
            }
            
            .region-selection-layer {
                margin-bottom: 15px;
                padding: 12px;
            }
            
            .region-selection-tabs {
                gap: 4px;
            }
            
            .region-select-tab {
                padding: 8px 16px !important;
                font-size: 14px;
                min-width: 80px !important;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                height: auto;
                gap: 15px;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: 600px !important;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px !important;
            }
            
            .price-cards {
                gap: 10px;
            }
            
            .price-card {
                min-height: 100px;
            }
            
            .main-price-circle {
                width: 100px;
                height: 100px;
            }
            
            .current-price {
                font-size: 24px;
            }
            
            .price-range {
                font-size: 8px;
            }
            
            .price-percentage {
                font-size: 11px;
            }
            
            .circle-action-btn {
                height: 50px;
                font-size: 11px;
            }
            
            .price-circle-layout {
                gap: 8px;
                margin: 15px 0;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            /* Small mobile devices */
            .container {
                max-width: 100%;
                padding: 95px 5px 15px;
            }
            
            .region-selection-layer {
                margin-bottom: 10px;
                padding: 10px;
            }
            
            .region-selection-tabs {
                gap: 3px;
                flex-wrap: wrap;
            }
            
            .region-select-tab {
                padding: 6px 12px !important;
                font-size: 12px;
                min-width: 70px !important;
            }
            
            .power-station-container {
                height: auto !important;
                min-height: 600px !important;
                padding: 12px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px !important;
            }
            
            .price-cards {
                gap: 8px;
            }
            
            .price-card {
                min-height: 90px;
            }
            
            .main-price-circle {
                width: 90px;
                height: 90px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .price-range {
                font-size: 7px;
            }
            
            .price-percentage {
                font-size: 10px;
            }
            
            .circle-action-btn {
                height: 45px;
                font-size: 10px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .price-circle-layout {
                gap: 6px;
                margin: 10px 0;
            }
        }
        
        /* Responsive adjustments for info-summary-card */
        @media (min-width: 1441px) {
            .info-summary-card {
                height: 150px !important;
                min-height: 150px !important;
                max-height: 150px !important;
                margin-top: 15px !important;
                padding: 0 24px !important;
            }
        }
        
        @media (max-width: 1440px) and (min-width: 1201px) {
            .info-summary-card {
                height: 140px !important;
                min-height: 140px !important;
                max-height: 140px !important;
                margin-top: 15px !important;
                padding: 0 20px !important;
            }
        }
        
        @media (max-width: 1200px) {
            .info-summary-card {
                height: 120px !important;
                min-height: 120px !important;
                max-height: 120px !important;
                margin-top: 12px !important;
                padding: 0 16px !important;
            }
        }
        
        @media (max-width: 768px) {
            .info-summary-card {
                height: 100px !important;
                min-height: 100px !important;
                max-height: 100px !important;
                margin-top: 10px !important;
                padding: 0 12px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 16px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-summary-card {
                height: 90px !important;
                min-height: 90px !important;
                max-height: 90px !important;
                margin-top: 8px !important;
                padding: 0 10px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 14px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 10px !important;
            }
        }

        /* Height-based Responsive */
        @media (min-height: 900px) {
            .power-station-container {
                height: auto !important;
                min-height: 600px;
                max-height: 800px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px;
                max-height: 800px;
            }
        }
        
        @media (min-height: 800px) and (max-height: 899px) {
            .power-station-container {
                height: auto !important;
                min-height: 600px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 600px;
            }
        }
        
        @media (max-height: 800px) {
            .power-station-container {
                height: auto;
            }
            
            .stats-row {
                height: auto;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 500px;
            }
            
            .right-panel-scroll {
                height: auto !important;
            }
            
            .main-price-circle {
                width: 100px;
                height: 100px;
            }
            
            .current-price {
                font-size: 24px;
            }
            
            .price-circle-layout {
                margin: 8px 0;
            }
            
            .action-buttons {
                margin: 8px 0;
            }
        }
        
        @media (max-height: 600px) {
            .power-station-container {
                height: auto !important;
                min-height: 300px;
            }
            
            .custom-card {
                height: auto !important;
                min-height: 300px;
            }
            
            .stats-row {
                height: auto;
                min-height: 300px;
            }
            
            .main-price-circle {
                width: 80px;
                height: 80px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .side-price {
                font-size: 14px;
            }
            
            .station-header {
                margin-bottom: 4px;
                padding-bottom: 4px;
            }
            
            .station-title {
                font-size: 14px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-green {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-yellow {
            background: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }

        /* Region Status Indicators */
        .region-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .region-status.charging {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .region-status.discharging {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        /* 选中状态下的标记样式 */
        .region-select-tab.active .region-status.charging {
            background: #000;
            color: #00ff88;
            border: 1px solid #00ff88;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(0, 255, 136, 0.5);
        }

        .region-select-tab.active .region-status.discharging {
            background: #000;
            color: #ffaa00;
            border: 1px solid #ffaa00;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(255, 170, 0, 0.5);
        }
        
        /* 按钮悬停效果 */
        .region-select-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .region-select-tab.active {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: #1a1a2e;
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            color: #fff;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Button Styles */
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: #fff;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff3333, #ff5555);
            transform: translateY(-1px);
        }
        
        /* Operation Type Styling */
        .operation-type {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .operation-type.stop-charge,
        .operation-type.stop-discharge {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* Info Row Styling */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }
        
        .info-row span {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Warning Message */
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            text-align: center;
        }
        
        .warning-message span {
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .modal-icon.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .modal-icon.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #00ff88;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-info-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn {
            flex: 0 0 auto;
            min-width: 120px;
            height: 44px;
            padding: 10px 25px;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateY(-1px);
        }
        
        /* Details Panel Styles */
        .details-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--color-bg-card);
            border-left: 1px solid var(--color-border);
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .details-panel.show {
            right: 0;
        }

        /* Operation Details Tabs Styles */
        .operation-details-tabs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
        }

        .operation-tab.active {
            color: #00ff88 !important;
            border-bottom-color: #00ff88 !important;
        }

        .operation-tab:hover {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .tab-content {
            color: rgba(255, 255, 255, 0.9);
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            flex: 1;
        }

        .detail-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
            text-align: right;
        }

        .command-tag, .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-tag.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .command-tag.discharge {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .status-tag.success {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .status-tag.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .status-tag.danger {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        .scrollable-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-list::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .details-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg);
        }
        
        .details-panel-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }
        
        .details-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .details-close-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }
        
        .details-content {
            padding: 20px;
        }
        
        .details-section {
            margin-bottom: 30px;
        }
        
        .details-section h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
        }
        
        .details-grid {
            display: grid;
            gap: 12px;
        }
        
        .details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .details-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }
        
        .details-value {
            font-size: 14px;
            color: var(--color-text);
            font-weight: 600;
        }
        
        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .status-item {
            text-align: center;
            padding: 15px;
            background: var(--color-bg);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        
        .status-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        /* Status Summary */
        .status-summary {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .status-summary-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 15px;
            text-align: center;
        }

        .status-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .status-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .status-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .status-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .map-stats {
            display: flex;
            gap: 30px;
        }

        .map-stat {
            text-align: center;
        }

        .map-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-bottom: 5px;
        }

        .map-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
        }

        /* Metrics Grid - New Layout */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .metrics-grid .metric-card {
            min-width: 0;
        }

        .metric-card {
            background: var(--color-bg-card, rgba(255,255,255,0.05));
            border-radius: var(--radius, 8px);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            text-align: left;
            line-height: 1;
        }

        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-align: left;
            line-height: 1;
        }

        .metric-change {
            font-size: 11px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 2px;
            text-align: left;
            line-height: 1;
            padding: 2px 0;
        }

        .metric-change.positive {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        /* Market Analysis Section */
        .market-analysis-section {
            margin-bottom: 40px;
            padding: 20px;
            width: calc(66.67% - 30px);
            margin-left: auto;
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(10px);
        }

        .price-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .price-stat-card {
            background: rgba(25, 25, 25, 0.9);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .price-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .price-stat-change {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 16px;
            opacity: 0.7;
        }

        /* Analytics Section */
        .analytics-section {
            width: 100%;
            display: flex;
            margin-bottom: 40px;
        }

        .analytics-chart {
            width: 66.6666%;
            min-height: 400px;
            padding: 30px;
            margin-left: auto;
        }

        .system-overview {
            padding: 30px;
        }

        .overview-stats {
            margin-bottom: 25px;
        }

        .overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .overview-item:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .overview-value {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .status-active {
            color: #00ff88;
        }

        .performance-chart {
            height: 120px;
            margin: 20px 0;
        }

        .overview-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Date Selection Styles */
        .date-selection {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .date-inputs {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 15px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .date-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            min-width: 140px;
        }

        .date-input:focus {
            outline: none;
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }
        
        /* 自动化条件时间选择器图标样式 */
        #chargeStartTime::-webkit-calendar-picker-indicator,
        #chargeEndTime::-webkit-calendar-picker-indicator {
            filter: brightness(0) saturate(100%) invert(70%) sepia(94%) saturate(1087%) hue-rotate(86deg) brightness(103%) contrast(101%);
            cursor: pointer;
        }
        
        #dischargeStartTime::-webkit-calendar-picker-indicator,
        #dischargeEndTime::-webkit-calendar-picker-indicator {
            filter: brightness(0) saturate(100%) invert(68%) sepia(99%) saturate(612%) hue-rotate(358deg) brightness(103%) contrast(101%);
            cursor: pointer;
        }

        .quick-select {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .quick-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 10px;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        /* Data Cards */
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .data-icon {
            font-size: 28px;
            color: rgba(255, 255, 255, 0.8);
        }

        .data-content {
            flex: 1;
        }

        .data-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stats-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
        }

        .stats-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .stats-change {
            font-size: 16px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-change.positive {
            color: #00ff88;
        }

        .stats-change.negative {
            color: #8A4AFF;
        }

        /* Remove excess bottom margin from last elements */
        .power-station-container > *:last-child {
            margin-bottom: 0;
        }

        .stats-grid > *:last-child {
            margin-bottom: 0;
        }

        /* Market and Map Container Styles */
        .market-container,
        .map-container {
            padding: 20px;
            min-height: auto;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* Market Stats Cards */
.market-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.market-stat-card {
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.market-stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.market-stat-value {
    font-size: 28px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.market-stat-value .indicator {
    width: 4px;
    height: 24px;
    background: #4A9EFF;
    border-radius: 2px;
}

.market-stat-value .menu-dots {
    margin-left: auto;
    color: rgba(255, 255, 255, 0.4);
    cursor: pointer;
}

.market-stat-value .menu-dots:hover {
    color: rgba(255, 255, 255, 0.8);
}

.chart-container {
    padding: 20px;
    height: 605.2px; /* 与电站管理卡片高度保持一致 */
    display: flex;
    flex-direction: column;
        }
    </style>
    <style>
        .custom-card {
            height: 600px;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .market-map-card {
            height: 605.2px;
            min-height: 605.2px;
            max-height: 605.2px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }
    </style>
    <style>
        /* 右侧内容正常显示，不独立滚动 */
        .right-panel-content {
            display: flex;
            flex-direction: column;
            height: auto;
            overflow: visible;
            padding-right: 10px;
        }
        
        .right-panel-scroll {
            overflow: visible;
        }
    </style>
</head>
<body>
    <!-- Header Container for HeaderNav Component -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <!-- Fixed Region Selector -->
    <div class="region-selector-fixed">
        <div id="regionSelectorContainer" style="display: flex; align-items: stretch; max-width: 1440px; margin: 0 auto; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px solid rgba(255,255,255,0.08); padding: 10px 20px; box-shadow: 0 2px 16px rgba(0,0,0,0.2); min-height: 80px; height: auto; transition: all 0.15s ease;">
            
            <!-- 充电/放电条件按钮组 (最左侧，垂直排列) -->
            <div class="condition-switch-group" style="display: flex; flex-direction: column; align-items: stretch; gap: 8px; margin-right: 20px; justify-content: center; width: 120px;">
                <button id="chargeConditionBtn" class="switch-btn" onclick="showChargeCondition()" style="padding: 10px 18px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.08); color: var(--color-text-secondary); border: 1px solid rgba(255,255,255,0.1); width: 100%; text-align: center; line-height: 1.2;">
                    <span data-i18n="chargeCondition" style="display: inline-block; white-space: pre-line;">充电条件</span>
                </button>
                <button id="dischargeConditionBtn" class="switch-btn" onclick="showDischargeCondition()" style="padding: 10px 18px; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s; background: rgba(255,255,255,0.08); color: var(--color-text-secondary); border: 1px solid rgba(255,255,255,0.1); width: 100%; text-align: center; line-height: 1.2;">
                    <span data-i18n="dischargeCondition" style="display: inline-block; white-space: pre-line;">放电条件</span>
                </button>
            </div>
            
            <!-- 地区选择标签 - 占满剩余空间 -->
            <div class="region-selection-container" style="flex: 1; display: flex; align-items: stretch;">
                <!-- 默认地区选择 -->
                <div class="region-selection-tabs" style="display: flex; gap: 8px; justify-content: space-between; width: 100%;">
                    <button class="region-select-tab active" data-region="NSW" onclick="selectMainRegion('NSW', this)" style="padding: 16px 20px; background: var(--color-primary); color: #000; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 60px; flex-direction: column; gap: 4px;">
                        <span style="font-size: 14px; font-weight: 700;">NSW</span>
                        <span class="region-status-badge" data-status="none"></span>
                    </button>
                    <button class="region-select-tab" data-region="QLD" onclick="selectMainRegion('QLD', this)" style="padding: 16px 20px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 60px; flex-direction: column; gap: 4px;">
                        <span style="font-size: 14px; font-weight: 700;">QLD</span>
                        <span class="region-status-badge" data-status="autoCharge"></span>
                    </button>
                    <button class="region-select-tab" data-region="VIC" onclick="selectMainRegion('VIC', this)" style="padding: 16px 20px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 60px; flex-direction: column; gap: 4px;">
                        <span style="font-size: 14px; font-weight: 700;">VIC</span>
                        <span class="region-status-badge" data-status="manualCharge"></span>
                    </button>
                    <button class="region-select-tab" data-region="SA" onclick="selectMainRegion('SA', this)" style="padding: 16px 20px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 60px; flex-direction: column; gap: 4px;">
                        <span style="font-size: 14px; font-weight: 700;">SA</span>
                        <span class="region-status-badge" data-status="autoDischarge"></span>
                    </button>
                    <button class="region-select-tab" data-region="TAS" onclick="selectMainRegion('TAS', this)" style="padding: 16px 20px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; flex: 1; min-height: 60px; flex-direction: column; gap: 4px;">
                        <span style="font-size: 14px; font-weight: 700;">TAS</span>
                        <span class="region-status-badge" data-status="manualDischarge"></span>
                    </button>
                </div>
                
                <!-- 条件地区选择容器 (隐藏，与默认地区选择在同一位置) -->
                <div id="conditionRegionContainer" style="display: none; gap: 8px; justify-content: space-between; width: 100%;">
                    <!-- 条件地区按钮将在这里动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Scrollable Main Content -->
    <div class="main-content-scrollable">
        <div class="container" style="padding-top: 20px; padding-left: 0; padding-right: 0; margin-top: 0;">
            <!-- Top Stats Row -->
        <div class="stats-row" style="align-items: flex-start;">
            <!-- Power Station Management Card -->
            <div class="custom-card power-station-card" style="width: 490px; height: 600px !important; background: rgba(255,255,255,0.03); border-radius: 20px; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 24px rgba(0,255,136,0.04); margin-bottom: 20px; display: flex; flex-direction: column; padding: 16px; overflow: hidden; box-sizing: border-box; position: relative;">
                <!-- Module Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; height: 35px; flex-shrink: 0;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px;">
                        <span data-i18n="station">电站管理</span>
                        <span id="regionStatusText" style="font-size: 12px; font-weight: 500; padding: 2px 8px; border-radius: 4px; display: none;"></span>
                    </h3>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 12px; color: rgba(255,255,255,0.8); font-weight: 500;" data-i18n="autoMode">自动</span>
                        <div class="auto-toggle-switch" onclick="toggleAutoMode()" style="position: relative; width: 36px; height: 20px; background: rgba(255,255,255,0.1); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid rgba(255,255,255,0.2);">
                            <div id="autoToggleKnob" style="position: absolute; top: 1px; right: 1px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: all 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Main Price Circle with Action Buttons -->
                <div style="display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 15px; height: 160px; flex-shrink: 0; transform: translateY(-6px);">
                    <!-- Left Charge Button -->
                    <button class="action-btn charge-btn" id="chargeBtn" onclick="window.handleCharge ? window.handleCharge() : handleCharge()" style="width: 70px; height: 50px; background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%); color: #000; border: none; border-radius: 25px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3); display: flex; align-items: center; justify-content: center;">
                        <span data-i18n="charge">充电</span>
                    </button>
                    
                    <!-- Center Circle -->
                    <div id="mainPriceCircle" style="position: relative; width: 160px; height: 160px; flex-shrink: 0; cursor: pointer; transition: transform 0.3s ease; border-radius: 50%; overflow: hidden; background: #666;" onclick="handleMainCircleClick()" onmouseenter="handleMainCircleHover()" onmouseleave="handleMainCircleLeave()">
                        <!-- Water level container -->
                        <div id="waterLevelContainer" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; transition: height 0.5s ease; overflow: hidden; z-index: 1;">
                            <!-- Water fill with wave curve -->
                            <div id="waterWaveContainer" style="position: absolute; top: -5px; left: 0; width: 100%; height: calc(100% + 10px); background: #5AC8FA; transition: background 0.3s ease;">
                                <!-- Wave surface using clip-path -->
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: inherit; clip-path: polygon(0% 100%, 0% 20%, 15% 15%, 30% 25%, 45% 18%, 60% 22%, 75% 12%, 90% 20%, 100% 15%, 100% 100%); animation: waveFlow 4s ease-in-out infinite;"></div>
                            </div>
                        </div>
                        <!-- Red overlay for hover effect - MUST be after water level -->
                        <div id="hoverOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #ff4444; opacity: 0; transition: opacity 0.3s ease; z-index: 8; pointer-events: none;"></div>
                        <!-- Price text -->
                        <div id="priceDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; transition: opacity 0.3s ease;">
                            <div style="font-size: 28px; font-weight: 700; color: #fff;" id="currentPrice">$163</div>
                            <div style="font-size: 16px; color: rgba(255,255,255,0.9); margin-top: 6px; font-weight: 600;" id="stationStatusLabel">电站状态</div>
                        </div>
                        <!-- Stop text (hidden by default) -->
                        <div id="stopDisplay" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 10; display: none; opacity: 0; transition: opacity 0.3s ease;">
                            <div style="font-size: 18px; font-weight: 700; color: #fff;" data-i18n="stop">停止</div>
                        </div>
                    </div>
                    
                    <!-- Right Discharge Button -->
                    <button class="action-btn discharge-btn" id="dischargeBtn" onclick="window.handleDischarge ? window.handleDischarge() : handleDischarge()" style="width: 70px; height: 50px; background: linear-gradient(135deg, #FFC107 0%, #FFD700 100%); color: #000; border: none; border-radius: 25px; font-size: 14px; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3); display: flex; align-items: center; justify-content: center;">
                        <span data-i18n="discharge">放电</span>
                    </button>
                </div>
                
                <!-- SOC Control Section -->
                <div style="display: flex; gap: 15px; margin-bottom: 15px; height: 60px; flex-shrink: 0;">
                    <!-- Charge Stop SOC -->
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 11px; color: #00ff88; font-weight: 600;" data-i18n="chargeStopSOC">充电停止SOC</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span id="chargeStopSOCDisplay" onclick="editChargeStopSOC()" style="color: #00ff88; font-size: 12px; font-weight: 700; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(0,255,136,0.1)'" onmouseout="this.style.background='transparent'">90</span>
                                <input id="chargeStopSOCInput" type="number" min="0" max="100" value="90" onchange="updateChargeSOCFromInput(this.value)" onblur="hideChargeSOCInput()" onkeyup="if(event.key==='Enter') hideChargeSOCInput()" style="width: 40px; background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); border-radius: 4px; color: #00ff88; font-size: 12px; font-weight: 700; text-align: center; padding: 2px; display: none;">
                                <span style="font-size: 10px; color: #00ff88;">%</span>
                            </div>
                        </div>
                        <div style="position: relative; margin-top: 12px;">
                            <div id="chargeSOCProgressContainer" onclick="handleChargeSOCBarClick(event)" style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer;">
                                <div id="chargeSOCProgressBar" style="width: 90%; height: 100%; background: #00ff88; border-radius: 2px; pointer-events: none;"></div>
                            </div>
                            <div id="chargeSOCProgressDot" style="position: absolute; top: -4px; left: 90%; transform: translateX(-50%); width: 12px; height: 12px; background: #00ff88; border-radius: 50%; cursor: pointer; pointer-events: none;"></div>
                            <input id="chargeSOCSlider" type="range" min="0" max="100" value="90" oninput="updateChargeSOC(this.value)" style="position: absolute; width: 100%; height: 12px; top: -4px; left: 0; opacity: 0; cursor: pointer;">
                        </div>
                    </div>
                    
                    <!-- Vertical Divider -->
                    <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                    
                    <!-- Discharge Stop SOC -->
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="font-size: 11px; color: #ffc107; font-weight: 600;" data-i18n="dischargeStopSOC">放电停止SOC</span>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <span id="dischargeStopSOCDisplay" onclick="editDischargeStopSOC()" style="color: #ffc107; font-size: 12px; font-weight: 700; cursor: pointer; padding: 2px 6px; border-radius: 4px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,193,7,0.1)'" onmouseout="this.style.background='transparent'">20</span>
                                <input id="dischargeStopSOCInput" type="number" min="0" max="100" value="20" onchange="updateDischargeSOCFromInput(this.value)" onblur="hideDischargeSOCInput()" onkeyup="if(event.key==='Enter') hideDischargeSOCInput()" style="width: 40px; background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 4px; color: #ffc107; font-size: 12px; font-weight: 700; text-align: center; padding: 2px; display: none;">
                                <span style="font-size: 10px; color: #ffc107;">%</span>
                            </div>
                        </div>
                        <div style="position: relative; margin-top: 12px;">
                            <div id="dischargeSOCProgressContainer" onclick="handleDischargeSOCBarClick(event)" style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer;">
                                <div id="dischargeSOCProgressBar" style="position: absolute; left: 20%; width: 80%; height: 100%; background: #ffc107; border-radius: 2px; pointer-events: none;"></div>
                            </div>
                            <div id="dischargeSOCProgressDot" style="position: absolute; top: -4px; left: 20%; transform: translateX(-50%); width: 12px; height: 12px; background: #ffc107; border-radius: 50%; cursor: pointer; pointer-events: none;"></div>
                            <input id="dischargeSOCSlider" type="range" min="0" max="100" value="20" oninput="updateDischargeSOC(this.value)" style="position: absolute; width: 100%; height: 12px; top: -4px; left: 0; opacity: 0; cursor: pointer;">
                        </div>
                    </div>
                </div>
                
                <!-- Automation Conditions -->
                <div style="margin-bottom: 15px; height: 160px; flex-shrink: 0;">
                    <h4 style="margin: 0 0 10px 0; font-size: 13px; color: rgba(255,255,255,0.8); font-weight: 600; display: flex; justify-content: space-between; align-items: center;">
                        <span data-i18n="autoConditions">自动化条件</span>
                        <button onclick="openConditionSettingsModal()" style="background: rgba(0,255,136,0.1); border: 1px solid rgba(0,255,136,0.3); color: #00ff88; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.3s;" data-i18n="settings">设置</button>
                    </h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; height: 135px;">
                        <!-- Auto Charge Conditions -->
                        <div style="background: rgba(0,255,136,0.05); padding: 8px; border-radius: 10px; border: 1px solid rgba(0,255,136,0.2);">
                            
                            <!-- 时间条件 -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                    <input type="checkbox" id="chargeTimeEnabled" checked style="width: 10px; height: 10px; min-width: 10px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8); white-space: nowrap;" data-i18n="timeCondition">时间条件</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center; margin-left: 14px;">
                                    <input type="time" id="chargeStartTime" value="22:00" step="60" style="width: 85px; padding: 4px 8px; border: 1px solid rgba(0,255,136,0.3); border-radius: 4px; background: rgba(0,255,136,0.05); color: #00ff88; font-size: 12px; text-align: center; height: 26px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 14px;">-</span>
                                    <input type="time" id="chargeEndTime" value="06:00" step="60" style="width: 85px; padding: 4px 8px; border: 1px solid rgba(0,255,136,0.3); border-radius: 4px; background: rgba(0,255,136,0.05); color: #00ff88; font-size: 12px; text-align: center; height: 26px;">
                                </div>
                            </div>
                            
                            <!-- 价格条件 -->
                            <div style="margin-top: 20px;">
                                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                    <input type="checkbox" id="chargePriceEnabled" checked style="width: 10px; height: 10px; min-width: 10px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8); white-space: nowrap;" data-i18n="priceCondition">价格条件</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center; margin-left: 14px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px; white-space: nowrap;">低于</span>
                                    <input type="number" id="chargePriceValue" value="50" style="width: 50px; padding: 4px 6px; border: 1px solid rgba(0,255,136,0.3); border-radius: 4px; background: rgba(0,255,136,0.05); color: #00ff88; font-size: 12px; text-align: center; height: 26px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px;">$</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Auto Discharge Conditions -->
                        <div style="background: rgba(255,193,7,0.05); padding: 8px; border-radius: 10px; border: 1px solid rgba(255,193,7,0.2);">
                            
                            <!-- 时间条件 -->
                            <div style="margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                    <input type="checkbox" id="dischargeTimeEnabled" checked style="width: 10px; height: 10px; min-width: 10px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8); white-space: nowrap;" data-i18n="timeCondition">时间条件</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center; margin-left: 14px;">
                                    <input type="time" id="dischargeStartTime" value="16:00" step="60" style="width: 85px; padding: 4px 8px; border: 1px solid rgba(255,193,7,0.3); border-radius: 4px; background: rgba(255,193,7,0.05); color: #ffc107; font-size: 12px; text-align: center; height: 26px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 14px;">-</span>
                                    <input type="time" id="dischargeEndTime" value="21:00" step="60" style="width: 85px; padding: 4px 8px; border: 1px solid rgba(255,193,7,0.3); border-radius: 4px; background: rgba(255,193,7,0.05); color: #ffc107; font-size: 12px; text-align: center; height: 26px;">
                                </div>
                            </div>
                            
                            <!-- 价格条件 -->
                            <div style="margin-top: 20px;">
                                <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">
                                    <input type="checkbox" id="dischargePriceEnabled" checked style="width: 10px; height: 10px; min-width: 10px;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.8); white-space: nowrap;" data-i18n="priceCondition">价格条件</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center; margin-left: 14px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px; white-space: nowrap;">高于</span>
                                    <input type="number" id="dischargePriceValue" value="100" style="width: 50px; padding: 4px 6px; border: 1px solid rgba(255,193,7,0.3); border-radius: 4px; background: rgba(255,193,7,0.05); color: #ffc107; font-size: 12px; text-align: center; height: 26px;">
                                    <span style="color: rgba(255,255,255,0.6); font-size: 12px;">$</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Bottom Stats Cards -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; height: 80px; flex-shrink: 0;">
                    <div style="background: rgba(255,255,255,0.04); padding: 10px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 18px; margin-bottom: 3px;">🏠</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 3px; font-weight: 500;" data-i18n="availableHomes">可放电家庭</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;" id="totalFamiliesCard">120</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.04); padding: 10px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 18px; margin-bottom: 3px;">⚡</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 3px; font-weight: 500;" data-i18n="availablePower">可放电量</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;" id="totalPowerCard">65kWh</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.04); padding: 10px 8px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; display: flex; flex-direction: column; justify-content: center; height: 100%; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="font-size: 18px; margin-bottom: 3px;">💰</div>
                        <div style="font-size: 9px; color: rgba(255,255,255,0.7); margin-bottom: 3px; font-weight: 500;" data-i18n="estimatedProfit">预计获利</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;">$3500</div>
                    </div>
                </div>
            </div>

            <!-- 右侧卡片区 -->
            <div style="display: flex; flex-direction: column; width: 100%; height: 100%; overflow: visible;">
                <div class="right-panel-scroll" style="overflow: visible; padding-right:10px; padding-bottom: 20px; height: 100%;">
                    <!-- 自定义卡片 -->
                    <div class="custom-card" style="height: 600px !important;">
                        <div style="padding: 15px; position: relative; height: 100%; display: flex; flex-direction: column; overflow: hidden; box-sizing: border-box;">
                            <!-- Tab Controls -->
                            <div class="panel-tabs">
                                <button class="panel-tab active" onclick="switchPanel('market', this)"><span data-i18n="market">行情</span></button>
                                <button class="panel-tab" onclick="switchPanel('map', this)"><span data-i18n="map">地图</span></button>
                            </div>

                            <!-- Market Panel -->
                            <div id="marketPanel" class="panel-content active">
                                <!-- Price Cards -->
                                <div class="market-section">
                                    <div class="price-cards" style="display: flex; gap: 20px;">
                                        <!-- Combined card for first 4 items -->
                                        <div class="price-card" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 120px;">
                                            <div style="display: flex; height: 100%;">
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('price')">
                                                    <div class="price-card-label" data-i18n="currentSpotPrice" style="font-size: 13px; font-weight: 500;">CURRENT SPOT PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh)</div>
                                                    <div class="price-card-value" id="spotPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('demand')">
                                                    <div class="price-card-label" data-i18n="currentDemand" style="font-size: 13px; font-weight: 500;">CURRENT DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW)</div>
                                                    <div class="price-card-value" id="currentDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,344</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecast')">
                                                    <div class="price-card-label" data-i18n="forecastPrice" style="font-size: 13px; font-weight: 500;">FORECAST PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecastDemand')">
                                                    <div class="price-card-label" data-i18n="forecastDemand" style="font-size: 13px; font-weight: 500;">FORECAST DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,202</div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Demand vs Generation card -->
                                        <div class="price-card demand-gen-card" style="flex: 0 0 20%; padding: 16px 12px; display: flex; flex-direction: column; min-height: 120px;">
                                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                                <!-- Demand Row -->
                                                <div style="margin-bottom: 16px;">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n="demand">需求</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">9,692 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 3px; overflow: hidden;">
                                                        <div style="width: 100%; height: 100%; background: rgba(0, 255, 136, 0.5); border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">👤</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Generation Row -->
                                                <div>
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n="generation">发电</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">8,319 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 3px; overflow: hidden; position: relative;">
                                                        <!-- 闪电发电部分 60% -->
                                                        <div style="width: 60%; height: 100%; background: rgba(0, 170, 255, 0.5); position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">⚡</span>
                                                        </div>
                                                        <!-- 风力发电部分 20% -->
                                                        <div style="width: 20%; height: 100%; background: rgba(64, 224, 208, 0.5); position: absolute; left: 60%; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">💨</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Market Chart -->
                                <div id="marketChart" style="height: 370px; width: 100%; margin-top: 40px;"></div>

                            </div>

                            <!-- Map Panel -->
                            <div id="mapPanel" class="panel-content">
                                <div id="australiaMap" style="height: 340px; max-height: 340px;"></div>
                                <div class="map-controls">
                                    <div class="map-stats">
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n="totalDevices">总设备数</span>
                                            <span class="map-stat-value" id="totalDevices">500</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n="activated">已下发</span>
                                            <span class="map-stat-value" id="activeDevices">0</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n="progress">执行进度</span>
                                            <span class="map-stat-value" id="progressPercent">0%</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n="currentOperation">当前操作</span>
                                            <span class="map-stat-value" id="currentOperationText" data-i18n="none">无</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 第二排：今日数据 + 4个指标 -->
        <div style="display: flex; gap: 20px; margin-top: -100px; margin-bottom: 20px; align-items: flex-start; max-width: 1440px; margin-left: auto; margin-right: auto;">
            <!-- 今日数据卡片 -->
            <div class="glass" style="width: 490px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 24px rgba(0,255,136,0.04); display: flex; flex-direction: column; padding: 16px; box-sizing: border-box; flex-shrink: 0;">
                <!-- 标题区域 -->
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 16px;">📊</div>
                        <div style="font-size: 14px; font-weight: 600; color: #fff;" data-i18n="todayData">今日数据</div>
                    </div>
                    <div style="font-size: 11px; color: rgba(0,255,136,0.8); background: rgba(0,255,136,0.1); padding: 2px 6px; border-radius: 4px;" data-i18n="realtime">实时</div>
                </div>
                
                <!-- 数据区域 -->
                <div style="display: flex; gap: 12px; flex: 1;">
                    <!-- 已放电家庭 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 16px; margin-bottom: 4px;">🏠</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.7); margin-bottom: 2px;" data-i18n="dischargedFamilies">已放电家庭</div>
                        <div style="font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px;">235</div>
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <span style="font-size: 8px; color: #00ff88;">↑</span>
                            <span style="font-size: 8px; color: rgba(255,255,255,0.6);" data-i18n="compareYesterday">比昨日</span>
                            <span style="font-size: 8px; color: #00ff88; font-weight: 600;">+21%</span>
                        </div>
                    </div>
                    
                    <!-- 已放电量 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 16px; margin-bottom: 4px;">⚡</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.7); margin-bottom: 2px;" data-i18n="dischargedAmount">已放电量</div>
                        <div style="font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px;">23547kWh</div>
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <span style="font-size: 8px; color: #00ff88;">↑</span>
                            <span style="font-size: 8px; color: rgba(255,255,255,0.6);" data-i18n="compareYesterday">比昨日</span>
                            <span style="font-size: 8px; color: #00ff88; font-weight: 600;">+21%</span>
                        </div>
                    </div>
                    
                    <!-- 已获利 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 16px; margin-bottom: 4px;">💰</div>
                        <div style="font-size: 10px; color: rgba(255,255,255,0.7); margin-bottom: 2px;" data-i18n="earnedProfit">已获利</div>
                        <div style="font-size: 14px; font-weight: 700; color: #fff; margin-bottom: 2px;">$23547</div>
                        <div style="display: flex; align-items: center; gap: 2px;">
                            <span style="font-size: 8px; color: #00ff88;">↑</span>
                            <span style="font-size: 8px; color: rgba(255,255,255,0.6);" data-i18n="compareYesterday">比昨日</span>
                            <span style="font-size: 8px; color: #00ff88; font-weight: 600;">+21%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 4个指标卡片 -->
            <div class="glass" style="width: 930px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 4px 24px rgba(0,255,136,0.04); display: flex; flex-direction: column; padding: 16px; box-sizing: border-box; flex-shrink: 0;">
                
                <!-- 4个指标区域 -->
                <div style="display: flex; gap: 16px; flex: 1;">
                    <!-- 家庭/Family -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 20px; margin-bottom: 6px;">🏠</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 4px;" data-i18n="family">Family</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;">460</div>
                    </div>
                    
                    <!-- 装机量 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 20px; margin-bottom: 6px;">🔋</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 4px;" data-i18n="installedCapacity">装机量</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;">235MW</div>
                    </div>
                    
                    <!-- 累计放电 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 20px; margin-bottom: 6px;">⚡</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 4px;" data-i18n="totalDischarge">累计放电</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;">234kwh</div>
                    </div>
                    
                    <!-- 累计获利 -->
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div style="font-size: 20px; margin-bottom: 6px;">💰</div>
                        <div style="font-size: 11px; color: rgba(255,255,255,0.7); margin-bottom: 4px;" data-i18n="totalProfit">累计获利</div>
                        <div style="font-size: 18px; font-weight: 700; color: #fff;">$12435</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 第三排：放电与获利（全屏宽度） -->
        <div style="margin-bottom: 20px; margin-top: -20px;">
            <!-- Discharge & Profit Chart 放电与收益 -->
                <div class="card" style="height:422px; min-height:422px; max-height:422px; margin-top:20px; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:24px;">
                    <div class="chart-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <div class="chart-title" data-i18n="profit.charts.dischargeAndProfit" style="font-size:18px; font-weight:500; color:var(--color-text);">放电与获利</div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <!-- Time Period Dropdown (on left) -->
                            <select id="discharge-period-select" class="period-dropdown" onchange="handleDischargePeriodChange()" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; padding:6px 12px; color:#fff; font-size:13px; min-width:80px; cursor:pointer; outline:none;">
                                <option value="day" data-i18n="day">日</option>
                                <option value="month" data-i18n="month">月</option>
                                <option value="year" data-i18n="year">年</option>
                                <option value="cumulative" data-i18n="cumulative">累计</option>
                            </select>
                            <!-- Date Picker (shown on right when not cumulative) -->
                            <div id="discharge-date-picker" style="display:flex; align-items:center;">
                                <input type="date" id="discharge-date-input" class="date-input" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; padding:6px 12px; color:#fff; font-size:13px; min-width:140px;">
                            </div>
                        </div>
                    </div>
                    <div id="powerRevenueChart" style="width:100%; height:calc(100% - 70px); min-height:0;"></div>
                </div>
            </div>
            
            <!-- 第四排：累计价格（全屏宽度） -->
            <div style="margin-bottom: 20px; margin-top: -20px;">
                <!-- 累计价格卡片 -->
                <div class="glass" style="height:620px; min-height:620px; max-height:620px; background:rgba(255,255,255,0.05); border-radius:20px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 4px 24px rgba(0,255,136,0.04); margin-top:20px; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:0;">
                    <!-- 顶部标题 -->
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:20px 32px 0 32px;">
                        <div style="font-size:18px; font-weight:700; color:#fff; letter-spacing:1px;" data-i18n="cumulativePrice">累计价格</div>
                    </div>
                    <!-- 关键数字区（完全参考custom-card的price-cards横向卡片组） -->
                    <div style="display:flex; gap:20px; margin:32px 32px 0 32px;">
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n="currentCumulativePrice">当前累计价格</span></div>
                            <div class="price-card-value" style="font-size:18px; font-weight:600; color:#fff;">$746,630</div>
                        </div>
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n="forecastCumulativePrice5min">预测累计价格(5min)</span></div>
                            <div class="price-card-value" style="font-size:18px; font-weight:600; color:#fff;">$746,622</div>
                        </div>
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n="thresholdStatus">阈值状态</span></div>
                            <div class="price-card-value" data-threshold-status="not_exceeded" style="font-size:18px; font-weight:600; color:#fff;"><span data-i18n="notExceeded">未超阈</span></div>
                        </div>
                    </div>
                    <!-- 图表区（复制行情marketChart结构和样式） -->
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:flex-end; align-items:stretch; padding:0 32px 32px 32px; margin-top:24px;">
                        <div id="cumulativeMarketChart" style="flex:1; min-height:0; width:100%; margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        

        <!-- System Overview -->
        <div class="glass system-overview" style="display:none;">
            <div class="chart-header">
                <h3 class="chart-title" data-i18n="systemOverview">系统概览</h3>
            </div>
            
            <div class="overview-stats">
                <div class="overview-item">
                    <div class="overview-label" data-i18n="totalCapacity">总容量</div>
                    <div class="overview-value">1,200 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n="onlineDevices">在线设备</div>
                    <div class="overview-value" id="onlineDevices">196/200</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n="networkStatus">网络状态</div>
                    <div class="overview-value status-active" data-i18n="normal">正常</div>
                </div>
            </div>

            <div class="performance-chart" id="systemPerformance"></div>
            
            <div class="overview-footer">
                <div class="overview-item">
                    <div class="overview-label">累计放电</div>
                    <div class="overview-value" id="totalDischargeOverview">445.2 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">累计收益</div>
                    <div class="overview-value" id="totalRevenueOverview">$186,430</div>
                </div>
            </div>


            <!-- Stats Overview Grid -->
            <div class="metrics-grid">
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">🏠</div>
                    <div class="stat-overview-label" data-i18n="family">家庭</div>
                    <div class="stat-overview-value" id="totalHomes">235</div>
                </div>
                
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">🔋</div>
                    <div class="stat-overview-label" data-i18n="installedCapacity">装机量</div>
                    <div class="stat-overview-value" id="installedCapacity">235MW</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">⚡</div>
                    <div class="stat-overview-label">累计放电</div>
                    <div class="stat-overview-value" id="totalDischarge">234kwh</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">💰</div>
                    <div class="stat-overview-label">累计获利</div>
                    <div class="stat-overview-value" id="totalProfit">$12,435</div>
                </div>
            </div>
            
            <!-- Analysis Page Modules: Discharge Statistics & Price Statistics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 32px;">
                <!-- Discharge Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n="dischargeStatistics">Discharge Statistics</span>
                    </h3>
                    
                    <!-- Top Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n="actualDischargeAmount">Actual Discharge Amount</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">18.50</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">kWh</span>
                                <span style="color: #00ff88; font-size: 12px; font-weight: 600;">8.0%</span>
                            </div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n="actualDischargeEfficiency">Actual Discharge Efficiency</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">89.0</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">%</span>
                                <span style="color: #00ff88; font-size: 12px; font-weight: 600;">2.0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: #00ff88; font-size: 32px; font-weight: 700; margin-bottom: 8px;">3</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="usersExceedingTarget">Users Exceeding Target</span>
                            </div>
                        </div>
                        <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: #ff6b6b; font-size: 32px; font-weight: 700; margin-bottom: 8px;">17</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="usersNotExceedingTarget">Users Not Exceeding Target</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n="priceStatistics">Price Statistics</span>
                    </h3>
                    
                    <!-- Top Prices Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$185</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n="todaysPrice">Today's Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +5.2%
                            </div>
                        </div>
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$152</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n="avgDischargePrice">Avg Discharge Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +3.8%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Details Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="background: #00ff88; color: #000; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                                <span data-i18n="sellPrice">Sell Price</span>
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="todaysLowest">Today's Lowest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$120</span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="todaysHighest">Today's Highest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$220</span>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n="sellPrice">Sell Price</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$185</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for operation verification -->
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 32px 36px 28px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: flex-start; background: rgba(255, 255, 255, 0.02);">
                <div class="modal-icon" style="width: 56px; height: 56px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                    <span id="confirmIcon" style="font-size: 28px;">⚡</span>
                </div>
                <h3 class="modal-title" id="confirmTitle" style="margin: 0; font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 0.5px;">确认充电操作</h3>
            </div>
            
            <div class="modal-body" style="padding: 36px;">
                <p id="confirmMessage" style="font-size: 16px; color: rgba(255, 255, 255, 0.7); margin: 0 0 32px 0; font-weight: 400; line-height: 1.6;">您确定要执行充电操作吗？</p>
                
                <div class="modal-info-grid" id="confirmInfoGrid" style="display: flex; flex-direction: column; gap: 0; margin-bottom: 32px;">
                    <div style="display: flex; gap: 20px;">
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n="operationType">操作类型</div>
                            <div class="modal-info-value" id="confirmOperationType" style="color: #00ff88; font-size: 20px; font-weight: 600; letter-spacing: 0.5px;">充电</div>
                        </div>
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n="targetDevices">影响设备</div>
                            <div class="modal-info-value" id="confirmTargetDevices" style="color: #fff; font-size: 20px; font-weight: 600;">500个</div>
                        </div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedPower">预计功率</div>
                        <div class="modal-info-value" id="confirmEstimatedPower">3.0MW</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="currentPrice">当前电价</div>
                        <div class="modal-info-value" id="confirmCurrentPrice">$85/MWh</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedDuration">预计时间</div>
                        <div class="modal-info-value" id="confirmDuration">15-30分钟</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n="estimatedProfit">预计获利</div>
                        <div class="modal-info-value" id="confirmCostBenefit">+$178</div>
                    </div>
                </div>
                
                <div class="warning-notice" style="padding: 20px; background: linear-gradient(145deg, rgba(255, 152, 0, 0.08), rgba(255, 152, 0, 0.04)); border: 1px solid rgba(255, 152, 0, 0.15); border-radius: 16px; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: rgba(255, 152, 0, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="font-size: 18px;">⚠️</span>
                        </div>
                        <span id="warningText" style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.8; flex: 1;">将开始对所有连接设备进行充电操作，此过程将消耗电网电力。</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 28px 36px 32px; background: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); display: flex; justify-content: flex-end; gap: 16px;">
                <button class="modal-btn modal-cancel-btn" onclick="closeConfirmationModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); letter-spacing: 0.5px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'" data-i18n="cancel">取消</button>
                <button class="modal-btn modal-confirm-btn" onclick="executeConfirmedOperation()" id="confirmExecuteBtn" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3); letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'">确认充电</button>
            </div>
        </div>
    </div>

    <!-- Modal for operation result -->
    <div id="operationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            
            <div class="modal-header" style="text-align: left; justify-content: flex-start;">
                <div class="modal-icon success">
                    <span id="modalIcon">✓</span>
                </div>
                <div style="margin-left: 12px;">
                    <h3 class="modal-title" id="modalTitle" data-i18n="commandSentSuccess">指令下发成功</h3>
                </div>
            </div>
            
            <div class="modal-body">
                <p id="modalMessage" data-i18n="systemExecuting">系统正在执行您的操作指令...</p>
                
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-label" data-i18n="operationType">操作类型</div>
                        <div class="modal-info-value" id="operationType">充电</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label" data-i18n="targetDevices">影响设备</div>
                        <div class="modal-info-value" id="targetDevices">500个</div>
                    </div>
                </div>
                
                <div class="status-summary" id="statusSummary" style="display: none;">
                    <div class="status-summary-title" data-i18n="deviceResponseStatistics">设备响应统计</div>
                    <div class="status-stats">
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesDispatched">500</div>
                            <div class="status-stat-label" data-i18n="commandsSent">指令下发</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesReceived">477</div>
                            <div class="status-stat-label" data-i18n="commandsReceived">指令接收</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesActivated">445</div>
                            <div class="status-stat-label" data-i18n="devicesActivated">成功激活</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="successRate">89%</div>
                            <div class="status-stat-label" data-i18n="successRate">成功率</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="openOperationDrawer()" style="width: 120px; height: 36px; font-size: 14px; padding: 0 16px;">
                    <span data-i18n="viewDetails">查看详情</span>
                </button>
                <button class="modal-btn modal-btn-secondary" onclick="closeOperationResultModal()" style="width: 80px; height: 36px; font-size: 14px; padding: 0 12px; margin-left: 10px;" data-i18n="close">关闭</button>
            </div>
        </div>
    </div>

    <!-- Operation Details Panel -->
    <div class="details-panel" id="operationDetailsPanel" style="display: none;">
        <div class="details-panel-header">
            <h3 data-i18n="operationDetails">Operation Details</h3>
            <button class="details-close-btn" onclick="closeDetailsPanel()">×</button>
        </div>
        <div class="details-content">
            <div class="details-section">
                <h4 data-i18n="basicInfo">Basic Information</h4>
                <div class="details-grid">
                    <div class="details-item">
                        <span class="details-label" data-i18n="operationType">Operation Type:</span>
                        <span class="details-value" id="detailsOperationType">Charge</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="targetDevices">Target Devices:</span>
                        <span class="details-value" id="detailsTargetDevices">500 <span data-i18n="devices">设备</span></span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="estimatedProfit">Estimated Profit:</span>
                        <span class="details-value" id="detailsEstimatedProfit"><span data-i18n="estimatedProfitValue">+$340</span></span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n="operationTime">Operation Time:</span>
                        <span class="details-value" id="detailsOperationTime">2024-06-26 14:30:00</span>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <h4 data-i18n="executionStatus">Execution Status</h4>
                <div class="status-overview">
                    <div class="status-item">
                        <div class="status-number" id="detailsDispatched">500</div>
                        <div class="status-label" data-i18n="devicesDispatched">Commands Sent</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" id="detailsReceived">477</div>
                        <div class="status-label" data-i18n="devicesReceived">Commands Received</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" id="detailsActivated">445</div>
                        <div class="status-label" data-i18n="devicesActivated">Devices Activated</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto Settings Panel -->
    <div class="auto-settings-panel" id="autoSettingsPanel" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10003; backdrop-filter: blur(5px);">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 500px; background: var(--color-bg-card); border-radius: 20px; padding: 24px; border: 1px solid var(--color-border); box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #fff; font-size: 18px;" data-i18n="autoSettings">自动化设置</h3>
                <button onclick="closeAutoSettings()" style="background: none; border: none; color: rgba(255,255,255,0.7); font-size: 24px; cursor: pointer; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;">×</button>
            </div>
            
            <!-- Auto Mode Type Selection -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="autoModeType">自动模式类型</label>
                <div style="display: flex; gap: 8px;">
                    <button id="autoChargeBtn" class="auto-type-btn active" onclick="selectAutoType('charge')" style="flex: 1; padding: 12px; border: none; border-radius: 12px; background: #4CD964; color: #000; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                        <span data-i18n="autoCharge">自动充电</span>
                    </button>
                    <button id="autoDischargeBtn" class="auto-type-btn" onclick="selectAutoType('discharge')" style="flex: 1; padding: 12px; border: none; border-radius: 12px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer; transition: all 0.3s;">
                        <span data-i18n="autoDischarge">自动放电</span>
                    </button>
                </div>
            </div>

            <!-- Time Range Settings -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="timeRange">时间范围</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="time" id="autoStartTime" value="22:00" style="flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                    <span style="color: rgba(255,255,255,0.7);" data-i18n="to">到</span>
                    <input type="time" id="autoEndTime" value="06:00" style="flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                </div>
            </div>

            <!-- Price Condition -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="priceCondition">价格条件</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select id="autoPriceOperator" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                        <option value="less" data-i18n="lessThan">低于</option>
                        <option value="greater" data-i18n="greaterThan">高于</option>
                    </select>
                    <input type="number" id="autoPriceValue" value="50" step="0.1" style="flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                    <span style="color: rgba(255,255,255,0.7);">$/MWh</span>
                </div>
            </div>

            <!-- Battery Level Condition -->
            <div style="margin-bottom: 24px;">
                <label style="display: block; color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 8px;" data-i18n="batteryCondition">电量条件</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <select id="autoBatteryOperator" style="padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                        <option value="less" data-i18n="lessThan">低于</option>
                        <option value="greater" data-i18n="greaterThan">高于</option>
                        <option value="between" data-i18n="between">介于</option>
                    </select>
                    <input type="number" id="autoBatteryValue" value="20" min="0" max="100" style="flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px;">
                    <input type="number" id="autoBatteryValue2" value="80" min="0" max="100" style="flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: #fff; font-size: 14px; display: none;">
                    <span style="color: rgba(255,255,255,0.7);">%</span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px;">
                <button onclick="closeAutoSettings()" style="flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 12px; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7); font-weight: 500; cursor: pointer; transition: all 0.3s;">
                    <span data-i18n="cancel">取消</span>
                </button>
                <button onclick="saveAutoSettings()" style="flex: 1; padding: 12px; border: none; border-radius: 12px; background: var(--color-primary); color: #000; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                    <span data-i18n="saveSettings">保存设置</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let marketChart, powerChart, performanceChart, mapChart, cumulativeMarketChart;
        let powerChartTimeSelector, currentOperation = null;
        let activatedDevices = 0, totalDevices = 500, chartUpdateInterval;
        let pendingOperation = null, previousPanel = null;
        
        // Auto operation variables
        let currentOperationMode = 'auto'; // 'manual' or 'auto' - default to auto
        let autoSettings = {
            charge: {
                timeRange: {
                    enabled: true,
                    start: '22:00',
                    end: '06:00'
                },
                priceCondition: {
                    enabled: true,
                    operator: 'less', // 'less', 'greater'
                    value: 50
                },
                socEndCondition: {
                    operator: 'greater', // 'less', 'greater'
                    value: 90
                },
                stopSOC: 90 // 充电停止SOC
            },
            discharge: {
                timeRange: {
                    enabled: true,
                    start: '16:00',
                    end: '21:00'
                },
                priceCondition: {
                    enabled: true,
                    operator: 'greater', // 'less', 'greater'
                    value: 100
                },
                socEndCondition: {
                    operator: 'less', // 'less', 'greater'
                    value: 20
                },
                stopSOC: 20 // 放电停止SOC
            }
        };
        let autoCheckInterval = null;
        
        // Auto operation functions
        function toggleAutoMode() {
            const isCurrentlyAuto = currentOperationMode === 'auto';
            const newMode = isCurrentlyAuto ? 'manual' : 'auto';
            switchOperationMode(newMode);
        }
        
        function switchOperationMode(mode) {
            currentOperationMode = mode;
            
            const autoToggleKnob = document.getElementById('autoToggleKnob');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const toggleSwitch = document.querySelector('.auto-toggle-switch');
            
            if (mode === 'manual') {
                // Update toggle switch to off position
                autoToggleKnob.style.left = '2px';
                autoToggleKnob.style.background = '#fff';
                toggleSwitch.style.background = 'rgba(255,255,255,0.1)';
                
                // Show and enable action buttons in manual mode
                chargeBtn.style.display = 'flex';
                dischargeBtn.style.display = 'flex';
                chargeBtn.disabled = false;
                dischargeBtn.disabled = false;
                chargeBtn.style.opacity = '1';
                dischargeBtn.style.opacity = '1';
                chargeBtn.style.cursor = 'pointer';
                dischargeBtn.style.cursor = 'pointer';
                
                // Stop auto check interval
                if (autoCheckInterval) {
                    clearInterval(autoCheckInterval);
                    autoCheckInterval = null;
                }
                
                // 重置当前地区状态为无状态
                if (regionData[selectedMainRegion]) {
                    regionData[selectedMainRegion].status = 'none';
                    // 更新电站管理显示
                    updatePowerStationStatus(selectedMainRegion, 'none');
                    // 更新地区状态标记
                    updateRegionStatusDisplay();
                }
                
                // 重置地区操作状态以确保按钮显示
                updateRegionOperationStatus(selectedMainRegion, 'none');
                
                console.log('Switched to manual mode, reset region status to none');
            } else {
                // Update toggle switch to on position
                autoToggleKnob.style.left = '22px';
                autoToggleKnob.style.background = '#fff';
                toggleSwitch.style.background = '#4CD964';
                
                // Show but disable action buttons in auto mode
                chargeBtn.style.display = 'flex';
                dischargeBtn.style.display = 'flex';
                chargeBtn.disabled = true;
                dischargeBtn.disabled = true;
                chargeBtn.style.opacity = '0.5';
                dischargeBtn.style.opacity = '0.5';
                chargeBtn.style.cursor = 'not-allowed';
                dischargeBtn.style.cursor = 'not-allowed';
                
                // Update conditions display
                updateAutoConditionsDisplay();
                
                // Start auto check interval
                startAutoOperationCheck();
            }
            
            // Update stop button visibility after mode change
            updateStopButtonVisibility();
            
            // Update action buttons visibility after mode change
            updateActionButtonsVisibility();
        }
        
        // Auto settings panel functions (no longer needed - using inline editing)
        function openAutoSettings() {
            // Settings are now edited inline, no need for modal
            console.log('Inline editing mode - no settings panel needed');
        }
        
        function closeAutoSettings() {
            // Settings are now edited inline, no need for modal
            console.log('Inline editing mode - no settings panel needed');
        }
        
        function saveAutoSettings() {
            // Get form values and update both charge and discharge settings (simplified for now)
            const timeStart = document.getElementById('autoStartTime').value;
            const timeEnd = document.getElementById('autoEndTime').value;
            const priceOperator = document.getElementById('autoPriceOperator').value;
            const priceValue = parseFloat(document.getElementById('autoPriceValue').value);
            const batteryOperator = document.getElementById('autoBatteryOperator').value;
            const batteryValue = parseFloat(document.getElementById('autoBatteryValue').value);
            
            // Update charge settings
            autoSettings.charge.timeRange.start = timeStart;
            autoSettings.charge.timeRange.end = timeEnd;
            autoSettings.charge.priceCondition.operator = priceOperator;
            autoSettings.charge.priceCondition.value = priceValue;
            autoSettings.charge.socEndCondition.operator = batteryOperator;
            autoSettings.charge.socEndCondition.value = batteryValue;
            
            // Close panel
            closeAutoSettings();
            
            // Show confirmation message
            showAutoSettingsSaved();
            
            // Update conditions display
            updateAutoConditionsDisplay();
            
            // Restart auto check if in auto mode
            if (currentOperationMode === 'auto') {
                startAutoOperationCheck();
            }
        }
        
        function selectAutoType(type) {
            autoSettings.type = type;
            
            // Update UI
            const chargeBtn = document.querySelector('[onclick="selectAutoType(\'charge\')"]');
            const dischargeBtn = document.querySelector('[onclick="selectAutoType(\'discharge\')"]');
            
            if (type === 'charge') {
                chargeBtn.style.background = '#4CD964';  // 绿色
                chargeBtn.style.color = '#000';
                dischargeBtn.style.background = 'transparent';
                dischargeBtn.style.color = 'rgba(255,255,255,0.7)';
            } else {
                chargeBtn.style.background = 'transparent';
                chargeBtn.style.color = 'rgba(255,255,255,0.7)';
                dischargeBtn.style.background = '#FFC107';  // 黄色
                dischargeBtn.style.color = '#000';
            }
        }
        
        function updateBatteryRangeVisibility() {
            const operator = document.getElementById('autoBatteryOperator').value;
            const value2Input = document.getElementById('autoBatteryValue2');
            
            if (operator === 'between') {
                value2Input.style.display = 'block';
            } else {
                value2Input.style.display = 'none';
            }
        }
        
        function startAutoOperationCheck() {
            // Clear existing interval
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
            }
            
            // Check conditions every 30 seconds
            autoCheckInterval = setInterval(checkAutoConditions, 30000);
        }
        
        function checkAutoConditions() {
            if (currentOperationMode !== 'auto') return;
            
            const now = new Date();
            const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const currentPrice = getCurrentPrice();
            const currentBatteryLevel = getCurrentBatteryLevel();
            
            // Check charge conditions
            if (shouldTriggerCharge(currentTime, currentPrice, currentBatteryLevel)) {
                triggerChargeOperation();
                return;
            }
            
            // Check discharge conditions
            if (shouldTriggerDischarge(currentTime, currentPrice, currentBatteryLevel)) {
                triggerDischargeOperation();
                return;
            }
        }
        
        function shouldTriggerCharge(currentTime, currentPrice, currentBatteryLevel) {
            const charge = autoSettings.charge;
            
            // Check time condition (if enabled)
            if (charge.timeRange.enabled) {
                if (!isTimeInRange(currentTime, charge.timeRange.start, charge.timeRange.end)) {
                    return false;
                }
            }
            
            // Check price condition (if enabled)
            if (charge.priceCondition.enabled) {
                if (!checkCondition(currentPrice, charge.priceCondition.operator, charge.priceCondition.value)) {
                    return false;
                }
            }
            
            // Check SOC end condition (always checked)
            if (!checkCondition(currentBatteryLevel, charge.socEndCondition.operator, charge.socEndCondition.value)) {
                return false;
            }
            
            return true;
        }
        
        function shouldTriggerDischarge(currentTime, currentPrice, currentBatteryLevel) {
            const discharge = autoSettings.discharge;
            
            // Check time condition (if enabled)
            if (discharge.timeRange.enabled) {
                if (!isTimeInRange(currentTime, discharge.timeRange.start, discharge.timeRange.end)) {
                    return false;
                }
            }
            
            // Check price condition (if enabled)
            if (discharge.priceCondition.enabled) {
                if (!checkCondition(currentPrice, discharge.priceCondition.operator, discharge.priceCondition.value)) {
                    return false;
                }
            }
            
            // Check SOC end condition (always checked)
            if (!checkCondition(currentBatteryLevel, discharge.socEndCondition.operator, discharge.socEndCondition.value)) {
                return false;
            }
            
            return true;
        }
        
        function checkCondition(value, operator, threshold) {
            switch (operator) {
                case 'less':
                    return value < threshold;
                case 'greater':
                    return value > threshold;
                default:
                    return true;
            }
        }
        
        function isTimeInRange(currentTime, startTime, endTime) {
            const current = timeToMinutes(currentTime);
            const start = timeToMinutes(startTime);
            const end = timeToMinutes(endTime);
            
            if (start <= end) {
                return current >= start && current <= end;
            } else {
                // Crosses midnight
                return current >= start || current <= end;
            }
        }
        
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function checkPriceCondition(price) {
            const { operator, value } = autoSettings.priceCondition;
            
            switch (operator) {
                case 'less':
                    return price < value;
                case 'greater':
                    return price > value;
                default:
                    return true;
            }
        }
        
        function checkBatteryCondition(batteryLevel) {
            const { operator, value, value2 } = autoSettings.batteryCondition;
            
            switch (operator) {
                case 'less':
                    return batteryLevel < value;
                case 'greater':
                    return batteryLevel > value;
                case 'between':
                    return batteryLevel >= Math.min(value, value2) && batteryLevel <= Math.max(value, value2);
                default:
                    return true;
            }
        }
        
        function getCurrentPrice() {
            // Get current price from the price circle
            const priceElement = document.querySelector('.current-price');
            if (priceElement) {
                const priceText = priceElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '');
                return parseFloat(priceText) || 0;
            }
            return 0;
        }
        
        function getCurrentBatteryLevel() {
            // Get current battery level from the power station data
            const batteryElement = document.querySelector('.power-bar');
            if (batteryElement) {
                const widthStyle = batteryElement.style.width;
                if (widthStyle) {
                    return parseFloat(widthStyle.replace('%', '')) || 0;
                }
            }
            return 50; // Default battery level
        }
        
        function triggerAutoOperation() {
            const operationType = autoSettings.type;
            
            // Prevent duplicate operations
            if (currentOperation) {
                console.log('Operation already in progress, skipping auto operation');
                return;
            }
            
            console.log(`Triggering automatic ${operationType} operation`);
            
            // Simulate button click for the appropriate operation
            if (operationType === 'charge') {
                triggerChargeOperation();
            } else {
                triggerDischargeOperation();
            }
        }
        
        function triggerChargeOperation() {
            // Simulate charge button click
            const chargeBtn = document.querySelector('#chargeBtn, [onclick*="charge"]');
            if (chargeBtn && !chargeBtn.disabled) {
                chargeBtn.click();
                showAutoOperationNotification('充电', '自动充电已启动');
            }
        }
        
        function triggerDischargeOperation() {
            // Simulate discharge button click
            const dischargeBtn = document.querySelector('#dischargeBtn, [onclick*="discharge"]');
            if (dischargeBtn && !dischargeBtn.disabled) {
                dischargeBtn.click();
                showAutoOperationNotification('放电', '自动放电已启动');
            }
        }
        
        function showAutoOperationNotification(operation, message) {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--color-bg-card);
                border: 1px solid var(--color-border);
                border-radius: 12px;
                padding: 16px;
                color: #fff;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px rgba(0,255,136,0.5);"></div>
                    <div>
                        <div style="font-weight: 600; margin-bottom: 4px;">自动操作</div>
                        <div style="font-size: 14px; opacity: 0.8;">${message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-in forwards';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }
        
        function showAutoSettingsSaved() {
            showAutoOperationNotification('设置', '自动化设置已保存');
        }
        
        function updateAutoConditionsDisplay() {
            // Safely load form values from autoSettings
            const setElementValue = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.value = value;
            };
            
            const setElementChecked = (id, checked) => {
                const el = document.getElementById(id);
                if (el) el.checked = checked;
            };
            
            // Update charge conditions
            setElementChecked('chargeTimeEnabled', autoSettings.charge.timeRange.enabled);
            setElementValue('chargeStartTime', autoSettings.charge.timeRange.start);
            setElementValue('chargeEndTime', autoSettings.charge.timeRange.end);
            
            setElementChecked('chargePriceEnabled', autoSettings.charge.priceCondition.enabled);
            setElementValue('chargePriceOperator', autoSettings.charge.priceCondition.operator);
            setElementValue('chargePriceValue', autoSettings.charge.priceCondition.value);
            
            setElementValue('chargeSocOperator', autoSettings.charge.socEndCondition.operator);
            setElementValue('chargeSocValue', autoSettings.charge.socEndCondition.value);
            
            // Update discharge conditions
            setElementChecked('dischargeTimeEnabled', autoSettings.discharge.timeRange.enabled);
            setElementValue('dischargeStartTime', autoSettings.discharge.timeRange.start);
            setElementValue('dischargeEndTime', autoSettings.discharge.timeRange.end);
            
            setElementChecked('dischargePriceEnabled', autoSettings.discharge.priceCondition.enabled);
            setElementValue('dischargePriceOperator', autoSettings.discharge.priceCondition.operator);
            setElementValue('dischargePriceValue', autoSettings.discharge.priceCondition.value);
            
            setElementValue('dischargeSocOperator', autoSettings.discharge.socEndCondition.operator);
            setElementValue('dischargeSocValue', autoSettings.discharge.socEndCondition.value);
        }
        
        function updateConditionStatus(operationType, conditionType, enabled) {
            autoSettings[operationType][conditionType === 'time' ? 'timeRange' : 'priceCondition'].enabled = enabled;
            
            // Update visual state of the condition controls
            const prefix = operationType === 'charge' ? 'charge' : 'discharge';
            const suffix = conditionType === 'time' ? 'Time' : 'Price';
            
            if (conditionType === 'time') {
                const startTimeInput = document.getElementById(`${prefix}StartTime`);
                const endTimeInput = document.getElementById(`${prefix}EndTime`);
                startTimeInput.disabled = !enabled;
                endTimeInput.disabled = !enabled;
                startTimeInput.style.opacity = enabled ? '1' : '0.5';
                endTimeInput.style.opacity = enabled ? '1' : '0.5';
            } else {
                const operatorSelect = document.getElementById(`${prefix}PriceOperator`);
                const valueInput = document.getElementById(`${prefix}PriceValue`);
                operatorSelect.disabled = !enabled;
                valueInput.disabled = !enabled;
                operatorSelect.style.opacity = enabled ? '1' : '0.5';
                valueInput.style.opacity = enabled ? '1' : '0.5';
            }
        }
        
        function updateAutoSettings() {
            // Update charge settings
            autoSettings.charge.timeRange.start = document.getElementById('chargeStartTime').value;
            autoSettings.charge.timeRange.end = document.getElementById('chargeEndTime').value;
            autoSettings.charge.priceCondition.operator = document.getElementById('chargePriceOperator').value;
            autoSettings.charge.priceCondition.value = parseFloat(document.getElementById('chargePriceValue').value);
            autoSettings.charge.socEndCondition.operator = document.getElementById('chargeSocOperator').value;
            autoSettings.charge.socEndCondition.value = parseFloat(document.getElementById('chargeSocValue').value);
            
            // Update discharge settings
            autoSettings.discharge.timeRange.start = document.getElementById('dischargeStartTime').value;
            autoSettings.discharge.timeRange.end = document.getElementById('dischargeEndTime').value;
            autoSettings.discharge.priceCondition.operator = document.getElementById('dischargePriceOperator').value;
            autoSettings.discharge.priceCondition.value = parseFloat(document.getElementById('dischargePriceValue').value);
            autoSettings.discharge.socEndCondition.operator = document.getElementById('dischargeSocOperator').value;
            autoSettings.discharge.socEndCondition.value = parseFloat(document.getElementById('dischargeSocValue').value);
            
            // Restart auto check if in auto mode
            if (currentOperationMode === 'auto') {
                startAutoOperationCheck();
            }
        }
        
        // Performance utilities (inline to avoid CORS issues)
        function throttle(func, limit) {
            let inThrottle;
            let lastFunc;
            let lastRan;
            
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    lastRan = Date.now();
                    inThrottle = true;
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, Math.max(limit - (Date.now() - lastRan), 0));
                }
                
                setTimeout(() => {
                    inThrottle = false;
                }, limit);
            };
        }

        // Data cache class
        class DataCache {
            constructor(ttl = 5 * 60 * 1000, maxSize = 100) {
                this.cache = new Map();
                this.ttl = ttl;
                this.maxSize = maxSize;
            }
            
            set(key, data) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            get(key) {
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                if (Date.now() - cached.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return cached.data;
            }
            
            clear() {
                this.cache.clear();
            }
        }

        // Chart manager class
        class ChartManager {
            constructor() {
                this.charts = new Map();
            }
            
            register(name, chart) {
                if (this.charts.has(name)) {
                    this.dispose(name);
                }
                this.charts.set(name, chart);
            }
            
            dispose(name) {
                const chart = this.charts.get(name);
                if (chart && typeof chart.dispose === 'function') {
                    chart.dispose();
                }
                this.charts.delete(name);
            }
        }
        
        // Create instances
        const dataCache = new DataCache();
        const chartManager = new ChartManager();
        
        // Initialize additional variables 
        let currentRegion = 'NSW';
        let selectedMainRegion = 'NSW'; // 新增：主地区选择
        let regionConditions = {}; // 存储各地区的条件设置
        let chartType = 'both';
        let autoSwitchInterval;
        let mapAnimationInterval;
        let deviceLocations = []; // Fixed device locations


        // Initialize HeaderNav immediately when scripts are loaded
        function initHeaderNav() {
            console.log('Initializing HeaderNav...');
            console.log('Checking HeaderNav availability:', typeof HeaderNav);
            console.log('Checking I18n availability:', typeof I18n);
            console.log('Checking headerContainer element:', document.getElementById('headerContainer'));
            
            if (typeof HeaderNav === 'undefined') {
                console.error('HeaderNav class not found!');
                return false;
            }
            
            try {
                const headerNav = new HeaderNav({
                    currentPage: 'home',
                    containerId: 'headerContainer'
                });
                console.log('HeaderNav initialized successfully');
                return true;
            } catch (error) {
                console.error('HeaderNav initialization failed:', error);
                return false;
            }
        }

        // Try to initialize HeaderNav immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHeaderNav);
        } else {
            initHeaderNav();
        }

        // Initialize all charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Use setTimeout to ensure all dependencies are loaded
            setTimeout(() => {
                try {
                    // Make sure HeaderNav is initialized
                    if (!window.headerNav) {
                        initHeaderNav();
                    }
                    
                    // Initialize price circle color and water wave effect
                    updatePriceCircleColor();
                    
                    // 设置定时更新水波效果（每10秒更新一次）
                    setInterval(() => {
                        updateWaterWaveLevel();
                    }, 10000);
                    
                    // Initialize auto conditions display (always shown)
                    updateAutoConditionsDisplay();
                    
                    // Initialize SOC sliders
                    initSOCSliders();
                    
                    // Initialize operation mode (default to auto)
                    switchOperationMode(currentOperationMode);
                    // HeaderNav initialized successfully
                    
                    // 启动z-index监控器
                    startDrawerZIndexMonitor();
                    
                    // Initialize i18n system if not already initialized by HeaderNav
                    if (!window.i18n && typeof I18n !== 'undefined') {
                        window.i18n = new I18n({
                            defaultLanguage: 'zh',
                            containerId: 'languageSelector'
                        });
                        console.log('i18n system initialized for homepage');
                    }
                    
                    // Initialize auto settings event listeners
                    const autoBatteryOperator = document.getElementById('autoBatteryOperator');
                    if (autoBatteryOperator) {
                        autoBatteryOperator.addEventListener('change', updateBatteryRangeVisibility);
                    }
                    
                    // Add language change listener for dynamic content
                    if (window.i18n) {
                        window.i18n.addObserver((newLanguage, oldLanguage) => {
                            console.log('Language changed from', oldLanguage, 'to', newLanguage);
                            updateDynamicContent(newLanguage);
                            
                            // Refresh all charts with new language
                            if (marketChart) {
                                updateMarketChart();
                            }
                            if (powerChart && powerChartTimeSelector) {
                                const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                                const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                                updatePowerChartWithData(labels, power, revenue, currentPeriod);
                            }
                            if (mapChart) {
                                updateMapStatistics();
                            }
                            // Refresh cumulative chart
                            const activeRegionBtn = document.querySelector('.region-switch-glow .time-tab.active');
                            if (activeRegionBtn) {
                                const region = activeRegionBtn.textContent.trim();
                                renderCumulativeChart(region);
                            }
                            
                            // Refresh condition regions if visible
                            if (currentConditionView !== 'default') {
                                const type = currentConditionView;
                                createConditionRegions(type);
                            }
                            
                            // Update default region display
                            updateRegionDisplay();
                            
                            // Update region status display with new language
                            updateRegionStatusDisplay();
                            
                            // 语言切换后重新调整间距
                            setTimeout(() => {
                                adjustSpacingForRegionSelector();
                            }, 300);
                            
                            // 更新大圆中的状态标签
                            const currentRegionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
                            updateStationStatusLabel(currentRegionStatus);
                        });
                    }
                } catch (error) {
                    console.error('HeaderNav failed to initialize:', error);
                }
            }, 10);
            
            // Add keyboard and click listeners for modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const confirmModal = document.getElementById('confirmationModal');
                    if (confirmModal && confirmModal.style.display === 'block') {
                        closeConfirmationModal();
                    }
                }
                
                // 添加强制刷新快捷键 Ctrl+Shift+R
                if (event.ctrlKey && event.shiftKey && event.key === 'R') {
                    event.preventDefault();
                    console.log('Force refresh triggered');
                    window.location.reload(true);
                }
                
                // 添加F5强制刷新
                if (event.key === 'F5') {
                    event.preventDefault();
                    console.log('F5 force refresh triggered');
                    window.location.reload(true);
                }
            });
            
            // Add click outside to close functionality
            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.addEventListener('click', function(event) {
                    if (event.target === confirmationModal) {
                        closeConfirmationModal();
                    }
                });
            }
            
            try {
                // Generate fixed device locations once (exactly 500 devices)
                deviceLocations = generateDeviceLocations();
                
                // 初始化地区状态指示器
                updateRegionStatusIndicators();
                
                // 设置默认选中NSW地区
                const defaultRegion = document.querySelector('.region-select-tab[data-region="NSW"]');
                if (defaultRegion) {
                    selectMainRegion('NSW', defaultRegion);
                }
                
                // 定期更新地区状态（模拟实时数据）
                setInterval(updateRegionStatusIndicators, 30000); // 每30秒更新一次
                
                // Initialize UI with correct device count
                document.getElementById('totalDevices').textContent = '500';
                document.getElementById('activeDevices').textContent = '0';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('currentOperationText').textContent = '无';
                
                console.log('Starting chart initialization...');
                console.log('ECharts available:', typeof echarts !== 'undefined');
                
                // Check if chart containers exist
                const containers = ['powerRevenueChart', 'systemPerformance', 'marketChart', 'australiaMap'];
                containers.forEach(id => {
                    const element = document.getElementById(id);
                    console.log(`Container ${id}:`, element ? 'Found' : 'NOT FOUND');
                    if (element) {
                        console.log(`Container ${id} dimensions:`, element.offsetWidth, 'x', element.offsetHeight);
                    }
                });
                
                console.log('Initializing charts...');
                
                try {
                    initPowerRevenueChart();
                    console.log('Power chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize power chart:', e);
                }
                
                try {
                    initSystemPerformanceChart();
                    console.log('Performance chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize performance chart:', e);
                }
                
                try {
                    initMarketChart();
                    console.log('Market chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize market chart:', e);
                }
                
                try {
                    initMap();
                    console.log('Map initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize map:', e);
                }
                
                console.log('All charts initialization attempted');
                
                // Verify chart objects created
                setTimeout(() => {
                    console.log('Chart objects status:');
                    console.log('marketChart:', !!marketChart);
                    console.log('mapChart:', !!mapChart);
                    console.log('powerChart:', !!powerChart);
                    console.log('performanceChart:', !!performanceChart);
                    
                    // Force resize all charts after initialization
                    if (marketChart) {
                        console.log('Force resizing marketChart');
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                    if (mapChart) {
                        console.log('Force resizing mapChart');
                        if (mapChart && typeof mapChart.resize === 'function') {
                            mapChart.resize();
                        }
                    }
                    if (powerChart) {
                        if (powerChart && typeof powerChart.resize === 'function') {
                            powerChart.resize();
                        }
                    }
                    if (performanceChart) {
                        if (performanceChart && typeof performanceChart.resize === 'function') {
                            performanceChart.resize();
                        }
                    }
                }, 300);
                
                // Initialize time selector after charts are ready
                setTimeout(() => {
                    try {
                        initPowerChartTimeSelector();
                    } catch (error) {
                        console.error('TimeSelector initialization failed:', error);
                    }
                }, 100);
                
                // Initialize with NSW region
                updatePriceCircleRegion('NSW');
                
                // Initialize cumulative chart
                renderCumulativeChart('NSW');
                
                // Force apply button styles
                forceButtonStyles();
                // Apply styles periodically to ensure they stick  
                setInterval(forceButtonStyles, 3000);
                
                // Add device response modal click handlers
                setTimeout(() => {
                    const statusSummary = document.querySelector('.status-summary');
                    if (statusSummary) {
                        statusSummary.style.cursor = 'pointer';
                        statusSummary.addEventListener('click', showDeviceResponseModal);
                    }
                    
                    // Also check for any analytics cards with device response text
                    const allCards = document.querySelectorAll('.card, .metric-card, .stat-card');
                    allCards.forEach(card => {
                        const text = card.textContent;
                        if (text && (text.includes('设备响应') || text.includes('Device Response'))) {
                            card.style.cursor = 'pointer';
                            card.addEventListener('click', showDeviceResponseModal);
                        }
                    });
                }, 1000);
                
                // Initialize highest price region display
                // updateHighestPriceRegion(); // Removed - using fixed text now
                
                // Initialize other station data
                document.getElementById('availableHomes').textContent = '235';
                document.getElementById('availablePower').textContent = '23547kWh';
                document.getElementById('estimatedProfit').textContent = '$12435';
                
                // Start real-time updates
                setInterval(updateRealtimeData, 5000);
            } catch (error) {
                console.error('Chart initialization failed:', error);
            }
            
            // Start auto switch if enabled
            const autoSwitchElement = document.getElementById('autoSwitch');
            if (autoSwitchElement && autoSwitchElement.checked) {
                startAutoSwitch();
            }
            
            // Add i18n observer to update charts when language changes
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Update power chart
                    if (powerChart) {
                        const dischargeLabel = window.i18n.getText('discharge');
                        const revenueLabel = window.i18n.getText('totalRevenue');
                        powerChart.setOption({
                            legend: {
                                data: [dischargeLabel, revenueLabel]
                            },
                            yAxis: [
                                {
                                    name: newLanguage === 'en' ? 'Power (kWh)' : 'kWh'
                                },
                                {
                                    name: newLanguage === 'en' ? 'Revenue ($)' : '$'
                                }
                            ],
                            series: [
                                {
                                    name: dischargeLabel
                                },
                                {
                                    name: revenueLabel
                                }
                            ]
                        });
                    }
                    
                    // Update market chart
                    if (marketChart) {
                        marketChart.setOption({
                            legend: {
                                data: [
                                    window.i18n.getText('historicalPrice'),
                                    window.i18n.getText('demand'),
                                    window.i18n.getText('predictedPrice'),
                                    window.i18n.getText('predictedDemand')
                                ]
                            },
                            yAxis: [
                                {
                                    name: window.i18n.getText('price')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                }
                            ],
                            series: [
                                {
                                    name: window.i18n.getText('historicalPrice')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                },
                                {
                                    name: window.i18n.getText('predictedPrice')
                                },
                                {
                                    name: window.i18n.getText('predictedDemand')
                                }
                            ]
                        });
                    }
                    
                    // Re-init system performance chart to update series names
                    if (document.getElementById('systemPerformance')) {
                        initSystemPerformanceChart();
                    }
                    
                    // Update time selector labels for charts
                    const currentPeriod = powerChartTimeSelector ? powerChartTimeSelector.getCurrentPeriod() : 'month';
                    const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                    updatePowerChartWithData(labels, power, revenue, currentPeriod);
                });
            }
        });
        
        // 显示强制刷新通知
        function showRefreshNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #00ff88, #00aaff);
                color: #000;
                padding: 20px 40px;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 600;
                z-index: 999999;
                box-shadow: 0 8px 32px rgba(0, 255, 136, 0.5);
                animation: pulse 0.5s ease-in-out;
            `;
            notification.textContent = '正在强制刷新页面...';
            document.body.appendChild(notification);
        }

        // System Performance Chart (Simplified Overview)
        function initSystemPerformanceChart() {
            performanceChart = echarts.init(document.getElementById('systemPerformance'));
            
            const hours = [];
            const efficiency = [];
            const availability = [];
            
            // Generate last 12 hours of system performance data
            for (let i = 11; i >= 0; i--) {
                const time = new Date();
                time.setHours(time.getHours() - i);
                hours.push(`${time.getHours()}:00`);
                
                // Generate realistic performance metrics
                efficiency.push(93.8 + Math.random() * 6.2); // 93.8-100% efficiency
                availability.push(95 + Math.random() * 5); // 95-100% availability
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            result += item.marker + ' ' + item.seriesName + ': ' + item.value.toFixed(1) + '%<br/>';
                        });
                        return result;
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    min: 85,
                    max: 100,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                },
                series: [
                    {
                        name: window.i18n ? window.i18n.getText('executionEfficiency') : '执行效率',
                        type: 'line',
                        data: efficiency,
                        smooth: true,
                        lineStyle: { color: '#00ff88', width: 2 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.2)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                            ])
                        },
                        symbol: 'none'
                    },
                    {
                        name: window.i18n ? window.i18n.getText('systemAvailability') : '系统可用性',
                        type: 'line',
                        data: availability,
                        smooth: true,
                        lineStyle: { color: '#00aaff', width: 2 },
                        symbol: 'none'
                    }
                ]
            };

            performanceChart.setOption(option);
            window.addEventListener('resize', throttle(() => {
                if (performanceChart && typeof performanceChart.resize === 'function') {
                    performanceChart.resize();
                }
            }, 250));
        }

        // Discharge & Profit chart
        // powerRevenueChart is already declared globally above
        function initPowerRevenueChart() {
            powerRevenueChart = echarts.init(document.getElementById('powerRevenueChart'));
            
            const options = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'var(--color-text-secondary)'
                        }
                    }
                },
                legend: {
                    data: [window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量', window.i18n ? window.i18n.getText('profit') : '获利'],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0:00', '6:00', '12:00', '18:00', '24:00'],
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' }
                },
                yAxis: [{
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('discharge') : '放电量',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                }, {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('profit') : '获利',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '${value}'
                    },
                    splitLine: { show: false }
                }],
                series: [{
                    name: window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量',
                    type: 'bar',
                    data: [100, 120, 240, 80, 110],
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    barWidth: '40%'
                }, {
                    name: window.i18n ? window.i18n.getText('profit') : '获利',
                    type: 'line',
                    yAxisIndex: 1,
                    data: [150, 180, 240, 120, 165],
                    lineStyle: {
                        width: 3,
                        color: '#ffd700'
                    },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 8,
                    smooth: true
                }]
            };
            
            powerRevenueChart.setOption(options);
            window.addEventListener('resize', throttle(() => {
                if (powerRevenueChart && typeof powerRevenueChart.resize === 'function') {
                    powerRevenueChart.resize();
                }
            }, 250));
        }


        // 地区操作状态存储
        const regionOperationStatus = {
            'NSW': 'none',  // 待机状态
            'QLD': 'discharging',
            'VIC': 'charging',
            'SA': 'discharging',
            'TAS': 'discharging'
        };
        
        // 获取地区操作状态
        function getRegionOperationStatus(region) {
            return regionOperationStatus[region] || 'none';
        }
        
        // 更新地区操作状态
        function updateRegionOperationStatus(region, status) {
            regionOperationStatus[region] = status;
        }

        // 更新地区按钮状态指示器
        function updateRegionStatusIndicators() {
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                const region = tab.getAttribute('data-region');
                const status = getRegionOperationStatus(region);
                let statusElement = tab.querySelector('.region-status');
                
                // 先移除所有可能的占位元素
                const lastChild = tab.lastElementChild;
                if (lastChild && lastChild.tagName === 'SPAN' && !lastChild.classList.contains('region-status') && lastChild.style.width === '20px') {
                    lastChild.remove();
                }
                
                if (statusElement) {
                    // 移除现有状态类
                    statusElement.classList.remove('charging', 'discharging');
                    
                    // 新的状态显示逻辑已移至updateRegionStatusDisplay函数
                    // 这里保留为兼容性，但不再使用+/-符号
                } else {
                    // 确保有占位元素
                    const placeholder = document.createElement('span');
                    placeholder.style.width = '20px';
                    tab.appendChild(placeholder);
                }
            });
        }

        // 主地区选择函数
        function selectMainRegion(region, button) {
            selectedMainRegion = region;
            
            // 更新按钮状态
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = 'var(--color-text-secondary)';
                tab.style.border = '1px solid var(--color-border)';
                tab.style.borderRadius = '50px';
                
                // Reset region name color for non-selected tabs
                const regionNameSpan = tab.querySelector('span');
                if (regionNameSpan && !regionNameSpan.innerHTML.includes('<div')) {
                    regionNameSpan.style.color = 'var(--color-text-secondary)';
                }
            });
            button.classList.add('active');
            button.style.background = 'var(--color-primary)';
            button.style.color = '#000';
            button.style.border = 'none';
            button.style.borderRadius = '50px';
            
            // Ensure region name text is visible when selected - use white for better contrast
            const regionNameSpan = button.querySelector('span');
            if (regionNameSpan && !regionNameSpan.innerHTML.includes('<div')) {
                regionNameSpan.style.color = '#000';
                regionNameSpan.style.fontWeight = '700';
            }
            
            // 获取该地区的状态
            const regionStatus = regionData[region].status;
            console.log(`Selected region: ${region}, Status: ${regionStatus}`);
            
            // 更新电站管理状态
            updatePowerStationStatus(region, regionStatus);
            
            // 根据状态切换面板和按钮
            if (regionStatus === 'autoCharge' || regionStatus === 'manualCharge' || regionStatus === 'autoDischarge' || regionStatus === 'manualDischarge') {
                // 有充放电标记的地区，显示地图，按钮变成停止
                currentOperation = status === 'charging' ? 'charge' : 'discharge';
                switchPanel('map');
                updateActionButtonsToStop();
            } else {
                // 无标记的地区（status === 'none'），显示行情，只显示充放电按钮
                currentOperation = null;
                switchPanel('market');
                updateActionButtonsToChargeDis();
            }
            
            // 更新页面数据
            updatePageDataByRegion(region);
            
            // 总是更新地区显示，以确保切换时样式正确
            updateRegionDisplay();
            
            // 调整间距
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 100);
        }
        
        // 更新电站管理状态
        function updatePowerStationStatus(region, status) {
            const statusText = document.getElementById('regionStatusText');
            const autoToggle = document.getElementById('autoToggleKnob');
            const circle = document.getElementById('mainPriceCircle');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            // 更新状态文字
            if (statusText) {
                if (status === 'none') {
                    statusText.textContent = '';
                    statusText.style.display = 'none';
                } else if (status === 'autoCharge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('autoCharge') : '自动充电';
                    statusText.style.color = '#4CD964';
                    statusText.style.background = 'rgba(76, 217, 100, 0.1)';
                    statusText.style.border = '1px dashed rgba(76, 217, 100, 0.3)';
                    statusText.style.display = 'inline-block';
                } else if (status === 'manualCharge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('manualCharge') : '手动充电';
                    statusText.style.color = '#4CD964';
                    statusText.style.background = 'rgba(76, 217, 100, 0.1)';
                    statusText.style.border = '1px solid rgba(76, 217, 100, 0.3)';
                    statusText.style.display = 'inline-block';
                } else if (status === 'autoDischarge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('autoDischarge') : '自动放电';
                    statusText.style.color = '#FFC107';
                    statusText.style.background = 'rgba(255, 193, 7, 0.1)';
                    statusText.style.border = '1px dashed rgba(255, 193, 7, 0.3)';
                    statusText.style.display = 'inline-block';
                } else if (status === 'manualDischarge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('manualDischarge') : '手动放电';
                    statusText.style.color = '#FFC107';
                    statusText.style.background = 'rgba(255, 193, 7, 0.1)';
                    statusText.style.border = '1px solid rgba(255, 193, 7, 0.3)';
                    statusText.style.display = 'inline-block';
                }
            }
            
            // 更新自动开关状态 - 根据自动/手动状态控制
            if (autoToggle) {
                if (status === 'autoCharge' || status === 'autoDischarge') {
                    // 自动模式：开关向右（开启状态）- 纯绿色背景，白色圆点
                    autoToggle.style.right = '1px';
                    autoToggle.style.left = 'auto';
                    autoToggle.style.background = '#fff';
                    autoToggle.parentElement.style.background = '#4CD964';
                } else {
                    // 手动模式或无状态：开关向左（关闭状态）
                    autoToggle.style.left = '1px';
                    autoToggle.style.right = 'auto';
                    autoToggle.style.background = '#fff';
                    autoToggle.parentElement.style.background = 'rgba(255,255,255,0.1)';
                }
            }
            
            // 控制充放电按钮的显示/隐藏
            if (chargeBtn && dischargeBtn) {
                if (status === 'none') {
                    // 无状态时显示充放电按钮
                    chargeBtn.style.display = 'flex';
                    dischargeBtn.style.display = 'flex';
                } else {
                    // 有状态时隐藏充放电按钮
                    chargeBtn.style.display = 'none';
                    dischargeBtn.style.display = 'none';
                }
            }
            
            // 更新水波颜色和高度
            if (circle) {
                const waterWaveContainer = circle.querySelector('#waterWaveContainer');
                const waterLevelContainer = circle.querySelector('#waterLevelContainer');
                
                if (status === 'autoCharge' || status === 'manualCharge') {
                    // 充电状态 - 使用菜单栏选中主题色，水波高度30%，添加大圆和水波动效
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = 'var(--color-primary, #00ff88)';
                        waterWaveContainer.style.animation = 'softWaveFlow 3s ease-in-out infinite';
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '30%';
                    }
                    // 给大圆添加向外微动效
                    circle.style.animation = 'chargeCirclePulse 2s ease-in-out infinite';
                } else if (status === 'autoDischarge' || status === 'manualDischarge') {
                    // 放电状态 - 黄色水波，水波高度80%，添加大圆和水波动效
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = '#FFC107';
                        waterWaveContainer.style.animation = 'softWaveFlow 2.5s ease-in-out infinite';
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '80%';
                    }
                    // 给大圆添加向外微动效
                    circle.style.animation = 'dischargeCirclePulse 2.2s ease-in-out infinite';
                } else {
                    // 无状态 - 蓝色水波，默认高度50%，无动效
                    if (waterWaveContainer) {
                        waterWaveContainer.style.background = '#5AC8FA';
                        waterWaveContainer.style.animation = 'softWaveFlow 4s ease-in-out infinite'; // 柔和波浪
                    }
                    if (waterLevelContainer) {
                        waterLevelContainer.style.height = '50%';
                    }
                    // 移除大圆动效
                    circle.style.animation = 'none';
                }
            }
            
            // 根据状态更新价格显示
            updatePriceByStatus(region, status);
            
            // 更新大圆中的状态标签
            updateStationStatusLabel(status);
        }
        
        // 更新电站状态标签
        function updateStationStatusLabel(status) {
            const statusLabel = document.getElementById('stationStatusLabel');
            if (!statusLabel) return;
            
            console.log('updateStationStatusLabel called with status:', status);
            
            let statusText = '';
            let showLabel = true;
            
            if (status === 'none') {
                // 没有状态时隐藏标签
                showLabel = false;
            } else if (status === 'autoCharge') {
                statusText = window.i18n ? window.i18n.getText('autoCharge') : '自动充电';
            } else if (status === 'manualCharge') {
                statusText = window.i18n ? window.i18n.getText('manualCharge') : '手动充电';
            } else if (status === 'autoDischarge') {
                statusText = window.i18n ? window.i18n.getText('autoDischarge') : '自动放电';
            } else if (status === 'manualDischarge') {
                statusText = window.i18n ? window.i18n.getText('manualDischarge') : '手动放电';
            }
            
            if (showLabel) {
                statusLabel.textContent = statusText;
                statusLabel.style.display = 'block';
                console.log('Station status label updated to:', statusText);
            } else {
                statusLabel.style.display = 'none';
                console.log('Station status label hidden (no status)');
            }
        }
        
        // 根据状态更新价格
        function updatePriceByStatus(region, status) {
            // 各地区固定价格
            const regionPrices = {
                'NSW': 163,
                'QLD': 34,
                'VIC': 21,
                'SA': 403,
                'TAS': 390
            };
            
            const price = regionPrices[region] || 163; // 默认NSW价格
            
            // 更新价格显示
            const currentPriceElement = document.getElementById('currentPrice');
            if (currentPriceElement) currentPriceElement.textContent = '$' + price;
        }
        
        // 更新操作按钮为停止状态
        function updateActionButtonsToStop() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // 添加operating类
            actionButtonsContainer.classList.add('operating');
            
            // 隐藏充放电按钮
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn) chargeBtn.style.display = 'none';
            if (dischargeBtn) dischargeBtn.style.display = 'none';
            
            // 不显示停止按钮，停止功能集成在大圆中
            // 移除任何现有的停止按钮
            const stopBtn = document.querySelector('.stop-btn');
            if (stopBtn) {
                stopBtn.remove();
            }
            
            // 不需要更改显示，保持价格显示
        }
        
        // 更新操作按钮为充放电状态
        function updateActionButtonsToChargeDis() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // 移除operating类
            actionButtonsContainer.classList.remove('operating');
            
            // 重置当前操作状态
            currentOperation = null;
            
            // 调用resetButtons确保正确重置
            resetButtons();
            
            // 移除停止按钮（而不仅是隐藏）
            const stopBtn = document.querySelector('.stop-btn');
            if (stopBtn) {
                stopBtn.remove();
            }
            
            // 确保按钮事件处理器正确绑定
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            if (chargeBtn) {
                chargeBtn.onclick = handleCharge;
            }
            if (dischargeBtn) {
                dischargeBtn.onclick = handleDischarge;
            }
        }
        
        // 根据地区更新页面数据
        function updatePageDataByRegion(region) {
            // 更新电站管理数据
            updatePowerStationData(region);
            
            // 更新市场数据
            updateMarketDataByRegion(region);
            
            // 更新统计卡片
            updateStatisticsCards(region);
            
            // 更新图表
            if (marketChart) {
                updateMarketChart();
            }
            if (powerRevenueChart) {
                updateDischargeChart(currentDischargePeriod, document.getElementById('discharge-date-input').value);
            }
            
            // 更新地图显示
            if (mapChart) {
                updateMapByRegion(region);
            }
        }
        
        // 更新电站管理数据
        function updatePowerStationData(region) {
            const regionData = {
                'NSW': { price: '$163', low: '$120.50', high: '$185.75', families: 120, power: '65kWh', profit: '$3500' },
                'QLD': { price: '$34', low: '$110.00', high: '$170.00', families: 90, power: '48kWh', profit: '$2800' },
                'VIC': { price: '$21', low: '$115.50', high: '$175.50', families: 100, power: '52kWh', profit: '$3100' },
                'SA': { price: '$403', low: '$125.00', high: '$190.00', families: 70, power: '38kWh', profit: '$2200' },
                'TAS': { price: '$390', low: '$100.00', high: '$160.00', families: 355, power: '32kWh', profit: '$1835' }
            };
            
            const data = regionData[region] || regionData['NSW'];
            
            // 更新价格显示
            document.getElementById('currentPrice').textContent = data.price;
            document.getElementById('todayLow').textContent = data.low;
            document.getElementById('todayHigh').textContent = data.high;
            document.getElementById('regionIndicator').textContent = region;
            
            // 更新统计数据
            document.getElementById('totalFamiliesCard').textContent = data.families;
            // 更新电站管理中的三个小卡片
            const powerStationCards = document.querySelectorAll('.power-station-container .stat-value');
            if (powerStationCards.length >= 3) {
                powerStationCards[0].textContent = data.families;  // 家庭数
                powerStationCards[1].textContent = data.power;  // 可放电量
                powerStationCards[2].textContent = data.profit;  // 预计获利
            }
            
            // 更新最高价格区域显示
            const highestPriceRegionElement = document.getElementById('highestPriceRegion') || document.getElementById('highestPriceRegionDisplay');
            if (highestPriceRegionElement) {
                highestPriceRegionElement.textContent = region;
            }
        }
        
        // 更新市场数据
        function updateMarketDataByRegion(region) {
            // 触发市场面板的地区切换
            const marketRegionTab = document.querySelector(`.region-tab[onclick*="${region}"]`);
            if (marketRegionTab) {
                switchMarketRegion(region, marketRegionTab);
            }
        }
        
        // 更新统计卡片
        function updateStatisticsCards(region) {
            const summaryData = {
                'NSW': { families: 120, capacity: '65kWh', discharge: '89kwh', profit: '$3500' },
                'QLD': { families: 90, capacity: '48kWh', discharge: '45kwh', profit: '$2800' },
                'VIC': { families: 100, capacity: '52kWh', discharge: '51kwh', profit: '$3100' },
                'SA': { families: 70, capacity: '38kWh', discharge: '32kwh', profit: '$2200' },
                'TAS': { families: 355, capacity: '32kWh', discharge: '17kwh', profit: '$1835' }
            };
            
            const data = summaryData[region] || summaryData['NSW'];
            
            // 更新汇总卡片
            const familySummary = document.getElementById('familySummaryCard');
            if (familySummary) familySummary.textContent = data.families;
            
            // 更新其他汇总数据
            const summaryElements = document.querySelectorAll('.info-summary-card .stat-value');
            if (summaryElements.length >= 4) {
                summaryElements[1].textContent = data.capacity;
                summaryElements[2].textContent = data.discharge;
                summaryElements[3].textContent = data.profit;
            }
        }
        
        // 更新地图显示
        function updateMapByRegion(region) {
            if (!mapChart) return;
            
            // 只显示选定地区的设备
            if (deviceLocations && deviceLocations.length > 0) {
                // 过滤选中地区的设备
                const filteredDevices = deviceLocations.filter(device => device.region === region);
                const seriesData = filteredDevices.map(device => ({
                    value: device.value,
                    id: device.id,
                    status: device.status,
                    region: device.region
                }));
                
                mapChart.setOption({
                    series: [{
                        data: seriesData
                    }]
                });
            }
            
            updateMapStatistics();
        }
        
        // Update functions
        function switchRegion(region, button) {
            currentRegion = region;
            
            // Update active button
            document.querySelectorAll('.chart-controls .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update chart with new data
            updateMainChart('both');
        }

        function switchPriceRegion(region, button) {
            // Update active button
            const parent = button.parentElement;
            parent.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update price data
            updatePriceData(region);
        }

        // Discharge & Profit time period switching
        let currentDischargePeriod = 'day';
        
        function handleDischargePeriodChange() {
            const periodSelect = document.getElementById('discharge-period-select');
            const period = periodSelect.value;
            currentDischargePeriod = period;
            
            // Handle date picker visibility and type
            const datePicker = document.getElementById('discharge-date-picker');
            const dateInput = document.getElementById('discharge-date-input');
            
            if (period === 'cumulative') {
                // Hide date picker for cumulative
                datePicker.style.display = 'none';
            } else {
                // Show date picker
                datePicker.style.display = 'flex';
                
                // Set appropriate input type and default value
                const today = new Date();
                switch(period) {
                    case 'day':
                        dateInput.type = 'date';
                        dateInput.value = today.toISOString().split('T')[0];
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'month':
                        dateInput.type = 'month';
                        dateInput.value = today.toISOString().slice(0, 7);
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'year':
                        // For year, we'll use a number input
                        dateInput.type = 'number';
                        dateInput.min = '2020';
                        dateInput.max = today.getFullYear().toString();
                        dateInput.value = today.getFullYear().toString();
                        dateInput.style.minWidth = '100px';
                        dateInput.style.width = '100px';
                        break;
                }
            }
            
            // Update chart data based on period
            updateDischargeChart(period, dateInput.value);
        }
        
        function updateDischargeChart(period, dateValue) {
            if (!powerRevenueChart) return;
            
            let xAxisData, dischargeData, profitData;
            
            switch(period) {
                case 'day':
                    // Hourly data for selected day
                    xAxisData = Array.from({length: 24}, (_, i) => i.toString());
                    dischargeData = Array.from({length: 24}, () => Math.floor(Math.random() * 200) + 50);
                    profitData = Array.from({length: 24}, () => Math.floor(Math.random() * 200) + 50);
                    break;
                case 'month':
                    // Daily data for selected month
                    const daysInMonth = new Date(dateValue.split('-')[0], dateValue.split('-')[1], 0).getDate();
                    xAxisData = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
                    dischargeData = Array.from({length: daysInMonth}, () => Math.floor(Math.random() * 200) + 50);
                    profitData = Array.from({length: daysInMonth}, () => Math.floor(Math.random() * 200) + 50);
                    break;
                case 'year':
                    // Monthly data for selected year
                    xAxisData = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    dischargeData = Array.from({length: 12}, () => Math.floor(Math.random() * 2000) + 500);
                    profitData = Array.from({length: 12}, () => Math.floor(Math.random() * 2000) + 500);
                    break;
                case 'cumulative':
                    // Cumulative data over time
                    xAxisData = ['2020', '2021', '2022', '2023', '2024'];
                    dischargeData = [5000, 12000, 25000, 45000, 78000];
                    profitData = [8000, 18000, 35000, 62000, 98000];
                    break;
            }
            
            // Update chart
            powerRevenueChart.setOption({
                xAxis: { data: xAxisData },
                series: [
                    { data: dischargeData },
                    { data: profitData }
                ]
            });
        }
        
        // Initialize discharge chart date input listener
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('discharge-date-input');
            if (dateInput) {
                // Set today's date as default
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
                
                dateInput.addEventListener('change', function() {
                    updateDischargeChart(currentDischargePeriod, this.value);
                });
            }
        });


        // Update power chart title with current time period
        function updatePowerChartTitle() {
            const chartTitle = document.getElementById('powerChartTitle');
            if (chartTitle) {
                chartTitle.textContent = window.i18n ? window.i18n.getText('powerRevenueTrend') : '放电与收益趋势';
            }
        }

        // Initialize time selector for power chart
        function initPowerChartTimeSelector() {
            if (typeof TimeSelector === 'undefined') {
                console.error('TimeSelector class not loaded');
                return;
            }
            powerChartTimeSelector = new TimeSelector({
                containerId: 'power-chart-time-selector',
                onPeriodChange: handlePowerChartPeriodChange,
                onCustomDateApply: handlePowerChartCustomDate,
                enableAutoRefresh: true,
                autoRefreshInterval: 30000,
                periods: [
                    { id: 'month', label: window.i18n ? window.i18n.getText('month') : '本月', shortcut: '1' },
                    { id: 'week', label: window.i18n ? window.i18n.getText('week') : '本周', shortcut: '2' },
                    { id: 'today', label: window.i18n ? window.i18n.getText('today') : '今日', shortcut: '3' },
                    { id: 'custom', label: window.i18n ? window.i18n.getText('custom') : '自定义', shortcut: '4' }
                ],
                quickSelectOptions: [
                    { label: window.i18n ? window.i18n.getText('last7Days') : '最近7天', days: 7 },
                    { label: window.i18n ? window.i18n.getText('last30Days') : '最近30天', days: 30 },
                    { label: window.i18n ? window.i18n.getText('last90Days') : '最近90天', days: 90 }
                ]
            });
            
            // Add language change observer to update TimeSelector
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Re-initialize TimeSelector with new language
                    if (powerChartTimeSelector) {
                        const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                        powerChartTimeSelector.destroy();
                        initPowerChartTimeSelector();
                        // Restore current period
                        setTimeout(() => {
                            if (powerChartTimeSelector && currentPeriod !== 'today') {
                                powerChartTimeSelector.setCurrentPeriod(currentPeriod);
                            }
                        }, 100);
                    }
                });
            }
            
            // Set initial title to show default period (today)
            updatePowerChartTitle();
            
            // Force initial data load for today to ensure display
            setTimeout(() => {
                const { labels, power, revenue } = generateAnalyticsData('month');
                updatePowerChartWithData(labels, power, revenue, 'month');
            }, 200);
        }

        // Handle period change from time selector
        function handlePowerChartPeriodChange(period, data) {
            console.log('Power chart period changed to:', period, data);
            
            // Update chart title with current period
            updatePowerChartTitle();
            
            // Generate data for the selected period
            const { labels, power, revenue } = generateAnalyticsData(period);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, period);
        }

        // Handle custom date range application
        function handlePowerChartCustomDate(startDate, endDate, dayCount) {
            console.log('Power chart custom date applied:', startDate, endDate, dayCount);
            
            // Format date range for display
            const startFormatted = new Date(startDate).toLocaleDateString('zh-CN');
            const endFormatted = new Date(endDate).toLocaleDateString('zh-CN');
            const customDateRange = `${startFormatted} 至 ${endFormatted}`;
            
            // Update chart title with custom date range
            updatePowerChartTitle();
            
            // Generate data for custom date range
            const { labels, power, revenue } = generateAnalyticsData('custom', startDate, endDate);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, 'custom');
        }

        // Legacy function for backward compatibility
        function updateAnalytics(period) {
            if (powerChartTimeSelector) {
                // Map old period names to new ones
                const periodMap = {
                    'today': 'today',
                    'week': 'week', 
                    'month': 'month',
                    'custom': 'custom'
                };
                
                const mappedPeriod = periodMap[period] || period;
                powerChartTimeSelector.setCurrentPeriod(mappedPeriod);
            }
        }

        function generateAnalyticsData(period, startDate = null, endDate = null) {
            // Create cache key based on parameters
            const cacheKey = `analyticsData_${period}_${startDate || 'null'}_${endDate || 'null'}`;
            
            // Check cache first for standard periods (not custom with random data)
            if (period !== 'custom') {
                const cached = dataCache.get(cacheKey);
                if (cached) {
                    return cached;
                }
            }
            
            const labels = [];
            const power = [];
            const revenue = [];
            
            if (period === 'today') {
                for (let i = 0; i < 24; i += 2) {
                    labels.push(`${i}:00`);
                    power.push(Math.random() * 150 + 50);
                    revenue.push(Math.random() * 200 + 100);
                }
            } else if (period === 'week') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                let days;
                if (currentLang === 'en') {
                    days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                } else if (currentLang === 'ja') {
                    days = ['月', '火', '水', '木', '金', '土', '日'];
                } else if (currentLang === 'ko') {
                    days = ['월', '화', '수', '목', '금', '토', '일'];
                } else {
                    days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                }
                days.forEach(day => {
                    labels.push(day);
                    power.push(Math.random() * 2000 + 1000);
                    revenue.push(Math.random() * 2500 + 1200);
                });
            } else if (period === 'month') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                for (let i = 1; i <= 30; i++) {
                    if (currentLang === 'en' || currentLang === 'ja' || currentLang === 'ko') {
                        labels.push(`${i}`);
                    } else {
                        labels.push(`${i}日`);
                    }
                    power.push(Math.random() * 3000 + 1500);
                    revenue.push(Math.random() * 4000 + 2000);
                }
            } else if (period === 'custom' && startDate && endDate) {
                // Generate data for custom date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                for (let i = 0; i < diffDays; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    
                    if (diffDays <= 7) {
                        // Show date format for week or less
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    } else if (diffDays <= 31) {
                        // Show day format for month
                        labels.push(`${currentDate.getDate()}日`);
                    } else {
                        // Show month/day for longer periods
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    }
                    
                    // Generate realistic historical data with some trend
                    const basePower = 1000 + Math.sin(i * 0.1) * 500;
                    const baseRevenue = 1500 + Math.sin(i * 0.15) * 700;
                    
                    power.push(Math.max(50, basePower + (Math.random() - 0.5) * 400));
                    revenue.push(Math.max(100, baseRevenue + (Math.random() - 0.5) * 600));
                }
            }
            
            const result = { labels, power, revenue };
            
            // Cache the result for standard periods
            if (period !== 'custom') {
                dataCache.set(cacheKey, result);
            }
            
            return result;
        }

        function updatePowerChartWithData(labels, power, revenue, period) {
            // Get updated translated labels
            const dischargeLabel = window.i18n ? window.i18n.getText('discharge') : '放电';
            const revenueLabel = window.i18n ? window.i18n.getText('totalRevenue') : '收益';
            
            powerChart.setOption({
                legend: {
                    data: [dischargeLabel, revenueLabel]
                },
                xAxis: { 
                    data: labels,
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: labels.length > 15 ? Math.floor(labels.length / 10) : 0
                    }
                },
                series: [
                    { 
                        name: dischargeLabel,
                        data: power 
                    },
                    { 
                        name: revenueLabel,
                        data: revenue 
                    }
                ]
            });
        }


        // Legacy functions for backward compatibility
        function applyCustomDateRange() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.applyCustomDateRange();
            }
        }

        function resetToToday() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.resetToDefault();
            }
        }

        function setQuickRange(days) {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.setQuickRange(days);
            }
        }

        function initializeDateInputs() {
            // This is now handled by the TimeSelector component
            console.log('Date inputs are now managed by TimeSelector component');
        }


        function updatePowerChart() {
            const date = document.getElementById('dateSelect').value;
            
            // Generate new data based on selected date
            const newData = [
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50
            ];
            
            powerChart.setOption({
                series: [{ data: newData }]
            });
        }

        function updatePriceData(region) {
            // Simulate data update based on region
            const basePrice = Math.random() * 100000 + 700000;
            document.getElementById('cumulativePrice').textContent = '$' + Math.floor(basePrice).toLocaleString();
            document.getElementById('forecastCumulative').textContent = '$' + Math.floor(basePrice - 8).toLocaleString();
            
        }

        // Real-time data updates
        function updateRealtimeData() {
            // Get current region from the price circle indicator
            const currentDisplayRegion = document.getElementById('regionIndicator').textContent;
            
            // Update price data based on current region
            updatePriceCircleRegion(currentDisplayRegion);
            
            // Update spot price with animation
            const spotPrice = Math.floor(Math.random() * 100 + 100);
            document.getElementById('spotPrice').textContent = '$' + spotPrice + '.73';
            
            // Update demand
            const demand = Math.floor(Math.random() * 1000 + 7500);
            document.getElementById('currentDemand').textContent = demand.toLocaleString();
            
            // Update power station management data with realistic values
            const baseHomes = 235;
            const basePower = 23547;
            const baseProfit = 12435;
            
            // Add small realistic variations
            const homesVariation = Math.floor((Math.random() - 0.5) * 10); // ±5 homes
            const powerVariation = Math.floor((Math.random() - 0.5) * 500); // ±250 kWh
            const profitVariation = Math.floor((Math.random() - 0.5) * 200); // ±100 dollars
            
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            const unit = currentLang === 'en' ? '' : 
                        currentLang === 'ja' ? '個' :
                        currentLang === 'ko' ? '개' : '个';
            document.getElementById('availableHomes').textContent = (baseHomes + homesVariation);
            document.getElementById('availablePower').textContent = (basePower + powerVariation) + 'kWh';
            document.getElementById('estimatedProfit').textContent = '$' + (baseProfit + profitVariation);
            
            // Add pulse effect to updated values (excluding today's high/low to avoid constant color change)
            const elements = ['currentPrice', 'spotPrice', 'currentDemand'];
            elements.forEach(id => {
                const elem = document.getElementById(id);
                elem.style.transition = 'color 0.3s';
                elem.style.color = '#00ff88';
                setTimeout(() => {
                    elem.style.color = '';
                }, 300);
            });
            
            // Update highest price region
            // updateHighestPriceRegion(); // Removed - using fixed text now
        }

        // Update highest price region display
        function updateHighestPriceRegion() {
            // 使用实际的地区价格数据
            const regionPrices = {
                'NSW': 163,
                'QLD': 34,
                'VIC': 21,
                'SA': 403,
                'TAS': 390
            };
            
            // Find region with highest price
            let highestRegion = 'NSW';
            let highestPrice = regionPrices['NSW'];
            
            for (const [region, price] of Object.entries(regionPrices)) {
                if (price > highestPrice) {
                    highestPrice = price;
                    highestRegion = region;
                }
            }
            
            // Update both displays
            const highestPriceElement = document.getElementById('highestPriceRegion');
            if (highestPriceElement) {
                highestPriceElement.textContent = highestRegion;
            }
            
            // Update the new display in region selection layer
            const highestRegionDisplay = document.getElementById('highestPriceRegionDisplay');
            if (highestRegionDisplay) {
                highestRegionDisplay.textContent = highestRegion;
            }
            
            const highestPriceValueDisplay = document.getElementById('highestPriceValue');
            if (highestPriceValueDisplay) {
                highestPriceValueDisplay.textContent = highestPrice;
            }
        }

        // Initialize Market Chart - Simplified and Reliable Version
        function initMarketChart() {
            const container = document.getElementById('marketChart');
            if (!container) {
                console.error('Market chart container not found!');
                return;
            }
            
            // Dispose existing instance if any
            if (marketChart) {
                marketChart.dispose();
            }
            
            // Wait for container to be visible
            setTimeout(() => {
                // Initialize chart
                marketChart = echarts.init(container, 'dark');
                
                // Force container to have proper dimensions
                container.style.width = '100%';
                container.style.height = '400px';
                
                // Force a reflow to apply the new dimensions
                container.offsetHeight;
            
            const hours = [];
            const prices = [];
            const demands = [];
            const forecastPrices = [];
            const forecastDemands = [];
            const currentTime = new Date().getHours();
            
            // Generate all hours
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
            }
            
            // Real AEMO data provided by user - 25 data points for 24 hours + 1 forecast
            const realPriceData = [78.02, 76.8, 76.10569, 76.57985, 66.84455, 76.8, 76.8, 99.00002, 114, 92.95795, 48.21009, 30, 20, 16, 26, 46, 76.58012, 162.93242, 185.01, 135.92112, 116.50411, 90.50123, 50.35, 49.85281, 61.73511];
            const realDemandData = [8643.99, 8140.06, 7637.91, 7386.94, 7060.29, 7447.28, 7824.33, 8524.53, 8852.48, 8693.11, 7725.83, 7244.6, 6908.53, 6898.11, 7364.28, 8512.75, 9479.01, 9963.7, 10770.01, 10573.32, 10312.64, 9887.83, 9365.22, 8557.16, 8182.48];
            
            let lastPrice = realPriceData[0]; // Start from real data
            let lastDemand = realDemandData[0]; // Start from real data
            
            for (let i = 0; i < 24; i++) {
                if (i < currentTime) {
                    // Historical data - use real data provided
                    const price = realPriceData[i] !== undefined ? realPriceData[i] : lastPrice;
                    const demand = realDemandData[i] !== undefined ? realDemandData[i] : lastDemand;
                    
                    prices.push(price);
                    demands.push(demand);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else if (i === currentTime) {
                    // Current time - use real data and start forecast from here
                    const price = realPriceData[i] !== undefined ? realPriceData[i] : lastPrice;
                    const demand = realDemandData[i] !== undefined ? realDemandData[i] : lastDemand;
                    
                    prices.push(price);
                    demands.push(demand);
                    forecastPrices.push(price); // Start forecast from current actual value
                    forecastDemands.push(demand); // Start forecast from current actual value
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else {
                    // Future time - only forecast data
                    prices.push(null);
                    demands.push(null);
                    
                    // Use real forecast data if available, otherwise generate
                    let forecastPrice, forecastDemand;
                    
                    if (i < realPriceData.length && i < realDemandData.length) {
                        // Use real forecast data
                        forecastPrice = realPriceData[i];
                        forecastDemand = realDemandData[i];
                    } else {
                        // Generate forecast based on last known values
                        const hoursAhead = i - currentTime;
                        const uncertaintyMultiplier = 1 + (hoursAhead * 0.1);
                        const prevForecastPrice = forecastPrices[i-1] || lastPrice;
                        const prevForecastDemand = forecastDemands[i-1] || lastDemand;
                        
                        // Simple trend continuation with some variation
                        const priceVariation = (Math.random() - 0.5) * 20 * uncertaintyMultiplier;
                        const demandVariation = (Math.random() - 0.5) * 500 * uncertaintyMultiplier;
                        
                        forecastPrice = Math.max(-50, prevForecastPrice + priceVariation); // Allow negative prices
                        forecastDemand = Math.max(6000, prevForecastDemand + demandVariation);
                    }
                    
                    forecastPrices.push(forecastPrice);
                    forecastDemands.push(forecastDemand);
                }
            }

                // Get translations
                const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
                const translations = {
                    en: {
                        historicalPrice: 'Historical Price',
                        predictedPrice: 'Predicted Price',
                        demand: 'Demand',
                        predictedDemand: 'Predicted Demand',
                        price: 'Price ($/MWh)',
                        demandUnit: 'Demand (MW)'
                    },
                    zh: {
                        historicalPrice: '历史价格',
                        predictedPrice: '预测价格',
                        demand: '需求',
                        predictedDemand: '预测需求',
                        price: '价格 ($/MWh)',
                        demandUnit: '需求 (MW)'
                    }
                };
                
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        borderColor: '#00ff88',
                        borderWidth: 1,
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            let result = `<div style="font-weight: bold; margin-bottom: 5px;">${params[0].axisValue}</div>`;
                            params.forEach(param => {
                                if (param.value !== null && param.value !== undefined) {
                                    const color = param.color;
                                    const value = param.seriesName.includes(getText('price')) || param.seriesName.includes('Price') 
                                        ? `$${param.value.toFixed ? param.value.toFixed(2) : param.value}` 
                                        : `${param.value.toFixed ? param.value.toFixed(0) : param.value} MW`;
                                    result += `<div>${param.marker} ${param.seriesName}: <strong>${value}</strong></div>`;
                                }
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')],
                        textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                        top: 10
                    },
                    grid: {
                        left: '60',
                        right: '60',
                        bottom: '40',
                        top: '50',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: hours,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                        axisLabel: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            interval: 2,
                            fontSize: 12
                        },
                        splitLine: { show: false }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: getText('price'),
                            nameTextStyle: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'left',
                            axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                            axisLabel: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '${value}'
                            },
                            splitLine: { 
                                lineStyle: { 
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    type: 'dashed'
                                } 
                            }
                        },
                        {
                            type: 'value',
                            name: getText('demandUnit'),
                            nameTextStyle: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'right',
                            axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                            axisLabel: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '{value} MW'
                            },
                        splitLine: { show: false }
                    }
                ],
                    series: [
                        {
                            name: getText('historicalPrice'),
                            type: 'line',
                            data: prices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#00ff88', 
                                width: 3
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                                ])
                            }
                        },
                        {
                            name: getText('demand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: demands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#ffd700', 
                                width: 2
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        },
                        {
                            name: getText('predictedPrice'),
                            type: 'line',
                            data: forecastPrices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#00ff88', 
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.15)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.02)' }
                                ])
                            }
                        },
                        {
                            name: getText('predictedDemand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: forecastDemands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: {
                                color: '#ffd700',
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        }
                    ]
                };

                // Apply configuration
                marketChart.setOption(option);
                
                // Force resize after setting option
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                        console.log('Market chart resized to:', container.offsetWidth, 'x', container.offsetHeight);
                    }
                }, 100);
                
                // Handle resize
                window.addEventListener('resize', () => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                    }
                });
                
                // Force initial resize
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                }, 100);
                
                console.log('Market chart initialized successfully');
            }, 50); // Small delay to ensure container is ready
        }

        // Initialize Australian States Map 
        function initMap() {
            console.log('initMap called');
            const container = document.getElementById('australiaMap');
            if (!container) {
                console.error('australiaMap container not found!');
                return;
            }
            console.log('australiaMap container found, dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            
            try {
                mapChart = echarts.init(container);
                console.log('mapChart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize mapChart:', error);
                return;
            }
            
            // Define Australian states with proper coordinates
            const australianStates = [
                // Main states
                { name: 'NSW', center: [147, -32], color: '#00ff88', radius: 25, deviceCount: 120 },
                { name: 'VIC', center: [144, -37], color: '#00aaff', radius: 20, deviceCount: 100 },
                { name: 'QLD', center: [145, -22], color: '#8A4AFF', radius: 28, deviceCount: 90 },
                { name: 'WA', center: [122, -26], color: '#ffaa00', radius: 30, deviceCount: 70 },
                { name: 'SA', center: [135, -30], color: '#9c27b0', radius: 22, deviceCount: 60 },
                { name: 'TAS', center: [147, -42], color: '#4caf50', radius: 12, deviceCount: 30 },
                { name: 'NT', center: [133, -19], color: '#2196f3', radius: 20, deviceCount: 20 },
                { name: 'ACT', center: [149, -35.3], color: '#ff9800', radius: 8, deviceCount: 10 }
            ];

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'rgba(0, 255, 136, 0.5)',
                    borderWidth: 1,
                    textStyle: { color: '#fff', fontSize: 12 },
                    formatter: function(params) {
                        if (params.seriesType === 'scatter') {
                            if (params.seriesIndex === 1) {
                                // Device points
                                const getStatusText = (status) => {
                                    if (!window.i18n) {
                                        const statusMap = {
                                            'inactive': '待机',
                                            'active': '激活',
                                            'charging': '充电中',
                                            'discharging': '放电中',
                                            'offline': '离线'
                                        };
                                        return statusMap[status] || status;
                                    }
                                    
                                    const statusKeys = {
                                        'inactive': 'inactive',
                                        'active': 'active',
                                        'charging': 'charging',
                                        'discharging': 'discharging',
                                        'offline': 'offline'
                                    };
                                    
                                    return window.i18n.getText(statusKeys[status]) || status;
                                };
                                const deviceText = window.i18n ? window.i18n.getText('device') : '设备';
                                const statusText = window.i18n ? window.i18n.getText('status') : '状态';
                                const regionText = window.i18n ? window.i18n.getText('region') : '区域';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 8px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: #00ff88; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${deviceText} ${params.data.id}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${getStatusText(params.data.status)}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${regionText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.region}</span>
                                    </div>
                                </div>`;
                            } else if (params.seriesIndex === 0) {
                                // State centers
                                const stateText = window.i18n ? window.i18n.getText('state') : '州';
                                const deviceCountText = window.i18n ? window.i18n.getText('deviceCount') : '设备数量';
                                const statusText = window.i18n ? window.i18n.getText('status') : '状态';
                                const normalText = window.i18n ? window.i18n.getText('normalOperation') : '正常运行';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 8px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: ${params.data.color}; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${params.data.name} ${stateText}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${deviceCountText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.deviceCount}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #00ff88; font-weight: 500;">${normalText}</span>
                                    </div>
                                </div>`;
                            }
                        }
                        return '';
                    }
                },
                graphic: [],
                xAxis: {
                    type: 'value',
                    min: 110,
                    max: 160,
                    show: false
                },
                yAxis: {
                    type: 'value',
                    min: -45,
                    max: -10,
                    show: false
                },
                grid: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0
                },
                series: [
                    // Region centers with glowing effect
                    {
                        name: 'States',
                        type: 'scatter',
                        data: australianStates.map(state => ({
                            value: state.center,
                            name: state.name,
                            color: state.color,
                            deviceCount: state.deviceCount,
                            symbolSize: state.radius * 2
                        })),
                        symbol: 'circle',
                        symbolSize: function(value, params) {
                            return params.data.symbolSize;
                        },
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.data.name;
                            },
                            position: 'inside',
                            color: '#000',
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            color: function(params) {
                                return {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.5,
                                    colorStops: [
                                        { offset: 0, color: params.data.color },
                                        { offset: 0.7, color: params.data.color },
                                        { offset: 1, color: 'rgba(255, 255, 255, 0.3)' }
                                    ]
                                };
                            },
                            opacity: 0.8,
                            borderColor: function(params) {
                                return params.data.color;
                            },
                            borderWidth: 3,
                            shadowBlur: 20,
                            shadowColor: function(params) {
                                return params.data.color;
                            }
                        },
                        emphasis: {
                            scale: 1.1,
                            label: {
                                fontSize: 16
                            },
                            itemStyle: {
                                opacity: 1,
                                shadowBlur: 30
                            }
                        },
                        z: 1
                    },
                    // Device network points
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: deviceLocations.map(device => ({
                            value: device.value,
                            id: device.id,
                            status: device.status,
                            region: device.region
                        })),
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            if (status === 'active' || status === 'charging' || status === 'discharging') {
                                return 8;
                            }
                            return status === 'offline' ? 3 : 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging': 
                                    case 'active':
                                        return currentOperation === 'charge' ? '#00ff88' : '#FFD700';
                                    case 'discharging': 
                                        return '#FFD700';
                                    case 'offline': 
                                        return 'rgba(255, 255, 255, 0.2)';
                                    default: 
                                        return 'rgba(255, 255, 255, 0.5)';
                                }
                            },
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                return (status === 'active' || status === 'charging' || status === 'discharging') ? 10 : 3;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging':
                                    case 'active':
                                        return currentOperation === 'charge' ? 'rgba(0, 255, 136, 0.8)' : 'rgba(255, 215, 0, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.5,
                            itemStyle: {
                                shadowBlur: 20,
                                shadowColor: 'rgba(0, 255, 136, 0.9)'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut',
                        z: 2
                    }
                ]
            };

            try {
                mapChart.setOption(option);
                console.log('mapChart option set successfully');
            } catch (error) {
                console.error('Failed to set mapChart option:', error);
                return;
            }
            
            // Update status statistics
            updateMapStatistics();
            
            window.addEventListener('resize', throttle(() => {
                if (mapChart && typeof mapChart.resize === 'function') {
                    mapChart.resize();
                }
            }, 250));
        }
        

        // Generate Australian state device locations (exactly 500 devices)
        function generateDeviceLocations() {
            const locations = [];
            
            const australianStates = [
                { 
                    center: [147, -32], 
                    weight: 120, 
                    name: 'NSW', 
                    spread: 4,
                    cities: ['Sydney', 'Newcastle', 'Wollongong', 'Central Coast', 'Coffs Harbour']
                },
                { 
                    center: [144, -37], 
                    weight: 100, 
                    name: 'VIC', 
                    spread: 3,
                    cities: ['Melbourne', 'Geelong', 'Ballarat', 'Bendigo', 'Shepparton']
                },
                { 
                    center: [145, -22], 
                    weight: 90, 
                    name: 'QLD', 
                    spread: 6,
                    cities: ['Brisbane', 'Gold Coast', 'Townsville', 'Cairns', 'Sunshine Coast']
                },
                { 
                    center: [122, -26], 
                    weight: 70, 
                    name: 'WA', 
                    spread: 8,
                    cities: ['Perth', 'Fremantle', 'Bunbury', 'Albany', 'Kalgoorlie']
                },
                { 
                    center: [135, -30], 
                    weight: 60, 
                    name: 'SA', 
                    spread: 4,
                    cities: ['Adelaide', 'Mount Gambier', 'Whyalla', 'Murray Bridge', 'Port Lincoln']
                },
                { 
                    center: [147, -42], 
                    weight: 30, 
                    name: 'TAS', 
                    spread: 2,
                    cities: ['Hobart', 'Launceston', 'Devonport', 'Burnie', 'Ulverstone']
                },
                { 
                    center: [133, -19], 
                    weight: 20, 
                    name: 'NT', 
                    spread: 5,
                    cities: ['Darwin', 'Alice Springs', 'Katherine', 'Palmerston', 'Tennant Creek']
                },
                { 
                    center: [149, -35.3], 
                    weight: 10, 
                    name: 'ACT', 
                    spread: 0.5,
                    cities: ['Canberra', 'Queanbeyan', 'Belconnen', 'Tuggeranong', 'Gungahlin']
                }
            ];
            
            // Calculate total weight for distribution
            const totalWeight = australianStates.reduce((sum, state) => sum + state.weight, 0);
            
            // Generate exactly 500 devices
            for (let i = 0; i < 500; i++) {
                // Select state based on weight distribution
                let randomWeight = Math.random() * totalWeight;
                let selectedState = australianStates[0];
                
                for (const state of australianStates) {
                    randomWeight -= state.weight;
                    if (randomWeight <= 0) {
                        selectedState = state;
                        break;
                    }
                }
                
                // Generate random point within state spread
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * selectedState.spread;
                
                const longitude = selectedState.center[0] + distance * Math.cos(angle);
                const latitude = selectedState.center[1] + distance * Math.sin(angle);
                
                // Assign random initial status for realistic distribution
                let initialStatus = 'inactive'; // Default
                const rand = Math.random();
                if (rand < 0.05) {
                    initialStatus = 'offline';  // 5% offline
                } else if (rand < 0.12) {
                    initialStatus = 'discharging';  // 7% discharging
                } else if (rand < 0.18) {
                    initialStatus = 'charging';  // 6% charging
                }
                // 82% remain as inactive/standby

                // Select random city from state
                const randomCity = selectedState.cities[Math.floor(Math.random() * selectedState.cities.length)];

                locations.push({
                    value: [longitude, latitude],
                    id: i,
                    status: initialStatus,
                    region: selectedState.name,
                    city: randomCity
                });
            }
            
            return locations;
        }

        // Interactive functions with proper state management and confirmation
        function handleCharge() {
            console.log('=== handleCharge Debug ===');
            console.log('handleCharge called');
            console.log('currentOperation:', currentOperation);
            console.log('typeof currentOperation:', typeof currentOperation);
            console.log('selectedMainRegion:', selectedMainRegion);
            console.log('Region operation status:', getRegionOperationStatus(selectedMainRegion));
            console.log('Button element:', document.getElementById('chargeBtn'));
            console.log('=========================');
            
            // 确保 currentOperation 是 null 而不是 undefined 或其他值
            if (currentOperation === null || currentOperation === undefined) {
                // 没有当前操作，可以开始充电
                console.log('No current operation, showing charge confirmation');
                showOperationConfirmation('charge');
            } else if (currentOperation === 'charge') {
                // 当前正在充电，显示停止确认
                console.log('Currently charging, showing stop confirmation');
                showStopConfirmation();
            } else if (currentOperation === 'discharge') {
                // 正在放电时不能充电
                console.log('Cannot charge while discharging');
                return;
            } else {
                // 未知状态，重置并显示充电确认
                console.log('Unknown operation state:', currentOperation, ', resetting and showing charge confirmation');
                currentOperation = null;
                showOperationConfirmation('charge');
            }
        }
        
        // 将函数暴露到全局作用域
        window.handleCharge = handleCharge;

        function handleDischarge() {
            console.log('=== handleDischarge Debug ===');
            console.log('handleDischarge called');
            console.log('currentOperation:', currentOperation);
            console.log('typeof currentOperation:', typeof currentOperation);
            console.log('selectedMainRegion:', selectedMainRegion);
            console.log('Region operation status:', getRegionOperationStatus(selectedMainRegion));
            console.log('Button element:', document.getElementById('dischargeBtn'));
            console.log('=============================');
            
            // 确保 currentOperation 是 null 而不是 undefined 或其他值
            if (currentOperation === null || currentOperation === undefined) {
                // 没有当前操作，可以开始放电
                console.log('No current operation, showing discharge confirmation');
                showOperationConfirmation('discharge');
            } else if (currentOperation === 'discharge') {
                // 当前正在放电，显示停止确认
                console.log('Currently discharging, showing stop confirmation');
                showStopConfirmation();
            } else if (currentOperation === 'charge') {
                // 正在充电时不能放电
                console.log('Cannot discharge while charging');
                return;
            } else {
                // 未知状态，重置并显示放电确认
                console.log('Unknown operation state:', currentOperation, ', resetting and showing discharge confirmation');
                currentOperation = null;
                showOperationConfirmation('discharge');
            }
        }
        
        // 将函数暴露到全局作用域
        window.handleDischarge = handleDischarge;
        
        // 添加全局调试函数
        window.debugOperationState = function() {
            console.log('=== Operation State Debug ===');
            console.log('currentOperation:', currentOperation);
            console.log('selectedMainRegion:', selectedMainRegion);
            console.log('Region operation status:', getRegionOperationStatus(selectedMainRegion));
            console.log('Charge button:', document.getElementById('chargeBtn'));
            console.log('Discharge button:', document.getElementById('dischargeBtn'));
            console.log('Charge button onclick:', document.getElementById('chargeBtn')?.onclick);
            console.log('Discharge button onclick:', document.getElementById('dischargeBtn')?.onclick);
            console.log('window.handleCharge:', window.handleCharge);
            console.log('window.handleDischarge:', window.handleDischarge);
            console.log('===========================');
        };

        // 新的操作启动函数
        function startOperation(operationType) {
            console.log('Starting operation:', operationType);
            
            // 重置弹窗关闭标志
            window.deviceResponseModalClosed = false;
            
            // 设置当前操作
            currentOperation = operationType;
            
            // 确保有选中的地区，如果没有则默认选择NSW
            if (!selectedMainRegion) {
                selectedMainRegion = 'NSW';
                // 更新UI显示
                const nswTab = document.querySelector('.region-select-tab[data-region="NSW"]');
                if (nswTab) {
                    selectMainRegion('NSW', nswTab);
                }
            }
            
            // 更新当前地区的操作状态
            updateRegionOperationStatus(selectedMainRegion, operationType === 'charge' ? 'charging' : 'discharging');
            
            // 更新地区状态指示器
            updateRegionStatusIndicators();
            
            // 立即更新价格圆圈颜色
            updatePriceCircleColor();
            
            // 更新电站管理标题的状态文字
            const statusText = document.getElementById('regionStatusText');
            if (statusText) {
                if (operationType === 'charge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('charging') : '充电中';
                    statusText.style.color = '#00ff88';
                    statusText.style.background = 'rgba(0, 255, 136, 0.1)';
                    statusText.style.border = '1px solid rgba(0, 255, 136, 0.3)';
                    statusText.style.display = 'inline-block';
                } else if (operationType === 'discharge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('discharging') : '放电中';
                    statusText.style.color = '#FFC107';
                    statusText.style.background = 'rgba(255, 193, 7, 0.1)';
                    statusText.style.border = '1px solid rgba(255, 193, 7, 0.3)';
                    statusText.style.display = 'inline-block';
                }
            }
            
            // 更新按钮状态
            updateButtonsForOperation(operationType);
            
            // 切换到地图视图
            switchPanel('map');
            
            // 启动设备动画
            setTimeout(() => {
                startDeviceAnimation();
            }, 300);
            
            // 添加备用定时器，确保统计弹窗显示（如果动画未正常完成）
            // 设置为10秒后显示，正常情况下动画会在约13秒内完成
            if (operationType === 'discharge' || operationType === 'charge') {
                const fallbackTimer = setTimeout(() => {
                    // 检查是否已经显示了统计弹窗，并且操作没有被手动停止
                    const modal = document.getElementById('deviceResponseModal');
                    const progressText = document.getElementById('progressPercent')?.textContent || '0%';
                    const currentProgress = parseInt(progressText.replace('%', '')) || 0;
                    
                    // 只有当操作仍在进行中、弹窗未显示、且进度达到100%时才显示
                    if (modal && modal.style.display === 'none' && currentOperation && currentOperation === operationType && currentProgress >= 100) {
                        console.log('Fallback: Showing operation statistics after timeout (progress: ' + currentProgress + '%)');
                        showOperationStatistics();
                    } else if (currentProgress < 100) {
                        console.log('Fallback timer: Progress only at ' + currentProgress + '%, not showing statistics yet');
                    }
                }, 10000); // 10秒后触发
                
                // 保存定时器引用，以便在停止操作时清除
                window.operationFallbackTimer = fallbackTimer;
            }
        }
        
        // 更新按钮状态
        function updateButtonsForOperation(operationType) {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge') {
                // 充电状态：隐藏两个按钮
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
            } else if (operationType === 'discharge') {
                // 放电状态：隐藏两个按钮
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
            }
        }

        // 停止确认弹窗
        function showStopConfirmation() {
            // 使用标准的停止确认弹窗，不显示预计收益
            showStopConfirmationModal();
        }
        
        // 停止操作
        function stopOperation() {
            console.log('Stopping operation:', currentOperation);
            
            // 停止动画
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
                console.log('Map animation interval cleared');
            }
            
            // 重置当前操作状态
            currentOperation = null;
            
            // 重置按钮状态
            resetButtons();
            
            // 恢复大圆显示价格
            const priceDisplay = document.getElementById('priceDisplay');
            const stopDisplay = document.getElementById('stopDisplay');
            if (priceDisplay) priceDisplay.style.display = 'block';
            if (stopDisplay) {
                stopDisplay.style.display = 'none';
                stopDisplay.style.opacity = '0';
            }
            
            // 确保按钮事件处理器正确绑定
            setTimeout(() => {
                const chargeBtn = document.getElementById('chargeBtn');
                const dischargeBtn = document.getElementById('dischargeBtn');
                if (chargeBtn) {
                    chargeBtn.onclick = handleCharge;
                    console.log('Charge button handler reattached after stop');
                }
                if (dischargeBtn) {
                    dischargeBtn.onclick = handleDischarge;
                    console.log('Discharge button handler reattached after stop');
                }
            }, 100);
            
            // 显示操作统计
            setTimeout(() => {
                console.log('Showing operation statistics after stop');
                showOperationStatistics();
            }, 200);
        }

        // 重置确认弹窗内容避免布局混乱
        function resetConfirmationModal() {
            const confirmModal = document.getElementById('confirmationModal');
            if (!confirmModal) return;
            
            // 关闭并重置弹窗
            confirmModal.classList.remove('show');
            confirmModal.style.display = 'none';
            confirmModal.style.opacity = '0';
            
            // 移除之前动态添加的收益行
            const confirmInfoGrid = document.getElementById('confirmInfoGrid');
            if (confirmInfoGrid) {
                // 移除所有动态添加的行（包括任何包含预计收益的行）
                const dynamicRows = confirmInfoGrid.querySelectorAll('div[style*="margin-top"]');
                dynamicRows.forEach(row => row.remove());
                
                // 额外检查：移除任何包含预计收益的元素
                const profitElements = confirmInfoGrid.querySelectorAll('[data-i18n="estimatedProfit"]');
                profitElements.forEach(element => {
                    const parentRow = element.closest('div[style*="flex"]');
                    if (parentRow && parentRow.parentElement === confirmInfoGrid) {
                        parentRow.remove();
                    }
                });
            }
            
            // 重置所有信息项为可见
            const allInfoItems = confirmModal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
        }

        // Show operation confirmation modal
        function showOperationConfirmation(operationType) {
            console.log('showOperationConfirmation called with:', operationType);
            pendingOperation = operationType;
            
            // 重置弹窗内容避免布局混乱
            resetConfirmationModal();
            
            // Store current panel state before showing confirmation
            const activePanel = document.querySelector('.panel-content.active');
            if (activePanel) {
                if (activePanel.id === 'marketPanel') {
                    previousPanel = 'market';
                } else if (activePanel.id === 'mapPanel') {
                    previousPanel = 'map';
                }
            }
            
            // Get current data for confirmation
            const currentPrice = document.getElementById('currentPrice').textContent;
            const deviceCount = 500;
            const estimatedPower = (deviceCount * 6) / 1000; // 6kW per device, convert to MW
            
            // Update confirmation modal content
            const confirmModal = document.getElementById('confirmationModal');
            // 使用i18n获取操作名称
            const getOperationName = (type) => {
                return window.i18n ? window.i18n.getText(type) : (type === 'charge' ? '充电' : '放电');
            };
            
            const operationColors = {
                'charge': '#00ff88',
                'discharge': '#ffd700'
            };
            
            // Update modal icon and color based on operation type
            const confirmIcon = document.getElementById('confirmIcon');
            const modalIcon = confirmIcon.parentElement;
            
            if (operationType === 'charge') {
                confirmIcon.textContent = '⚡';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(0, 255, 136, 0.15)';
                document.getElementById('confirmOperationType').style.color = '#00ff88';
            } else if (operationType === 'discharge') {
                confirmIcon.textContent = '🔋';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.15)';
                document.getElementById('confirmOperationType').style.color = '#ffd700';
            }
            
            // 使用i18n获取警告消息
            const getWarningMessage = (type) => {
                if (!window.i18n) {
                    return type === 'charge' ? 
                        '将开始对所有连接设备进行充电操作，此过程将消耗电网电力。' :
                        '将开始对所有连接设备进行放电操作，向电网输送电力以获取收益。';
                }
                
                const messages = {
                    'zh': {
                        'charge': '将开始对所有连接设备进行充电操作，此过程将消耗电网电力。',
                        'discharge': '将开始对所有连接设备进行放电操作，向电网输送电力以获取收益。'
                    },
                    'en': {
                        'charge': 'Will start charging all connected devices, this process will consume grid power.',
                        'discharge': 'Will start discharging all connected devices, sending power to the grid for revenue.'
                    },
                    'ja': {
                        'charge': '接続されたすべてのデバイスの充電を開始します。このプロセスでは電力網の電力を消費します。',
                        'discharge': '接続されたすべてのデバイスの放電を開始し、収益のために電力網に電力を送信します。'
                    },
                    'ko': {
                        'charge': '연결된 모든 장치의 충전을 시작합니다. 이 과정에서 전력망 전력을 소모합니다.',
                        'discharge': '연결된 모든 장치의 방전을 시작하여 수익을 위해 전력망에 전력을 보냅니다.'
                    }
                };
                
                const currentLang = window.i18n.getCurrentLanguage();
                return messages[currentLang] && messages[currentLang][type] ? 
                    messages[currentLang][type] : messages['zh'][type];
            };
            
            const operationName = getOperationName(operationType);
            const confirmTitleTexts = {
                'zh': `确认${operationName}操作`,
                'en': `Confirm ${operationName} Operation`,
                'ja': `${operationName}操作を確認`,
                'ko': `${operationName} 작업 확인`
            };
            const confirmMessageTexts = {
                'zh': `您确定要执行${operationName}操作吗？`,
                'en': `Are you sure to execute ${operationName} operation?`,
                'ja': `${operationName}操作を実行してもよろしいですか？`,
                'ko': `${operationName} 작업을 실행하시겠습니까?`
            };
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            
            document.getElementById('confirmTitle').textContent = confirmTitleTexts[currentLang] || confirmTitleTexts['zh'];
            document.getElementById('confirmMessage').textContent = confirmMessageTexts[currentLang] || confirmMessageTexts['zh'];
            document.getElementById('confirmOperationType').textContent = operationName;
            
            const deviceTexts = {
                'zh': deviceCount + '个',
                'en': deviceCount.toString(), // 英文模式只显示数字
                'ja': deviceCount + '台',
                'ko': deviceCount + '대'
            };
            document.getElementById('confirmTargetDevices').textContent = deviceTexts[currentLang] || deviceTexts['zh'];
            
            // 首先重置所有信息项为可见状态
            const allInfoItems = confirmModal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // Remove any dynamically added rows from previous operations
            const confirmInfoGrid = document.getElementById('confirmInfoGrid');
            const dynamicRows = confirmInfoGrid.querySelectorAll('div[style*="margin-top"]');
            dynamicRows.forEach(row => row.remove());
            
            // Hide/show fields based on user requirements
            const estimatedPowerEl = document.getElementById('confirmEstimatedPower');
            const currentPriceEl = document.getElementById('confirmCurrentPrice');
            const durationEl = document.getElementById('confirmDuration');
            const costBenefitEl = document.getElementById('confirmCostBenefit');
            
            const estimatedPowerItem = estimatedPowerEl ? estimatedPowerEl.parentElement : null;
            const currentPriceItem = currentPriceEl ? currentPriceEl.parentElement : null;
            const durationItem = durationEl ? durationEl.parentElement : null;
            const costBenefitItem = costBenefitEl ? costBenefitEl.parentElement : null;
            
            // 判断是否为停止操作
            const isStopOperation = operationType.includes('stop') || pendingOperation.includes('stop');
            
            if (operationType === 'charge' || isStopOperation) {
                // For charge and stop operations: hide all profit-related fields
                if (estimatedPowerItem) estimatedPowerItem.style.display = 'none';
                if (currentPriceItem) currentPriceItem.style.display = 'none';
                if (durationItem) durationItem.style.display = 'none';
                if (costBenefitItem) costBenefitItem.style.display = 'none';
            } else if (operationType === 'discharge' && !isStopOperation) {
                // For discharge only (not stop discharge): show predicted profit
                if (estimatedPowerItem) estimatedPowerItem.style.display = 'none';
                if (currentPriceItem) currentPriceItem.style.display = 'none';
                if (durationItem) durationItem.style.display = 'none';
                if (costBenefitItem) costBenefitItem.style.display = 'none';
                
                const profitRow = document.createElement('div');
                profitRow.style.cssText = 'display: flex; gap: 20px; margin-top: 20px;';
                const profitLabel = window.i18n ? window.i18n.getText('estimatedProfit') : '预计收益';
                profitRow.innerHTML = `
                    <div class="modal-info-item" style="flex: 1; max-width: calc(50% - 10px); background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s; display: flex; flex-direction: column;">
                        <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n="estimatedProfit">${profitLabel}</div>
                        <div class="modal-info-value" style="color: #ffd700; font-size: 20px; font-weight: 600;">+$${Math.floor(estimatedPower * parseInt(currentPrice.replace('$', '')) * 0.7)}</div>
                    </div>
                    <div style="flex: 1;"></div>
                `;
                confirmInfoGrid.appendChild(profitRow);
            }
            
            // Update warning message
            document.getElementById('warningText').textContent = getWarningMessage(operationType);
            
            // Update execute button
            const executeBtn = document.getElementById('confirmExecuteBtn');
            const executeBtnTexts = {
                'zh': `确认${operationName}`,
                'en': `Confirm ${operationName}`,
                'ja': `${operationName}確認`,
                'ko': `${operationName} 확인`
            };
            executeBtn.textContent = executeBtnTexts[currentLang] || executeBtnTexts['zh'];
            
            if (operationType === 'discharge') {
                executeBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffcc00)';
                executeBtn.style.color = '#000';
                executeBtn.onmouseover = function() { 
                    this.style.transform='translateY(-1px)'; 
                    this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
                executeBtn.onmouseout = function() { 
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 16px rgba(255, 215, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
            } else if (operationType === 'charge') {
                // Charge按钮使用绿色
                executeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00dd77)';
                executeBtn.style.color = '#000';
                executeBtn.onmouseover = function() { 
                    this.style.transform='translateY(-1px)'; 
                    this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
                executeBtn.onmouseout = function() { 
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
            } else {
                // 其他操作（停止等）使用红色
                executeBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                executeBtn.style.color = '#fff';
            }
            
            // Show modal with animation
            confirmModal.classList.add('show');
            confirmModal.style.display = 'flex';
            
            // Add fade-in animation
            setTimeout(() => {
                confirmModal.style.opacity = '1';
            }, 10);
        }


        // Close confirmation modal
        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
            pendingOperation = null;
            
            // Don't change panel view when canceling - keep current state
            // This ensures the UI stays in the same state when user cancels
        }

        // Execute confirmed operation
        function executeConfirmedOperation() {
            if (!pendingOperation) return;
            
            const operationType = pendingOperation;
            closeConfirmationModal();
            
            console.log('Executing confirmed operation:', operationType);
            
            if (operationType === 'stop' || operationType.startsWith('stop_')) {
                // Execute stop operation
                executeStopOperation();
            } else {
                // Execute start operation
                startOperation(operationType);
                
                // 确保价格圆圈颜色立即更新
                setTimeout(() => {
                    updatePriceCircleColor();
                    console.log('Price circle color updated after operation start');
                }, 100);
            }
            
            pendingOperation = null;
        }

        // Execute the actual operation after confirmation
        function executeOperation(operationType) {
            console.log('executeOperation called with:', operationType); // Debug log
            
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            currentOperation = operationType;
            console.log('currentOperation set to:', currentOperation); // Debug log
            
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge') {
                // 隐藏两个按钮
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
                
                // 不更改显示，保持价格显示
                
                // Switch to map view only after confirmation
                console.log('Switching to map panel...'); // Debug log
                switchPanel('map');
                console.log('Map panel switched, starting device animation...'); // Debug log
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            } else if (operationType === 'discharge') {
                // 隐藏两个按钮
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
                
                // 不更改显示，保持价格显示
                
                // Switch to map view only after confirmation
                console.log('Switching to map panel...'); // Debug log
                switchPanel('map');
                console.log('Map panel switched, starting device animation...'); // Debug log
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            }
        }


        function showDetail(type) {
            console.log('Showing detail for:', type);
            // Add detail view logic here
        }

        // Panel switching functions
        function switchPanel(panel, button) {
            console.log('switchPanel called with panel:', panel); // Debug log
            // Update panel visibility
            document.querySelectorAll('.panel-content').forEach(p => {
                p.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(panel + 'Panel');
            console.log('Target panel found:', !!targetPanel); // Debug log
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Panel', panel, 'activated successfully'); // Debug log
            }
            
            // Update button states - always update, even if button not provided
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the correct tab button
            if (button) {
                button.classList.add('active');
            } else {
                // If no button provided, find the tab by panel name
                const targetTab = Array.from(document.querySelectorAll('.panel-tab')).find(tab => {
                    const onclick = tab.getAttribute('onclick');
                    return onclick && onclick.includes(`'${panel}'`);
                });
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Auto-selected tab for panel:', panel);
                }
            }
            
            // Resize charts after switching
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 100);
            
            // Additional resize with longer delay to ensure proper rendering
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 300);
        }

        // Market region switching
        function switchMarketRegion(region, button) {
            // Update active button
            document.querySelectorAll('#marketPanel .region-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update current region
            currentRegion = region;
            
            // Update market chart with new data
            updateMarketChart(region);
            
            // Update power station management module prices
            updatePriceCircleRegion(region);
            
            // Sync cumulative price region selector
            const cumulativeTabs = document.querySelectorAll('.glass .region-tab');
            cumulativeTabs.forEach(tab => {
                if (tab.textContent === region) {
                    tab.classList.add('active');
                    // Trigger cumulative region update
                    switchCumulativeRegion(region, tab);
                } else {
                    tab.classList.remove('active');
                }
            });
        }
        
        // Update price circle region
        function updatePriceCircleRegion(region) {
            document.getElementById('regionIndicator').textContent = region;
            
            // 各地区固定价格
            const regionPrices = {
                'NSW': 163,
                'QLD': 34,
                'VIC': 21,
                'SA': 403,
                'TAS': 390
            };
            
            const price = regionPrices[region] || 163; // 默认NSW价格
            document.getElementById('currentPrice').textContent = '$' + price;
            
            // Add smooth transition effect
            const priceElement = document.getElementById('currentPrice');
            priceElement.style.transition = 'color 0.3s ease';
            priceElement.style.color = '#00ff88';
            setTimeout(() => {
                priceElement.style.color = '#fff';
            }, 300);
        }

        function updateMarketChart(region) {
            // Check cache first
            const currentHour = new Date().getHours();
            const cacheKey = `marketChart_${region}_${currentHour}`;
            
            const cached = dataCache.get(cacheKey);
            if (cached) {
                marketChart.setOption(cached);
                return;
            }
            
            // Generate new data based on region
            const hours = [];
            const actualPrices = [];
            const actualDemands = [];
            const forecastPrices = [];
            const forecastDemands = [];
            const currentTime = new Date().getHours();
            
            let lastPrice = 150;
            let lastDemand = 7500;
            
            // Single loop to handle all data generation correctly
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
                
                if (i < currentTime) {
                    // Historical data before current time
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    actualPrices.push(price);
                    actualDemands.push(demand);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else if (i === currentTime) {
                    // Current time - both actual and forecast data for seamless connection
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    actualPrices.push(price);
                    actualDemands.push(demand);
                    forecastPrices.push(price); // Start forecast from current actual value
                    forecastDemands.push(demand); // Start forecast from current actual value
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else {
                    // Future data - no actual data, only forecast
                    actualPrices.push(null);
                    actualDemands.push(null);
                    
                    // Generate realistic market forecast with regional characteristics
                    const hoursAhead = i - currentTime;
                    const uncertaintyMultiplier = 1 + (hoursAhead * 0.15); // Uncertainty grows over time
                    
                    // Regional price characteristics
                    const regionMultipliers = {
                        'NSW': { volatility: 1.2, trend: 0.05 },
                        'QLD': { volatility: 0.9, trend: -0.02 },
                        'VIC': { volatility: 1.1, trend: 0.03 },
                        'SA': { volatility: 1.4, trend: 0.08 },
                        'TAS': { volatility: 0.7, trend: -0.01 }
                    };
                    
                    const currentRegionData = regionMultipliers[region] || regionMultipliers['NSW'];
                    
                    // Price forecast with market dynamics
                    const priceBaseVariation = (Math.random() - 0.5) * 25 * uncertaintyMultiplier * currentRegionData.volatility;
                    const priceMarketTrend = currentRegionData.trend * hoursAhead * 10;
                    const pricePeakHours = i >= 17 && i <= 21 ? 15 + Math.random() * 20 : 0; // Evening peak
                    const priceVolatilityEvent = Math.random() < 0.15 ? (Math.random() - 0.5) * 100 : 0;
                    
                    const totalPriceVariation = priceBaseVariation + priceMarketTrend + pricePeakHours + priceVolatilityEvent;
                    const prevForecastPrice = forecastPrices[i-1];
                    
                    // Demand forecast with consumption patterns
                    const demandBaseVariation = (Math.random() - 0.5) * 500 * uncertaintyMultiplier;
                    const demandBusinessHours = (i >= 8 && i <= 18) ? 300 + Math.random() * 400 : -(Math.random() * 200);
                    const demandTemperatureFactor = (Math.random() - 0.5) * 800;
                    const demandIndustrialEvent = Math.random() < 0.12 ? (Math.random() - 0.5) * 1200 : 0;
                    
                    const totalDemandVariation = demandBaseVariation + demandBusinessHours + demandTemperatureFactor + demandIndustrialEvent;
                    const prevForecastDemand = forecastDemands[i-1];
                    
                    forecastPrices.push(Math.max(25, Math.min(500, prevForecastPrice + totalPriceVariation)));
                    forecastDemands.push(Math.max(3000, Math.min(15000, prevForecastDemand + totalDemandVariation)));
                }
            }
            
            const chartOption = {
                xAxis: { data: hours },
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('price') : '价格',
                        window.i18n ? window.i18n.getText('demand') : '需求', 
                        window.i18n ? window.i18n.getText('predictedPrice') : '预测价格',
                        window.i18n ? window.i18n.getText('predictedDemand') : '预测需求'
                    ],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 0
                },
                series: [
                    { 
                        data: actualPrices,
                        name: window.i18n ? window.i18n.getText('price') : 'Price'
                    },      // Historical prices
                    { 
                        data: actualDemands,
                        name: window.i18n ? window.i18n.getText('demand') : 'Demand'
                    },     // Historical demands  
                    { 
                        data: forecastPrices,
                        name: window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price'
                    },    // Forecast prices
                    { 
                        data: forecastDemands,
                        name: window.i18n ? window.i18n.getText('predictedDemand') : 'Predicted Demand'
                    }    // Forecast demands
                ]
            };
            
            // Cache the chart option (cache for 1 hour since market data changes)
            dataCache.set(cacheKey, chartOption);
            marketChart.setOption(chartOption);
        }

        // Auto switch functionality
        // 自动切换功能已移除
        // function toggleAutoSwitch() { }
        // function startAutoSwitch() { }
        // function stopAutoSwitch() { }

        // 处理停止操作
        function handleStop() {
            console.log('handleStop called');
            // 显示停止确认弹窗
            showStopConfirmationModal();
        }
        
        // 将函数暴露到全局作用域
        window.handleStop = handleStop;
        
        // 主圆圈悬停处理
        function handleMainCircleHover() {
            // 只在充电或放电状态时显示停止
            if (currentOperation === 'charge' || currentOperation === 'discharge') {
                const priceDisplay = document.getElementById('priceDisplay');
                const stopDisplay = document.getElementById('stopDisplay');
                const mainCircle = document.getElementById('mainPriceCircle');
                const hoverOverlay = document.getElementById('hoverOverlay');
                
                // 隐藏价格显示
                if (priceDisplay) {
                    priceDisplay.style.opacity = '0';
                }
                
                // 显示停止文本
                if (stopDisplay) {
                    stopDisplay.style.display = 'block';
                    setTimeout(() => {
                        stopDisplay.style.opacity = '1';
                    }, 10);
                }
                
                // 显示红色覆盖层
                if (hoverOverlay) {
                    hoverOverlay.style.opacity = '1';
                }
                
                if (mainCircle) {
                    mainCircle.style.transform = 'scale(1.05)';
                }
            }
        }
        
        // 主圆圈鼠标离开处理
        function handleMainCircleLeave() {
            const priceDisplay = document.getElementById('priceDisplay');
            const stopDisplay = document.getElementById('stopDisplay');
            const mainCircle = document.getElementById('mainPriceCircle');
            const hoverOverlay = document.getElementById('hoverOverlay');
            
            // 隐藏停止文本
            if (stopDisplay) {
                stopDisplay.style.opacity = '0';
                setTimeout(() => {
                    stopDisplay.style.display = 'none';
                }, 300);
            }
            
            // 恢复价格显示
            if (priceDisplay) {
                priceDisplay.style.opacity = '1';
            }
            
            // 隐藏红色覆盖层
            if (hoverOverlay) {
                hoverOverlay.style.opacity = '0';
            }
            
            if (mainCircle) {
                mainCircle.style.transform = 'scale(1)';
            }
            
            // 恢复原来的颜色
            updatePriceCircleColor();
        }
        
        // 主圆圈点击处理
        function handleMainCircleClick() {
            // 只在充电或放电状态时响应点击
            if (currentOperation === 'charge' || currentOperation === 'discharge') {
                // 显示停止确认弹窗
                showStopConfirmation();
            }
        }
        
        // 暴露函数到全局
        window.handleMainCircleHover = handleMainCircleHover;
        window.handleMainCircleLeave = handleMainCircleLeave;
        window.handleMainCircleClick = handleMainCircleClick;
        
        function showStopConfirmationModal() {
            // 首先重置弹窗，确保没有预计收益
            resetConfirmationModal();
            
            // 根据当前操作确定停止类型
            const currentOp = currentOperation || 'charge'; // 默认为充电
            const isCharging = currentOp === 'charge';
            
            // 使用 confirmationModal 以保持与充电弹窗一致的样式
            const modal = document.getElementById('confirmationModal');
            if (!modal) {
                console.error('confirmationModal not found');
                return;
            }
            
            // 首先重置所有信息项为可见状态
            const allInfoItems = modal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // 设置弹窗内容
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOperationType = document.getElementById('confirmOperationType');
            const confirmTargetDevices = document.getElementById('confirmTargetDevices');
            const warningText = document.getElementById('warningText');
            const confirmExecuteBtn = document.getElementById('confirmExecuteBtn');
            const confirmIcon = document.getElementById('confirmIcon');
            
            // 设置图标和标题
            if (confirmIcon) confirmIcon.textContent = '🛑';
            
            // Update modal icon style for stop operation
            const modalIcon = confirmIcon.parentElement;
            if (modalIcon) {
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 68, 68, 0.15), rgba(255, 68, 68, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 68, 68, 0.15)';
            }
            
            // Update operation type card color for stop
            const operationTypeElement = document.getElementById('confirmOperationType');
            if (operationTypeElement) {
                operationTypeElement.style.color = '#ff4444';
            }
            
            if (isCharging) {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopChargeTitle') : '确认停止充电';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopChargeMessage') : '您确定要停止充电操作吗？';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopCharge') : '停止充电';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopCharge') : '确认停止充电';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopChargeWarning') : '停止操作将立即终止所有设备的充电状态，设备将恢复到待机模式。';
            } else {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeTitle') : '确认停止放电';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeMessage') : '您确定要停止放电操作吗？';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopDischarge') : '停止放电';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopDischarge') : '确认停止放电';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopDischargeWarning') : '停止操作将立即终止所有设备的放电状态，设备将恢复到待机模式。';
            }
            
            // 设置影响设备数量
            if (confirmTargetDevices) {
                const deviceCount = window.i18n && window.i18n.getCurrentLanguage() === 'en' ? '500' : '500个';
                confirmTargetDevices.textContent = deviceCount;
            }
            
            // 隐藏其他不需要的信息项
            const estimatedPowerItem = document.getElementById('confirmEstimatedPower');
            const currentPriceItem = document.getElementById('confirmCurrentPrice');
            const durationItem = document.getElementById('confirmDuration');
            const costBenefitItem = document.getElementById('confirmCostBenefit');
            
            if (estimatedPowerItem && estimatedPowerItem.parentElement) {
                estimatedPowerItem.parentElement.style.display = 'none';
            }
            if (currentPriceItem && currentPriceItem.parentElement) {
                currentPriceItem.parentElement.style.display = 'none';
            }
            if (durationItem && durationItem.parentElement) {
                durationItem.parentElement.style.display = 'none';
            }
            if (costBenefitItem && costBenefitItem.parentElement) {
                costBenefitItem.parentElement.style.display = 'none';
            }
            
            // 设置pending operation为停止操作
            pendingOperation = 'stop';
            
            // 显示弹窗
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            // 添加模态框打开动画
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }
        
        function executeStopOperation() {
            console.log('执行停止操作');
            
            // 调用停止操作函数，它会处理所有的状态重置和UI更新
            stopOperation();
        }
        
        // Enhanced device animation with wave effect
        function startDeviceAnimation() {
            console.log('startDeviceAnimation called'); // Debug log
            console.log('mapChart exists:', !!mapChart); // Debug log
            console.log('deviceLocations length:', deviceLocations.length); // Debug log
            
            activatedDevices = 0;
            const totalDevices = 500;
            
            // Clear previous animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
                console.log('Cleared previous animation interval'); // Debug log
            }
            
            // Update UI
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('activeDevices').textContent = activatedDevices;
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentOperationText').textContent = 
                currentOperation === 'charge' ? 
                (window.i18n ? window.i18n.getText('charging') : '充电中') : 
                (window.i18n ? window.i18n.getText('discharging') : '放电中');
            
            let animationStep = 0;
            const maxSteps = totalDevices / 3; // Complete animation in ~167 steps
            
            // Start wave animation
            mapAnimationInterval = setInterval(() => {
                if (animationStep < maxSteps) {
                    // Create wave effect - activate 2-4 devices per step with some randomness
                    const baseActivation = Math.floor(3 + Math.random() * 2); // 3-4 devices
                    const waveBonus = Math.sin((animationStep / maxSteps) * Math.PI * 2) * 2; // Wave pattern
                    const actualActivation = Math.max(1, Math.floor(baseActivation + waveBonus));
                    
                    activatedDevices = Math.min(activatedDevices + actualActivation, totalDevices);
                    animationStep++;
                    
                    // Update UI with smooth progress
                    document.getElementById('activeDevices').textContent = activatedDevices;
                    document.getElementById('progressPercent').textContent = 
                        Math.floor((activatedDevices / totalDevices) * 100) + '%';
                    
                    // Update map with animation - this will sync the statistics
                    try {
                        updateMapDevicesWithAnimation(activatedDevices);
                    } catch (error) {
                        console.error('Error updating map devices:', error);
                    }
                    
                    // Add some visual effects for special milestones
                    if (activatedDevices % 50 === 0) {
                        createEnergyWave();
                    }
                    
                } else {
                    // Animation complete
                    clearInterval(mapAnimationInterval);
                    
                    // 确保所有设备都已激活
                    activatedDevices = totalDevices;
                    document.getElementById('activeDevices').textContent = activatedDevices;
                    
                    // 计算实际进度
                    const actualProgress = Math.round((activatedDevices / totalDevices) * 100);
                    document.getElementById('progressPercent').textContent = actualProgress + '%';
                    
                    // 只有真正达到100%时才显示统计弹窗
                    if (actualProgress >= 100) {
                        // 动画完成后显示统计
                        setTimeout(() => {
                            console.log('Animation complete, showing statistics for:', currentOperation);
                            showOperationStatistics();
                        }, 1000);
                    }
                }
            }, 80); // Slightly faster updates for smoother animation
        }

        function updateMapDevicesWithAnimation(activeCount) {
            if (!mapChart || !deviceLocations.length) return;
            
            // Update actual device statuses based on command progress
            // Simulate devices receiving commands and changing their real status
            const successRate = 0.85; // 85% of devices successfully receive and execute commands
            const executedDevices = Math.floor(activeCount * successRate);
            
            // Update device statuses to reflect real execution
            for (let i = 0; i < deviceLocations.length; i++) {
                const device = deviceLocations[i];
                
                if (device.status === 'offline') {
                    // Offline devices stay offline
                    continue;
                }
                
                if (i < executedDevices && currentOperation) {
                    // These devices have successfully received and executed the command
                    if (currentOperation === 'charge') {
                        device.status = 'charging';
                    } else if (currentOperation === 'discharge') {
                        device.status = 'discharging';
                    }
                } else if (i < activeCount) {
                    // These devices received command but haven't executed yet (processing)
                    device.status = 'active';
                } else {
                    // These devices are inactive/standby
                    if (device.status === 'charging' || device.status === 'discharging' || device.status === 'active') {
                        device.status = 'inactive';
                    }
                }
            }
            
            // Create animated device data based on real status
            const data = deviceLocations.map((device, index) => {
                const justActivated = index >= activeCount - 5 && index < activeCount; // Last 5 devices that got commands
                
                return {
                    value: device.value,
                    id: device.id,
                    status: device.status, // Use actual device status
                    region: device.region,
                    city: device.city,
                    justActivated: justActivated
                };
            });
            
            // Update the device series with enhanced styling
            console.log('Updating map with', data.length, 'devices'); // Debug log
            mapChart.setOption({
                series: [
                    {}, // Keep region centers unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data,
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            const justActivated = params.data.justActivated;
                            
                            if (justActivated) {
                                return 14; // Larger for just activated
                            } else if (status === 'charging' || status === 'discharging') {
                                return 8; // Larger for operational devices
                            } else if (status === 'active') {
                                return 6;
                            } else if (status === 'offline') {
                                return 4;
                            }
                            return 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    // Bright pulse effect for just activated devices
                                    if (status === 'charging') return '#00ff88';
                                    if (status === 'discharging') return '#8A4AFF';
                                    if (status === 'active') return '#ffcc00';
                                }
                                
                                // Enhanced status colors with gradients
                                switch (status) {
                                    case 'charging': 
                                        return '#00ff88'; // Vibrant green for charging
                                    case 'discharging': 
                                        return '#FFD700'; // Yellow for discharging
                                    case 'active':
                                        return '#ffcc00'; // Bright yellow for active
                                    case 'offline': 
                                        return 'rgba(120, 120, 120, 0.4)'; // Gray for offline
                                    default:
                                        return 'rgba(255, 255, 255, 0.6)'; // Soft white for inactive
                                }
                            },
                            borderColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return '#ffffff';
                                }
                                
                                switch (status) {
                                    case 'charging': return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging': return 'rgba(255, 215, 0, 0.8)';
                                    case 'active': return 'rgba(255, 204, 0, 0.8)';
                                    default: return 'rgba(255, 255, 255, 0.4)';
                                }
                            },
                            borderWidth: function(params) {
                                const status = params.data.status;
                                if (params.data.justActivated) return 3;
                                if (status === 'charging' || status === 'discharging') return 2;
                                return 1;
                            },
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return 25; // Enhanced glow for new activations
                                } else if (status === 'charging' || status === 'discharging') {
                                    return 15; // Medium glow for operational devices
                                } else if (status === 'active') {
                                    return 8;
                                }
                                return 4;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    if (status === 'charging') return 'rgba(0, 255, 136, 0.9)';
                                    if (status === 'discharging') return 'rgba(255, 51, 102, 0.9)';
                                    if (status === 'active') return 'rgba(255, 204, 0, 0.9)';
                                }
                                
                                switch (status) {
                                    case 'charging':
                                        return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    case 'active':
                                        return 'rgba(255, 170, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.8,
                            itemStyle: {
                                shadowBlur: 30,
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': return 'rgba(0, 255, 136, 1)';
                                        case 'discharging': return 'rgba(255, 215, 0, 1)';
                                        case 'active': return 'rgba(255, 204, 0, 1)';
                                        default: return 'rgba(255, 255, 255, 0.8)';
                                    }
                                },
                                borderWidth: 3,
                                borderColor: '#ffffff'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut'
                    }
                ]
            });
            
            console.log('Map setOption completed successfully'); // Debug log
            
            // Update map statistics with current active count
            updateMapStatistics(activeCount);
        }

        function createEnergyWave() {
            // Visual effect for energy wave (could be enhanced with more sophisticated graphics)
            if (mapChart) {
                const option = mapChart.getOption();
                
                // Add temporary graphic element for wave effect
                const waveGraphic = {
                    type: 'circle',
                    shape: {
                        cx: 300,
                        cy: 250,
                        r: 50
                    },
                    style: {
                        stroke: currentOperation === 'charge' ? '#00ff88' : '#8A4AFF',
                        lineWidth: 3,
                        fill: 'transparent',
                        opacity: 0.8
                    },
                    z: 10
                };
                
                // Add wave and remove after animation
                setTimeout(() => {
                    if (mapChart) {
                        const currentGraphic = mapChart.getOption().graphic || [];
                        mapChart.setOption({
                            graphic: [...currentGraphic, waveGraphic]
                        });
                        
                        // Remove wave after 500ms
                        setTimeout(() => {
                            updateMapStatistics(); // This resets the graphic to just statistics
                        }, 500);
                    }
                }, 50);
            }
        }

        function updateMapDevices(activeCount) {
            if (!mapChart || !deviceLocations.length) return;
            
            // Create updated device data that works with both geo and cartesian2d
            const data = deviceLocations.map((device, index) => {
                const isActive = index < activeCount;
                
                return {
                    name: `设备${device.id}`,
                    value: device.value.concat ? device.value.concat([device.id]) : device.value,
                    id: device.id,
                    status: isActive ? 'active' : 'inactive',
                    city: device.city
                };
            });
            
            // Update the device series (series[1], after cities series[0])
            mapChart.setOption({
                series: [
                    {}, // Keep cities unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data
                    }
                ]
            });
            
            // Update legend with new counts
            updateMapLegend();
        }

        // 更新价格圆圈颜色的函数
        function updatePriceCircleColor() {
            // Update stop button visibility based on current state
            updateStopButtonVisibility();
            
            // Update action buttons visibility based on current state
            updateActionButtonsVisibility();
            
            // 获取当前选中地区的状态
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            console.log('UpdatePriceCircleColor - Region:', selectedMainRegion, 'Status:', regionStatus);
            
            // Update water wave colors based on operation status
            const waterWaveContainer = document.getElementById('waterWaveContainer');
            
            if (!waterWaveContainer) {
                console.log('Water wave container not found!');
                return;
            }
            
            const waterLevelContainer = document.getElementById('waterLevelContainer');
            
            if (regionStatus === 'charging') {
                // 充电状态 - 绿色，30%水位
                waterWaveContainer.style.background = '#00cc6a';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '30%';
                }
                console.log('Set charging water wave color and 30% level');
            } else if (regionStatus === 'discharging') {
                // 放电状态 - 黄色，80%水位
                waterWaveContainer.style.background = '#ffc107';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '80%';
                }
                console.log('Set discharging water wave color and 80% level');
            } else {
                // 无状态 - 青色/浅蓝色，50%水位
                waterWaveContainer.style.background = '#5AC8FA';
                if (waterLevelContainer) {
                    waterLevelContainer.style.height = '50%';
                }
                console.log('Set idle water wave color and 50% level');
            }
        }

        // 更新停止按钮显示状态
        function updateStopButtonVisibility() {
            const mainPriceCircle = document.getElementById('mainPriceCircle');
            if (!mainPriceCircle) return;
            
            // 获取当前选中地区的状态
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            
            // 只有在手动模式下且正在进行充电或放电操作时才显示停止按钮
            const shouldShowStop = currentOperationMode === 'manual' && 
                                  (regionStatus === 'charging' || regionStatus === 'discharging');
            
            if (shouldShowStop) {
                mainPriceCircle.classList.add('manual-operation');
                console.log('Stop button enabled - manual operation in progress');
            } else {
                mainPriceCircle.classList.remove('manual-operation');
                console.log('Stop button disabled - no manual operation or in auto mode');
            }
        }


        // 初始化SOC滑动条位置
        function initSOCSliders() {
            // 初始化充电停止SOC进度条
            const chargeSOCSlider = document.getElementById('chargeSOCSlider');
            const chargeProgressBar = document.getElementById('chargeSOCProgressBar');
            const chargeProgressDot = document.getElementById('chargeSOCProgressDot');
            const chargeInput = document.getElementById('chargeStopSOCInput');
            if (chargeSOCSlider && chargeProgressBar && chargeProgressDot && chargeInput) {
                // 设置初始进度条宽度
                chargeProgressBar.style.width = chargeSOCSlider.value + '%';
                // 设置初始圆点位置
                chargeProgressDot.style.left = chargeSOCSlider.value + '%';
                // 设置初始输入框值
                chargeInput.value = chargeSOCSlider.value;
            }
            
            // 初始化放电停止SOC进度条
            const dischargeSOCSlider = document.getElementById('dischargeSOCSlider');
            const dischargeProgressBar = document.getElementById('dischargeSOCProgressBar');
            const dischargeProgressDot = document.getElementById('dischargeSOCProgressDot');
            const dischargeInput = document.getElementById('dischargeStopSOCInput');
            if (dischargeSOCSlider && dischargeProgressBar && dischargeProgressDot && dischargeInput) {
                // 设置初始进度条位置 (从滑块位置到100%)
                dischargeProgressBar.style.left = dischargeSOCSlider.value + '%';
                dischargeProgressBar.style.width = (100 - dischargeSOCSlider.value) + '%';
                // 设置初始圆点位置
                dischargeProgressDot.style.left = dischargeSOCSlider.value + '%';
                // 设置初始输入框值
                dischargeInput.value = dischargeSOCSlider.value;
            }
        }

        // 更新充电停止SOC进度条
        function updateChargeSOC(socValue) {
            const progressBar = document.getElementById('chargeSOCProgressBar');
            const progressDot = document.getElementById('chargeSOCProgressDot');
            const socInput = document.getElementById('chargeStopSOCInput');
            const socDisplay = document.getElementById('chargeStopSOCDisplay');
            const socSlider = document.getElementById('chargeSOCSlider');
            
            if (progressBar && progressDot && socInput && socSlider) {
                // 更新进度条宽度
                progressBar.style.width = socValue + '%';
                
                // 更新圆点位置
                progressDot.style.left = socValue + '%';
                
                // 更新输入框值
                socInput.value = socValue;
                
                // 更新显示值
                if (socDisplay) {
                    socDisplay.textContent = socValue;
                }
                
                // 更新滑动条值
                socSlider.value = socValue;
                
                // 更新autoSettings中的值
                if (window.autoSettings) {
                    window.autoSettings.charge.stopSOC = parseInt(socValue);
                }
            }
            
            console.log(`Charge Stop SOC updated to: ${socValue}%`);
        }

        // 从输入框更新充电停止SOC
        function updateChargeSOCFromInput(socValue) {
            // 限制在0-100范围内
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // 如果输入值无效，重置为有效值
            const socInput = document.getElementById('chargeStopSOCInput');
            if (socInput) {
                socInput.value = validValue;
            }
            
            // 更新进度条
            updateChargeSOC(validValue);
        }

        // 更新放电停止SOC进度条
        function updateDischargeSOC(socValue) {
            const progressBar = document.getElementById('dischargeSOCProgressBar');
            const progressDot = document.getElementById('dischargeSOCProgressDot');
            const socInput = document.getElementById('dischargeStopSOCInput');
            const socDisplay = document.getElementById('dischargeStopSOCDisplay');
            const socSlider = document.getElementById('dischargeSOCSlider');
            
            if (progressBar && progressDot && socInput && socSlider) {
                // 进度条从 socValue 填充到 100%
                progressBar.style.left = socValue + '%';
                progressBar.style.width = (100 - socValue) + '%';
                
                // 更新圆点位置
                progressDot.style.left = socValue + '%';
                
                // 更新输入框值
                socInput.value = socValue;
                
                // 更新显示值
                if (socDisplay) {
                    socDisplay.textContent = socValue;
                }
                
                // 更新滑动条值
                socSlider.value = socValue;
                
                // 更新autoSettings中的值
                if (window.autoSettings) {
                    window.autoSettings.discharge.stopSOC = parseInt(socValue);
                }
            }
            
            console.log(`Discharge Stop SOC updated to: ${socValue}%`);
        }

        // 从输入框更新放电停止SOC
        function updateDischargeSOCFromInput(socValue) {
            // 限制在0-100范围内
            const validValue = Math.max(0, Math.min(100, parseInt(socValue) || 0));
            
            // 如果输入值无效，重置为有效值
            const socInput = document.getElementById('dischargeStopSOCInput');
            if (socInput) {
                socInput.value = validValue;
            }
            
            // 更新进度条
            updateDischargeSOC(validValue);
        }

        // 编辑充电停止SOC
        function editChargeStopSOC() {
            const display = document.getElementById('chargeStopSOCDisplay');
            const input = document.getElementById('chargeStopSOCInput');
            if (display && input) {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
            }
        }

        // 隐藏充电SOC输入框
        function hideChargeSOCInput() {
            const display = document.getElementById('chargeStopSOCDisplay');
            const input = document.getElementById('chargeStopSOCInput');
            if (display && input) {
                display.style.display = 'inline';
                input.style.display = 'none';
                // 更新显示的值
                display.textContent = input.value;
            }
        }

        // 编辑放电停止SOC
        function editDischargeStopSOC() {
            const display = document.getElementById('dischargeStopSOCDisplay');
            const input = document.getElementById('dischargeStopSOCInput');
            if (display && input) {
                display.style.display = 'none';
                input.style.display = 'block';
                input.focus();
                input.select();
            }
        }

        // 隐藏放电SOC输入框
        function hideDischargeSOCInput() {
            const display = document.getElementById('dischargeStopSOCDisplay');
            const input = document.getElementById('dischargeStopSOCInput');
            if (display && input) {
                display.style.display = 'inline';
                input.style.display = 'none';
                // 更新显示的值
                display.textContent = input.value;
            }
        }

        // 点击充电SOC进度条设置值
        function handleChargeSOCBarClick(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.round((clickX / containerWidth) * 100);
            
            // 限制在0-100范围内
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // 更新滑动条值
            const slider = document.getElementById('chargeSOCSlider');
            if (slider) {
                slider.value = socValue;
                updateChargeSOC(socValue);
            }
        }

        // 点击放电SOC进度条设置值
        function handleDischargeSOCBarClick(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const containerWidth = rect.width;
            const percentage = Math.round((clickX / containerWidth) * 100);
            
            // 限制在0-100范围内
            const socValue = Math.max(0, Math.min(100, percentage));
            
            // 更新滑动条值
            const slider = document.getElementById('dischargeSOCSlider');
            if (slider) {
                slider.value = socValue;
                updateDischargeSOC(socValue);
            }
        }

        // 更新充电/放电按钮的显示状态
        function updateActionButtonsVisibility() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const priceDisplay = document.getElementById('priceDisplay');
            const stopDisplay = document.getElementById('stopDisplay');
            
            if (!chargeBtn || !dischargeBtn) return;
            
            // 获取当前选中地区的状态
            const regionStatus = getRegionOperationStatus(selectedMainRegion);
            
            // 在充电或放电操作时隐藏按钮（不管是手动还是自动模式）
            const shouldHideButtons = regionStatus === 'charging' || regionStatus === 'discharging';
            
            if (shouldHideButtons) {
                chargeBtn.style.display = 'none';
                dischargeBtn.style.display = 'none';
                console.log('Action buttons hidden - operation in progress');
                
                // 不更改显示，保持价格显示
            } else {
                chargeBtn.style.display = 'flex';
                dischargeBtn.style.display = 'flex';
                console.log('Action buttons visible - no operation in progress');
                
                // 显示价格文字
                if (priceDisplay) priceDisplay.style.display = 'block';
                if (stopDisplay) {
                    stopDisplay.style.display = 'none';
                    stopDisplay.style.opacity = '0';
                }
            }
        }

        // 计算当前价格在今日低高价格中的占比并更新水波高度
        function updateWaterWaveLevel() {
            const currentPriceElement = document.getElementById('currentPrice');
            const todayLowElement = document.getElementById('todayLow');
            const todayHighElement = document.getElementById('todayHigh');
            const pricePercentageElement = document.getElementById('pricePercentage');
            const waterWave = document.getElementById('waterWave');
            
            if (!currentPriceElement || !todayLowElement || !todayHighElement || !pricePercentageElement || !waterWave) {
                console.log('Required elements not found for water wave update');
                return;
            }
            
            // 提取价格数值
            const currentPrice = parseFloat(currentPriceElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            const todayLow = parseFloat(todayLowElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            const todayHigh = parseFloat(todayHighElement.textContent.replace('$', '').replace(/[^0-9.-]/g, '')) || 0;
            
            console.log('Price calculation:', { currentPrice, todayLow, todayHigh });
            
            // 计算价格占比 (0-100%)
            let percentage = 0;
            if (todayHigh > todayLow) {
                percentage = ((currentPrice - todayLow) / (todayHigh - todayLow)) * 100;
                percentage = Math.max(0, Math.min(100, percentage)); // 限制在0-100%范围内
            }
            
            // 更新百分比显示
            pricePercentageElement.textContent = `${Math.round(percentage)}%`;
            
            // 更新水位容器高度，而不是水波高度
            const waterLevelContainer = document.getElementById('waterLevelContainer');
            if (waterLevelContainer) {
                // 直接使用价格占比作为水位高度
                waterLevelContainer.style.height = `${percentage}%`;
                console.log(`Updated water level: ${percentage}%`);
            }
        }

        function stopOperation() {
            // Stop animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
            }
            
            // 清除备用定时器
            if (window.operationFallbackTimer) {
                clearTimeout(window.operationFallbackTimer);
                window.operationFallbackTimer = null;
                console.log('Cleared operation fallback timer');
            }
            
            // 保存停止前的操作类型，用于显示统计
            window.lastStoppedOperation = currentOperation;
            
            // 重置当前操作状态
            currentOperation = null;
            
            // 更新地区状态 - 移除当前地区的充放电标记
            updateRegionOperationStatus(selectedMainRegion, 'none');
            
            // 更新地区状态指示器
            updateRegionStatusIndicators();
            
            // 立即更新价格圆圈颜色
            updatePriceCircleColor();
            
            // 添加延迟确保圆圈颜色更新
            setTimeout(() => {
                updatePriceCircleColor();
                console.log('Price circle color updated after stop operation');
            }, 100);
            
            // 恢复充放电按钮
            updateActionButtonsToChargeDis();
            
            // 切换到行情面板
            switchPanel('market');
            
            // Show operation completion modal with device response statistics
            setTimeout(() => {
                showOperationStatistics();
            }, 500);
            
            // Start gradual device reset animation
            startDeviceResetAnimation();
            
            // Update UI to initial state
            document.getElementById('activeDevices').textContent = '0';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentOperationText').textContent = '无';
            document.getElementById('totalDevices').textContent = '500';
            
            // Reset buttons to original state
            resetButtons();
            
            // Don't reset currentOperation immediately - keep it for the modal
            // It will be reset when the modal is closed
            
            // Update map to show initial device distribution
            updateMapStatistics();
        }

        function startDeviceResetAnimation() {
            console.log('Starting device reset animation...');
            
            let resetStep = 0;
            const maxResetSteps = 50; // Reset animation over 50 steps
            const devicesPerStep = Math.ceil(deviceLocations.length / maxResetSteps);
            
            const resetInterval = setInterval(() => {
                if (resetStep >= maxResetSteps) {
                    clearInterval(resetInterval);
                    activatedDevices = 0;
                    console.log('Device reset animation completed');
                    return;
                }
                
                // Reset a batch of devices each step
                const startIndex = resetStep * devicesPerStep;
                const endIndex = Math.min(startIndex + devicesPerStep, deviceLocations.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const device = deviceLocations[i];
                    // Gradually change to initial status distribution
                    const rand = Math.random();
                    if (rand < 0.05) {
                        device.status = 'offline';  // 5% offline
                    } else if (rand < 0.12) {
                        device.status = 'discharging';  // 7% discharging
                    } else if (rand < 0.18) {
                        device.status = 'charging';  // 6% charging
                    } else {
                        device.status = 'inactive';  // 82% inactive
                    }
                }
                
                // Update map display
                updateMapWithDeviceStates();
                
                resetStep++;
            }, 100); // Update every 100ms for smooth animation
        }

        function resetDevicesToInitialState() {
            // Reset all devices to their original initial status
            deviceLocations.forEach(device => {
                const rand = Math.random();
                if (rand < 0.05) {
                    device.status = 'offline';  // 5% offline
                } else if (rand < 0.12) {
                    device.status = 'discharging';  // 7% discharging
                } else if (rand < 0.18) {
                    device.status = 'charging';  // 6% charging
                } else {
                    device.status = 'inactive';  // 82% inactive
                }
            });
            
            // Update the map with initial device states
            if (mapChart && deviceLocations.length) {
                const data = deviceLocations.map(device => ({
                    value: device.value,
                    id: device.id,
                    status: device.status,
                    region: device.region,
                    city: device.city
                }));
                
                mapChart.setOption({
                    series: [
                        {}, // Keep state centers unchanged
                        {
                            name: 'Devices',
                            type: 'scatter',
                            data: data,
                            symbolSize: function(value, params) {
                                const status = params.data.status;
                                if (status === 'charging' || status === 'discharging') {
                                    return 8;
                                } else if (status === 'offline') {
                                    return 3;
                                }
                                return 5;
                            },
                            itemStyle: {
                                color: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': 
                                            return '#00ff88';
                                        case 'discharging': 
                                            return '#FFD700';
                                        case 'offline': 
                                            return 'rgba(255, 255, 255, 0.2)';
                                        default: 
                                            return 'rgba(255, 255, 255, 0.5)';
                                    }
                                },
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 1,
                                shadowBlur: function(params) {
                                    const status = params.data.status;
                                    return (status === 'charging' || status === 'discharging') ? 10 : 3;
                                },
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging':
                                            return 'rgba(0, 255, 136, 0.8)';
                                        case 'discharging':
                                            return 'rgba(255, 215, 0, 0.8)';
                                        default:
                                            return 'rgba(255, 255, 255, 0.3)';
                                    }
                                }
                            },
                            animation: true,
                            animationDuration: 800,
                            animationEasing: 'cubicOut'
                        }
                    ]
                });
            }
        }

        function resetButtons() {
            console.log('resetButtons called');
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (actionButtons) {
                actionButtons.classList.remove('operating');
            }
            
            // Reset charge button
            if (chargeBtn) {
                chargeBtn.innerHTML = `<span data-i18n="charge">${window.i18n ? window.i18n.getText('charge') : '充电'}</span>`;
                chargeBtn.classList.remove('stop-btn');
                chargeBtn.classList.add('charge-btn');
                chargeBtn.style.display = 'flex';
                chargeBtn.style.removeProperty('background');
                chargeBtn.style.color = '#000'; // 确保文字颜色为黑色
                chargeBtn.onclick = handleCharge;
                // 确保按钮可点击
                chargeBtn.disabled = false;
                chargeBtn.style.pointerEvents = 'auto';
                console.log('Charge button reset, onclick:', chargeBtn.onclick);
            }
            
            // Reset discharge button
            if (dischargeBtn) {
                dischargeBtn.innerHTML = `<span data-i18n="discharge">${window.i18n ? window.i18n.getText('discharge') : '放电'}</span>`;
                dischargeBtn.classList.remove('stop-btn');
                dischargeBtn.classList.add('discharge-btn');
                dischargeBtn.style.display = 'flex';
                dischargeBtn.style.removeProperty('background');
                dischargeBtn.style.color = '#000'; // 确保文字颜色为黑色
                dischargeBtn.onclick = handleDischarge;
                // 确保按钮可点击
                dischargeBtn.disabled = false;
                dischargeBtn.style.pointerEvents = 'auto';
                console.log('Discharge button reset, onclick:', dischargeBtn.onclick);
            }
        }

        // Update map statistics display (shows actual device status, not command status)
        function updateMapStatistics(activeCount = 0) {
            if (!deviceLocations || !mapChart) return;
            
            // Always count actual device statuses regardless of command progress
            let counts = {
                charging: 0,
                discharging: 0,
                processing: 0, // Devices that received command but not executing yet
                inactive: 0,
                offline: 0
            };
            
            // Count actual device statuses
            deviceLocations.forEach(device => {
                switch (device.status) {
                    case 'charging':
                        counts.charging++;
                        break;
                    case 'discharging':
                        counts.discharging++;
                        break;
                    case 'active': // Command received, processing
                        counts.processing++;
                        break;
                    case 'offline':
                        counts.offline++;
                        break;
                    case 'inactive':
                    default:
                        counts.inactive++;
                        break;
                }
            });

            // Update statistics display without background box
            const statisticsGraphic = [
                {
                    type: 'group',
                    right: 20,
                    top: 20,
                    children: [
                        // Charging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#00ff88' },
                            position: [-15, 6],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('charging') : '充电中'}: ${counts.charging}`,
                                fill: '#00ff88',
                                fontSize: 12
                            },
                            position: [0, 0],
                            z: 101
                        },
                        // Discharging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#FFD700' },
                            position: [-15, 26],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('discharging') : '放电中'}: ${counts.discharging}`,
                                fill: '#FFD700',
                                fontSize: 12
                            },
                            position: [0, 20],
                            z: 101
                        },
                        // Standby indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: 'rgba(255, 255, 255, 0.8)' },
                            position: [-15, 46],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('standby') : '待机'}: ${counts.inactive}`,
                                fill: 'rgba(255, 255, 255, 0.8)',
                                fontSize: 12
                            },
                            position: [0, 40],
                            z: 101
                        },
                        // Offline indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: 'rgba(255, 255, 255, 0.3)' },
                            position: [-15, 66],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('offline') : '离线'}: ${counts.offline}`,
                                fill: 'rgba(255, 255, 255, 0.5)',
                                fontSize: 12
                            },
                            position: [0, 60],
                            z: 101
                        }
                    ]
                }
            ];

            // Update the chart with new statistics
            mapChart.setOption({
                graphic: statisticsGraphic
            });
        }

        function fullReset() {
            resetButtons();
            currentOperation = null;
        }

        // 新的操作统计显示函数
        function showOperationStatistics() {
            console.log('Showing operation statistics');
            
            // 检查用户是否已经关闭了弹窗
            if (window.deviceResponseModalClosed) {
                console.log('Device response modal was closed by user, not showing again');
                return;
            }
            
            const modal = document.getElementById('deviceResponseModal');
            if (!modal) {
                console.error('Device response modal not found!');
                return;
            }
            
            // 设置操作类型和消息
            let operationName = '';
            let messageText = '';
            let isStopOperation = false;
            
            const lastOperation = currentOperation || 'stop'; // 如果currentOperation为null，说明是停止操作
            
            if (lastOperation === 'charge') {
                operationName = window.i18n ? window.i18n.getText('charge') : 'Charge';
                messageText = window.i18n ? window.i18n.getText('chargeCompleteMessage') : 'Charging command completed. Here is the device response statistics report:';
            } else if (lastOperation === 'discharge') {
                operationName = window.i18n ? window.i18n.getText('discharge') : 'Discharge';
                messageText = window.i18n ? window.i18n.getText('dischargeCompleteMessage') : 'Discharging command completed. Here is the device response statistics report:';
            } else {
                // 这是停止操作
                isStopOperation = true;
                const stoppedType = window.lastStoppedOperation;
                if (stoppedType === 'charge') {
                    operationName = window.i18n ? window.i18n.getText('stopCharge') || '停止充电' : 'Stop Charging';
                } else if (stoppedType === 'discharge') {
                    operationName = window.i18n ? window.i18n.getText('stopDischarge') || '停止放电' : 'Stop Discharging';
                } else {
                    operationName = window.i18n ? window.i18n.getText('stop') : 'Stop';
                }
                messageText = window.i18n ? window.i18n.getText('stopCompleteMessage') : 'Stop command completed. Here is the device response statistics report:';
            }
            
            // 更新模态框内容
            const operationTypeDisplay = document.getElementById('operationTypeDisplay');
            const operationCompleteMessage = document.getElementById('operationCompleteMessage');
            const targetDevicesDisplay = document.getElementById('targetDevicesDisplay');
            const responseModalIcon = document.getElementById('responseModalIcon');
            const modalIcon = document.getElementById('modalIcon');
            
            if (operationTypeDisplay) {
                operationTypeDisplay.textContent = operationName;
                // 根据操作类型设置颜色
                if (isStopOperation) {
                    // 停止操作使用红色
                    operationTypeDisplay.style.color = '#ff6b6b';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(255, 107, 107, 0.15), rgba(255, 107, 107, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(255, 107, 107, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = '🛑';
                } else if (lastOperation === 'discharge') {
                    operationTypeDisplay.style.color = '#ffd700';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = '🔋';
                } else {
                    operationTypeDisplay.style.color = '#00ff88';
                    if (responseModalIcon) {
                        responseModalIcon.style.background = 'linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05))';
                        responseModalIcon.style.boxShadow = '0 4px 12px rgba(0, 255, 136, 0.15)';
                    }
                    if (modalIcon) modalIcon.textContent = '⚡';
                }
            }
            if (operationCompleteMessage) operationCompleteMessage.textContent = messageText;
            if (targetDevicesDisplay) {
                const unit = window.i18n && window.i18n.getCurrentLanguage() === 'en' ? '' : '个';
                targetDevicesDisplay.textContent = '500' + unit;
            }
            
            // 设置统计数据
            const stats = {
                received: Math.floor(Math.random() * 8) + 492, // 492-499
                activated: Math.floor(Math.random() * 35) + 465, // 465-499
            };
            stats.successRate = Math.floor((stats.activated / 500) * 100);
            
            // 更新统计显示
            const commandsReceivedStat = document.getElementById('commandsReceivedStat');
            const devicesActivatedStat = document.getElementById('devicesActivatedStat');
            const successRateStat = document.getElementById('successRateStat');
            
            if (commandsReceivedStat) commandsReceivedStat.textContent = stats.received;
            if (devicesActivatedStat) devicesActivatedStat.textContent = stats.activated;
            if (successRateStat) successRateStat.textContent = stats.successRate + '%';
            
            // 显示模态框 - 使用flex居中
            modal.style.display = 'flex';
            
            console.log('Device response statistics modal displayed');
        }

        // 直接复制操作记录页面的抽屉组件
        class HomeOperationDrawer extends DrawerComponent {
            constructor() {
                super({
                    containerId: 'homeOperationDrawer',
                    title: window.i18n ? window.i18n.getText('operationDetails') : '操作记录详情',
                    width: '500px',
                    tabs: [
                        { key: 'basic', label: window.i18n ? window.i18n.getText('basicInfo') : '基本信息' },
                        { key: 'stations', label: window.i18n ? window.i18n.getText('stationDetails') : '电站详情' },
                        { key: 'timeline', label: window.i18n ? window.i18n.getText('executionTimeline') : '执行时间线' }
                    ],
                    onClose: () => {
                        console.log('操作记录抽屉关闭');
                    },
                    onTabSwitch: (tabKey, data) => {
                        this.setContent(data, tabKey);
                    }
                });
                
                // 在创建后立即设置z-index
                this.forceTopZIndex();
            }
            
            forceTopZIndex() {
                // 使用定时器确保DOM已经创建
                const attempts = 0;
                const maxAttempts = 10;
                
                const setZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // 设置抽屉的z-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // 设置内部元素的z-index
                        const allElements = drawer.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.setProperty('z-index', '2147483647', 'important');
                        });
                        
                        console.log('Drawer z-index force set to maximum');
                        return true;
                    }
                    return false;
                };
                
                // 立即尝试一次
                if (!setZIndex() && attempts < maxAttempts) {
                    // 如果失败，使用定时器重试
                    const interval = setInterval(() => {
                        if (setZIndex() || attempts >= maxAttempts) {
                            clearInterval(interval);
                        }
                        attempts++;
                    }, 100);
                }
            }
            
            // 重写open方法确保z-index最高
            open(data = null) {
                super.open(data);
                
                // 多次确保z-index设置
                const ensureZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // 设置容器z-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // 设置所有子元素
                        const overlay = drawer.querySelector('.drawer-overlay');
                        const container = drawer.querySelector('.drawer-container');
                        
                        if (overlay) {
                            overlay.style.setProperty('z-index', '2147483647', 'important');
                            overlay.style.setProperty('position', 'fixed', 'important');
                        }
                        
                        if (container) {
                            container.style.setProperty('z-index', '2147483647', 'important');
                            container.style.setProperty('position', 'fixed', 'important');
                        }
                    }
                };
                
                // 立即执行
                ensureZIndex();
                
                // 延迟执行多次以确保
                [10, 50, 100, 200, 500].forEach(delay => {
                    setTimeout(ensureZIndex, delay);
                });
                
                // 再次强制设置z-index
                this.forceTopZIndex();
            }
            
            generateContent(operation, tabKey) {
                if (!operation) return `<div>Loading data...</div>`;
                
                const commandInfo = this.getCommandInfo(operation.command);
                
                switch(tabKey) {
                    case 'basic':
                        return this.generateBasicInfo(operation, commandInfo);
                    case 'stations':
                        return this.generateStationDetails(operation);
                    case 'timeline':
                        return this.generateTimeline(operation);
                    default:
                        return this.generateBasicInfo(operation, commandInfo);
                }
            }
            
            getCommandInfo(command) {
                const commandTexts = {
                    'charge': window.i18n ? window.i18n.getText('charge') : '充电',
                    'discharge': window.i18n ? window.i18n.getText('discharge') : '放电',
                    'stop': window.i18n ? window.i18n.getText('stop') : '停止'
                };
                const commandMap = {
                    'charge': { text: commandTexts['charge'], class: 'charge' },
                    'discharge': { text: commandTexts['discharge'], class: 'discharge' },
                    'stop': { text: commandTexts['stop'], class: 'stop' }
                };
                return commandMap[command] || { text: command, class: 'default' };
            }

            generateBasicInfo(operation, commandInfo) {
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📊</span>
                            ${window.i18n ? window.i18n.getText('operationOverview') : '操作概览'}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${operation.stations || operation.dispatched}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('totalStations') : '总电站数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.success || operation.activated}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successCount') : '成功数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.failed || (operation.dispatched - operation.activated)}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('failedCount') : '失败数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.successRate || Math.round((operation.activated / operation.dispatched) * 100)}%</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successRate') : '成功率'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📝</span>
                            ${window.i18n ? window.i18n.getText('basicInfo') : '基本信息'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationTime') : '操作时间'}</span>
                            <span class="detail-value">${operation.time || new Date().toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationCommand') : '操作命令'}</span>
                            <span class="detail-value">
                                <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operator') : '操作人员'}</span>
                            <span class="detail-value">${window.i18n ? window.i18n.getText('systemAdmin') : '系统管理员'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationId') : '操作编号'}</span>
                            <span class="detail-value">#${operation.id ? operation.id.toString().padStart(8, '0') : Date.now().toString().slice(-8)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('executionStatus') : '执行状态'}</span>
                            <span class="detail-value">
                                <span class="status-tag success">${window.i18n ? window.i18n.getText('allSuccess') : '全部成功'}</span>
                            </span>
                        </div>
                    </div>
                `;
            }

            generateStationDetails(operation) {
                // 生成模拟的电站数据
                const stationCount = operation.stations || operation.dispatched || 500;
                const successCount = operation.success || operation.activated || 450;
                const stations = [];
                for (let i = 0; i < Math.min(stationCount, 10); i++) {
                    const isSuccess = i < successCount;
                    stations.push({
                        id: `ST${(1000 + i).toString()}`,
                        name: `${window.i18n ? window.i18n.getText('station') : '电站'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                        status: isSuccess ? 'success' : 'failed',
                        location: `${window.i18n ? window.i18n.getText('area') : '区域'}${Math.floor(i / 10) + 1}`,
                        executeTime: new Date(new Date().getTime() + i * 1000).toLocaleTimeString('zh-CN')
                    });
                }
                
                return `
                    <div class="detail-section flex-fill">
                        <div class="detail-section-title">
                            <span>⚡</span>
                            ${window.i18n ? window.i18n.getText('stationExecutionDetails') : '电站执行详情'}
                        </div>
                        <div class="scrollable-list">
                            ${stations.map(station => `
                                <div class="detail-row">
                                    <div>
                                        <div class="detail-label">${station.name} (${station.id})</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                            ${station.location} • ${station.executeTime}
                                        </div>
                                    </div>
                                    <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                        ${station.status === 'success' ? (window.i18n ? window.i18n.getText('success') : '成功') : (window.i18n ? window.i18n.getText('failed') : '失败')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            generateTimeline(operation) {
                const startTime = new Date(operation.time || Date.now());
                const successCount = operation.success || operation.activated || 450;
                const failedCount = operation.failed || (operation.dispatched - operation.activated) || 50;
                const timeline = [
                    { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('commandCreated') : '操作命令创建', status: 'success' },
                    { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('validationPassed') : '命令验证通过', status: 'success' },
                    { time: startTime, event: window.i18n ? window.i18n.getText('executionStarted') : '开始执行命令', status: 'success' },
                    { time: new Date(startTime.getTime() + 30000), event: `${successCount}${window.i18n ? window.i18n.getText('stationsSuccess') : '个电站执行成功'}`, status: 'success' },
                ];
                
                if (failedCount > 0) {
                    timeline.push({
                        time: new Date(startTime.getTime() + 45000),
                        event: `${failedCount}${window.i18n ? window.i18n.getText('stationsFailed') : '个电站执行失败'}`,
                        status: 'danger'
                    });
                }
                
                timeline.push({
                    time: new Date(startTime.getTime() + 60000),
                    event: window.i18n ? window.i18n.getText('executionCompleted') : '操作执行完成',
                    status: failedCount === 0 ? 'success' : 'warning'
                });
                
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>🕰️</span>
                            ${window.i18n ? window.i18n.getText('executionTimeline') : '执行时间线'}
                        </div>
                        <div style="position: relative; padding-left: 24px;">
                            <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                            ${timeline.map((item, index) => `
                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                    <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                        <span class="detail-label">${item.event}</span>
                                        <span class="status-tag ${item.status}">
                                            ${item.status === 'success' ? (window.i18n ? window.i18n.getText('normal') : '正常') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('warning') : '警告') : (window.i18n ? window.i18n.getText('error') : '错误')}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                        ${item.time.toLocaleString('zh-CN')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // Device Response Drawer Class - 完全复制自 OperationDrawer
        class DeviceResponseDrawer extends DrawerComponent {
            constructor() {
                super({
                    containerId: 'deviceResponseDrawerComponent',
                    title: window.i18n ? window.i18n.getText('operationLog.detailTitle') : '操作记录详情',
                    width: '500px',
                    tabs: [
                        { key: 'basic', label: window.i18n ? window.i18n.getText('operationLog.tabs.basic') : '基本信息' },
                        { key: 'stations', label: window.i18n ? window.i18n.getText('operationLog.tabs.stations') : '电站详情' },
                        { key: 'timeline', label: window.i18n ? window.i18n.getText('operationLog.tabs.timeline') : '执行时间线' }
                    ],
                    onClose: () => {
                        console.log('操作记录抽屉关闭');
                    },
                    onTabSwitch: (tabKey, data) => {
                        this.setContent(data, tabKey);
                    }
                });
                
                // 确保抽屉在最顶层
                this.forceTopZIndex();
            }
            
            forceTopZIndex() {
                setTimeout(() => {
                    const drawer = document.querySelector(`#${this.containerId}`);
                    if (drawer) {
                        drawer.style.zIndex = '2147483647';
                        drawer.style.position = 'fixed';
                    }
                    const overlay = document.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.zIndex = '2147483646';
                    }
                }, 10);
            }
            
            open(operation) {
                super.open(operation);
                this.forceTopZIndex();
            }
            
            generateContent(operation, tabKey) {
                if (!operation) return `<div>${window.i18n ? window.i18n.getText('dataLoading') : 'Loading data...'}</div>`;
                
                const commandInfo = this.getCommandInfo(operation.command || 'charge');
                
                switch(tabKey) {
                    case 'basic':
                        return this.generateBasicInfo(operation, commandInfo);
                    case 'stations':
                        return this.generateStationDetails(operation);
                    case 'timeline':
                        return this.generateTimeline(operation);
                    default:
                        return this.generateBasicInfo(operation, commandInfo);
                }
            }
            
            getCommandInfo(command) {
                const commandMap = {
                    'charge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.charge') : '充电',
                        class: 'charge'
                    },
                    'discharge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.discharge') : '放电',
                        class: 'discharge'
                    },
                    'stop_charge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.stopCharge') : '停止充电',
                        class: 'stop-charge'
                    },
                    'stop_discharge': {
                        text: window.i18n ? window.i18n.getText('operationLog.commands.stopDischarge') : '停止放电',
                        class: 'stop-discharge'
                    }
                };
                return commandMap[command] || { text: command, class: '' };
            }
            
            generateBasicInfo(operation, commandInfo) {
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📊</span>
                            ${window.i18n ? window.i18n.getText('operationLog.overview.title') : '操作概览'}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${operation.stations || operation.totalStations || 235}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.totalStations') : '总电站数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.success || operation.onlineStations || 230}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successCount') : '成功数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.failed || 5}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.failedCount') : '失败数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.successRate || Math.round((230 / 235) * 100)}%</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successRate') : '成功率'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📝</span>
                            ${window.i18n ? window.i18n.getText('operationLog.basicInfo.title') : '基本信息'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationTime') : '操作时间'}</span>
                            <span class="detail-value">${operation.time || new Date().toLocaleString()}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationCommand') : '操作命令'}</span>
                            <span class="detail-value">
                                <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operator') : '操作人员'}</span>
                            <span class="detail-value">${this.getOperatorName(operation.operator || 'System')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationId') : '操作编号'}</span>
                            <span class="detail-value">#${(operation.id || Date.now()).toString().padStart(8, '0')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.executionStatus') : '执行状态'}</span>
                            <span class="detail-value">
                                <span class="status-tag ${(operation.failed || 5) === 0 ? 'success' : (operation.success || 230) > (operation.failed || 5) ? 'warning' : 'danger'}">
                                    ${(operation.failed || 5) === 0 ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.allSuccess') : '全部成功') : (operation.success || 230) > (operation.failed || 5) ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.partialSuccess') : '部分成功') : (window.i18n ? window.i18n.getText('operationLog.basicInfo.mostlyFailed') : '多数失败')}
                                </span>
                            </span>
                        </div>
                    </div>
                `;
            }
            
            getOperatorName(operator) {
                if (operator === 'System') {
                    return window.i18n ? window.i18n.getText('system') : '系统';
                }
                return operator;
            }
            
            generateStationDetails(operation) {
                // 生成模拟的电站数据
                const stations = [];
                const totalStations = operation.stations || operation.totalStations || 235;
                const successCount = operation.success || operation.onlineStations || 230;
                
                for (let i = 0; i < totalStations; i++) {
                    const isSuccess = i < successCount;
                    stations.push({
                        id: `ST${(1000 + i).toString()}`,
                        name: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.station') : '电站'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                        status: isSuccess ? 'success' : 'failed',
                        location: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.area') : '区域'}${Math.floor(i / 10) + 1}`,
                        executeTime: new Date(new Date().getTime() + i * 1000).toLocaleTimeString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')
                    });
                }
                
                return `
                    <div class="detail-section flex-fill" style="margin-bottom: 0;">
                        <div class="detail-section-title">
                            <span>⚡</span>
                            ${window.i18n ? window.i18n.getText('operationLog.stationDetails.title') : '电站执行详情'}
                        </div>
                        <div class="scrollable-list" style="flex: 1; min-height: 600px; padding-bottom: 16px;">
                            ${stations.map(station => `
                                <div class="detail-row">
                                    <div>
                                        <div class="detail-label">${station.name} (${station.id})</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                            ${station.location} • ${station.executeTime}
                                        </div>
                                    </div>
                                    <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                        ${station.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.stationDetails.success') : '成功') : (window.i18n ? window.i18n.getText('operationLog.stationDetails.failed') : '失败')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            generateTimeline(operation) {
                const startTime = new Date(operation.time || new Date());
                const successCount = operation.success || operation.onlineStations || 230;
                const failedCount = operation.failed || 5;
                
                const timeline = [
                    { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('operationLog.timeline.commandCreated') : '操作命令创建', status: 'success' },
                    { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('operationLog.timeline.validationPassed') : '命令验证通过', status: 'success' },
                    { time: startTime, event: window.i18n ? window.i18n.getText('operationLog.timeline.executionStarted') : '开始执行命令', status: 'success' },
                    { time: new Date(startTime.getTime() + 30000), event: `${successCount}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsSuccess') : '个电站执行成功'}`, status: 'success' },
                ];
                
                if (failedCount > 0) {
                    timeline.push({
                        time: new Date(startTime.getTime() + 45000),
                        event: `${failedCount}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsFailed') : '个电站执行失败'}`,
                        status: 'danger'
                    });
                }
                
                timeline.push({
                    time: new Date(startTime.getTime() + 60000),
                    event: window.i18n ? window.i18n.getText('operationLog.timeline.executionCompleted') : '操作执行完成',
                    status: failedCount === 0 ? 'success' : 'warning'
                });
                
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>🕰️</span>
                            ${window.i18n ? window.i18n.getText('operationLog.timeline.title') : '执行时间线'}
                        </div>
                        <div style="position: relative; padding-left: 24px;">
                            <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                            ${timeline.map((item, index) => `
                                <div style="position: relative; margin-bottom: 16px;">
                                    <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                    <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                        <span class="detail-label">${item.event}</span>
                                        <span class="status-tag ${item.status}">
                                            ${item.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.timeline.normal') : '正常') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('operationLog.timeline.warning') : '警告') : (window.i18n ? window.i18n.getText('operationLog.timeline.error') : '错误')}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                        ${item.time.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // 初始化抽屉组件（全局变量）
        window.homeOperationDrawer = null;

        // 打开操作详情抽屉
        function openOperationDrawer() {
            console.log('Opening operation drawer');
            
            if (!window.homeOperationDrawer) {
                window.homeOperationDrawer = new HomeOperationDrawer();
            }

            // 构造操作记录格式的数据
            const dispatched = parseInt(document.getElementById('devicesDispatched')?.textContent || '500');
            const activated = parseInt(document.getElementById('devicesActivated')?.textContent || '452');
            const operation = {
                id: Date.now() % 100000000,
                time: new Date().toLocaleString('zh-CN'),
                command: currentOperation || 'charge',
                operator: 'admin',
                stations: dispatched,
                success: activated,
                failed: dispatched - activated,
                dispatched: dispatched,
                activated: activated,
                successRate: Math.round((activated / dispatched) * 100)
            };

            console.log('Drawer operation data:', operation);
            
            // 直接打开抽屉并设置内容
            window.homeOperationDrawer.open();
            
            // 强制确保抽屉在最顶层
            setTimeout(() => {
                const drawerElement = document.getElementById('homeOperationDrawer');
                if (drawerElement) {
                    // 设置最高z-index
                    drawerElement.style.setProperty('z-index', '2147483647', 'important');
                    drawerElement.style.setProperty('position', 'fixed', 'important');
                    
                    // 查找并设置overlay的z-index
                    const overlay = document.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483646', 'important');
                        overlay.style.setProperty('position', 'fixed', 'important');
                    }
                    
                    // 查找抽屉容器
                    const container = drawerElement.querySelector('.drawer-container') || 
                                    document.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                        container.style.setProperty('position', 'fixed', 'important');
                    }
                    
                    console.log('Force set all drawer elements to maximum z-index');
                }
            }, 100);
            
            // 设置内容数据
            homeOperationDrawer.setContent(operation, 'basic');
        }

        // 全局z-index监控器
        function startDrawerZIndexMonitor() {
            setInterval(() => {
                const drawer = document.getElementById('homeOperationDrawer');
                if (drawer && drawer.style.display !== 'none') {
                    // 确保抽屉始终在最顶层
                    drawer.style.setProperty('z-index', '2147483647', 'important');
                    drawer.style.setProperty('position', 'fixed', 'important');
                    
                    const overlay = drawer.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483647', 'important');
                    }
                    
                    const container = drawer.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                    }
                }
            }, 100);
        }

        // 关闭模态框函数
        function closeModal() {
            const modal = document.getElementById('operationModal');
            const statusSummary = document.getElementById('statusSummary');
            const infoGrid = document.querySelector('.modal-info-grid');
            
            modal.style.display = 'none';
            
            // Reset modal display states
            statusSummary.style.display = 'none';
            infoGrid.style.display = 'grid';
            
            // Reset current operation after modal is closed
            currentOperation = null;
        }

        function viewDetails() {
            // Close the modal
            closeModal();
            
            // Update details panel with current operation data
            const detailsPanel = document.getElementById('operationDetailsPanel');
            const operationType = document.getElementById('operationType').textContent;
            const targetDevices = document.getElementById('targetDevices').textContent;
            const estimatedProfit = document.getElementById('estimatedProfit').textContent;
            
            // Update details panel content
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = targetDevices;
            document.getElementById('detailsEstimatedProfit').textContent = estimatedProfit;
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
            
            // Update execution status numbers
            document.getElementById('detailsDispatched').textContent = document.getElementById('devicesDispatched').textContent;
            document.getElementById('detailsReceived').textContent = document.getElementById('devicesReceived').textContent;
            document.getElementById('detailsActivated').textContent = document.getElementById('devicesActivated').textContent;
            
            // Show the details panel
            detailsPanel.style.display = 'block';
            setTimeout(() => {
                detailsPanel.classList.add('show');
            }, 10);
        }
        
        // Remove duplicate function - using the one at line 5875 instead

        function closeDetailsPanel() {
            const detailsPanel = document.getElementById('operationDetailsPanel');
            detailsPanel.classList.remove('show');
            setTimeout(() => {
                detailsPanel.style.display = 'none';
            }, 300);
        }

        function populateOperationDrawerData() {
            console.log('populateOperationDrawerData called with currentOperation:', currentOperation);
            // Update basic information
            const operationType = currentOperation === 'charge' ? '充电' : (currentOperation === 'discharge' ? '放电' : '停止操作');
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = '500个设备';
            const profitElement = document.getElementById('detailsEstimatedProfit');
            if (profitElement) {
                profitElement.innerHTML = '<span data-i18n="estimatedProfitValue">+$340</span>';
            }
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
            console.log('Operation drawer data populated successfully');
        }

        // Operation Details Tabs Functions (copied from OperationDrawer)
        let currentOperationData = null;
        let activeOperationTab = 'basic';

        function switchOperationTab(tabKey) {
            // Update active tab
            document.querySelectorAll('.operation-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabKey}"]`).classList.add('active');
            
            activeOperationTab = tabKey;
            
            // Generate content for the selected tab
            if (currentOperationData) {
                generateOperationTabContent(currentOperationData, tabKey);
            }
        }

        function generateOperationTabContent(operation, tabKey) {
            const contentContainer = document.getElementById('operationTabContent');
            
            switch(tabKey) {
                case 'basic':
                    contentContainer.innerHTML = generateBasicInfo(operation);
                    break;
                case 'stations':
                    contentContainer.innerHTML = generateStationDetails(operation);
                    break;
                case 'timeline':
                    contentContainer.innerHTML = generateTimeline(operation);
                    break;
                default:
                    contentContainer.innerHTML = generateBasicInfo(operation);
            }
        }

        function generateBasicInfo(operation) {
            const commandInfo = getCommandInfo(operation.command);
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>📊</span>
                        ${window.i18n ? window.i18n.getText('operationLog.overview.title') : '操作概览'}
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${operation.stations}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.totalStations') : '总电站数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.success}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successCount') : '成功数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.failed}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.failedCount') : '失败数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round((operation.success / operation.stations) * 100)}%</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successRate') : '成功率'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>📝</span>
                        ${window.i18n ? window.i18n.getText('operationLog.basicInfo.title') : '基本信息'}
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationTime') : '操作时间'}</span>
                        <span class="detail-value">${operation.time}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationCommand') : '操作命令'}</span>
                        <span class="detail-value">
                            <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operator') : '操作人员'}</span>
                        <span class="detail-value">${getOperatorName(operation.operator)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationId') : '操作编号'}</span>
                        <span class="detail-value">#${operation.id.toString().padStart(8, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.executionStatus') : '执行状态'}</span>
                        <span class="detail-value">
                            <span class="status-tag ${operation.failed === 0 ? 'success' : operation.success > operation.failed ? 'warning' : 'danger'}">
                                ${operation.failed === 0 ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.allSuccess') : '全部成功') : operation.success > operation.failed ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.partialSuccess') : '部分成功') : (window.i18n ? window.i18n.getText('operationLog.basicInfo.mostlyFailed') : '多数失败')}
                            </span>
                        </span>
                    </div>
                </div>
            `;
        }

        function generateStationDetails(operation) {
            // Generate simulated station data
            const stations = [];
            for (let i = 0; i < operation.stations; i++) {
                const isSuccess = i < operation.success;
                stations.push({
                    id: `ST${(1000 + i).toString()}`,
                    name: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.station') : '电站'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                    status: isSuccess ? 'success' : 'failed',
                    location: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.area') : '区域'}${Math.floor(i / 10) + 1}`,
                    executeTime: new Date(new Date(operation.time).getTime() + i * 1000).toLocaleTimeString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')
                });
            }
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>⚡</span>
                        ${window.i18n ? window.i18n.getText('operationLog.stationDetails.title') : '电站执行详情'}
                    </div>
                    <div class="scrollable-list">
                        ${stations.map(station => `
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">${station.name} (${station.id})</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                        ${station.location} • ${station.executeTime}
                                    </div>
                                </div>
                                <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                    ${station.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.stationDetails.success') : '成功') : (window.i18n ? window.i18n.getText('operationLog.stationDetails.failed') : '失败')}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateTimeline(operation) {
            const startTime = new Date(operation.time);
            const timeline = [
                { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('operationLog.timeline.commandCreated') : '操作命令创建', status: 'success' },
                { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('operationLog.timeline.validationPassed') : '命令验证通过', status: 'success' },
                { time: startTime, event: window.i18n ? window.i18n.getText('operationLog.timeline.executionStarted') : '开始执行命令', status: 'success' },
                { time: new Date(startTime.getTime() + 30000), event: `${operation.success}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsSuccess') : '个电站执行成功'}`, status: 'success' },
            ];
            
            if (operation.failed > 0) {
                timeline.push({
                    time: new Date(startTime.getTime() + 45000),
                    event: `${operation.failed}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsFailed') : '个电站执行失败'}`,
                    status: 'danger'
                });
            }
            
            timeline.push({
                time: new Date(startTime.getTime() + 60000),
                event: window.i18n ? window.i18n.getText('operationLog.timeline.executionCompleted') : '操作执行完成',
                status: operation.failed === 0 ? 'success' : 'warning'
            });
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>🕰️</span>
                        ${window.i18n ? window.i18n.getText('operationLog.timeline.title') : '执行时间线'}
                    </div>
                    <div style="position: relative; padding-left: 24px;">
                        <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                        ${timeline.map((item, index) => `
                            <div style="position: relative; margin-bottom: 24px;">
                                <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                    <span class="detail-label">${item.event}</span>
                                    <span class="status-tag ${item.status}">
                                        ${item.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.timeline.normal') : '正常') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('operationLog.timeline.warning') : '警告') : (window.i18n ? window.i18n.getText('operationLog.timeline.error') : '错误')}
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                    ${item.time.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Helper functions
        function getCommandInfo(command) {
            const commands = {
                'charge': { text: window.i18n ? window.i18n.getText('charge') : '充电', class: 'charge' },
                'discharge': { text: window.i18n ? window.i18n.getText('discharge') : '放电', class: 'discharge' }
            };
            return commands[command] || { text: command, class: 'charge' };
        }

        function getOperatorName(operator) {
            const operators = {
                'admin': window.i18n ? window.i18n.getText('systemAdmin') : '系统管理员',
                'user1': window.i18n ? window.i18n.getText('operatorA') : '操作员A',
                'user2': window.i18n ? window.i18n.getText('operatorB') : '操作员B'
            };
            return operators[operator] || operator;
        }

        // Initialize operation data when modal shows device response statistics
        function initializeOperationData() {
            const now = new Date();
            currentOperationData = {
                id: Math.floor(Math.random() * 1000000),
                time: now.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN'),
                command: currentOperation || 'discharge',
                operator: 'admin',
                stations: parseInt(document.getElementById('devicesDispatched')?.textContent || '500'),
                success: parseInt(document.getElementById('devicesActivated')?.textContent || '445'),
                failed: parseInt(document.getElementById('devicesDispatched')?.textContent || '500') - parseInt(document.getElementById('devicesActivated')?.textContent || '445')
            };
            
            // Generate initial content for the basic tab
            generateOperationTabContent(currentOperationData, 'basic');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('operationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        updateRealtimeData();
                        break;
                    case '1':
                        e.preventDefault();
                        switchRegion('NSW', document.querySelector('.tab.active'));
                        break;
                    case '2':
                        e.preventDefault();
                        switchRegion('QLD', document.querySelectorAll('.tab')[1]);
                        break;
                }
            }
        });

        // Touch gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                // Swipe left - next region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex < tabs.length - 1) {
                    tabs[activeIndex + 1].click();
                }
            }
            if (touchEndX > touchStartX + 50) {
                // Swipe right - previous region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex > 0) {
                    tabs[activeIndex - 1].click();
                }
            }
        }

        // Header functions
        function toggleMessages() {
            alert('消息中心：\n• 系统维护通知 (2小时前)\n• 电价波动提醒 (4小时前)\n• 设备状态报告 (1天前)');
        }

        function toggleLanguage() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function changeLanguage(langCode, langName) {
            document.getElementById('currentLang').textContent = langName;
            document.getElementById('languageDropdown').style.display = 'none';
            // 这里可以添加实际的语言切换逻辑
            console.log('Language changed to:', langCode);
        }

        function toggleUserMenu() {
            alert('用户菜单：\n• 个人设置\n• 账户管理\n• 退出登录');
        }

        // 点击其他地方关闭下拉菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('languageDropdown').style.display = 'none';
            }
        });

        // 累计价格卡片图表和区域切换联动
        function renderCumulativeChart(region) {
            if (!window.echarts || !document.getElementById('cumulativeMarketChart')) return;
            const chart = echarts.init(document.getElementById('cumulativeMarketChart'));
            // 区域参数影响数据生成
            const regionBase = {
                'NSW': 200,
                'QLD': 180,
                'VIC': 160,
                'SA': 140,
                'TAS': 120
            };
            const base = regionBase[region] || 200;
            const hours = [];
            const prices = [];
            const forecastPrices = [];
            const currentTime = new Date().getHours();
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
            }
            let lastPrice = base;
            for (let i = 0; i < 24; i++) {
                if (i < currentTime) {
                    const price = lastPrice + (Math.random() - 0.5) * 20;
                    prices.push(price);
                    forecastPrices.push(null);
                    lastPrice = price;
                } else if (i === currentTime) {
                    const price = lastPrice + (Math.random() - 0.5) * 20;
                    prices.push(price);
                    forecastPrices.push(price);
                    lastPrice = price;
                } else {
                    prices.push(null);
                    const price = lastPrice + (Math.random() - 0.5) * 30;
                    forecastPrices.push(price);
                    lastPrice = price;
                }
            }
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('historicalPrice') : 'Historical Price',
                        window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price'
                    ],
                    textStyle: { color: 'rgba(255,255,255,0.7)', fontWeight: 600 },
                    top: 0,
                    itemWidth: 18,
                    itemHeight: 8,
                    selectedMode: false,
                    formatter: function(name) {
                        return name;
                    }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', interval: 2 }
                },
                yAxis: {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('price') : 'Price',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                },
                series: [
                    {
                        name: window.i18n ? window.i18n.getText('historicalPrice') : 'Historical Price',
                        type: 'line',
                        data: prices,
                        smooth: true,
                        lineStyle: { color: '#00ff88', width: 2 },
                        itemStyle: { color: '#00ff88' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.2)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0)' }
                            ])
                        },
                        symbol: 'circle',
                        showSymbol: false
                    },
                    {
                        name: window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price',
                        type: 'line',
                        data: forecastPrices,
                        smooth: false,
                        lineStyle: { color: '#00ff88', width: 2, type: 'dashed', opacity: 0.85 },
                        itemStyle: { color: '#00ff88' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.15)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0)' }
                            ])
                        },
                        symbol: 'circle',
                        showSymbol: false
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', throttle(() => chart.resize(), 250));
        }

        // 区域切换时累计价格卡片所有数据切换
        function switchCumulativeRegion(region, btn) {
            // 按钮高亮 - 更新选择器以匹配新的HTML结构
            const cumulativeContainer = btn.closest('.glass');
            cumulativeContainer.querySelectorAll('.region-tab').forEach(tab => tab.classList.remove('active'));
            btn.classList.add('active');
            
            // 同步市场区域选择
            currentRegion = region;
            
            // 切换大数字区数据（模拟）
            const baseMap = { 'NSW': 746630, 'QLD': 623800, 'VIC': 512400, 'SA': 401200, 'TAS': 312000 };
            const forecastMap = { 'NSW': 746622, 'QLD': 623790, 'VIC': 512390, 'SA': 401180, 'TAS': 311980 };
            const notExceededText = window.i18n ? window.i18n.getText('notExceeded') : '未超阈';
            const statusMap = { 'NSW': notExceededText, 'QLD': notExceededText, 'VIC': notExceededText, 'SA': notExceededText, 'TAS': notExceededText };
            
            // 更新累计价格卡片中的值
            const priceCards = cumulativeContainer.querySelectorAll('.price-card-value');
            if (priceCards.length >= 3) {
                priceCards[0].textContent = `$${baseMap[region].toLocaleString()}`;
                priceCards[1].textContent = `$${forecastMap[region].toLocaleString()}`;
                priceCards[2].textContent = statusMap[region];
            }
            
            // 切换图表
            renderCumulativeChart(region);
        }

        // 页面加载时默认渲染 NSW - 这个功能已在主初始化代码中处理
        
        // Force apply button colors
        function forceButtonStyles() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn && !chargeBtn.classList.contains('stop-btn')) {
                chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #00D67A, #00FF88)', 'important');
                chargeBtn.style.setProperty('border', '2px solid rgba(0, 255, 136, 0.3)', 'important');
                chargeBtn.style.setProperty('color', '#000', 'important');
                chargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(0, 255, 136, 0.3)', 'important');
            }
            
            if (dischargeBtn && !dischargeBtn.classList.contains('stop-btn')) {
                dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #FFA500, #FFD700)', 'important');
                dischargeBtn.style.setProperty('border', '2px solid rgba(255, 215, 0, 0.3)', 'important');
                dischargeBtn.style.setProperty('color', '#000', 'important');
                dischargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(255, 215, 0, 0.3)', 'important');
            }
            
            console.log('Button styles applied with !important!');
        }
        

        // 主题切换按钮逻辑
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.onclick = function() {
                document.body.classList.toggle('theme-dark');
                this.textContent = document.body.classList.contains('theme-dark') ? '☀️' : '🌙';
            }
        }
        
        // 更新动态内容的函数
        function updateDynamicContent(language) {
            if (!window.i18n) {
                console.warn('window.i18n not available in updateDynamicContent');
                return;
            }
            
            try {
                console.log('updateDynamicContent called with language:', language);
                // 更新所有i18n元素
                window.i18n.updatePageTexts();
                
                // 更新页面标题
                const pageTitles = {
                    'zh': '能源管理中心',
                    'en': 'Energy Management Center',
                    'ja': 'エネルギー管理センター',
                    'ko': '에너지 관리 센터'
                };
                document.title = pageTitles[language] || pageTitles['zh'];
                
                // 更新确认按钮文本 (动态设置的)
                const confirmBtn = document.getElementById('confirmExecuteBtn');
                if (confirmBtn) {
                    const confirmText = window.i18n.getText('confirmExecute');
                    if (confirmText !== 'confirmExecute') {
                        confirmBtn.innerHTML = '<span data-i18n="confirmExecute">' + confirmText + '</span>';
                    }
                }
                
                // 更新当前操作文本
                const currentOpText = document.getElementById('currentOperationText');
                if (currentOpText && currentOpText.textContent === '无') {
                    const noneText = window.i18n.getText('none');
                    if (noneText !== 'none') {
                        currentOpText.textContent = noneText;
                    }
                }
                
                // 更新图表标题和图例
                updateChartTitles(language);
                
                // 更新阈值状态文本
                const thresholdStatus = document.querySelector('[data-threshold-status]');
                if (thresholdStatus) {
                    const statusKey = thresholdStatus.getAttribute('data-threshold-status');
                    if (statusKey) {
                        const translations = {
                            'zh': { 'not_exceeded': '未超阈', 'exceeded': '已超阈', 'warning': '警告' },
                            'en': { 'not_exceeded': 'Below Threshold', 'exceeded': 'Exceeded', 'warning': 'Warning' },
                            'ja': { 'not_exceeded': '閾値未満', 'exceeded': '閾値超過', 'warning': '警告' },
                            'ko': { 'not_exceeded': '임계값 미만', 'exceeded': '임계값 초과', 'warning': '경고' }
                        };
                        const text = translations[language] && translations[language][statusKey];
                        if (text) {
                            thresholdStatus.textContent = text;
                        }
                    }
                }
                
                // 更新价格统计文本
                const priceLabels = document.querySelectorAll('[data-price-label]');
                priceLabels.forEach(label => {
                    const labelKey = label.getAttribute('data-price-label');
                    if (labelKey === 'current-cumulative') {
                        const text = language === 'en' ? 'Current Cumulative Price' :
                                   language === 'ja' ? '現在の累積価格' :
                                   language === 'ko' ? '현재 누적 가격' : '当前累计价格';
                        label.textContent = text;
                    } else if (labelKey === 'forecast-cumulative') {
                        const text = language === 'en' ? 'Forecast Cumulative Price (5min)' :
                                   language === 'ja' ? '予測累積価格（5分）' :
                                   language === 'ko' ? '예측 누적 가격 (5분)' : '预测累计价格(5min)';
                        label.textContent = text;
                    } else if (labelKey === 'threshold-status') {
                        const text = language === 'en' ? 'Threshold Status' :
                                   language === 'ja' ? '閾値状態' :
                                   language === 'ko' ? '임계값 상태' : '阈值状态';
                        label.textContent = text;
                    }
                });
                
                // 更新百分比变化文本
                const changeElements = document.querySelectorAll('[data-change-text]');
                changeElements.forEach(elem => {
                    const changeValue = elem.getAttribute('data-change-text');
                    if (changeValue) {
                        const changeText = language === 'en' ? `↑ ${changeValue}% vs Yesterday` :
                                         language === 'ja' ? `↑ 昨日比${changeValue}%` :
                                         language === 'ko' ? `↑ 어제대비 ${changeValue}%` : `↑ 比昨日${changeValue}%`;
                        elem.textContent = changeText;
                    }
                });
                
                // 更新数量单位 (个 -> units)
                const countElements = ['totalHomes', 'confirmTargetDevices', 'targetDevices', 'totalFamiliesCard', 'todayDischargeFamilies', 'familySummaryCard'];
                countElements.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem && elem.textContent.includes('个')) {
                        const number = elem.textContent.replace('个', '');
                        const unit = language === 'en' ? '' : 
                                   language === 'ja' ? '個' :
                                   language === 'ko' ? '개' : '个';
                        elem.textContent = number + unit;
                    }
                });
                
                // 家庭单位已删除，不需要更新
                
                // 更新家庭/Family显示切换
                const chineseTexts = document.querySelectorAll('.chinese-text');
                const englishTexts = document.querySelectorAll('.english-text');
                
                if (language === 'en') {
                    chineseTexts.forEach(elem => elem.style.display = 'none');
                    englishTexts.forEach(elem => elem.style.display = 'inline');
                } else {
                    chineseTexts.forEach(elem => elem.style.display = 'inline');
                    englishTexts.forEach(elem => elem.style.display = 'none');
                }
                
                // 更新地区状态显示
                if (typeof updateRegionStatusDisplay === 'function') {
                    console.log('Calling updateRegionStatusDisplay for language:', language);
                    updateRegionStatusDisplay();
                } else {
                    console.warn('updateRegionStatusDisplay function not found');
                }
                
                // 更新电站状态标签
                if (typeof updateStationStatusLabel === 'function') {
                    const currentRegionStatus = regionData[selectedMainRegion] ? regionData[selectedMainRegion].status : 'none';
                    console.log('Calling updateStationStatusLabel with status:', currentRegionStatus, 'for language:', language);
                    updateStationStatusLabel(currentRegionStatus);
                } else {
                    console.warn('updateStationStatusLabel function not found');
                }
                
                console.log('Dynamic content updated for language:', language);
            } catch (error) {
                console.error('Error updating dynamic content:', error);
            }
        }
        
        // 更新图表标题
        function updateChartTitles(language) {
            // 更新市场图表
            if (marketChart) {
                const option = marketChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('historicalPrice'),
                        window.i18n.getText('demand'),
                        window.i18n.getText('predictedPrice'),
                        window.i18n.getText('predictedDemand')
                    ];
                }
                if (option && option.yAxis) {
                    option.yAxis[0].name = window.i18n.getText('price');
                    option.yAxis[1].name = window.i18n.getText('demand');
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('historicalPrice');
                    option.series[1].name = window.i18n.getText('demand');
                    option.series[2].name = window.i18n.getText('predictedPrice');
                    option.series[3].name = window.i18n.getText('predictedDemand');
                }
                marketChart.setOption(option, true);
            }
            
            // 更新功率图表
            if (powerChart) {
                const option = powerChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('actualDischarge'),
                        window.i18n.getText('profit')
                    ];
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('actualDischarge');
                    option.series[1].name = window.i18n.getText('profit');
                }
                powerChart.setOption(option, true);
                
                // Force chart refresh for 'month' period to fix display issue
                if (powerChartTimeSelector && powerChartTimeSelector.getCurrentPeriod() === 'month') {
                    const { labels, power, revenue } = generateAnalyticsData('month');
                    updatePowerChartWithData(labels, power, revenue, 'month');
                }
            }
            
            // 更新图表标题
            const powerChartTitle = document.getElementById('powerChartTitle');
            if (powerChartTitle) {
                powerChartTitle.textContent = window.i18n.getText('powerRevenueTrend');
            }
        }
    </script>
    
    <!-- Device Command Modal -->
    <div id="deviceCommandModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeviceCommandModal()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n="deviceCommand">设备指令</h3>
                <button class="modal-close" onclick="closeDeviceCommandModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="command-info">
                    <div class="info-row">
                        <label data-i18n="operationType">操作类型</label>
                        <span id="commandOperationType" class="operation-type"></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n="targetDevices">目标设备</label>
                        <span id="commandTargetDevices">235 <span data-i18n="devices">设备</span></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n="executionTime">预计执行时间</label>
                        <span id="commandExecutionTime"><span data-i18n="immediately">立即</span></span>
                    </div>
                    <div class="info-row" id="estimatedRevenueRow" style="display: none;">
                        <label data-i18n="estimatedProfit">预计获利</label>
                        <span id="commandEstimatedRevenue" style="color: #00ff88; font-weight: 600;"><span data-i18n="estimatedProfitValue">+$340</span></span>
                    </div>
                </div>
                <div class="warning-message">
                    <span data-i18n="operationWarning">此操作将影响所有选中的设备，请确认后继续。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeviceCommandModal()" data-i18n="cancel">取消</button>
                <button class="btn btn-primary" id="confirmCommandBtn" onclick="executeDeviceCommand()" data-i18n="confirmExecute">确认执行</button>
            </div>
        </div>
    </div>
    
    <!-- Operation Result Modal (shown after charge/discharge command) -->
    <div id="operationResultModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10001;">
        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px);" onclick="closeOperationResultModal()"></div>
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1f2e; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); max-width: 600px; width: 90vw; overflow: hidden;">
            <div class="modal-header" style="padding: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(0, 255, 136, 0.2); display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 24px;">📊</span>
                    </div>
                    <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #fff;" data-i18n="deviceResponseStatisticsTitle">设备响应统计</h3>
                </div>
                <button style="background: none; border: none; font-size: 24px; color: rgba(255, 255, 255, 0.6); cursor: pointer; padding: 0; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;" onclick="closeOperationResultModal()" onmouseover="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.color='#fff';" onmouseout="this.style.background='none'; this.style.color='rgba(255, 255, 255, 0.6)';">×</button>
            </div>
            <div style="padding: 24px;">
                <p id="operationResultMessage" style="color: rgba(255, 255, 255, 0.8); margin-bottom: 24px; font-size: 14px;"></p>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="operationType">操作类型</div>
                        <div id="resultOperationType" style="font-size: 16px; font-weight: 600;"></div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="targetDevices">目标设备</div>
                        <div id="resultTargetDevices" style="font-size: 16px; font-weight: 600; color: #fff;">500</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px; text-align: center;">
                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.6); margin-bottom: 8px;" data-i18n="estimatedDuration">预计时长</div>
                        <div style="font-size: 16px; font-weight: 600; color: #fff;">15-30 <span data-i18n="minutes">分钟</span></div>
                    </div>
                </div>
                
                <div style="background: rgba(0, 255, 136, 0.1); border-radius: 16px; padding: 24px;">
                    <h4 style="color: #00ff88; margin: 0 0 20px 0; text-align: center; font-size: 16px;" data-i18n="deviceResponseStatistics">Device Response Statistics</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">500</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="commandsSent">Commands Sent</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="commandsReceived" style="font-size: 36px; font-weight: 700; color: #00ff88;">498</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="commandsReceived">Commands Received</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="devicesActivated" style="font-size: 36px; font-weight: 700; color: #00ff88;">448</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="devicesActivated">Devices Activated</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="successRate" style="font-size: 36px; font-weight: 700; color: #00ff88;">89%</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n="successRate">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 32px 24px; min-height: 100px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <button style="background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 8px 16px; font-size: 14px; cursor: pointer; transition: all 0.3s;" onclick="closeOperationResultModal()" onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'" data-i18n="close">关闭</button>
                <button style="background: #00ff88; color: #000; border: none; border-radius: 8px; padding: 8px 24px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onclick="viewDetailsFromResult()" onmouseover="this.style.background='#00dd77'" onmouseout="this.style.background='#00ff88'">
                    <span data-i18n="viewDetails">查看详情</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Device Response Statistics Modal -->
    <div id="deviceResponseModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10002; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 28px 32px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: flex-start; background: rgba(255, 255, 255, 0.02);">
                <div class="modal-icon" id="responseModalIcon" style="width: 48px; height: 48px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 16px; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                    <span id="modalIcon" style="font-size: 24px;">📊</span>
                </div>
                <h3 class="modal-title" style="margin: 0; font-size: 20px; font-weight: 700; color: #fff; letter-spacing: 0.3px;" data-i18n="deviceResponseStatistics">设备响应统计</h3>
            </div>
            
            <div class="modal-body" style="padding: 32px;">
                <p class="modal-message" style="color: rgba(255, 255, 255, 0.7); margin: 0 0 24px 0; font-size: 15px; font-weight: 400; line-height: 1.5; text-align: left;" id="operationCompleteMessage">操作完成，以下是设备响应统计报告：</p>
                
                <div class="modal-info-grid" style="display: flex; flex-direction: column; gap: 0; margin-bottom: 28px;">
                    <div style="display: flex; gap: 16px;">
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px 20px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 6px; font-weight: 400;" data-i18n="operationType">操作类型</div>
                            <div class="modal-info-value" id="operationTypeDisplay" style="color: #00ff88; font-size: 18px; font-weight: 600; letter-spacing: 0.3px;">充电</div>
                        </div>
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; padding: 16px 20px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 6px; font-weight: 400;" data-i18n="targetDevices">影响设备</div>
                            <div class="modal-info-value" id="targetDevicesDisplay" style="color: #fff; font-size: 18px; font-weight: 600;">500个</div>
                        </div>
                    </div>
                </div>
                
                <div class="status-summary" style="background: linear-gradient(145deg, rgba(0, 255, 136, 0.08), rgba(0, 255, 136, 0.04)); border: 1px solid rgba(0, 255, 136, 0.15); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 28px; font-weight: 700; color: #00ff88; line-height: 1;">500</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-top: 6px;" data-i18n="commandsIssued">指令下发</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="commandsReceivedStat" style="font-size: 28px; font-weight: 700; color: #00ff88; line-height: 1;">492</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-top: 6px;" data-i18n="commandsReceived">指令接收</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="devicesActivatedStat" style="font-size: 28px; font-weight: 700; color: #00ff88; line-height: 1;">486</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-top: 6px;" data-i18n="devicesExecuted">已下发</div>
                        </div>
                        <div style="text-align: center;">
                            <div id="successRateStat" style="font-size: 28px; font-weight: 700; color: #00ff88; line-height: 1;">97%</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-top: 6px;" data-i18n="successRate">成功率</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 20px 28px 28px; display: flex; gap: 12px;">
                <button class="modal-btn modal-cancel-btn" onclick="closeDeviceResponseModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.9); border: 1px solid rgba(255, 255, 255, 0.12); padding: 10px 20px; border-radius: 999px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s; min-width: 80px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.12)'" data-i18n="close">关闭</button>
                <button class="modal-btn modal-confirm-btn" onclick="viewDeviceResponseDetails()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 10px 20px; border-radius: 999px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s; border: none; box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3); min-width: 100px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 255, 136, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 255, 136, 0.3)'" data-i18n="viewDetails">查看详情</button>
            </div>
        </div>
    </div>
    
    
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: relative;
            background: #1a1f2e;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .command-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .info-row span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
        
        .operation-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .operation-type.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .operation-type.discharge {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }
        
        .operation-type.stop {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 16px;
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }
        
        
        .btn {
            padding: 10px 24px;
            border-radius: 22px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 100px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00D67A, #00FF88);
            color: #000;
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        /* Device Response Modal Styles */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .modal-tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .modal-tab.active {
            color: #fff;
        }
        
        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }
        
        .tab-content {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .station-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .station-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .detail-label {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .detail-value {
            color: #fff;
        }
        
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 32px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #1a1f2e;
        }
        
        .timeline-item.completed::before {
            background: #00ff88;
        }
        
        .timeline-item.active::before {
            background: #ffa500;
            box-shadow: 0 0 0 4px rgba(255, 165, 0, 0.2);
        }
        
        .timeline-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .timeline-title {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        /* Result Modal Styles */
        .result-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }
        
        .result-info-item {
            text-align: center;
        }
        
        .result-info-item label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-info-item span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
    </style>
    
    <script>
        // Device Command Modal Functions
        let isOperationActive = false;
        
        // 移除重复的函数定义，使用主要的handleCharge和handleDischarge函数
        
        
        function showDeviceCommandModal(operation, currentOpText) {
            const modal = document.getElementById('deviceCommandModal');
            const modalTitle = modal.querySelector('.modal-title');
            const operationType = document.getElementById('commandOperationType');
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const warningMessage = modal.querySelector('.warning-message span');
            const executionTime = document.getElementById('commandExecutionTime');
            
            // Update modal based on operation type
            if (operation === 'charge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmCharge') : '确认充电';
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : '充电';
                operationType.className = 'operation-type charge';
                operationType.style.color = '#00ff88';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : '此操作将影响所有选中的设备，请确认后继续。';
                
                // Hide estimated revenue for charge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            } else if (operation === 'discharge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmDischarge') : '确认放电';
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : '放电';
                operationType.className = 'operation-type discharge';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : '此操作将影响所有选中的设备，请确认后继续。';
                
                // Show estimated revenue for discharge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) {
                    revenueRow.style.display = 'flex';
                    const revenueElement = document.getElementById('commandEstimatedRevenue');
                    if (revenueElement) {
                        revenueElement.innerHTML = '<span data-i18n="estimatedProfitValue">+$340</span>';
                    }
                }
            } else if (operation === 'stop') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmStop') : '确认停止';
                const stopText = window.i18n ? window.i18n.getText('stopOperation') : '停止操作';
                operationType.textContent = stopText;
                operationType.className = 'operation-type stop';
                warningMessage.textContent = window.i18n ? window.i18n.getText('stopWarning') : '停止操作将立即终止所有设备的充电/放电状态，设备将恢复到待机模式。';
                
                // Hide estimated revenue for stop
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            }
            
            // Store operation for execution
            confirmBtn.setAttribute('data-operation', operation);
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closeDeviceCommandModal() {
            const modal = document.getElementById('deviceCommandModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
        }
        
        function executeDeviceCommand() {
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const operation = confirmBtn.getAttribute('data-operation');
            
            closeDeviceCommandModal();
            
            // Update button states
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operation === 'stop') {
                // 执行停止操作
                console.log('Stop operation confirmed, executing stop...');
                executeStopOperation();
            } else {
                // Set active operation
                isOperationActive = true;
                currentOperation = operation;
                
                // Add operating class to container for centering
                actionButtons.classList.add('operating');
                
                // Update buttons - only show one centered stop button
                if (operation === 'charge') {
                    chargeBtn.innerHTML = `<span data-i18n="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                    chargeBtn.classList.remove('charge-btn');
                    chargeBtn.classList.add('stop-btn');
                    chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    chargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    chargeBtn.style.setProperty('color', '#fff', 'important');
                    chargeBtn.style.setProperty('flex', '1', 'important');
                    chargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide discharge button
                    dischargeBtn.style.display = 'none';
                } else if (operation === 'discharge') {
                    dischargeBtn.innerHTML = `<span data-i18n="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                    dischargeBtn.classList.remove('discharge-btn');
                    dischargeBtn.classList.add('stop-btn');
                    dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    dischargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    dischargeBtn.style.setProperty('color', '#fff', 'important');
                    dischargeBtn.style.setProperty('flex', '1', 'important');
                    dischargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide charge button
                    chargeBtn.style.display = 'none';
                }
            }
            
            // Only show modal immediately for stop operation
            // For charge/discharge, the animation will handle showing the modal when complete
            if (operation === 'stop') {
                setTimeout(() => {
                    // 不再自动打开详情抽屉
                    console.log('Stop operation complete');
                }, 1500);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Simple notification (you can enhance this)
            console.log(`${type}: ${message}`);
        }
        
        // Operation Result Modal Functions
        function showOperationResultModal(operation) {
            const modal = document.getElementById('operationResultModal');
            const message = document.getElementById('operationResultMessage');
            const operationType = document.getElementById('resultOperationType');
            const targetDevices = document.getElementById('resultTargetDevices');
            
            // Set operation type
            if (operation === 'charge') {
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : '充电';
                operationType.style.color = '#00ff88';
                message.textContent = window.i18n ? window.i18n.getText('chargingCompleteMessage') : '充电指令下发完成，以下是设备响应统计报告：';
            } else if (operation === 'discharge') {
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : '放电';
                operationType.style.color = '#ffd700';
                message.textContent = window.i18n ? window.i18n.getText('dischargingCompleteMessage') : '放电指令下发完成，以下是设备响应统计报告：';
            }
            
            // Set target devices - 英文模式只显示数字
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            if (currentLang === 'en') {
                targetDevices.textContent = '500';
            } else {
                targetDevices.textContent = '500个';
            }
            
            // 生成随机统计数据
            const commandsReceived = Math.floor(Math.random() * 10) + 490; // 490-499
            const devicesActivated = Math.floor(Math.random() * 50) + 430; // 430-479
            const successRate = Math.floor((devicesActivated / 500) * 100);
            
            document.getElementById('commandsReceived').textContent = commandsReceived;
            document.getElementById('devicesActivated').textContent = devicesActivated;
            document.getElementById('successRate').textContent = successRate + '%';
            
            // 显示弹窗
            modal.style.display = 'block';
        }
        
        function closeOperationResultModal() {
            document.getElementById('operationResultModal').style.display = 'none';
        }
        
        function viewDetailsFromResult() {
            closeOperationResultModal();
            showDeviceResponseModal();
        }
        
        // Device Response Modal Functions
        function showDeviceResponseModal() {
            const modal = document.getElementById('deviceResponseModal');
            modal.style.display = 'flex';
            // Load data for the modal
            loadDeviceResponseData();
        }
        
        function closeDeviceResponseModal() {
            document.getElementById('deviceResponseModal').style.display = 'none';
            // 设置标志，防止自动重新显示
            window.deviceResponseModalClosed = true;
            console.log('Device response modal closed by user');
        }
        
        function viewDeviceResponseDetails() {
            // 使用新的抽屉组件
            if (!window.deviceResponseDrawer) {
                window.deviceResponseDrawer = new DeviceResponseDrawer();
            }
            
            // 创建与操作记录页面相同格式的数据
            const operation = {
                id: Date.now(),
                time: new Date().toLocaleString(),
                command: currentOperation || 'charge',
                operator: 'System',
                region: selectedMainRegion || 'NSW',
                stations: 235,
                success: 230,
                failed: 5
            };
            
            // 打开抽屉 - 不关闭设备响应统计弹窗
            window.deviceResponseDrawer.open(operation);
        }
        
        
        function switchDeviceResponseTab(tabName, tabElement) {
            // Update active tab
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
        
        function loadDeviceResponseData(operation) {
            // 模拟加载设备响应数据
            const deviceData = {
                operation: operation || currentOperation || 'charge',
                totalDevices: 500,
                commandsReceived: Math.floor(Math.random() * 10) + 490,
                devicesActivated: Math.floor(Math.random() * 50) + 430,
                onlineDevices: Math.floor(Math.random() * 10) + 490,
                executingDevices: Math.floor(Math.random() * 50) + 430,
                stations: generateStationData(50), // 生成50个电站数据
                timeline: generateTimelineData()
            };
            
            // 存储数据以供后续使用
            window.currentDeviceResponseData = deviceData;
            
            return deviceData;
        }
        
        // 生成随机电站数据
        function generateStationData(count) {
            const stations = [];
            const regions = ['NSW', 'VIC', 'QLD', 'WA', 'SA', 'TAS', 'NT', 'ACT'];
            const statuses = ['online', 'charging', 'discharging', 'idle', 'offline'];
            const statusLabels = {
                online: { zh: '在线', en: 'Online' },
                charging: { zh: '充电中', en: 'Charging' },
                discharging: { zh: '放电中', en: 'Discharging' },
                idle: { zh: '空闲', en: 'Idle' },
                offline: { zh: '离线', en: 'Offline' }
            };
            
            for (let i = 0; i < count; i++) {
                const region = regions[Math.floor(Math.random() * regions.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                stations.push({
                    id: `${region}-${String(i + 1).padStart(3, '0')}`,
                    name: `Station ${region}-${String(i + 1).padStart(3, '0')}`,
                    region: region,
                    location: `${region} Region`,
                    capacity: Math.floor(Math.random() * 400) + 100, // 100-500 kWh
                    power: Math.floor(Math.random() * 200) + 50, // 50-250 kW
                    soc: Math.floor(Math.random() * 100), // 0-100%
                    status: status,
                    statusLabel: statusLabels[status]
                });
            }
            
            return stations;
        }
        
        // 生成时间线数据
        function generateTimelineData() {
            const now = new Date();
            const timeline = [];
            
            // 指令下发
            timeline.push({
                time: formatTime(now),
                title: { zh: '指令下发', en: 'Command Issued' },
                description: { zh: '系统向所有设备发送操作指令', en: 'System sent operation command to all devices' },
                type: 'success'
            });
            
            // 设备响应
            const responseTime = new Date(now.getTime() + 5000);
            const respondedCount = Math.floor(Math.random() * 10) + 490;
            timeline.push({
                time: formatTime(responseTime),
                title: { zh: '设备响应', en: 'Devices Responded' },
                description: { 
                    zh: `${respondedCount}个设备确认收到指令`, 
                    en: `${respondedCount} devices confirmed receipt of command` 
                },
                type: 'success'
            });
            
            // 开始执行
            const executionTime = new Date(now.getTime() + 15000);
            const executingCount = Math.floor(Math.random() * 50) + 430;
            timeline.push({
                time: formatTime(executionTime),
                title: { zh: '开始执行', en: 'Execution Started' },
                description: { 
                    zh: `${executingCount}个设备开始执行操作`, 
                    en: `${executingCount} devices started executing operation` 
                },
                type: 'active'
            });
            
            // 部分完成
            const partialTime = new Date(now.getTime() + 60000);
            const completedCount = Math.floor(Math.random() * 100) + 300;
            timeline.push({
                time: formatTime(partialTime),
                title: { zh: '部分完成', en: 'Partial Completion' },
                description: { 
                    zh: `${completedCount}个设备已完成操作`, 
                    en: `${completedCount} devices completed operation` 
                },
                type: 'info'
            });
            
            return timeline;
        }
        
        // 格式化时间
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        
        // 添加全局强制切换到市场页面的命令
        window.forceMarket = function() {
            console.log('Force switching to market page');
            switchPanel('market');
            
            // 更新按钮状态
            const marketTab = document.querySelector('[onclick*="switchPanel(\'market\')"]');
            const mapTab = document.querySelector('[onclick*="switchPanel(\'map\')"]');
            if (marketTab) marketTab.classList.add('active');
            if (mapTab) mapTab.classList.remove('active');
            
            // 更新面板显示
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            if (marketPanel) {
                marketPanel.style.display = 'block';
                marketPanel.classList.add('active');
            }
            if (mapPanel) {
                mapPanel.style.display = 'none';
                mapPanel.classList.remove('active');
            }
            
            console.log('Switched to market page successfully');
        };
        
        // 在控制台输出帮助信息
        console.log('💡 Tip: Use window.forceMarket() to force switch to market page');
        
        // 添加手动测试函数
        window.testMarketChart = function() {
            console.log('Testing market chart...');
            const container = document.getElementById('marketChart');
            if (!container) {
                console.error('Market chart container not found!');
                return;
            }
            
            console.log('Container found:', container);
            console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            console.log('Container parent:', container.parentElement);
            console.log('Panel active:', document.getElementById('marketPanel').classList.contains('active'));
            
            // 销毁旧实例
            if (marketChart) {
                marketChart.dispose();
            }
            
            // 创建新实例
            marketChart = echarts.init(container);
            
            // 使用最简单的配置
            const option = {
                title: { text: 'Market Test' },
                xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                yAxis: { type: 'value' },
                series: [{ data: [120, 200, 150], type: 'line' }]
            };
            
            marketChart.setOption(option);
            console.log('Test chart created:', marketChart);
        };
        
        window.testMapChart = function() {
            console.log('Testing map chart...');
            const container = document.getElementById('australiaMap');
            if (!container) {
                console.error('Map chart container not found!');
                return;
            }
            
            // 切换到地图面板
            switchPanel('map');
            
            setTimeout(() => {
                console.log('Container found:', container);
                console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
                
                // 销毁旧实例
                if (mapChart) {
                    mapChart.dispose();
                }
                
                // 创建新实例
                mapChart = echarts.init(container);
                
                // 使用最简单的配置
                const option = {
                    title: { text: 'Map Test' },
                    xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                    yAxis: { type: 'value' },
                    series: [{ data: [120, 200, 150], type: 'bar' }]
                };
                
                mapChart.setOption(option);
                console.log('Test chart created:', mapChart);
            }, 300);
        };
        
        console.log('💡 Use window.testMarketChart() or window.testMapChart() to test charts');
        
        // 修复函数 - 重新初始化所有图表
        window.fixCharts = function() {
            console.log('Fixing charts...');
            
            // 确保容器可见
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            
            // 激活市场面板
            marketPanel.classList.add('active');
            marketPanel.style.display = 'flex';
            mapPanel.classList.remove('active');
            mapPanel.style.display = 'none';
            
            // 重新初始化市场图表
            setTimeout(() => {
                if (marketChart) {
                    marketChart.dispose();
                }
                initMarketChart();
                
                // 切换到地图面板并初始化
                setTimeout(() => {
                    mapPanel.classList.add('active');
                    mapPanel.style.display = 'flex';
                    marketPanel.classList.remove('active');
                    marketPanel.style.display = 'none';
                    
                    if (mapChart) {
                        mapChart.dispose();
                    }
                    initMap();
                    
                    // 切回市场面板
                    setTimeout(() => {
                        marketPanel.classList.add('active');
                        marketPanel.style.display = 'flex';
                        mapPanel.classList.remove('active');
                        mapPanel.style.display = 'none';
                        
                        if (marketChart) {
                            if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                        }
                        
                        console.log('Charts fixed!');
                    }, 500);
                }, 500);
            }, 100);
        };
        
        console.log('💡 Use window.fixCharts() to reinitialize all charts');
        
        // Update power revenue chart when language changes
        window.updatePowerRevenueChartLanguage = function() {
            if (!powerRevenueChart) return;
            
            powerRevenueChart.setOption({
                legend: {
                    data: [window.i18n.getText('actualDischarge'), window.i18n.getText('profit')]
                },
                yAxis: [
                    {
                        name: window.i18n.getText('discharge')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ],
                series: [
                    {
                        name: window.i18n.getText('actualDischarge')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ]
            });
        };
        
        // Update market chart when language changes
        window.updateMarketChartLanguage = function() {
            if (!marketChart) return;
            
            const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
            const translations = {
                en: {
                    historicalPrice: 'Historical Price',
                    predictedPrice: 'Predicted Price',
                    demand: 'Demand',
                    predictedDemand: 'Predicted Demand',
                    price: 'Price ($/MWh)',
                    demandUnit: 'Demand (MW)'
                },
                zh: {
                    historicalPrice: '历史价格',
                    predictedPrice: '预测价格',
                    demand: '需求',
                    predictedDemand: '预测需求',
                    price: '价格 ($/MWh)',
                    demandUnit: '需求 (MW)'
                }
            };
            
            marketChart.setOption({
                legend: {
                    data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')]
                },
                yAxis: [
                    {
                        name: getText('price')
                    },
                    {
                        name: getText('demandUnit')
                    }
                ],
                series: [
                    {
                        name: getText('historicalPrice')
                    },
                    {
                        name: getText('demand')
                    },
                    {
                        name: getText('predictedPrice')
                    },
                    {
                        name: getText('predictedDemand')
                    }
                ]
            });
        };
        
        // Force re-initialization when page is fully loaded
        window.addEventListener('load', function() {
            console.log('Window fully loaded, final chart check...');
            setTimeout(() => {
                // Force reinitialize market chart if it's not visible
                const marketPanel = document.getElementById('marketPanel');
                if (marketPanel && marketPanel.classList.contains('active')) {
                    const marketContainer = document.getElementById('marketChart');
                    if (marketContainer && (!marketChart || marketContainer.offsetHeight === 0)) {
                        console.log('Market chart needs reinitialization');
                        initMarketChart();
                    } else if (marketChart) {
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                }
            }, 1000);
        });
        
        // Debug function to force market chart initialization
        window.forceInitMarketChart = function() {
            console.log('Force initializing market chart...');
            const panel = document.getElementById('marketPanel');
            const container = document.getElementById('marketChart');
            
            if (!panel || !container) {
                console.error('Panel or container not found');
                return;
            }
            
            // Make sure panel is visible
            panel.classList.add('active');
            panel.style.display = 'flex';
            
            // Ensure container has dimensions
            if (container.offsetHeight === 0) {
                container.style.height = '400px';
            }
            
            // Reinitialize
            setTimeout(() => {
                initMarketChart();
                console.log('Market chart reinitialized');
            }, 100);
        };
        
        console.log('💡 Use window.forceInitMarketChart() to force initialize market chart');
        
        // Debug function to force update translations
        window.forceUpdateTranslations = function() {
            if (window.i18n) {
                window.i18n.updatePageTexts();
                console.log('Translations updated');
            } else {
                console.error('i18n not initialized');
            }
        };
        
        console.log('💡 Use window.forceUpdateTranslations() to force update all translations');
    </script>
    
    <style>
        /* 最终强制覆盖 - 确保抽屉在绝对最顶层 */
        #homeOperationDrawer,
        #homeOperationDrawer .drawer-overlay,
        #homeOperationDrawer .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        /* 降低首页其他元素的z-index */
        .hero-section, .hero-section * {
            z-index: 1 !important;
        }
        
        .dashboard-content, .dashboard-content * {
            z-index: 1 !important;
        }
        
        .panel-content {
            z-index: 1 !important;
        }
        
        .container, .container * {
            z-index: 1 !important;
        }
        
        /* 确保操作统计模态框也在合理层级 */
        #operationModal {
            z-index: 9999 !important;
        }
        
        /* 确保所有其他模态框在抽屉下方 */
        .modal:not(#homeOperationDrawer) {
            z-index: 1000 !important;
        }
        
        /* 特定元素层级覆盖 */
        .modal-content,
        .price-card,
        .chart-container,
        .info-card,
        .glass {
            z-index: 1 !important;
        }
    </style>
    
        </div>
    </div>
    
    <!-- 条件开关功能 -->
    <script>
        
        // 模拟地区数据
        const regionData = {
            'NSW': {
                status: 'none',
                chargeTime: '08:00-09:00',
                dischargeTime: '18:00-22:00',
                chargePrice: '60$',
                dischargePrice: '120$',
                chargeSoc: '70%',
                dischargeSoc: '30%'
            },
            'QLD': {
                status: 'autoCharge',
                chargeTime: '07:00-11:00',
                dischargeTime: '17:00-21:00',
                chargePrice: '45$',
                dischargePrice: '110$',
                chargeSoc: '75%',
                dischargeSoc: '25%'
            },
            'VIC': {
                status: 'manualCharge',
                chargeTime: '06:00-10:00',
                dischargeTime: '19:00-23:00',
                chargePrice: '55$',
                dischargePrice: '130$',
                chargeSoc: '80%',
                dischargeSoc: '20%'
            },
            'SA': {
                status: 'autoDischarge',
                chargeTime: '09:00-13:00',
                dischargeTime: '16:00-20:00',
                chargePrice: '50$',
                dischargePrice: '125$',
                chargeSoc: '85%',
                dischargeSoc: '15%'
            },
            'TAS': {
                status: 'manualDischarge',
                chargeTime: '10:00-14:00',
                dischargeTime: '15:00-19:00',
                chargePrice: '40$',
                dischargePrice: '100$',
                chargeSoc: '90%',
                dischargeSoc: '10%'
            }
        };
        
        // 状态文本映射
        const statusText = {
            'none': { 'zh': '', 'en': '' },
            'autoCharge': { 'zh': '自动充电', 'en': 'Auto Charge' },
            'autoDischarge': { 'zh': '自动放电', 'en': 'Auto Discharge' },
            'manualCharge': { 'zh': '手动充电', 'en': 'Manual Charge' },
            'manualDischarge': { 'zh': '手动放电', 'en': 'Manual Discharge' }
        };
        
        // 当前条件视图状态
        let currentConditionView = 'default';
        
        // 显示充电条件
        function showChargeCondition() {
            const chargeBtn = document.getElementById('chargeConditionBtn');
            const dischargeBtn = document.getElementById('dischargeConditionBtn');
            const defaultContainer = document.querySelector('.region-selection-tabs');
            const conditionContainer = document.getElementById('conditionRegionContainer');
            const selectorContainer = document.getElementById('regionSelectorContainer');
            
            if (currentConditionView === 'charge') {
                // 取消充电条件视图
                currentConditionView = 'default';
                chargeBtn.style.background = 'rgba(255,255,255,0.08)';
                chargeBtn.style.color = 'var(--color-text-secondary)';
                // 显示默认地区选择，隐藏条件地区选择
                defaultContainer.style.display = 'flex';
                conditionContainer.style.display = 'none';
                // 恢复默认高度
                selectorContainer.style.minHeight = '80px';
                // 确保选中的地区保持active状态
                const activeTab = document.querySelector(`.region-select-tab[data-region="${selectedMainRegion}"]`);
                if (activeTab && !activeTab.classList.contains('active')) {
                    selectMainRegion(selectedMainRegion, activeTab);
                }
            } else {
                // 显示充电条件视图
                currentConditionView = 'charge';
                chargeBtn.style.background = '#4CD964';
                chargeBtn.style.color = '#000';
                // 重置放电按钮
                dischargeBtn.style.background = 'rgba(255,255,255,0.08)';
                dischargeBtn.style.color = 'var(--color-text-secondary)';
                // 隐藏默认地区选择，显示条件地区选择
                defaultContainer.style.display = 'none';
                conditionContainer.style.display = 'flex';
                createConditionRegions('charge');
                // 调整容器高度以适应条件视图
                selectorContainer.style.minHeight = '140px';
                // 更新内容区域显示当前选中地区的数据
                updatePriceCircleRegion(selectedMainRegion);
                renderCumulativeChart(selectedMainRegion);
            }
            
            // 延迟调整间距，等待高度动画完成
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // 显示放电条件
        function showDischargeCondition() {
            const chargeBtn = document.getElementById('chargeConditionBtn');
            const dischargeBtn = document.getElementById('dischargeConditionBtn');
            const defaultContainer = document.querySelector('.region-selection-tabs');
            const conditionContainer = document.getElementById('conditionRegionContainer');
            const selectorContainer = document.getElementById('regionSelectorContainer');
            
            if (currentConditionView === 'discharge') {
                // 取消放电条件视图
                currentConditionView = 'default';
                dischargeBtn.style.background = 'rgba(255,255,255,0.08)';
                dischargeBtn.style.color = 'var(--color-text-secondary)';
                // 显示默认地区选择，隐藏条件地区选择
                defaultContainer.style.display = 'flex';
                conditionContainer.style.display = 'none';
                // 恢复默认高度
                selectorContainer.style.minHeight = '80px';
                // 确保选中的地区保持active状态
                const activeTab = document.querySelector(`.region-select-tab[data-region="${selectedMainRegion}"]`);
                if (activeTab && !activeTab.classList.contains('active')) {
                    selectMainRegion(selectedMainRegion, activeTab);
                }
            } else {
                // 显示放电条件视图
                currentConditionView = 'discharge';
                dischargeBtn.style.background = '#FFC107';
                dischargeBtn.style.color = '#000';
                // 重置充电按钮
                chargeBtn.style.background = 'rgba(255,255,255,0.08)';
                chargeBtn.style.color = 'var(--color-text-secondary)';
                // 隐藏默认地区选择，显示条件地区选择
                defaultContainer.style.display = 'none';
                conditionContainer.style.display = 'flex';
                createConditionRegions('discharge');
                // 调整容器高度以适应条件视图
                selectorContainer.style.minHeight = '140px';
                // 更新内容区域显示当前选中地区的数据
                updatePriceCircleRegion(selectedMainRegion);
                renderCumulativeChart(selectedMainRegion);
            }
            
            // 延迟调整间距，等待高度动画完成
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // 创建条件地区按钮
        function createConditionRegions(type) {
            const container = document.getElementById('conditionRegionContainer');
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            
            container.innerHTML = '';
            container.style.display = 'flex';
            
            regions.forEach((region, index) => {
                const timeText = window.i18n ? window.i18n.getText('timeCondition') : '时间条件';
                const priceText = window.i18n ? window.i18n.getText('priceCondition') : '价格条件';
                const stopSOCText = type === 'charge' ? 
                    (window.i18n ? window.i18n.getText('chargeStopSOC') : '充电停止SOC') :
                    (window.i18n ? window.i18n.getText('dischargeStopSOC') : '放电停止SOC');
                
                const bgColor = type === 'charge' ? '#4CD964' : '#FFC107';
                
                // 检查是否是当前选中的地区（与主地区选择保持一致）
                const isSelected = region === selectedMainRegion;
                
                const button = document.createElement('button');
                button.className = 'condition-region-btn';
                button.dataset.region = region;
                button.style.cssText = `
                    padding: 16px 16px;
                    background: ${isSelected ? bgColor : 'transparent'};
                    color: ${isSelected ? '#000' : 'var(--color-text-secondary)'};
                    border: ${isSelected ? '2px solid #000' : '1px solid var(--color-border)'};
                    border-radius: 50px;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.3s;
                    display: flex;
                    align-items: flex-start;
                    justify-content: flex-start;
                    flex: 1;
                    min-height: 120px;
                    flex-direction: column;
                    gap: 4px;
                `;
                
                // 获取该地区的状态
                const status = regionData[region].status;
                let statusBadgeHTML = '';
                
                if (status !== 'none') {
                    const statusTextMap = {
                        'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : '自动充电',
                        'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : '手动充电',
                        'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : '自动放电',
                        'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : '手动放电'
                    };
                    const statusText = statusTextMap[status] || status;
                    
                    // 为选中状态优化样式，确保在彩色背景上的可读性
                    if (isSelected) {
                        const borderStyle = (status === 'autoCharge' || status === 'autoDischarge') ? 'dashed' : 'solid';
                        statusBadgeHTML = `<span style="background: rgba(0,0,0,0.3); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; border: 1px ${borderStyle} #000;">${statusText}</span>`;
                    } else {
                        const statusStyle = getStatusStyle(status, false);
                        statusBadgeHTML = `<span style="${statusStyle.cssText}">${statusText}</span>`;
                    }
                }
                
                button.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 6px; width: 100%; padding: 0 8px;">
                        <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                            <span style="font-size: 14px; font-weight: 600;">${region}</span>
                            ${statusBadgeHTML}
                        </div>
                        <div style="font-size: 11px; opacity: 0.9; text-align: left; line-height: 1.6; display: flex; flex-direction: column; gap: 4px;">
                            <div>${timeText}: ${type === 'charge' ? regionData[region].chargeTime : regionData[region].dischargeTime}</div>
                            <div>${priceText}: ${type === 'charge' ? regionData[region].chargePrice : regionData[region].dischargePrice}</div>
                            <div>${stopSOCText}: ${type === 'charge' ? regionData[region].chargeSoc : regionData[region].dischargeSoc}</div>
                        </div>
                    </div>
                `;
                
                button.onclick = function() {
                    selectConditionRegion(region, this, type);
                };
                
                container.appendChild(button);
            });
        }
        
        // 选择条件地区
        function selectConditionRegion(region, button, type) {
            // 更新selectedMainRegion以保持与主地区选择同步
            selectedMainRegion = region;
            
            // 重新创建条件地区按钮以反映新的选中状态
            createConditionRegions(type);
            
            // 获取该地区的状态
            const regionStatus = regionData[region].status;
            console.log(`Selected condition region: ${region}, Status: ${regionStatus}`);
            
            // 更新电站管理状态
            updatePowerStationStatus(region, regionStatus);
            
            // 更新相关显示
            updatePriceCircleRegion(region);
            renderCumulativeChart(region);
            
            // 更新页面数据 - 这是关键的缺失部分
            updatePageDataByRegion(region);
            
            // 更新地区显示
            updateRegionDisplay();
            
            // 调整间距
            // 延迟调整间距，等待高度动画完成
            setTimeout(() => {
                adjustSpacingForRegionSelector();
            }, 160);
        }
        
        // 更新地区显示
        function updateRegionDisplay() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            const currentLang = getCurrentLanguage() || 'zh';
            
            console.log('updateRegionDisplay called');
            
            regions.forEach(region => {
                const regionButton = document.querySelector(`[data-region="${region}"]`);
                if (!regionButton) {
                    console.log('Region button not found:', region);
                    return;
                }
                
                // 重新获取span元素，因为innerHTML可能改变了DOM结构
                let regionSpan = regionButton.querySelector('span:first-child');
                let statusBadge = regionButton.querySelector('.region-status-badge');
                
                if (!regionSpan || !statusBadge) {
                    console.log('Region button missing elements:', region);
                    return;
                }
                
                // 默认状态：只显示地区名称和状态
                regionSpan.textContent = region;
                
                // 确保地区名称有正确的颜色
                const isActive = regionButton.classList.contains('active');
                if (isActive) {
                    regionSpan.style.color = '#000'; // 选中的地区用黑色文字（在亮绿色背景上）
                    regionSpan.style.fontWeight = '700';
                } else {
                    regionSpan.style.color = 'var(--color-text-secondary)'; // 未选中的地区用次要文字颜色
                    regionSpan.style.fontWeight = '500';
                }
                
                // 更新data-status属性
                statusBadge.setAttribute('data-status', regionData[region].status);
                
                // 根据地区状态决定是否显示状态标记
                const status = regionData[region].status;
                if (status === 'none') {
                    statusBadge.style.display = 'none';
                    statusBadge.innerHTML = '';
                } else {
                    // 获取状态样式
                    const statusStyle = getStatusStyle(status, isActive);
                    statusBadge.style.cssText = statusStyle.cssText;
                    statusBadge.innerHTML = statusStyle.text;
                    statusBadge.style.display = 'inline-block';
                }
            });
            
            // 调整间距
            setTimeout(adjustSpacingForRegionSelector, 100);
        }
        
        // 获取状态标记样式
        function getStatusStyle(status, isActive) {
            if (status === 'none') return { cssText: '', text: '' };
            
            const statusTextMap = {
                'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : '自动充电',
                'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : '手动充电',
                'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : '自动放电',
                'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : '手动放电'
            };
            
            const statusColors = {
                'autoCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'dashed' },
                'manualCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'solid' },
                'autoDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'dashed' },
                'manualDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'solid' }
            };
            
            const style = statusColors[status];
            const text = statusTextMap[status];
            if (!style || !text) return { cssText: '', text: '' };
            
            // 如果是选中状态，使用黑色文字和边框
            const textColor = isActive ? '#000' : style.color;
            const borderColor = isActive ? '#000' : style.border;
            
            const cssText = `background: ${style.bg}; color: ${textColor}; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 700; border: 1px ${style.borderStyle} ${borderColor};`;
            
            return { cssText, text };
        }
        
        
        // 动态调整间距以适应地区选择栏高度变化
        function adjustSpacingForRegionSelector() {
            const regionSelector = document.querySelector('.region-selector-fixed');
            const mainContent = document.querySelector('.main-content-scrollable');
            
            if (regionSelector && mainContent) {
                // 强制浏览器重新计算布局
                regionSelector.style.display = 'none';
                regionSelector.offsetHeight; // 触发重排
                regionSelector.style.display = '';
                
                // 获取地区选择栏的实际高度
                const selectorHeight = regionSelector.offsetHeight;
                // 基础间距 + 地区选择栏高度 + 额外间距
                // 统一增加10px间距，条件视图时稍微多一点
                const extraSpacing = currentConditionView !== 'default' ? 25 : 20;
                
                const newMarginTop = 100 + selectorHeight + extraSpacing;
                mainContent.style.marginTop = newMarginTop + 'px';
                
                console.log('Region selector height:', selectorHeight, 'New margin-top:', newMarginTop, 'View:', currentConditionView);
            }
        }
        
        // 更新地区状态显示
        function updateRegionStatusDisplay() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            const currentLang = getCurrentLanguage() || 'zh';
            console.log('updateRegionStatusDisplay called with language:', currentLang);
            
            regions.forEach(region => {
                const regionButton = document.querySelector(`[data-region="${region}"]`);
                if (!regionButton) {
                    console.log('Region button not found:', region);
                    return;
                }
                
                const statusBadge = regionButton.querySelector('.region-status-badge');
                if (!statusBadge) {
                    console.log('Status badge not found for region:', region);
                    return;
                }
                
                const status = regionData[region].status;
                
                // 使用i18n系统获取状态文本
                let statusDisplay = '';
                if (status !== 'none') {
                    const statusTextMap = {
                        'autoCharge': window.i18n ? window.i18n.getText('autoCharge') : '自动充电',
                        'manualCharge': window.i18n ? window.i18n.getText('manualCharge') : '手动充电',
                        'autoDischarge': window.i18n ? window.i18n.getText('autoDischarge') : '自动放电',
                        'manualDischarge': window.i18n ? window.i18n.getText('manualDischarge') : '手动放电'
                    };
                    statusDisplay = statusTextMap[status] || status;
                }
                
                // 更新状态文本
                statusBadge.textContent = statusDisplay;
                statusBadge.setAttribute('data-status', status);
                console.log(`Updated ${region} status badge: "${statusDisplay}" (status: ${status})`);
                
                // 根据状态设置颜色和边框样式
                const statusColors = {
                    'none': { bg: 'transparent', color: 'transparent', border: 'transparent', borderStyle: 'none' },
                    'autoCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'dashed' },
                    'manualCharge': { bg: 'rgba(76, 217, 100, 0.2)', color: '#4CD964', border: '#4CD964', borderStyle: 'solid' },
                    'autoDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'dashed' },
                    'manualDischarge': { bg: 'rgba(255, 193, 7, 0.2)', color: '#FFC107', border: '#FFC107', borderStyle: 'solid' }
                };
                
                const colorScheme = statusColors[status];
                if (colorScheme) {
                    statusBadge.style.background = colorScheme.bg;
                    statusBadge.style.color = colorScheme.color;
                    statusBadge.style.borderColor = colorScheme.border;
                    statusBadge.style.borderStyle = colorScheme.borderStyle;
                    statusBadge.style.borderWidth = status === 'none' ? '0' : '1px';
                    statusBadge.style.display = status === 'none' ? 'none' : 'inline-block';
                    statusBadge.style.fontSize = '13px';
                    statusBadge.style.fontWeight = '700';
                    statusBadge.style.padding = '6px 12px';
                }
            });
            
            // 每次更新显示后调整间距
            setTimeout(adjustSpacingForRegionSelector, 100);
        }
        
        // 获取当前语言
        function getCurrentLanguage() {
            // 优先从i18n系统获取当前语言
            if (window.i18n && typeof window.i18n.getCurrentLanguage === 'function') {
                return window.i18n.getCurrentLanguage();
            }
            // 降级方案：从HTML属性获取
            return document.documentElement.getAttribute('data-language') || 
                   document.documentElement.lang === 'zh-CN' ? 'zh' : 'en';
        }
        
        // 初始化显示
        document.addEventListener('DOMContentLoaded', function() {
            updateRegionDisplay();
            // 初始化时调整间距
            setTimeout(adjustSpacingForRegionSelector, 300);
            
            // 确保初始选中的地区有正确的颜色
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 100);
        });
        
        // 立即执行一次初始化（防止DOMContentLoaded已经触发）
        setTimeout(function() {
            updateRegionDisplay();
            adjustSpacingForRegionSelector();
            
            // 确保选中地区颜色正确
            const activeRegion = document.querySelector('.region-select-tab.active');
            if (activeRegion) {
                activeRegion.style.background = 'var(--color-primary)';
                activeRegion.style.color = '#000';
                const activeSpan = activeRegion.querySelector('span:first-child');
                if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                    activeSpan.style.color = '#000';
                    activeSpan.style.fontWeight = '700';
                }
            }
        }, 100);
        
        // 更强制的初始化
        window.addEventListener('load', function() {
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 500);
            
            // 最终确保选中地区颜色正确
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 200);
        });
        
        // 如果页面已经加载完成，立即执行
        if (document.readyState === 'complete') {
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 100);
            
            // 确保选中地区颜色正确
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 50);
        }
        
        // 测试功能：强制更新翻译
        window.forceUpdateTranslations = function() {
            if (window.i18n && window.i18n.updatePageTexts) {
                window.i18n.updatePageTexts();
            }
            updateRegionDisplay();
            setTimeout(adjustSpacingForRegionSelector, 100);
            
            // 确保选中地区颜色正确
            setTimeout(() => {
                const activeRegion = document.querySelector('.region-select-tab.active');
                if (activeRegion) {
                    activeRegion.style.background = 'var(--color-primary)';
                    activeRegion.style.color = '#000';
                    const activeSpan = activeRegion.querySelector('span:first-child');
                    if (activeSpan && !activeSpan.innerHTML.includes('<div')) {
                        activeSpan.style.color = '#000';
                        activeSpan.style.fontWeight = '700';
                    }
                }
            }, 150);
        };
        
        // 条件设置弹窗功能
        
        // Simplified modal - old complex functions removed
        
        // Simplified settings - removed complex timeline variables
        
        // Removed complex timeline functions - simplified modal only needs basic settings
        
        // 多段时间选择功能
        let currentConditionType = 'charge'; // 当前条件类型: charge 或 discharge
        let currentSelectedRegion = 'NSW'; // 当前选中的地区
        let selectedRegionData = {}; // 存储每个地区的时间设置
        
        // 时间段数据结构
        let chargeTimeSettings = { segments: [{ start: 22, end: 6, id: 'charge-1' }] }; // 22:00 - 06:00
        let dischargeTimeSettings = { segments: [{ start: 6, end: 22, id: 'discharge-1' }] }; // 06:00 - 22:00
        
        function switchConditionType(type) {
            // 保存当前数据
            saveRegionData(currentSelectedRegion, currentConditionType);
            
            // 切换条件类型
            currentConditionType = type;
            
            // 加载新的数据
            loadRegionData(currentSelectedRegion, type);
            
            // 更新UI
            updateModalUI();
            updateTimelineDisplay();
            updateModalCurrentSettings();
        }
        
        function switchModalRegion(region, button) {
            // 保存当前数据
            saveRegionData(currentSelectedRegion, currentConditionType);
            
            // 切换地区
            currentSelectedRegion = region;
            
            // 更新地区按钮状态
            document.querySelectorAll('.modal-region-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'rgba(255,255,255,0.1)';
                tab.style.color = 'rgba(255,255,255,0.7)';
                tab.style.border = '1px solid rgba(255,255,255,0.2)';
            });
            
            button.classList.add('active');
            button.style.background = 'var(--color-primary)';
            button.style.color = '#000';
            button.style.border = 'none';
            
            // 加载新地区数据
            loadRegionData(region, currentConditionType);
            
            // 更新时间轴
            updateTimelineDisplay();
            updateModalCurrentSettings();
        }
        
        function updateModalUI() {
            const chargeBtn = document.getElementById('modalChargeBtn');
            const dischargeBtn = document.getElementById('modalDischargeBtn');
            
            if (currentConditionType === 'charge') {
                chargeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00cc6a)';
                chargeBtn.style.color = '#000';
                chargeBtn.style.border = 'none';
                
                dischargeBtn.style.background = 'rgba(255,255,255,0.1)';
                dischargeBtn.style.color = 'rgba(255,255,255,0.6)';
                dischargeBtn.style.border = '1px solid rgba(255,255,255,0.2)';
            } else {
                dischargeBtn.style.background = 'linear-gradient(135deg, #FFC107, #FFB000)';
                dischargeBtn.style.color = '#000';
                dischargeBtn.style.border = 'none';
                
                chargeBtn.style.background = 'rgba(255,255,255,0.1)';
                chargeBtn.style.color = 'rgba(255,255,255,0.6)';
                chargeBtn.style.border = '1px solid rgba(255,255,255,0.2)';
            }
        }
        
        function loadRegionData(region, type) {
            const key = `${region}_${type}`;
            
            if (selectedRegionData[key]) {
                // 加载已保存的数据
                if (type === 'charge') {
                    chargeTimeSettings = selectedRegionData[key];
                } else {
                    dischargeTimeSettings = selectedRegionData[key];
                }
            } else {
                // 使用默认数据
                if (type === 'charge') {
                    chargeTimeSettings = { segments: [{ start: 22, end: 6, id: `charge-${Date.now()}` }] };
                } else {
                    dischargeTimeSettings = { segments: [{ start: 6, end: 22, id: `discharge-${Date.now()}` }] };
                }
                selectedRegionData[key] = type === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            }
        }
        
        function saveRegionData(region, type) {
            const key = `${region}_${type}`;
            selectedRegionData[key] = type === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
        }
        
        function updateModalCurrentSettings() {
            const currentSettings = document.getElementById('modalCurrentSettings');
            const typeText = currentConditionType === 'charge' ? '充电' : '放电';
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            
            if (settings.segments.length === 0) {
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: 未设置时间段`;
            } else if (settings.segments.length === 1) {
                const segment = settings.segments[0];
                const timeText = `${segment.start.toString().padStart(2, '0')}:00 - ${segment.end.toString().padStart(2, '0')}:00`;
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: ${timeText}`;
            } else {
                currentSettings.innerHTML = `${currentSelectedRegion} - ${typeText}: ${settings.segments.length}个时间段`;
            }
        }
        
        function updateTimelineDisplay() {
            const timeline = document.getElementById('timeline');
            if (!timeline) return;
            
            // 清除现有时间段
            document.querySelectorAll('.time-segment').forEach(segment => segment.remove());
            
            // 不在时间轴上显示时间段，只在时间条件卡片中显示
            // // 创建当前类型的时间段
            // const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            // settings.segments.forEach((segment, index) => {
            //     createTimeSegment(currentConditionType, segment, index);
            // });
        }
        
        function createTimeSegment(type, segment, index) {
            const timeline = document.getElementById('timeline');
            const element = document.createElement('div');
            element.className = 'time-segment';
            element.dataset.type = type;
            element.dataset.segmentId = segment.id;
            element.dataset.index = index;
            
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            const gradientColor = type === 'charge' ? '#00cc6a' : '#FFB000';
            
            // 计算位置和宽度
            let left, width;
            if (segment.start > segment.end) {
                // 跨日处理
                left = (segment.start / 24 * 100);
                width = ((24 - segment.start + segment.end) / 24 * 100);
            } else {
                left = (segment.start / 24 * 100);
                width = ((segment.end - segment.start) / 24 * 100);
            }
            
            element.style.cssText = `
                position: absolute;
                left: ${left}%;
                width: ${width}%;
                height: 48px;
                top: 6px;
                background: linear-gradient(135deg, ${color}, ${gradientColor});
                border-radius: 8px;
                cursor: move;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #000;
                font-size: 10px;
                font-weight: 600;
                user-select: none;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                border: 1px solid rgba(255,255,255,0.2);
            `;
            
            const timeText = `${segment.start.toString().padStart(2, '0')}:00-${segment.end.toString().padStart(2, '0')}:00`;
            element.innerHTML = `
                <span>${timeText}</span>
                <button onclick="removeTimeSegment('${segment.id}')" style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: #ff4444; color: #fff; border: none; border-radius: 50%; font-size: 10px; cursor: pointer; display: none;" class="delete-btn">×</button>
            `;
            
            // 添加悬停效果显示删除按钮
            element.addEventListener('mouseenter', () => {
                element.querySelector('.delete-btn').style.display = 'flex';
            });
            element.addEventListener('mouseleave', () => {
                element.querySelector('.delete-btn').style.display = 'none';
            });
            
            // 不在时间轴上显示时间段
            // timeline.appendChild(element);
        }
        
        function addTimeSegment() {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            const newSegment = {
                start: 10,
                end: 14,
                id: `${currentConditionType}-${Date.now()}`
            };
            
            settings.segments.push(newSegment);
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #00ff88;">✓ 新时间段已添加: 10:00-14:00</span>`);
        }
        
        function removeTimeSegment(segmentId) {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            settings.segments = settings.segments.filter(s => s.id !== segmentId);
            
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #ff4444;">✓ 时间段已删除</span>`);
        }
        
        function clearAllTimeSegments() {
            const settings = currentConditionType === 'charge' ? chargeTimeSettings : dischargeTimeSettings;
            settings.segments = [];
            
            updateTimelineDisplay();
            updateModalCurrentSettings();
            
            updateSelectionInfo(`<span style="color: #ff4444;">✓ 所有时间段已清除</span>`);
        }
        
        function updateSelectionInfo(message) {
            const info = document.getElementById('timeSelectionInfo');
            if (info) {
                info.innerHTML = message;
                setTimeout(() => {
                    info.innerHTML = '<span style="color: rgba(255,255,255,0.6); font-size: 12px;">💡 点击空白区域添加时间段，拖拽时间段调整时间</span>';
                }, 3000);
            }
        }
        
        function saveConditionSettings() {
            // 保存当前正在编辑的数据
            saveRegionData(currentSelectedRegion, currentConditionType);
            
            // 保存所有地区的设置数据到localStorage
            localStorage.setItem('regionTimeSettings', JSON.stringify(selectedRegionData));
            
            // 关闭弹窗
            closeConditionSettingsModal();
            
            // 显示保存成功提示
            showAutoOperationNotification('设置', '多地区条件设置已保存');
            
            console.log('多地区时间条件设置已保存:', selectedRegionData);
        }
        
        // 页面加载时恢复设置
        function loadConditionSettings() {
            const savedRegionSettings = localStorage.getItem('regionTimeSettings');
            if (savedRegionSettings) {
                try {
                    selectedRegionData = JSON.parse(savedRegionSettings);
                    console.log('已恢复地区时间设置:', selectedRegionData);
                } catch (e) {
                    console.error('恢复地区设置时出错:', e);
                    selectedRegionData = {};
                }
            }
        }
        
        // 在页面加载完成后恢复设置
        window.addEventListener('load', function() {
            setTimeout(loadConditionSettings, 500);
        });
        
        // 更新openConditionSettingsModal函数以初始化新的简化弹窗
        function openConditionSettingsModal() {
            console.log('=== OPENING CONDITION SETTINGS MODAL ===');
            
            try {
                const modal = document.getElementById('conditionSettingsModal');
                if (!modal) {
                    console.error('Modal element not found!');
                    return;
                }
                
                modal.style.display = 'flex';
                
                // 确保时间段列表容器存在
                setTimeout(() => {
                    const chargeContainer = document.getElementById('chargeTimeSegmentsList');
                    const dischargeContainer = document.getElementById('dischargeTimeSegmentsList');
                    console.log('Checking containers after modal open:', {
                        chargeContainer: !!chargeContainer,
                        dischargeContainer: !!dischargeContainer
                    });
                    
                    // 立即更新显示
                    updateTimeSegmentsList();
                }, 100);
                
                // 显示当前选中地区名称
                const regionNameEl = document.getElementById('modalRegionName');
                if (regionNameEl) {
                    regionNameEl.textContent = selectedMainRegion;
                }
                
                // 初始化全局变量
                if (!window.chargeTimeSegments) {
                    window.chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
                }
                if (!window.dischargeTimeSegments) {
                    window.dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
                }
                
                // 加载当前地区的设置
                loadCurrentRegionConditionSettings();
                
                // 绑定事件监听
                setTimeout(() => {
                    bindTimeInputEvents();
                    // 确保时间选择事件也绑定
                    bindTimeSelectionEvents();
                }, 200);
            } catch (error) {
                console.error('Error opening modal:', error);
                alert('打开设置弹窗时出错：' + error.message);
            }
        }
        
        function closeConditionSettingsModal() {
            console.log('Closing condition settings modal...');
            try {
                const modal = document.getElementById('conditionSettingsModal');
                if (modal) {
                    modal.style.display = 'none';
                    console.log('Modal closed successfully');
                } else {
                    console.error('Modal element not found when trying to close!');
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }
        
        // 确保函数全局可用
        window.openConditionSettingsModal = openConditionSettingsModal;
        window.closeConditionSettingsModal = closeConditionSettingsModal;
        window.saveCurrentRegionSettings = saveCurrentRegionSettings;
        
        // 加载当前地区的条件设置
        function loadCurrentRegionConditionSettings() {
            const region = selectedMainRegion;
            if (!regionConditions[region]) {
                regionConditions[region] = {
                    charge: {
                        timeEnabled: true,
                        timeSegments: [{ start: '22:00', end: '06:00' }],
                        priceEnabled: true,
                        priceValue: 50
                    },
                    discharge: {
                        timeEnabled: true,
                        timeSegments: [{ start: '16:00', end: '21:00' }],
                        priceEnabled: true,
                        priceValue: 100
                    }
                };
            }
            
            const conditions = regionConditions[region];
            
            // 加载充电条件
            const chargeTimeEnabledEl = document.getElementById('modalChargeTimeEnabled');
            const chargePriceEnabledEl = document.getElementById('modalChargePriceEnabled');
            const chargePriceValueEl = document.getElementById('modalChargePriceValue');
            
            console.log('Loading charge conditions - Elements found:', {
                chargeTimeEnabled: !!chargeTimeEnabledEl,
                chargePriceEnabled: !!chargePriceEnabledEl,
                chargePriceValue: !!chargePriceValueEl
            });
            
            if (chargeTimeEnabledEl) chargeTimeEnabledEl.checked = conditions.charge.timeEnabled;
            if (chargePriceEnabledEl) chargePriceEnabledEl.checked = conditions.charge.priceEnabled;
            if (chargePriceValueEl) chargePriceValueEl.value = conditions.charge.priceValue;
            
            // 加载放电条件
            const dischargeTimeEnabledEl = document.getElementById('modalDischargeTimeEnabled');
            const dischargePriceEnabledEl = document.getElementById('modalDischargePriceEnabled');
            const dischargePriceValueEl = document.getElementById('modalDischargePriceValue');
            
            console.log('Loading discharge conditions - Elements found:', {
                dischargeTimeEnabled: !!dischargeTimeEnabledEl,
                dischargePriceEnabled: !!dischargePriceEnabledEl,
                dischargePriceValue: !!dischargePriceValueEl
            });
            
            if (dischargeTimeEnabledEl) dischargeTimeEnabledEl.checked = conditions.discharge.timeEnabled;
            if (dischargePriceEnabledEl) dischargePriceEnabledEl.checked = conditions.discharge.priceEnabled;
            if (dischargePriceValueEl) dischargePriceValueEl.value = conditions.discharge.priceValue;
            
            // 初始化时间段数组
            chargeTimeSegments = [...(conditions.charge.timeSegments || [{ start: '22:00', end: '06:00' }])];
            dischargeTimeSegments = [...(conditions.discharge.timeSegments || [{ start: '16:00', end: '21:00' }])];
            
            // 更新全局变量
            window.chargeTimeSegments = chargeTimeSegments;
            window.dischargeTimeSegments = dischargeTimeSegments;
            
            // 初始化新系统的时间条件数据，确保每个segment都有type属性
            timeConditionSegments.charge = chargeTimeSegments.map(seg => ({
                ...seg,
                type: 'charge',
                id: seg.id || Date.now().toString() + Math.random()
            }));
            timeConditionSegments.discharge = dischargeTimeSegments.map(seg => ({
                ...seg,
                type: 'discharge',
                id: seg.id || Date.now().toString() + Math.random()
            }));
            
            console.log('Loaded time segments:', { chargeTimeSegments, dischargeTimeSegments });
            console.log('Initialized timeConditionSegments:', JSON.stringify(timeConditionSegments, null, 2));
            console.log('Charge segments count:', timeConditionSegments.charge.length);
            console.log('Discharge segments count:', timeConditionSegments.discharge.length);
            
            // 延迟渲染以确保 DOM 元素已经加载
            setTimeout(() => {
                renderTimeSegments();
                updateTimeline();
                toggleConditionSettings();
                
                // 更新新系统的时间轴显示
                updateTimelineDisplay();
                updateTimeSegmentsList();
            }, 100);
        }
        
        // 保存当前地区的设置
        function saveCurrentRegionSettings() {
            console.log('=== SAVING CURRENT REGION SETTINGS ===');
            const region = selectedMainRegion;
            console.log('Region:', region);
            
            try {
                if (!regionConditions[region]) {
                    regionConditions[region] = {
                        charge: {},
                        discharge: {}
                    };
                }
                
                // 获取元素并检查是否存在
                const chargeTimeEnabledEl = document.getElementById('modalChargeTimeEnabled');
                const chargePriceEnabledEl = document.getElementById('modalChargePriceEnabled');
                const chargePriceValueEl = document.getElementById('modalChargePriceValue');
                const dischargeTimeEnabledEl = document.getElementById('modalDischargeTimeEnabled');
                const dischargePriceEnabledEl = document.getElementById('modalDischargePriceEnabled');
                const dischargePriceValueEl = document.getElementById('modalDischargePriceValue');
                
                // 保存充电条件，使用新系统的数据（包含type属性）
                regionConditions[region].charge = {
                    timeEnabled: chargeTimeEnabledEl ? chargeTimeEnabledEl.checked : true,
                    timeSegments: timeConditionSegments.charge.map(seg => ({
                        start: seg.start,
                        end: seg.end,
                        type: 'charge',
                        id: seg.id
                    })),
                    priceEnabled: chargePriceEnabledEl ? chargePriceEnabledEl.checked : true,
                    priceCondition: 'below', // 固定为低于
                    priceValue: chargePriceValueEl ? parseFloat(chargePriceValueEl.value) : 50
                };
                
                // 保存放电条件，使用新系统的数据（包含type属性）
                regionConditions[region].discharge = {
                    timeEnabled: dischargeTimeEnabledEl ? dischargeTimeEnabledEl.checked : true,
                    timeSegments: timeConditionSegments.discharge.map(seg => ({
                        start: seg.start,
                        end: seg.end,
                        type: 'discharge',
                        id: seg.id
                    })),
                    priceEnabled: dischargePriceEnabledEl ? dischargePriceEnabledEl.checked : true,
                    priceCondition: 'above', // 固定为高于
                    priceValue: dischargePriceValueEl ? parseFloat(dischargePriceValueEl.value) : 100
                };
                
                console.log('Saving to localStorage...');
                
                // 保存到localStorage
                localStorage.setItem('regionConditions', JSON.stringify(regionConditions));
                console.log('Saved to localStorage successfully');
                
                // 关闭弹窗
                console.log('Closing modal...');
                closeConditionSettingsModal();
                
                // 更新自动条件显示
                console.log('Updating auto conditions display...');
                if (typeof updateAutoConditionsDisplay === 'function') {
                    updateAutoConditionsDisplay();
                }
                
                console.log('当前地区的自动化条件设置已保存:', region, regionConditions[region]);
                
                // 显示保存成功提示
                alert('设置已保存成功！');
            } catch (error) {
                console.error('保存设置时出错:', error);
                alert('保存设置失败：' + error.message);
            }
        }
        
        // 保留原有的loadAllConditionSettings函数以防兼容性问题
        function loadAllConditionSettings() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            
            regions.forEach(region => {
                // 充电条件
                const chargeStartElement = document.getElementById(`chargeStart${region}`);
                const chargeEndElement = document.getElementById(`chargeEnd${region}`);
                const chargePriceConditionElement = document.getElementById(`chargePriceCondition${region}`);
                const chargePriceValueElement = document.getElementById(`chargePriceValue${region}`);
                
                if (chargeStartElement && chargeEndElement && chargePriceConditionElement && chargePriceValueElement) {
                    // 从localStorage或使用默认值
                    const savedChargeData = localStorage.getItem(`charge_${region}`);
                    if (savedChargeData) {
                        try {
                            const data = JSON.parse(savedChargeData);
                            chargeStartElement.value = data.startTime || '22:00';
                            chargeEndElement.value = data.endTime || '06:00';
                            chargePriceConditionElement.value = data.priceCondition || 'below';
                            chargePriceValueElement.value = data.priceValue || '50';
                        } catch (e) {
                            console.error('Error loading charge data for', region, e);
                        }
                    }
                }
                
                // 放电条件
                const dischargeStartElement = document.getElementById(`dischargeStart${region}`);
                const dischargeEndElement = document.getElementById(`dischargeEnd${region}`);
                const dischargePriceConditionElement = document.getElementById(`dischargePriceCondition${region}`);
                const dischargePriceValueElement = document.getElementById(`dischargePriceValue${region}`);
                
                if (dischargeStartElement && dischargeEndElement && dischargePriceConditionElement && dischargePriceValueElement) {
                    // 从localStorage或使用默认值
                    const savedDischargeData = localStorage.getItem(`discharge_${region}`);
                    if (savedDischargeData) {
                        try {
                            const data = JSON.parse(savedDischargeData);
                            dischargeStartElement.value = data.startTime || '17:00';
                            dischargeEndElement.value = data.endTime || '21:00';
                            dischargePriceConditionElement.value = data.priceCondition || 'above';
                            dischargePriceValueElement.value = data.priceValue || '120';
                        } catch (e) {
                            console.error('Error loading discharge data for', region, e);
                        }
                    }
                }
            });
        }
        
        // 保存所有地区的条件设置
        function saveAllConditionSettings() {
            const regions = ['NSW', 'QLD', 'VIC', 'SA', 'TAS'];
            let savedCount = 0;
            
            regions.forEach(region => {
                // 保存充电条件
                const chargeData = {
                    startTime: document.getElementById(`chargeStart${region}`)?.value || '22:00',
                    endTime: document.getElementById(`chargeEnd${region}`)?.value || '06:00',
                    priceCondition: document.getElementById(`chargePriceCondition${region}`)?.value || 'below',
                    priceValue: document.getElementById(`chargePriceValue${region}`)?.value || '50'
                };
                
                localStorage.setItem(`charge_${region}`, JSON.stringify(chargeData));
                
                // 保存放电条件
                const dischargeData = {
                    startTime: document.getElementById(`dischargeStart${region}`)?.value || '17:00',
                    endTime: document.getElementById(`dischargeEnd${region}`)?.value || '21:00',
                    priceCondition: document.getElementById(`dischargePriceCondition${region}`)?.value || 'above',
                    priceValue: document.getElementById(`dischargePriceValue${region}`)?.value || '120'
                };
                
                localStorage.setItem(`discharge_${region}`, JSON.stringify(dischargeData));
                savedCount++;
            });
            
            // 关闭弹窗
            closeConditionSettingsModal();
            
            // 显示保存成功提示
            showAutoOperationNotification('设置', `已保存${savedCount}个地区的自动化条件设置`);
            
            console.log('所有地区的自动化条件设置已保存');
        }
        
        // 条件开关函数
        function toggleConditionSettings() {
            // 充电时间条件
            const chargeTimeEnabled = document.getElementById('chargeTimeEnabled')?.checked;
            const chargeTimeSettings = document.getElementById('chargeTimeSettings');
            if (chargeTimeSettings) {
                chargeTimeSettings.style.opacity = chargeTimeEnabled ? '1' : '0.5';
                chargeTimeSettings.style.pointerEvents = chargeTimeEnabled ? 'auto' : 'none';
            }
            
            // 充电价格条件
            const chargePriceEnabled = document.getElementById('chargePriceEnabled')?.checked;
            const chargePriceSettings = document.getElementById('chargePriceSettings');
            if (chargePriceSettings) {
                chargePriceSettings.style.opacity = chargePriceEnabled ? '1' : '0.5';
                chargePriceSettings.style.pointerEvents = chargePriceEnabled ? 'auto' : 'none';
            }
            
            // 放电时间条件
            const dischargeTimeEnabled = document.getElementById('dischargeTimeEnabled')?.checked;
            const dischargeTimeSettings = document.getElementById('dischargeTimeSettings');
            if (dischargeTimeSettings) {
                dischargeTimeSettings.style.opacity = dischargeTimeEnabled ? '1' : '0.5';
                dischargeTimeSettings.style.pointerEvents = dischargeTimeEnabled ? 'auto' : 'none';
            }
            
            // 放电价格条件
            const dischargePriceEnabled = document.getElementById('dischargePriceEnabled')?.checked;
            const dischargePriceSettings = document.getElementById('dischargePriceSettings');
            if (dischargePriceSettings) {
                dischargePriceSettings.style.opacity = dischargePriceEnabled ? '1' : '0.5';
                dischargePriceSettings.style.pointerEvents = dischargePriceEnabled ? 'auto' : 'none';
            }
        }
        
        // 添加事件监听
        setTimeout(() => {
            const checkboxes = [
                'chargeTimeEnabled',
                'chargePriceEnabled', 
                'dischargeTimeEnabled',
                'dischargePriceEnabled'
            ];
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.addEventListener('change', toggleConditionSettings);
                }
            });
        }, 500);
        
        // 多段时间管理 - 全局变量
        if (typeof window.chargeTimeSegments === 'undefined') {
            window.chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
        }
        if (typeof window.dischargeTimeSegments === 'undefined') {
            window.dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
        }
        
        let chargeTimeSegments = window.chargeTimeSegments;
        let dischargeTimeSegments = window.dischargeTimeSegments;
        
        // 添加充电时间段
        function addChargeTimeSegment() {
            const newSegment = { start: '22:00', end: '06:00' };
            window.chargeTimeSegments.push(newSegment);
            chargeTimeSegments = window.chargeTimeSegments;
            console.log('Added charge segment, total:', chargeTimeSegments.length);
            renderTimeSegments();
            updateTimeline();
            // 重新绑定事件
            setTimeout(() => bindTimeInputEvents(), 50);
        }
        
        // 添加放电时间段
        function addDischargeTimeSegment() {
            const newSegment = { start: '16:00', end: '21:00' };
            window.dischargeTimeSegments.push(newSegment);
            dischargeTimeSegments = window.dischargeTimeSegments;
            console.log('Added discharge segment, total:', dischargeTimeSegments.length);
            renderTimeSegments();
            updateTimeline();
            // 重新绑定事件
            setTimeout(() => bindTimeInputEvents(), 50);
        }
        
        // 渲染时间段
        function renderTimeSegments() {
            console.log('Rendering time segments:', { chargeTimeSegments, dischargeTimeSegments });
            
            // 渲染充电时间段
            const chargeContainer = document.getElementById('chargeTimeSegments');
            if (chargeContainer) {
                chargeContainer.innerHTML = '';
                chargeTimeSegments.forEach((segment, index) => {
                    const segmentDiv = createTimeSegmentElement(segment, index, 'charge');
                    chargeContainer.appendChild(segmentDiv);
                });
                console.log('Rendered charge segments:', chargeTimeSegments.length);
            } else {
                console.warn('chargeTimeSegments container not found');
            }
            
            // 渲染放电时间段
            const dischargeContainer = document.getElementById('dischargeTimeSegments');
            if (dischargeContainer) {
                dischargeContainer.innerHTML = '';
                dischargeTimeSegments.forEach((segment, index) => {
                    const segmentDiv = createTimeSegmentElement(segment, index, 'discharge');
                    dischargeContainer.appendChild(segmentDiv);
                });
                console.log('Rendered discharge segments:', dischargeTimeSegments.length);
            } else {
                console.warn('dischargeTimeSegments container not found');
            }
        }
        
        // 创建时间段元素
        function createTimeSegmentElement(segment, index, type) {
            const segmentDiv = document.createElement('div');
            segmentDiv.className = 'time-segment';
            segmentDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; padding: 6px; background: rgba(255,255,255,0.05); border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);';
            
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            
            segmentDiv.innerHTML = `
                <span style="color: ${color}; font-size: 12px; min-width: 20px; font-weight: 500;">${index + 1}.</span>
                <input type="time" value="${segment.start}" data-index="${index}" data-field="start" data-type="${type}" class="time-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 6px; border-radius: 3px; font-size: 11px; outline: none; width: 70px;">
                <span style="color: rgba(255,255,255,0.6); font-size: 12px;">-</span>
                <input type="time" value="${segment.end}" data-index="${index}" data-field="end" data-type="${type}" class="time-input" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 4px 6px; border-radius: 3px; font-size: 11px; outline: none; width: 70px;">
                <button onclick="removeTimeSegment(${index}, '${type}')" style="background: rgba(255,0,0,0.2); border: 1px solid rgba(255,0,0,0.3); color: #ff6b6b; padding: 2px 6px; border-radius: 3px; font-size: 10px; cursor: pointer; transition: all 0.3s;">×</button>
            `;
            
            return segmentDiv;
        }
        
        // 绑定时间输入事件
        function bindTimeInputEvents() {
            // 移除旧的事件监听器
            if (window.timeInputHandler) {
                document.removeEventListener('change', window.timeInputHandler);
            }
            
            // 创建新的事件监听器
            window.timeInputHandler = function(e) {
                if (e.target.classList.contains('time-input')) {
                    const index = parseInt(e.target.getAttribute('data-index'));
                    const field = e.target.getAttribute('data-field');
                    const type = e.target.getAttribute('data-type');
                    const value = e.target.value;
                    
                    console.log('Time input changed:', { index, field, type, value });
                    updateTimeSegment(index, field, value, type);
                }
            };
            
            document.addEventListener('change', window.timeInputHandler);
            console.log('Time input event handler bound');
        }
        
        // 更新时间段
        function updateTimeSegment(index, field, value, type) {
            console.log('Updating time segment:', { index, field, value, type });
            
            if (type === 'charge' && index < chargeTimeSegments.length) {
                chargeTimeSegments[index][field] = value;
                console.log('Updated charge segment:', chargeTimeSegments[index]);
            } else if (type === 'discharge' && index < dischargeTimeSegments.length) {
                dischargeTimeSegments[index][field] = value;
                console.log('Updated discharge segment:', dischargeTimeSegments[index]);
            }
            
            // 检查并解决冲突
            resolveTimeConflicts();
            updateTimeline();
        }
        
        // 删除时间段
        function removeTimeSegment(index, type) {
            if (type === 'charge') {
                chargeTimeSegments.splice(index, 1);
            } else {
                dischargeTimeSegments.splice(index, 1);
            }
            
            renderTimeSegments();
            updateTimeline();
        }
        
        // 解决时间冲突（新的覆盖旧的）
        function resolveTimeConflicts() {
            console.log('Resolving conflicts...');
            
            // 先解决充电内部冲突
            const originalChargeLength = chargeTimeSegments.length;
            chargeTimeSegments = resolveInternalConflicts(chargeTimeSegments);
            
            // 再解决放电内部冲突
            const originalDischargeLength = dischargeTimeSegments.length;
            dischargeTimeSegments = resolveInternalConflicts(dischargeTimeSegments);
            
            // 最后解决充电和放电之间的冲突
            resolveCrossTypeConflicts();
            
            // 只在数量发生变化时才重新渲染
            if (chargeTimeSegments.length !== originalChargeLength || dischargeTimeSegments.length !== originalDischargeLength) {
                renderTimeSegments();
            }
        }
        
        // 解决内部冲突
        function resolveInternalConflicts(segments) {
            const resolved = [];
            
            segments.forEach(newSegment => {
                let hasConflict = false;
                
                // 检查与已存在段的冲突
                for (let i = resolved.length - 1; i >= 0; i--) {
                    if (timeSegmentsOverlap(newSegment, resolved[i])) {
                        // 有冲突，删除旧的
                        resolved.splice(i, 1);
                        hasConflict = true;
                    }
                }
                
                resolved.push(newSegment);
            });
            
            return resolved;
        }
        
        // 解决充电和放电之间的冲突
        function resolveCrossTypeConflicts() {
            const allSegments = [
                ...chargeTimeSegments.map(s => ({ ...s, type: 'charge', index: chargeTimeSegments.indexOf(s) })),
                ...dischargeTimeSegments.map(s => ({ ...s, type: 'discharge', index: dischargeTimeSegments.indexOf(s) }))
            ];
            
            // 按添加顺序排序（新的在后）
            for (let i = allSegments.length - 1; i >= 0; i--) {
                const current = allSegments[i];
                
                for (let j = i - 1; j >= 0; j--) {
                    const other = allSegments[j];
                    
                    if (timeSegmentsOverlap(current, other)) {
                        // 有冲突，删除较早的那个
                        if (other.type === 'charge') {
                            chargeTimeSegments.splice(other.index, 1);
                        } else {
                            dischargeTimeSegments.splice(other.index, 1);
                        }
                        
                        // 更新索引
                        allSegments.splice(j, 1);
                        i--; // 调整当前索引
                    }
                }
            }
        }
        
        // 判断时间段是否重叠
        function timeSegmentsOverlap(segment1, segment2) {
            const start1 = timeToMinutes(segment1.start);
            const end1 = timeToMinutes(segment1.end);
            const start2 = timeToMinutes(segment2.start);
            const end2 = timeToMinutes(segment2.end);
            
            // 处理跨夜情况
            const isOvernight1 = end1 < start1;
            const isOvernight2 = end2 < start2;
            
            if (isOvernight1 && isOvernight2) {
                return true; // 两个都跨夜，认为有重叠
            } else if (isOvernight1) {
                return (start2 >= start1 || end2 <= end1);
            } else if (isOvernight2) {
                return (start1 >= start2 || end1 <= end2);
            } else {
                return (start1 < end2 && start2 < end1);
            }
        }
        
        // 时间转换为分钟
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // 更新时间轴显示
        function updateTimeline() {
            const timelineDisplay = document.getElementById('timelineDisplay');
            if (!timelineDisplay) return;
            
            timelineDisplay.innerHTML = '';
            
            // 不在时间轴上显示时间段，只在时间条件卡片中显示
            // // 显示充电时间段
            // chargeTimeSegments.forEach(segment => {
            //     const segmentBar = createTimelineSegment(segment, 'charge');
            //     timelineDisplay.appendChild(segmentBar);
            // });
            
            // // 显示放电时间段
            // dischargeTimeSegments.forEach(segment => {
            //     const segmentBar = createTimelineSegment(segment, 'discharge');
            //     timelineDisplay.appendChild(segmentBar);
            // });
        }
        
        // 创建时间轴段
        function createTimelineSegment(segment, type) {
            const startHour = parseFloat(segment.start.replace(':', '.'));
            const endHour = parseFloat(segment.end.replace(':', '.'));
            
            const div = document.createElement('div');
            const color = type === 'charge' ? 'linear-gradient(135deg, #00ff88, #00dd77)' : 'linear-gradient(135deg, #FFC107, #FFB300)';
            
            if (endHour < startHour) {
                // 跨夜情况，分两段显示
                const container = document.createElement('div');
                
                // 第一段
                const part1 = document.createElement('div');
                const leftPercent1 = (startHour / 24) * 100;
                const widthPercent1 = ((24 - startHour) / 24) * 100;
                part1.style.cssText = `
                    position: absolute;
                    left: ${leftPercent1}%;
                    width: ${widthPercent1}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 12px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                part1.innerHTML = `${segment.start}-24:00`;
                
                // 第二段
                const part2 = document.createElement('div');
                const widthPercent2 = (endHour / 24) * 100;
                part2.style.cssText = `
                    position: absolute;
                    left: 0%;
                    width: ${widthPercent2}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 12px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                part2.innerHTML = `00:00-${segment.end}`;
                
                container.appendChild(part1);
                container.appendChild(part2);
                return container;
            } else {
                // 正常情况
                const leftPercent = (startHour / 24) * 100;
                const widthPercent = ((endHour - startHour) / 24) * 100;
                
                div.style.cssText = `
                    position: absolute;
                    left: ${leftPercent}%;
                    width: ${widthPercent}%;
                    height: 24px;
                    background: ${color};
                    border-radius: 12px;
                    top: 4px;
                    opacity: 0.8;
                    transition: all 0.3s;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #000;
                    font-size: 10px;
                    font-weight: 600;
                `;
                
                div.innerHTML = `${segment.start}-${segment.end}`;
                
                // 添加悬停效果
                div.onmouseenter = () => {
                    div.style.opacity = '1';
                    div.style.transform = 'scale(1.02)';
                };
                div.onmouseleave = () => {
                    div.style.opacity = '0.8';
                    div.style.transform = 'scale(1)';
                };
                
                return div;
            }
        }
        
        // 更新时间轴显示（同 updateTimeline）
        function updateTimelineDisplay() {
            updateTimeline();
        }
        
        // 创建时间轴段（同 createTimelineSegment）
        function createTimeSegmentBar(segment) {
            return createTimelineSegment(segment, segment.type || 'charge');
        }
        
        // 检查时间冲突（兼容性接口）
        function checkTimeConflicts(chargeSegments, dischargeSegments) {
            resolveTimeConflicts();
        }

        // ============== 时间条件管理系统 ==============
        
        // 时间条件状态管理
        let timeConditionSegments = {
            charge: [], // 充电时间段
            discharge: [] // 放电时间段
        };
        
        let currentTimeSelectionMode = null; // 'charge' 或 'discharge'
        let timeSelection = {
            isSelecting: false,
            startX: 0,
            current: null // { start: '09:00', end: '17:00', type: 'charge' }
        };

        // 设置时间选择模式
        function setTimeSelectionMode(mode) {
            console.log('=== SET TIME SELECTION MODE ===');
            console.log('Mode:', mode);
            console.log('Previous segments before mode change:', JSON.stringify(timeConditionSegments, null, 2));
            
            // 确保 timeConditionSegments 已初始化
            if (!timeConditionSegments.charge || !timeConditionSegments.discharge) {
                console.error('timeConditionSegments not properly initialized!');
                timeConditionSegments = {
                    charge: [],
                    discharge: []
                };
            }
            
            currentTimeSelectionMode = mode;
            
            // 更新按钮状态
            const chargeBtn = document.getElementById('chargeSelectBtn');
            const dischargeBtn = document.getElementById('dischargeSelectBtn');
            const selectionBox = document.getElementById('timeSelectionBox');
            const interactArea = document.getElementById('timelineInteractArea');
            
            // 重置所有按钮
            chargeBtn.style.background = 'rgba(0,255,136,0.15)';
            chargeBtn.style.borderColor = 'rgba(0,255,136,0.3)';
            dischargeBtn.style.background = 'rgba(255,193,7,0.15)';
            dischargeBtn.style.borderColor = 'rgba(255,193,7,0.3)';
            
            if (mode === 'charge') {
                chargeBtn.style.background = 'rgba(0,255,136,0.3)';
                chargeBtn.style.borderColor = '#00ff88';
                if (selectionBox) {
                    selectionBox.style.background = 'rgba(0,255,136,0.3)';
                    selectionBox.style.borderColor = '#00ff88';
                }
                interactArea.style.cursor = 'crosshair';
            } else if (mode === 'discharge') {
                dischargeBtn.style.background = 'rgba(255,193,7,0.3)';
                dischargeBtn.style.borderColor = '#FFC107';
                if (selectionBox) {
                    selectionBox.style.background = 'rgba(255,193,7,0.3)';
                    selectionBox.style.borderColor = '#FFC107';
                }
                interactArea.style.cursor = 'crosshair';
            }
            
            // 绑定拖拽事件（只会绑定一次）
            bindTimeSelectionEvents();
            
            console.log('Time selection mode set to:', mode);
            console.log('Segments after mode change:', JSON.stringify(timeConditionSegments, null, 2));
            
            // 确保时间段显示正确
            updateTimelineDisplay();
            updateTimeSegmentsList();
        }

        // 全局变量用于事件处理
        let timeSelectionEventsBound = false;
        let isDraggingGlobal = false;
        let startXGlobal = 0;

        // 绑定时间选择拖拽事件（只绑定一次）
        function bindTimeSelectionEvents() {
            if (timeSelectionEventsBound) {
                console.log('Time selection events already bound, skipping...');
                return; // 防止重复绑定
            }
            
            const interactArea = document.getElementById('timelineInteractArea');
            if (!interactArea) {
                console.error('timelineInteractArea not found!');
                return;
            }
            
            console.log('Binding time selection events...');
            
            // 鼠标按下
            interactArea.addEventListener('mousedown', (e) => {
                if (!currentTimeSelectionMode) return;
                
                isDraggingGlobal = true;
                timeSelection.isSelecting = true;
                startXGlobal = e.clientX - interactArea.getBoundingClientRect().left;
                timeSelection.startX = startXGlobal;
                
                const selectionBox = document.getElementById('timeSelectionBox');
                if (selectionBox) {
                    selectionBox.style.display = 'block';
                    selectionBox.style.left = startXGlobal + 'px';
                    selectionBox.style.width = '0px';
                }
                
                e.preventDefault();
                console.log('Mouse down - starting selection in mode:', currentTimeSelectionMode);
            });
            
            // 鼠标移动
            interactArea.addEventListener('mousemove', (e) => {
                if (!isDraggingGlobal || !currentTimeSelectionMode) return;
                
                const currentX = e.clientX - interactArea.getBoundingClientRect().left;
                const selectionBox = document.getElementById('timeSelectionBox');
                
                const left = Math.min(startXGlobal, currentX);
                const width = Math.abs(currentX - startXGlobal);
                
                if (selectionBox) {
                    selectionBox.style.left = left + 'px';
                    selectionBox.style.width = width + 'px';
                }
                
                // 实时计算时间范围
                updateCurrentTimeSelection(left, width, interactArea.getBoundingClientRect().width);
            });
            
            // 鼠标抬起
            interactArea.addEventListener('mouseup', (e) => {
                console.log('=== MOUSE UP EVENT ===');
                console.log('isDraggingGlobal:', isDraggingGlobal);
                console.log('currentTimeSelectionMode:', currentTimeSelectionMode);
                
                if (!isDraggingGlobal || !currentTimeSelectionMode) {
                    console.log('Mouse up ignored - not dragging or no mode selected');
                    return;
                }
                
                isDraggingGlobal = false;
                timeSelection.isSelecting = false;
                
                const currentX = e.clientX - interactArea.getBoundingClientRect().left;
                const totalWidth = interactArea.getBoundingClientRect().width;
                const left = Math.min(startXGlobal, currentX);
                const width = Math.abs(currentX - startXGlobal);
                
                console.log('Mouse up - selection completed. Width:', width);
                console.log('Left:', left, 'TotalWidth:', totalWidth);
                
                if (width > 10) { // 最小拖拽距离
                    updateCurrentTimeSelection(left, width, totalWidth);
                    console.log('Valid selection created:', timeSelection.current);
                    
                    // 自动添加时间段
                    console.log('Calling autoAddTimeSegment...');
                    autoAddTimeSegment();
                } else {
                    // 清除选择
                    clearTimeSelection();
                    console.log('Selection too small, cleared');
                }
            });
            
            // 防止拖拽到外部
            document.addEventListener('mouseup', () => {
                if (isDraggingGlobal) {
                    isDraggingGlobal = false;
                    timeSelection.isSelecting = false;
                    console.log('Global mouse up - stopped dragging');
                }
            });
            
            timeSelectionEventsBound = true;
            console.log('Time selection events bound successfully');
        }

        // 更新当前时间选择
        function updateCurrentTimeSelection(left, width, totalWidth) {
            const startPercent = left / totalWidth;
            const endPercent = (left + width) / totalWidth;
            
            const startHour = Math.floor(startPercent * 24);
            const endHour = Math.ceil(endPercent * 24);
            
            const formatTime = (hour) => {
                return hour.toString().padStart(2, '0') + ':00';
            };
            
            timeSelection.current = {
                start: formatTime(Math.max(0, startHour)),
                end: formatTime(Math.min(24, endHour)),
                type: currentTimeSelectionMode
            };
            
            console.log('Current time selection:', timeSelection.current);
        }

        // 自动添加时间段（框选完成后自动调用）
        function autoAddTimeSegment() {
            if (!timeSelection.current || !currentTimeSelectionMode) {
                console.log('No valid selection to add');
                return;
            }
            
            // 创建新时间段时，确保包含当前类型
            const newSegment = {
                start: timeSelection.current.start,
                end: timeSelection.current.end,
                id: Date.now().toString(), // 唯一ID
                type: currentTimeSelectionMode // 明确记录类型
            };
            
            console.log('Auto-adding time segment:', newSegment, 'to', currentTimeSelectionMode);
            
            // 检查与对方类型的时间冲突并处理
            const oppositeType = currentTimeSelectionMode === 'charge' ? 'discharge' : 'charge';
            const newOppositeSegments = [];
            
            timeConditionSegments[oppositeType].forEach((segment) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    // 有重叠，需要处理
                    const splitSegments = splitSegmentByOverlap(segment, newSegment);
                    console.log(`Splitting ${oppositeType} segment:`, segment, 'into:', splitSegments);
                    newOppositeSegments.push(...splitSegments);
                } else {
                    // 无重叠，保留原段
                    newOppositeSegments.push(segment);
                }
            });
            
            // 更新对方类型的时间段
            timeConditionSegments[oppositeType] = newOppositeSegments;
            console.log(`Updated ${oppositeType} segments after overlap handling:`, newOppositeSegments);
            
            // 检查与自己类型的时间段，合并相邻或重叠的段
            const mergedSegment = { ...newSegment };
            const segmentsToRemove = [];
            
            console.log(`Checking for merge with existing ${currentTimeSelectionMode} segments:`, timeConditionSegments[currentTimeSelectionMode]);
            
            timeConditionSegments[currentTimeSelectionMode].forEach((segment, index) => {
                if (shouldMergeSegments(mergedSegment, segment)) {
                    console.log(`Merging new segment [${mergedSegment.start}-${mergedSegment.end}] with existing [${segment.start}-${segment.end}]`);
                    
                    // 合并时间段
                    const merged = mergeTimeSegments(mergedSegment, segment);
                    mergedSegment.start = merged.start;
                    mergedSegment.end = merged.end;
                    
                    segmentsToRemove.push(index);
                    console.log(`Result after merge: [${mergedSegment.start}-${mergedSegment.end}]`);
                }
            });
            
            console.log(`Will remove ${segmentsToRemove.length} segments and add merged segment`);
            
            // 移除要合并的时间段
            for (let i = segmentsToRemove.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[currentTimeSelectionMode].splice(segmentsToRemove[i], 1)[0];
                console.log(`Removed segment for merge:`, removedSegment);
            }
            
            // 添加合并后的时间段到正确的数组
            console.log(`Before adding: ${currentTimeSelectionMode} segments count:`, timeConditionSegments[currentTimeSelectionMode].length);
            timeConditionSegments[currentTimeSelectionMode].push(mergedSegment);
            console.log(`Auto-added merged ${currentTimeSelectionMode} segment:`, mergedSegment);
            console.log(`After adding: ${currentTimeSelectionMode} segments count:`, timeConditionSegments[currentTimeSelectionMode].length);
            
            // 同步到旧系统的全局变量
            if (currentTimeSelectionMode === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // 立即更新所有显示
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // 也更新旧系统的显示（如果存在）
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
            
            // 清除选择框但保持选择模式
            clearTimeSelection();
            
            console.log('Total segments now:', {
                charge: timeConditionSegments.charge.length,
                discharge: timeConditionSegments.discharge.length
            });
            
            // 调试：显示当前所有时间段
            const chargeList = timeConditionSegments.charge.map(s => `${s.start}-${s.end}`).join(', ');
            const dischargeList = timeConditionSegments.discharge.map(s => `${s.start}-${s.end}`).join(', ');
            console.log(`充电时间段(${timeConditionSegments.charge.length}个): ${chargeList || '无'}`);
            console.log(`放电时间段(${timeConditionSegments.discharge.length}个): ${dischargeList || '无'}`);
        }

        // 添加当前时间选择
        function addCurrentTimeSelection() {
            console.log('=== ADD TIME SEGMENT CALLED ===');
            console.log('timeSelection.current:', timeSelection.current);
            console.log('currentTimeSelectionMode:', currentTimeSelectionMode);
            console.log('Current segments before adding:', JSON.stringify(timeConditionSegments, null, 2));
            
            if (!timeSelection.current || !currentTimeSelectionMode) {
                alert('请先在时间轴上选择时间段');
                return;
            }
            
            const newSegment = {
                start: timeSelection.current.start,
                end: timeSelection.current.end,
                id: Date.now().toString() // 唯一ID
            };
            
            console.log('Adding time segment:', newSegment, 'to', currentTimeSelectionMode);
            
            // 检查与对方类型的时间冲突
            const oppositeType = currentTimeSelectionMode === 'charge' ? 'discharge' : 'charge';
            const conflictingSegments = [];
            
            timeConditionSegments[oppositeType].forEach((segment, index) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    conflictingSegments.push(index);
                }
            });
            
            // 移除冲突的对方时间段
            for (let i = conflictingSegments.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[oppositeType].splice(conflictingSegments[i], 1)[0];
                console.log(`Removed conflicting ${oppositeType} segment:`, removedSegment);
            }
            
            // 检查与自己类型的时间冲突
            const sameTypeConflicts = [];
            timeConditionSegments[currentTimeSelectionMode].forEach((segment, index) => {
                if (isTimeSegmentOverlap(newSegment, segment)) {
                    sameTypeConflicts.push(index);
                }
            });
            
            // 移除冲突的同类型时间段
            for (let i = sameTypeConflicts.length - 1; i >= 0; i--) {
                const removedSegment = timeConditionSegments[currentTimeSelectionMode].splice(sameTypeConflicts[i], 1)[0];
                console.log(`Removed conflicting ${currentTimeSelectionMode} segment:`, removedSegment);
            }
            
            // 添加新时间段
            timeConditionSegments[currentTimeSelectionMode].push(newSegment);
            console.log(`Added new ${currentTimeSelectionMode} segment:`, newSegment);
            
            // 更新显示
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // 只清除当前选择框，但保持选择模式
            clearTimeSelection();
            
            console.log('=== FINAL SEGMENTS STATE ===');
            console.log('timeConditionSegments:', JSON.stringify(timeConditionSegments, null, 2));
            console.log('Current mode remains:', currentTimeSelectionMode);
            console.log('=== ADD SEGMENT COMPLETED ===');
        }

        // 清除时间选择
        function clearTimeSelection() {
            console.log('Clearing time selection...');
            timeSelection.current = null;
            
            const selectionBox = document.getElementById('timeSelectionBox');
            if (selectionBox) {
                selectionBox.style.display = 'none';
            } else {
                console.error('timeSelectionBox not found!');
            }
        }

        // 更新时间轴显示
        function updateTimelineDisplay() {
            console.log('=== updateTimelineDisplay called ===');
            console.log('Current timeConditionSegments:', JSON.stringify(timeConditionSegments, null, 2));
            
            const display = document.getElementById('timelineSegmentDisplay');
            if (!display) {
                console.error('timelineSegmentDisplay element not found!');
                return;
            }
            
            // 清空现有显示
            display.innerHTML = '';
            
            console.log(`Displaying ${timeConditionSegments.charge.length} charge segments`);
            // 显示充电时间段
            timeConditionSegments.charge.forEach((segment, index) => {
                console.log(`Creating charge segment ${index}:`, segment);
                const element = createTimelineSegmentElement(segment, 'charge');
                display.appendChild(element);
            });
            
            console.log(`Displaying ${timeConditionSegments.discharge.length} discharge segments`);
            // 显示放电时间段
            timeConditionSegments.discharge.forEach((segment, index) => {
                console.log(`Creating discharge segment ${index}:`, segment);
                const element = createTimelineSegmentElement(segment, 'discharge');
                display.appendChild(element);
            });
            
            console.log('Timeline display updated successfully');
        }

        // 创建时间轴段元素
        function createTimelineSegmentElement(segment, type) {
            const element = document.createElement('div');
            
            const startHour = parseInt(segment.start.split(':')[0]);
            const endHour = parseInt(segment.end.split(':')[0]);
            
            const startPercent = (startHour / 24) * 100;
            let widthPercent = ((endHour - startHour) / 24) * 100;
            
            // 处理跨午夜的情况
            if (endHour < startHour) {
                widthPercent = ((24 - startHour + endHour) / 24) * 100;
            }
            
            // 使用segment自身的type属性（如果有），否则使用传入的type
            const actualType = segment.type || type;
            const color = actualType === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = actualType === 'charge' ? 'rgba(0,255,136,0.3)' : 'rgba(255,193,7,0.3)';
            
            element.style.cssText = `
                position: absolute;
                left: ${startPercent}%;
                width: ${widthPercent}%;
                height: 100%;
                background: ${bgColor};
                border: 1px solid ${color};
                border-radius: 4px;
                pointer-events: none;
            `;
            
            element.dataset.segmentType = actualType;
            element.dataset.segmentId = segment.id || `${actualType}-${Date.now()}`;
            
            return element;
        }

        // 更新时间段列表
        function updateTimeSegmentsList() {
            console.log('=== updateTimeSegmentsList called ===');
            updateChargeSegmentsList();
            updateDischargeSegmentsList();
        }

        // 更新充电时间段列表
        function updateChargeSegmentsList() {
            const container = document.getElementById('chargeTimeSegmentsList');
            const countLabel = document.getElementById('chargeSegmentCount');
            
            if (!container) {
                console.error('chargeTimeSegmentsList container not found!');
                return;
            }
            
            const segments = timeConditionSegments.charge;
            // 不再显示数量
            // countLabel.textContent = `(${segments.length}个)`;
            
            container.innerHTML = '';
            // 设置容器为水平布局
            container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;';
            
            if (segments.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">暂无充电时间段</div>';
                return;
            }
            
            segments.forEach((segment, index) => {
                const segmentElement = createTimeSegmentListItem(segment, index, 'charge');
                container.appendChild(segmentElement);
            });
        }

        // 更新放电时间段列表
        function updateDischargeSegmentsList() {
            console.log('=== updateDischargeSegmentsList called ===');
            console.log('Discharge segments:', timeConditionSegments.discharge);
            
            const container = document.getElementById('dischargeTimeSegmentsList');
            const countLabel = document.getElementById('dischargeSegmentCount');
            
            if (!container) {
                console.error('dischargeTimeSegmentsList container not found!');
                return;
            }
            
            const segments = timeConditionSegments.discharge;
            // 不再显示数量
            // countLabel.textContent = `(${segments.length}个)`;
            
            container.innerHTML = '';
            // 设置容器为水平布局
            container.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; min-height: 30px;';
            
            if (segments.length === 0) {
                container.innerHTML = '<div style="color: rgba(255,255,255,0.5); font-size: 12px; padding: 8px;">暂无放电时间段</div>';
                return;
            }
            
            segments.forEach((segment, index) => {
                console.log(`Creating discharge list item ${index}:`, segment);
                const segmentElement = createTimeSegmentListItem(segment, index, 'discharge');
                container.appendChild(segmentElement);
            });
        }

        // 创建时间段列表项
        function createTimeSegmentListItem(segment, index, type) {
            const item = document.createElement('div');
            // 使用segment自身的type属性（如果有），否则使用传入的type
            const actualType = segment.type || type;
            const color = actualType === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = actualType === 'charge' ? 'rgba(0,255,136,0.1)' : 'rgba(255,193,7,0.1)';
            const borderColor = actualType === 'charge' ? 'rgba(0,255,136,0.3)' : 'rgba(255,193,7,0.3)';
            
            item.style.cssText = `
                position: relative;
                display: inline-flex;
                align-items: center;
                padding: 6px 12px;
                background: ${bgColor};
                border: 1px solid ${borderColor};
                border-radius: 6px;
                font-size: 12px;
                color: ${color};
                font-weight: 500;
                min-width: 80px;
                justify-content: center;
            `;
            
            item.dataset.segmentType = actualType;
            item.dataset.segmentIndex = index;
            item.dataset.segmentId = segment.id;
            
            // 创建可编辑的时间显示
            const timeDisplay = document.createElement('span');
            timeDisplay.style.cursor = 'pointer';
            timeDisplay.textContent = `${segment.start} - ${segment.end}`;
            timeDisplay.onclick = () => enableTimeEditing(item, segment, index, actualType);
            
            item.innerHTML = `
                <button onclick="deleteTimeSegment(${index}, '${actualType}')" 
                        style="position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; 
                               background: #ff4444; color: #fff; border: none; border-radius: 50%; 
                               font-size: 10px; cursor: pointer; display: flex; align-items: center; 
                               justify-content: center; line-height: 1; padding: 0; transition: all 0.3s;
                               box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                        onmouseover="this.style.background='#ff6666'" 
                        onmouseout="this.style.background='#ff4444'">×</button>
            `;
            
            item.insertBefore(timeDisplay, item.firstChild);
            
            return item;
        }

        // 启用时间编辑
        function enableTimeEditing(item, segment, index, type) {
            const color = type === 'charge' ? '#00ff88' : '#FFC107';
            const bgColor = type === 'charge' ? 'rgba(0,255,136,0.1)' : 'rgba(255,193,7,0.1)';
            
            // 创建输入框
            const startInput = document.createElement('input');
            startInput.type = 'time';
            startInput.value = segment.start;
            startInput.style.cssText = `
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.2);
                color: #fff;
                padding: 2px 4px;
                border-radius: 3px;
                font-size: 11px;
                outline: none;
                width: 60px;
            `;
            
            const endInput = document.createElement('input');
            endInput.type = 'time';
            endInput.value = segment.end;
            endInput.style.cssText = startInput.style.cssText;
            
            const separator = document.createElement('span');
            separator.textContent = ' - ';
            separator.style.color = color;
            
            // 保存原始内容
            const originalContent = item.innerHTML;
            
            // 清空并添加输入框
            item.innerHTML = '';
            item.appendChild(startInput);
            item.appendChild(separator);
            item.appendChild(endInput);
            
            // 添加确认和取消按钮
            const confirmBtn = document.createElement('button');
            confirmBtn.textContent = '✓';
            confirmBtn.style.cssText = `
                margin-left: 4px;
                background: ${bgColor};
                border: 1px solid ${color};
                color: ${color};
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                cursor: pointer;
            `;
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '✗';
            cancelBtn.style.cssText = confirmBtn.style.cssText.replace(color, '#ff6666').replace(bgColor, 'rgba(255,0,0,0.1)');
            
            confirmBtn.onclick = () => {
                const newStart = startInput.value;
                const newEnd = endInput.value;
                
                if (newStart && newEnd) {
                    updateTimeSegment(index, 'start', newStart, type);
                    updateTimeSegment(index, 'end', newEnd, type);
                }
                
                // 恢复正常显示
                updateTimeSegmentsList();
            };
            
            cancelBtn.onclick = () => {
                // 恢复原始内容
                item.innerHTML = originalContent;
                // 重新绑定事件
                const timeDisplay = item.querySelector('span');
                if (timeDisplay) {
                    timeDisplay.onclick = () => enableTimeEditing(item, segment, index, type);
                }
            };
            
            item.appendChild(confirmBtn);
            item.appendChild(cancelBtn);
            
            // 聚焦第一个输入框
            startInput.focus();
            startInput.select();
        }

        // 更新时间段
        function updateTimeSegment(index, field, value, type) {
            if (!timeConditionSegments[type][index]) return;
            
            const oldSegment = { ...timeConditionSegments[type][index] };
            timeConditionSegments[type][index][field] = value;
            
            console.log(`Updated ${type} segment ${index}:`, timeConditionSegments[type][index]);
            
            // 检查更新后的时间段是否与其他时间段冲突
            const updatedSegment = timeConditionSegments[type][index];
            const oppositeType = type === 'charge' ? 'discharge' : 'charge';
            
            // 检查与对方类型的冲突
            const conflictingOpposite = [];
            timeConditionSegments[oppositeType].forEach((segment, idx) => {
                if (isTimeSegmentOverlap(updatedSegment, segment)) {
                    conflictingOpposite.push(idx);
                }
            });
            
            // 移除冲突的对方时间段
            for (let i = conflictingOpposite.length - 1; i >= 0; i--) {
                const removed = timeConditionSegments[oppositeType].splice(conflictingOpposite[i], 1)[0];
                console.log(`Removed conflicting ${oppositeType} segment:`, removed);
            }
            
            // 检查与同类型其他时间段的冲突
            const conflictingSame = [];
            timeConditionSegments[type].forEach((segment, idx) => {
                if (idx !== index && isTimeSegmentOverlap(updatedSegment, segment)) {
                    conflictingSame.push(idx);
                }
            });
            
            // 移除冲突的同类型时间段
            for (let i = conflictingSame.length - 1; i >= 0; i--) {
                const removed = timeConditionSegments[type].splice(conflictingSame[i], 1)[0];
                console.log(`Removed conflicting ${type} segment:`, removed);
                // 如果删除的索引小于当前索引，需要调整当前索引
                if (conflictingSame[i] < index) {
                    index--;
                }
            }
            
            // 合并所有相邻或重叠的同类型时间段
            consolidateTimeSegments(type);
            
            // 同步到旧系统
            if (type === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // 更新显示
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // 更新旧系统显示
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
        }

        // 删除时间段
        function deleteTimeSegment(index, type) {
            if (!timeConditionSegments[type][index]) return;
            
            const removedSegment = timeConditionSegments[type].splice(index, 1)[0];
            console.log(`Deleted ${type} segment:`, removedSegment);
            
            // 合并所有相邻或重叠的同类型时间段
            consolidateTimeSegments(type);
            
            // 同步到旧系统
            if (type === 'charge') {
                window.chargeTimeSegments = [...timeConditionSegments.charge];
                chargeTimeSegments = window.chargeTimeSegments;
            } else {
                window.dischargeTimeSegments = [...timeConditionSegments.discharge];
                dischargeTimeSegments = window.dischargeTimeSegments;
            }
            
            // 更新显示
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            // 更新旧系统显示
            if (typeof renderTimeSegments === 'function') {
                renderTimeSegments();
            }
            if (typeof updateTimeline === 'function') {
                updateTimeline();
            }
        }

        // 检查时间段重叠
        function isTimeSegmentOverlap(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // 处理跨午夜的情况
            if (end1 < start1) { // segment1 跨午夜
                if (end2 < start2) { // segment2 也跨午夜
                    // 两个都跨午夜，需要检查是否真的有重叠
                    // 不重叠的情况：segment1的结束时间 < segment2的开始时间 且 segment2的结束时间 < segment1的开始时间
                    return !(end1 < start2 && end2 < start1);
                } else {
                    // segment1跨午夜，segment2不跨午夜
                    // segment2要么在晚上部分，要么在早上部分
                    return (start2 >= start1) || (end2 <= end1);
                }
            } else if (end2 < start2) { // 只有 segment2 跨午夜
                // segment2跨午夜，segment1不跨午夜
                return (start1 >= start2) || (end1 <= end2);
            } else { // 都不跨午夜
                return (start1 < end2) && (end1 > start2);
            }
        }

        // 时间字符串转分钟数
        function timeStringToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // 分钟数转时间字符串
        function minutesToTimeString(minutes) {
            // 处理负数和超过24小时的情况
            minutes = ((minutes % 1440) + 1440) % 1440;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        // 检查两个时间段是否应该合并（重叠或相邻）
        function shouldMergeSegments(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // 处理跨午夜的情况
            if (end1 < start1 || end2 < start2) {
                // 复杂情况，暂时只处理有重叠的情况
                return isTimeSegmentOverlap(segment1, segment2);
            }
            
            // 都不跨午夜的简单情况
            // 检查是否重叠或相邻（相差不超过1分钟视为相邻）
            const gap = Math.min(Math.abs(start1 - end2), Math.abs(start2 - end1));
            return isTimeSegmentOverlap(segment1, segment2) || gap <= 1;
        }

        // 合并两个时间段
        function mergeTimeSegments(segment1, segment2) {
            const start1 = timeStringToMinutes(segment1.start);
            const end1 = timeStringToMinutes(segment1.end);
            const start2 = timeStringToMinutes(segment2.start);
            const end2 = timeStringToMinutes(segment2.end);
            
            // 处理跨午夜的情况
            const overnight1 = end1 < start1;
            const overnight2 = end2 < start2;
            
            if (overnight1 && overnight2) {
                // 两个都跨午夜，合并后仍跨午夜
                const minStart = Math.min(start1, start2);
                const maxEnd = Math.max(end1, end2);
                return {
                    start: minutesToTimeString(minStart),
                    end: minutesToTimeString(maxEnd)
                };
            } else if (overnight1 || overnight2) {
                // 其中一个跨午夜，需要特殊处理
                // 简化处理：返回覆盖两个时间段的最大范围
                let allTimes = [start1, end1, start2, end2];
                
                if (overnight1) {
                    // segment1跨午夜
                    if (start2 >= start1 || end2 <= end1) {
                        // segment2在晚上部分或早上部分
                        return segment1; // segment1已经包含segment2
                    }
                    // 需要扩展
                    if (start2 < start1 && end2 > end1) {
                        // segment2跨越了segment1的间隙
                        return {
                            start: '00:00',
                            end: '24:00'
                        };
                    }
                    return {
                        start: minutesToTimeString(Math.min(start1, start2)),
                        end: minutesToTimeString(Math.max(end1, end2))
                    };
                } else {
                    // segment2跨午夜
                    if (start1 >= start2 || end1 <= end2) {
                        return segment2; // segment2已经包含segment1
                    }
                    if (start1 < start2 && end1 > end2) {
                        return {
                            start: '00:00',
                            end: '24:00'
                        };
                    }
                    return {
                        start: minutesToTimeString(Math.min(start1, start2)),
                        end: minutesToTimeString(Math.max(end1, end2))
                    };
                }
            } else {
                // 都不跨午夜，简单合并
                const minStart = Math.min(start1, start2);
                const maxEnd = Math.max(end1, end2);
                return {
                    start: minutesToTimeString(minStart),
                    end: minutesToTimeString(maxEnd)
                };
            }
        }

        // 合并同类型的所有相邻或重叠时间段
        function consolidateTimeSegments(type) {
            const segments = timeConditionSegments[type];
            if (segments.length <= 1) return;
            
            console.log(`Consolidating ${type} segments before:`, segments);
            
            // 重复合并直到没有可合并的段
            let hasChanges = true;
            while (hasChanges) {
                hasChanges = false;
                
                for (let i = 0; i < segments.length - 1; i++) {
                    for (let j = i + 1; j < segments.length; j++) {
                        if (shouldMergeSegments(segments[i], segments[j])) {
                            // 合并这两个段
                            const merged = mergeTimeSegments(segments[i], segments[j]);
                            
                            // 保留合并后的段在i位置
                            segments[i] = {
                                ...merged,
                                id: segments[i].id, // 保留原ID
                                type: type
                            };
                            
                            // 删除j位置的段
                            segments.splice(j, 1);
                            
                            hasChanges = true;
                            console.log(`Merged segments at positions ${i} and ${j}`);
                            break;
                        }
                    }
                    if (hasChanges) break;
                }
            }
            
            console.log(`Consolidating ${type} segments after:`, segments);
        }

        // 根据重叠分割时间段
        function splitSegmentByOverlap(existingSegment, newSegment) {
            const existing = {
                start: timeStringToMinutes(existingSegment.start),
                end: timeStringToMinutes(existingSegment.end)
            };
            const newSeg = {
                start: timeStringToMinutes(newSegment.start),
                end: timeStringToMinutes(newSegment.end)
            };
            
            const result = [];
            
            // 处理跨午夜的情况
            const existingOvernight = existing.end < existing.start;
            const newOvernight = newSeg.end < newSeg.start;
            
            if (existingOvernight && newOvernight) {
                // 两个都跨午夜，特殊处理
                // 可能产生0-2个片段
                if (newSeg.end < existing.start && existing.end < newSeg.start) {
                    // 新段完全覆盖旧段，返回空
                    return [];
                }
                
                if (existing.start > newSeg.end && newSeg.start > existing.end) {
                    // 无重叠
                    return [existingSegment];
                }
                
                // 部分重叠
                if (existing.start > newSeg.end) {
                    // 保留晚上部分
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(existing.start),
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                if (newSeg.end < existing.end) {
                    // 保留早上部分
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: minutesToTimeString(existing.end)
                    });
                }
            } else if (existingOvernight) {
                // 只有existing跨午夜
                if (newSeg.start >= existing.start || newSeg.end <= existing.end) {
                    // 新段在晚上或早上部分
                    if (newSeg.start >= existing.start) {
                        // 新段在晚上部分
                        if (newSeg.end < 1440) {
                            // 保留更晚的部分
                            result.push({
                                ...existingSegment,
                                start: minutesToTimeString(newSeg.end),
                                end: existingSegment.end
                            });
                        }
                        // 保留早上部分
                        result.push({
                            ...existingSegment,
                            start: '00:00',
                            end: existingSegment.end
                        });
                    } else {
                        // 新段在早上部分
                        result.push({
                            ...existingSegment,
                            start: existingSegment.start,
                            end: '24:00'
                        });
                        if (newSeg.start > 0) {
                            result.push({
                                ...existingSegment,
                                start: '00:00',
                                end: minutesToTimeString(newSeg.start)
                            });
                        }
                        if (newSeg.end < existing.end) {
                            result.push({
                                ...existingSegment,
                                start: minutesToTimeString(newSeg.end),
                                end: existingSegment.end
                            });
                        }
                    }
                } else {
                    // 新段跨越午夜分界
                    if (newSeg.start > existing.end && newSeg.end < existing.start) {
                        // 保留existing
                        return [existingSegment];
                    }
                }
            } else if (newOvernight) {
                // 只有new跨午夜
                if (existing.start >= newSeg.start || existing.end <= newSeg.end) {
                    // existing完全被覆盖
                    return [];
                }
                // 部分覆盖
                if (existing.start < newSeg.start && existing.end > newSeg.start) {
                    result.push({
                        ...existingSegment,
                        start: existingSegment.start,
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                if (existing.start < newSeg.end && existing.end > newSeg.end) {
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: existingSegment.end
                    });
                }
            } else {
                // 都不跨午夜，简单情况
                if (newSeg.start <= existing.start && newSeg.end >= existing.end) {
                    // 完全覆盖
                    return [];
                }
                
                if (newSeg.start > existing.start && newSeg.start < existing.end) {
                    // 保留前半部分
                    result.push({
                        ...existingSegment,
                        start: existingSegment.start,
                        end: minutesToTimeString(newSeg.start)
                    });
                }
                
                if (newSeg.end > existing.start && newSeg.end < existing.end) {
                    // 保留后半部分
                    result.push({
                        ...existingSegment,
                        start: minutesToTimeString(newSeg.end),
                        end: existingSegment.end
                    });
                }
            }
            
            // 过滤掉无效的时间段（开始时间等于结束时间）
            return result.filter(seg => seg.start !== seg.end);
        }

        // 初始化时间条件模块
        function initTimeConditions() {
            console.log('=== initTimeConditions called ===');
            
            // 确保timeConditionSegments已初始化
            if (typeof timeConditionSegments === 'undefined' || !timeConditionSegments.charge || !timeConditionSegments.discharge) {
                console.log('Initializing timeConditionSegments...');
                window.timeConditionSegments = {
                    charge: [],
                    discharge: []
                };
                timeConditionSegments = window.timeConditionSegments;
            }
            
            // 初始化旧系统的全局变量
            if (!window.chargeTimeSegments) {
                window.chargeTimeSegments = [];
            }
            if (!window.dischargeTimeSegments) {
                window.dischargeTimeSegments = [];
            }
            
            // 确保局部变量也初始化
            chargeTimeSegments = window.chargeTimeSegments;
            dischargeTimeSegments = window.dischargeTimeSegments;
            
            // 初始化显示
            console.log('Calling initial display updates...');
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            console.log('Time conditions module initialized');
            console.log('Initial segments:', {
                charge: timeConditionSegments.charge,
                discharge: timeConditionSegments.discharge
            });
        }
        
        // 在页面加载完成后初始化
        setTimeout(() => {
            initTimeConditions();
        }, 100);
        
        // 测试函数 - 手动添加时间段
        window.testAddTimeSegment = function(type = 'charge', start = '10:00', end = '12:00') {
            console.log('=== TEST ADD TIME SEGMENT ===');
            console.log('Adding', type, 'segment:', start, '-', end);
            
            if (!timeConditionSegments[type]) {
                console.error('timeConditionSegments not initialized!');
                return;
            }
            
            const testSegment = {
                start: start,
                end: end,
                id: Date.now().toString(),
                type: type
            };
            
            timeConditionSegments[type].push(testSegment);
            console.log('Segment added:', testSegment);
            console.log('Current segments:', timeConditionSegments);
            
            // 更新显示
            updateTimelineDisplay();
            updateTimeSegmentsList();
            
            console.log('Display updated');
        };
        
        // 调试函数 - 检查所有相关元素
        window.checkTimeConditionElements = function() {
            console.log('=== CHECKING TIME CONDITION ELEMENTS ===');
            
            const elements = {
                'timelineInteractArea': document.getElementById('timelineInteractArea'),
                'timeSelectionBox': document.getElementById('timeSelectionBox'),
                'timelineSegmentDisplay': document.getElementById('timelineSegmentDisplay'),
                'chargeTimeSegmentsList': document.getElementById('chargeTimeSegmentsList'),
                'dischargeTimeSegmentsList': document.getElementById('dischargeTimeSegmentsList'),
                'chargeSelectBtn': document.getElementById('chargeSelectBtn'),
                'dischargeSelectBtn': document.getElementById('dischargeSelectBtn'),
                'chargeSegmentCount': document.getElementById('chargeSegmentCount'),
                'dischargeSegmentCount': document.getElementById('dischargeSegmentCount')
            };
            
            for (const [id, element] of Object.entries(elements)) {
                console.log(`${id}:`, element ? '✓ Found' : '✗ Not found');
            }
            
            console.log('\n=== CHECKING VARIABLES ===');
            console.log('timeConditionSegments:', typeof timeConditionSegments !== 'undefined' ? timeConditionSegments : 'undefined');
            console.log('currentTimeSelectionMode:', typeof currentTimeSelectionMode !== 'undefined' ? currentTimeSelectionMode : 'undefined');
            console.log('timeSelectionEventsBound:', typeof timeSelectionEventsBound !== 'undefined' ? timeSelectionEventsBound : 'undefined');
            
            return elements;
        };
        
        // 检查两个时间段是否重叠
        function isTimeOverlap(segment1, segment2) {
            const start1 = timeToMinutes(segment1.start);
            const end1 = timeToMinutes(segment1.end);
            const start2 = timeToMinutes(segment2.start);
            const end2 = timeToMinutes(segment2.end);
            
            // 处理跨午夜的情况
            if (end1 < start1) { // segment1 跨午夜
                if (end2 < start2) { // segment2 也跨午夜
                    return true; // 两个跨午夜的段肯定重叠
                } else {
                    return (start2 >= start1) || (end2 <= end1);
                }
            } else if (end2 < start2) { // 只有 segment2 跨午夜
                return (start1 >= start2) || (end1 <= end2);
            } else { // 都不跨午夜
                return (start1 < end2) && (end1 > start2);
            }
        }
        
        // 将时间字符串转换为分钟数
        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        // 初始化事件监听和数据
        setTimeout(() => {
            // 初始化时间段数组
            if (typeof chargeTimeSegments === 'undefined') {
                chargeTimeSegments = [{ start: '22:00', end: '06:00' }];
            }
            if (typeof dischargeTimeSegments === 'undefined') {
                dischargeTimeSegments = [{ start: '16:00', end: '21:00' }];
            }
            
            console.log('Initialized time segments:', { chargeTimeSegments, dischargeTimeSegments });
        }, 500);
    </script>
    
    <!-- Condition Settings Modal -->
    <div id="conditionSettingsModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 10003; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 900px; max-width: 95%; max-height: 90vh; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1); overflow-y: auto;">
            <div class="modal-header" style="padding: 24px 32px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: space-between; background: rgba(255, 255, 255, 0.02); position: sticky; top: 0; z-index: 1;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 700; color: #fff;">自动化条件设置</h3>
                    <span id="modalRegionName" style="padding: 4px 12px; background: var(--color-primary); color: #000; border-radius: 20px; font-size: 12px; font-weight: 600;">NSW</span>
                </div>
                <button onclick="closeConditionSettingsModal()" style="background: none; border: none; color: rgba(255,255,255,0.6); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='none'">×</button>
            </div>
            
            <div class="modal-body" style="padding: 24px 32px;">
                <!-- 条件设置区域 -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <!-- 充电条件 -->
                    <div style="min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="font-size: 18px;">⚡</span>
                            <h4 style="margin: 0; color: #00ff88; font-size: 16px; font-weight: 600;">充电条件</h4>
                        </div>
                        
                        <!-- Price Condition -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                <input type="checkbox" id="modalChargePriceEnabled" checked style="width: 16px; height: 16px; accent-color: #00ff88; cursor: pointer;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Price Condition</span>
                            </label>
                            <div id="chargePriceSettings" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 13px; font-weight: 500;">低于</span>
                                <input type="number" id="modalChargePriceValue" value="50" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 8px; border-radius: 4px; font-size: 13px; outline: none; width: 70px; min-width: 70px;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 13px;">$</span>
                            </div>
                        </div>
                        
                        <!-- Time Condition -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                <input type="checkbox" id="modalChargeTimeEnabled" checked style="width: 16px; height: 16px; accent-color: #00ff88; cursor: pointer;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Time Condition</span>
                            </label>
                            <div id="chargeTimeSettings" style="min-width: 0; display: none;">
                                <div id="chargeTimeSegments" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; min-width: 0;">
                                    <!-- 充电时间段会动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 放电条件 -->
                    <div style="min-width: 0;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                            <span style="font-size: 18px;">🔋</span>
                            <h4 style="margin: 0; color: #FFC107; font-size: 16px; font-weight: 600;">放电条件</h4>
                        </div>
                        
                        <!-- Price Condition -->
                        <div style="margin-bottom: 16px;">
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                <input type="checkbox" id="modalDischargePriceEnabled" checked style="width: 16px; height: 16px; accent-color: #FFC107; cursor: pointer;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Price Condition</span>
                            </label>
                            <div id="dischargePriceSettings" style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 13px; font-weight: 500;">高于</span>
                                <input type="number" id="modalDischargePriceValue" value="100" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 8px; border-radius: 4px; font-size: 13px; outline: none; width: 70px; min-width: 70px;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 13px;">$</span>
                            </div>
                        </div>
                        
                        <!-- Time Condition -->
                        <div>
                            <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; cursor: pointer;">
                                <input type="checkbox" id="modalDischargeTimeEnabled" checked style="width: 16px; height: 16px; accent-color: #FFC107; cursor: pointer;">
                                <span style="color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 500;">Time Condition</span>
                            </label>
                            <div id="dischargeTimeSettings" style="min-width: 0; display: none;">
                                <div id="dischargeTimeSegments" style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; min-width: 0;">
                                    <!-- 放电时间段会动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 时间条件设置 -->
                <div style="background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); padding: 20px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="color: rgba(255,255,255,0.9); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                            ⏰ 时间条件
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 12px; height: 6px; background: linear-gradient(135deg, #00ff88, #00dd77); border-radius: 3px;"></div>
                                <span style="color: rgba(255,255,255,0.8); font-size: 11px;">充电</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <div style="width: 12px; height: 6px; background: linear-gradient(135deg, #FFC107, #FFB300); border-radius: 3px;"></div>
                                <span style="color: rgba(255,255,255,0.8); font-size: 11px;">放电</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div style="display: flex; gap: 12px; margin-bottom: 16px; justify-content: center;">
                        <button id="chargeSelectBtn" onclick="setTimeSelectionMode('charge')" style="padding: 8px 16px; background: rgba(0,255,136,0.15); border: 1px solid rgba(0,255,136,0.3); color: #00ff88; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            🔋 选择充电时间
                        </button>
                        <button id="dischargeSelectBtn" onclick="setTimeSelectionMode('discharge')" style="padding: 8px 16px; background: rgba(255,193,7,0.15); border: 1px solid rgba(255,193,7,0.3); color: #FFC107; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                            ⚡ 选择放电时间
                        </button>
                    </div>
                    
                    <!-- 时间轴容器 -->
                    <div style="position: relative;">
                        <!-- 时间刻度 -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: 6px; padding: 0 4px;">
                            <span style="color: rgba(255,255,255,0.8); font-size: 10px; font-weight: 500;">00</span>
                            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">06</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 10px; font-weight: 500;">12</span>
                            <span style="color: rgba(255,255,255,0.6); font-size: 10px;">18</span>
                            <span style="color: rgba(255,255,255,0.8); font-size: 10px; font-weight: 500;">24</span>
                        </div>
                        
                        <!-- 时间轴主体 -->
                        <div id="timelineContainer" style="position: relative; height: 32px; background: rgba(0,0,0,0.4); border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); overflow: hidden; user-select: none;">
                            <!-- 刻度线 -->
                            <div style="position: absolute; top: 0; bottom: 0; display: flex; justify-content: space-between; width: 100%; padding: 0 4px; pointer-events: none;">
                                <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                                <div style="width: 1px; background: rgba(255,255,255,0.1);"></div>
                                <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                                <div style="width: 1px; background: rgba(255,255,255,0.1);"></div>
                                <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                            </div>
                            
                            <!-- 时间段显示区域 -->
                            <div id="timelineSegmentDisplay" style="position: absolute; top: 2px; left: 2px; right: 2px; bottom: 2px; pointer-events: none;"></div>
                            
                            <!-- 选择框 -->
                            <div id="timeSelectionBox" style="position: absolute; top: 0; height: 100%; background: rgba(0,255,136,0.3); border: 2px solid #00ff88; display: none; pointer-events: none;"></div>
                            
                            <!-- 可交互区域 -->
                            <div id="timelineInteractArea" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; cursor: default;"></div>
                        </div>
                        
                        <!-- 操作说明 -->
                        <div style="margin-top: 8px; text-align: center; color: rgba(255,255,255,0.6); font-size: 11px;">
                            在时间轴上拖拽即可添加时间段
                        </div>
                    </div>
                    
                    <!-- 时间段列表 -->
                    <div style="margin-top: 20px;">
                        <!-- 充电时间段 -->
                        <div style="margin-bottom: 16px;">
                            <div style="color: #00ff88; font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                🔋 充电时间段
                            </div>
                            <div id="chargeTimeSegmentsList" style="display: flex; flex-direction: column; gap: 6px;">
                                <!-- 充电时间段将在这里显示 -->
                            </div>
                        </div>
                        
                        <!-- 放电时间段 -->
                        <div>
                            <div style="color: #FFC107; font-size: 13px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                                ⚡ 放电时间段
                            </div>
                            <div id="dischargeTimeSegmentsList" style="display: flex; flex-direction: column; gap: 6px;">
                                <!-- 放电时间段将在这里显示 -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 16px 32px; background: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); display: flex; justify-content: flex-end; gap: 12px; position: sticky; bottom: 0;">
                <button onclick="closeConditionSettingsModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.3s;">取消</button>
                <button onclick="saveCurrentRegionSettings()" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 10px 20px; border-radius: 6px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none;">保存设置</button>
            </div>
        </div>
    </div>
    
    <!-- 立即尝试初始化HeaderNav -->
    <script>
        // 立即尝试初始化HeaderNav
        setTimeout(() => {
            if (typeof initHeaderNav === 'function') {
                initHeaderNav();
            }
        }, 100);
        
        // 强制执行地区显示更新
        setTimeout(() => {
            if (typeof updateRegionDisplay === 'function') {
                console.log('Force calling updateRegionDisplay');
                updateRegionDisplay();
            }
        }, 200);
        
    </script>
</body>
</html>
