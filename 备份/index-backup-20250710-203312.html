<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源管理中心</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <link rel="stylesheet" href="components/common-styles.css">
    <link rel="stylesheet" href="components/time-selector.css">
    <link rel="stylesheet" href="components/i18n.css">
    <link rel="stylesheet" href="components/notification-center.css">
    <link rel="stylesheet" href="components/header-nav.css">
    <link rel="stylesheet" href="components/drawer-component.css">
    <link rel="stylesheet" href="components/user-dropdown.css">
    <script src="components/time-selector.js"></script>
    <script src="components/i18n.js"></script>
    <script src="components/simple-message-icon.js"></script>
    <script src="components/user-dropdown-simple-new.js"></script>
    <script src="components/header-nav.js"></script>
    <script src="components/drawer-component.js"></script>
    <script src="fix-charts-dom-ready.js" defer></script>
    <style>
        /* 强制抽屉组件在最顶层 */
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        /* 确保抽屉容器在所有元素之上 */
        #homeOperationDrawer {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        #homeOperationDrawer * {
            z-index: inherit !important;
        }
        
        /* 确保所有抽屉相关元素都在最顶层 */
        [id*="Drawer"], [class*="drawer"] {
            z-index: 2147483647 !important;
            position: relative !important;
        }
        
        /* Override for homepage specific styles */
        body {
            background: #000 !important;
            overflow: hidden;
            height: 100vh;
        }
        
        .container {
            background: transparent;
        }
        .btn {
            background: var(--color-primary);
            color: #fff;
            border-radius: 22px;
            border: none;
            padding: 0 24px;
            height: 44px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:hover {
            background: var(--color-accent);
        }
        .input {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            padding: 0 12px;
            height: 40px;
            color: var(--color-text);
            font-size: 16px;
        }
        /* 主题切换按钮 */
        .theme-toggle-btn {
            position: absolute;
            right: 32px;
            top: 24px;
            z-index: 100;
            background: var(--color-bg-card);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            box-shadow: var(--color-shadow);
            transition: background 0.3s, color 0.3s;
        }
        .theme-toggle-btn:hover {
            background: var(--color-primary);
            color: #fff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glass morphism effects */
        .glass {
            background: var(--color-bg-card, rgba(255,255,255,0.05));
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: var(--radius, 20px);
            color: var(--color-text);
        }

        /* Pulse animation for status indicators */
        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }



        .language-selector {
            position: relative;
            cursor: pointer;
        }

        .language-current {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            transition: all 0.3s;
        }

        .language-current:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 0;
            display: none;
            min-width: 120px;
        }

        .language-option {
            padding: 8px 16px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00aaff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* Period Dropdown Styles */
        .period-dropdown {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px;
            padding-right: 32px !important;
            transition: all 0.3s ease;
        }

        .period-dropdown:hover {
            background-color: rgba(255,255,255,0.12) !important;
            border-color: rgba(255,255,255,0.25) !important;
        }

        .period-dropdown:focus {
            background-color: rgba(255,255,255,0.15) !important;
            border-color: var(--color-primary) !important;
            box-shadow: 0 0 0 2px rgba(0,185,107,0.2);
        }

        .period-dropdown option {
            background: #1a1a1a;
            color: #fff;
            padding: 8px;
        }

        /* Main Container */
        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 120px 10px 0; /* 移除底部padding避免遮挡 */
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 24px 0;
            border-bottom: 1px solid var(--color-border);
        }

        /* Top Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 0;
            padding-right: 0;
            height: 600px;
            position: relative;
            overflow: hidden;
        }

        /* Market Section */
        .market-section {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .market-section .price-cards {
            width: 100%;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .market-section .price-card {
            flex: 1;
            min-width: 0;
        }

        /* Power Station Management Styles */
        .power-station-container {
            display: flex;
            flex-direction: column;
            padding: 12px;
            height: 100%;
            overflow: hidden;
        }

        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            padding-bottom: 4px;
        }

        .station-title {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }

        .highest-price-region {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Price Circle Layout */
        .price-circle-layout {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            gap: 20px;
        }

        .price-side-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            flex: 1;
        }

        .side-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            white-space: nowrap;
        }

        .side-price {
            font-size: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Main Price Circle */
        .main-price-circle {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .circle-background {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #00ff88, #00aa66);
            opacity: 0.9;
        }

        .circle-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: #fff;
        }

        .current-price {
            font-size: 36px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
        }

        .price-unit {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 16px;
            margin: 20px 0;
        }

        .action-btn {
            flex: 1;
            padding: 12px 24px;
            border: 2px solid transparent;
            border-radius: 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #000;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .charge-btn {
            background: linear-gradient(135deg, #00D67A, #00FF88) !important;
            border: 2px solid rgba(0, 255, 136, 0.3) !important;
            color: #000 !important;
        }

        .charge-btn:hover {
            transform: translateY(-2px);
            background: #00E070 !important;
            box-shadow: 0 8px 20px rgba(0, 255, 136, 0.4) !important;
            border-color: rgba(0, 255, 136, 0.6) !important;
        }

        .discharge-btn {
            background: linear-gradient(135deg, #FFA500, #FFD700) !important;
            border: 2px solid rgba(255, 215, 0, 0.3) !important;
            color: #000 !important;
        }

        .discharge-btn:hover {
            transform: translateY(-2px);
            background: #FFC107 !important;
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.4) !important;
            border-color: rgba(255, 215, 0, 0.6) !important;
        }
        
        /* 停止按钮样式 */
        .stop-btn {
            background: linear-gradient(135deg, #ff4444, #ff6b6b) !important;
            border: 2px solid rgba(255, 68, 68, 0.3) !important;
            flex: 1 !important;
            margin: 0 !important;
            color: #fff !important;
            padding: 12px 24px !important;
            border-radius: 32px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 4px 12px rgba(255, 68, 68, 0.2) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }
        
        .stop-btn:hover {
            box-shadow: 0 8px 20px rgba(255, 68, 68, 0.4) !important;
            border-color: rgba(255, 68, 68, 0.6) !important;
        }
        
        /* 操作中的按钮容器样式 */
        .action-buttons.operating {
            justify-content: center !important;
        }
        
        .action-buttons.operating .action-btn:not(.stop-btn) {
            display: none !important;
        }
        
        .action-buttons.operating .stop-btn {
            flex: 1 !important;
            max-width: 200px !important;
        }

        /* Stats Compact Grid */
        .stats-compact-grid {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            padding: 4px 0;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            background: #1a1a1a;
            border-radius: 8px;
            height: calc(100% / 4 - 3px);
        }

        .stat-icon {
            font-size: 14px;
            width: 16px;
            text-align: center;
            opacity: 0.9;
        }

        .stat-content {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            font-size: 12px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Stats Grid */
        .bottom-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .bottom-stat-card {
            padding: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .bottom-stat-title {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 3px;
        }

        .bottom-stat-value {
            font-size: 12px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 2px;
        }

        .bottom-stat-change {
            font-size: 8px;
            font-weight: 500;
        }

        .bottom-stat-change.positive {
            color: #00ff88;
        }

        .bottom-stat-change.negative {
            color: #8A4AFF;
        }

        /* Legacy: Electricity Cost Circle for backward compatibility */
        .cost-circle-container {
            padding: 40px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .cost-circle {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .circle-bg {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #00ff88 0deg, #00ff88 144deg, rgba(255, 255, 255, 0.1) 144deg);
            padding: 3px;
            mask: radial-gradient(farthest-side, transparent calc(100% - 20px), #000 calc(100% - 20px));
        }

        .circle-inner {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .cost-amount {
            font-size: 48px;
            font-weight: 300;
            margin-bottom: 5px;
        }

        .cost-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Price Range Display */
        .price-range {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
            gap: 20px;
        }

        .price-stat {
            flex: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .price-stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .price-stat-value {
            font-size: 20px;
            font-weight: 600;
        }

        .price-high {
            color: #8A4AFF;
        }

        .price-low {
            color: #00ff88;
        }

        .cost-buttons {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 30px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-primary {
            background: #00ff88;
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: #8A4AFF;
            color: #fff;
            border: 1px solid #8A4AFF;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        /* Panel Tabs */
        .panel-tabs {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .panel-tab {
            padding: 8px 20px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .panel-tab:hover {
            color: #fff;
        }

        .panel-tab.active {
            color: #00ff88;
        }

        .panel-tab.active::after {
            content: '';
            position: absolute;
            bottom: -16px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }

        .auto-switch-toggle {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* Switch Toggle */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #00ff88;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        /* Panel Content */
        .panel-content { display: none; }
        .panel-content.active { display: flex; flex-direction: column; flex: 1; min-height: 450px; }

        /* Region Tabs */
        .region-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .region-tab {
            padding: 6px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .region-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .region-tab.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }

        /* Price Cards */
        .price-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            height: 80px; /* 固定高度 */
        }

        .price-card {
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 0;
            height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            background: var(--color-bg-card, rgba(255,255,255,0.03));
            border-radius: var(--radius, 8px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
        }

        .price-card-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 6px;
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .price-card-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Demand Generation Card */
        .demand-gen-card {
            padding: 12px !important;
            gap: 6px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            height: 80px;
        }

        .demand-gen-row {
            display: flex;
            align-items: center;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.3s ease;
            height: 50%;
            justify-content: space-between;
        }

        .demand-gen-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .demand-gen-value {
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .demand-row {
            background: linear-gradient(90deg, rgba(76, 217, 100, 0.2), rgba(76, 217, 100, 0.15));
        }

        .demand-row .demand-gen-value {
            color: #4CD964;
        }

        .generation-row {
            background: linear-gradient(90deg, rgba(30, 144, 255, 0.2), rgba(30, 144, 255, 0.15));
        }

        .generation-row .demand-gen-value {
            color: #1E90FF;
        }

        @media (max-width: 768px) {
            .price-cards {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 480px) {
            .price-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-container {
            padding: 20px;
            height: 605.2px; /* 固定高度，与地图卡片一致 */
            display: flex;
            flex-direction: column;
            width: calc(100% - 30px); /* 减去左侧gap的宽度 */
            margin-left: auto;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 18px;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
        }

        .tab {
            padding: 6px 16px;
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: rgba(255, 255, 255, 0.3);
        }

        .chart-area {
            flex: 1;
            width: 100%;
            height: calc(100% - 60px); /* 减去头部的高度 */
            min-height: 0; /* 防止内容溢出 */
        }

        /* Info Cards */
        .info-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .info-card {
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
        }

        .info-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .info-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Stats Overview */
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
            width: calc(100% - 30px);
            margin-left: auto;
        }

        .stat-overview-card {
            background: rgba(26, 26, 26, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-overview-icon {
            font-size: 20px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .stat-overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            margin-bottom: 4px;
        }

        .stat-overview-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        /* Bottom Section */
        .bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 40px;
        }

        .data-table {
            padding: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }

        .data-value {
            font-size: 18px;
            font-weight: 500;
        }

        /* Region Selection Layer Styles */
        .region-select-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.05) !important;
            color: var(--color-text) !important;
        }
        
        .region-select-tab.active {
            background: var(--color-primary) !important;
            color: #000 !important;
            box-shadow: 0 2px 8px rgba(0, 255, 136, 0.3);
        }
        
        /* Responsive Layout */
        @media (min-width: 1441px) {
            /* Large screens */
            .container {
                max-width: 98%;
                padding: 100px 20px 20px;
            }
            
            .stats-row {
                height: calc(100vh - 160px);
                min-height: 700px;
            }
            
            .power-station-container {
                height: calc(100vh - 160px) !important;
                min-height: 700px;
            }
            
            .custom-card {
                height: calc(100vh - 160px) !important;
                min-height: 700px;
            }
        }
        
        @media (max-width: 1440px) and (min-width: 1201px) {
            /* Medium-large screens */
            .container {
                max-width: 98%;
                padding: 100px 15px 20px;
            }
            
            .stats-row {
                height: calc(100vh - 140px);
                min-height: 600px;
            }
            
            .power-station-container {
                height: calc(100vh - 140px) !important;
                min-height: 600px;
            }
            
            .custom-card {
                height: calc(100vh - 140px) !important;
                min-height: 600px;
            }
        }
        
        @media (max-width: 1200px) {
            /* Tablet and small desktop */
            .container {
                max-width: 100%;
                padding: 100px 10px 20px;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                height: auto;
                gap: 20px;
            }
            
            .power-station-container {
                height: 600px !important;
                margin-bottom: 20px;
            }
            
            .custom-card {
                height: 600px !important;
            }
            
            .info-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-price-circle {
                width: 120px;
                height: 120px;
            }
            
            .current-price {
                font-size: 28px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile devices */
            .container {
                max-width: 100%;
                padding: 100px 8px 20px;
            }
            
            .region-selection-layer {
                margin-bottom: 15px;
                padding: 12px;
            }
            
            .region-selection-tabs {
                gap: 4px;
            }
            
            .region-select-tab {
                padding: 8px 16px !important;
                font-size: 14px;
                min-width: 80px !important;
            }
            
            .stats-row {
                grid-template-columns: 1fr;
                height: auto;
                gap: 15px;
            }
            
            .power-station-container {
                height: 600px !important;
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .custom-card {
                height: 600px !important;
            }
            
            .price-cards {
                gap: 10px;
            }
            
            .price-card {
                min-height: 100px;
            }
            
            .main-price-circle {
                width: 100px;
                height: 100px;
            }
            
            .current-price {
                font-size: 24px;
            }
            
            .side-price {
                font-size: 16px;
            }
            
            .price-circle-layout {
                gap: 8px;
                margin: 15px 0;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
        }

        @media (max-width: 480px) {
            /* Small mobile devices */
            .container {
                max-width: 100%;
                padding: 95px 5px 15px;
            }
            
            .region-selection-layer {
                margin-bottom: 10px;
                padding: 10px;
            }
            
            .region-selection-tabs {
                gap: 3px;
                flex-wrap: wrap;
            }
            
            .region-select-tab {
                padding: 6px 12px !important;
                font-size: 12px;
                min-width: 70px !important;
            }
            
            .power-station-container {
                height: 600px !important;
                padding: 12px;
            }
            
            .custom-card {
                height: 600px !important;
            }
            
            .price-cards {
                gap: 8px;
            }
            
            .price-card {
                min-height: 90px;
            }
            
            .main-price-circle {
                width: 90px;
                height: 90px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .side-price {
                font-size: 14px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .info-cards {
                grid-template-columns: 1fr;
            }
            
            .price-circle-layout {
                gap: 6px;
                margin: 10px 0;
            }
        }
        
        /* Responsive adjustments for info-summary-card */
        @media (min-width: 1441px) {
            .info-summary-card {
                height: 150px !important;
                min-height: 150px !important;
                max-height: 150px !important;
                margin-top: 15px !important;
                padding: 0 24px !important;
            }
        }
        
        @media (max-width: 1440px) and (min-width: 1201px) {
            .info-summary-card {
                height: 140px !important;
                min-height: 140px !important;
                max-height: 140px !important;
                margin-top: 15px !important;
                padding: 0 20px !important;
            }
        }
        
        @media (max-width: 1200px) {
            .info-summary-card {
                height: 120px !important;
                min-height: 120px !important;
                max-height: 120px !important;
                margin-top: 12px !important;
                padding: 0 16px !important;
            }
        }
        
        @media (max-width: 768px) {
            .info-summary-card {
                height: 100px !important;
                min-height: 100px !important;
                max-height: 100px !important;
                margin-top: 10px !important;
                padding: 0 12px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 16px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 12px !important;
            }
        }
        
        @media (max-width: 480px) {
            .info-summary-card {
                height: 90px !important;
                min-height: 90px !important;
                max-height: 90px !important;
                margin-top: 8px !important;
                padding: 0 10px !important;
            }
            
            .info-summary-card div[style*="font-size:18px"] {
                font-size: 14px !important;
            }
            
            .info-summary-card div[style*="font-size:13px"] {
                font-size: 10px !important;
            }
        }

        /* Height-based Responsive */
        @media (min-height: 900px) {
            .power-station-container {
                height: calc(100vh - 180px) !important;
                min-height: 600px;
                max-height: 800px;
            }
            
            .custom-card {
                height: calc(100vh - 180px) !important;
                min-height: 600px;
                max-height: 800px;
            }
        }
        
        @media (min-height: 800px) and (max-height: 899px) {
            .power-station-container {
                height: calc(100vh - 200px) !important;
                min-height: 600px;
            }
            
            .custom-card {
                height: calc(100vh - 200px) !important;
                min-height: 600px;
            }
        }
        
        @media (max-height: 800px) {
            .power-station-container {
                height: calc(100vh - 200px);
            }
            
            .stats-row {
                height: calc(100vh - 200px);
            }
            
            .custom-card {
                height: calc(100vh - 200px) !important;
                min-height: 500px;
            }
            
            .right-panel-scroll {
                height: calc(100vh - 200px) !important;
            }
            
            .main-price-circle {
                width: 100px;
                height: 100px;
            }
            
            .current-price {
                font-size: 24px;
            }
            
            .price-circle-layout {
                margin: 8px 0;
            }
            
            .action-buttons {
                margin: 8px 0;
            }
        }
        
        @media (max-height: 600px) {
            .power-station-container {
                height: calc(100vh - 160px) !important;
                min-height: 300px;
            }
            
            .custom-card {
                height: calc(100vh - 160px) !important;
                min-height: 300px;
            }
            
            .stats-row {
                height: calc(100vh - 160px);
                min-height: 300px;
            }
            
            .main-price-circle {
                width: 80px;
                height: 80px;
            }
            
            .current-price {
                font-size: 20px;
            }
            
            .side-price {
                font-size: 14px;
            }
            
            .station-header {
                margin-bottom: 4px;
                padding-bottom: 4px;
            }
            
            .station-title {
                font-size: 14px;
            }
        }

        /* Animations */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-green {
            background: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .status-yellow {
            background: #ffaa00;
            box-shadow: 0 0 10px rgba(255, 170, 0, 0.5);
        }

        /* Region Status Indicators */
        .region-status {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 600;
        }

        .region-status.charging {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .region-status.discharging {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        /* 选中状态下的标记样式 */
        .region-select-tab.active .region-status.charging {
            background: #000;
            color: #00ff88;
            border: 1px solid #00ff88;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(0, 255, 136, 0.5);
        }

        .region-select-tab.active .region-status.discharging {
            background: #000;
            color: #ffaa00;
            border: 1px solid #ffaa00;
            font-weight: 700;
            box-shadow: 0 0 6px rgba(255, 170, 0, 0.5);
        }
        
        /* 按钮悬停效果 */
        .region-select-tab:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .region-select-tab.active {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ff88;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        
        .modal.show {
            display: flex !important;
        }

        .modal-content {
            background: #1a1a2e;
            margin: 0;
            padding: 0;
            border: none;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            color: #fff;
            position: relative;
            animation: modalSlideIn 0.3s ease-out;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Modal Button Styles */
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: #fff;
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #ff3333, #ff5555);
            transform: translateY(-1px);
        }
        
        /* Operation Type Styling */
        .operation-type {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .operation-type.stop-charge,
        .operation-type.stop-discharge {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        /* Info Row Styling */
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            font-weight: 500;
        }
        
        .info-row span {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Warning Message */
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            text-align: center;
        }
        
        .warning-message span {
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }

        .modal-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .modal-icon.success {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .modal-icon.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #00ff88;
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .modal-info-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-info-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-info-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-btn {
            flex: 0 0 auto;
            min-width: 120px;
            height: 44px;
            padding: 10px 25px;
            border: none;
            border-radius: 22px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #000;
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #00cc6a, #00aa55);
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }

        .modal-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateY(-1px);
        }
        
        /* Details Panel Styles */
        .details-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--color-bg-card);
            border-left: 1px solid var(--color-border);
            box-shadow: -4px 0 20px rgba(0,0,0,0.1);
            z-index: 1001;
            transition: right 0.3s ease;
            overflow-y: auto;
        }
        
        .details-panel.show {
            right: 0;
        }

        /* Operation Details Tabs Styles */
        .operation-details-tabs {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px;
        }

        .operation-tab.active {
            color: #00ff88 !important;
            border-bottom-color: #00ff88 !important;
        }

        .operation-tab:hover {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        .tab-content {
            color: rgba(255, 255, 255, 0.9);
        }

        .detail-section {
            margin-bottom: 20px;
        }

        .detail-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            flex: 1;
        }

        .detail-value {
            font-size: 13px;
            color: #fff;
            font-weight: 500;
            text-align: right;
        }

        .command-tag, .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .command-tag.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .command-tag.discharge {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }

        .status-tag.success {
            background: rgba(52, 199, 89, 0.2);
            color: #34c759;
        }

        .status-tag.warning {
            background: rgba(255, 149, 0, 0.2);
            color: #ff9500;
        }

        .status-tag.danger {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
        }

        .scrollable-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .scrollable-list::-webkit-scrollbar {
            width: 4px;
        }

        .scrollable-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .scrollable-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }
        
        .details-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--color-border);
            background: var(--color-bg);
        }
        
        .details-panel-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text);
        }
        
        .details-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .details-close-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }
        
        .details-content {
            padding: 20px;
        }
        
        .details-section {
            margin-bottom: 30px;
        }
        
        .details-section h4 {
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 8px;
        }
        
        .details-grid {
            display: grid;
            gap: 12px;
        }
        
        .details-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        
        .details-label {
            font-size: 14px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }
        
        .details-value {
            font-size: 14px;
            color: var(--color-text);
            font-weight: 600;
        }
        
        .status-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .status-item {
            text-align: center;
            padding: 15px;
            background: var(--color-bg);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        
        .status-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-weight: 500;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #fff;
        }

        /* Status Summary */
        .status-summary {
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .status-summary-title {
            font-size: 16px;
            font-weight: 600;
            color: #00ff88;
            margin-bottom: 15px;
            text-align: center;
        }

        .status-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .status-stat {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .status-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #00ff88;
            margin-bottom: 5px;
        }

        .status-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Map Controls */
        .map-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .map-stats {
            display: flex;
            gap: 30px;
        }

        .map-stat {
            text-align: center;
        }

        .map-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-bottom: 5px;
        }

        .map-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #00ff88;
        }

        /* Metrics Grid - New Layout */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .metrics-grid .metric-card {
            min-width: 0;
        }

        .metric-card {
            background: var(--color-bg-card, rgba(255,255,255,0.05));
            border-radius: var(--radius, 8px);
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            color: var(--color-text);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            text-align: left;
            line-height: 1;
        }

        .metric-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            text-align: left;
            line-height: 1;
        }

        .metric-change {
            font-size: 11px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 2px;
            text-align: left;
            line-height: 1;
            padding: 2px 0;
        }

        .metric-change.positive {
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        /* Market Analysis Section */
        .market-analysis-section {
            margin-bottom: 40px;
            padding: 20px;
            width: calc(66.67% - 30px);
            margin-left: auto;
            background: rgba(17, 17, 17, 0.7);
            backdrop-filter: blur(10px);
        }

        .price-stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .price-stat-card {
            background: rgba(25, 25, 25, 0.9);
            border-radius: 12px;
            padding: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .price-stat-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .price-stat-change {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .price-stat-icon {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 16px;
            opacity: 0.7;
        }

        /* Analytics Section */
        .analytics-section {
            width: 100%;
            display: flex;
            margin-bottom: 40px;
        }

        .analytics-chart {
            width: 66.6666%;
            min-height: 400px;
            padding: 30px;
            margin-left: auto;
        }

        .system-overview {
            padding: 30px;
        }

        .overview-stats {
            margin-bottom: 25px;
        }

        .overview-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .overview-item:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .overview-value {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
        }

        .status-active {
            color: #00ff88;
        }

        .performance-chart {
            height: 120px;
            margin: 20px 0;
        }

        .overview-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Date Selection Styles */
        .date-selection {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .date-inputs {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 15px;
        }

        .date-input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .date-input-group label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .date-input {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            font-size: 14px;
            min-width: 140px;
        }

        .date-input:focus {
            outline: none;
            border-color: rgba(0, 255, 136, 0.5);
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.1);
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
            opacity: 0.6;
        }

        .quick-select {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .quick-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-right: 10px;
        }

        .quick-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 6px 12px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }

        /* Data Cards */
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .data-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .data-icon {
            font-size: 28px;
            color: rgba(255, 255, 255, 0.8);
        }

        .data-content {
            flex: 1;
        }

        .data-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
        }

        .data-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .stats-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stats-label {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
        }

        .stats-value {
            font-size: 32px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 8px;
        }

        .stats-change {
            font-size: 16px;
            color: #00ff88;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-change.positive {
            color: #00ff88;
        }

        .stats-change.negative {
            color: #8A4AFF;
        }

        /* Remove excess bottom margin from last elements */
        .power-station-container > *:last-child {
            margin-bottom: 0;
        }

        .stats-grid > *:last-child {
            margin-bottom: 0;
        }

        /* Market and Map Container Styles */
        .market-container,
        .map-container {
            padding: 20px;
            min-height: auto;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        /* Market Stats Cards */
.market-stats {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
}

.market-stat-card {
    padding: 20px;
    display: flex;
    flex-direction: column;
}

.market-stat-label {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.market-stat-value {
    font-size: 28px;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
}

.market-stat-value .indicator {
    width: 4px;
    height: 24px;
    background: #4A9EFF;
    border-radius: 2px;
}

.market-stat-value .menu-dots {
    margin-left: auto;
    color: rgba(255, 255, 255, 0.4);
    cursor: pointer;
}

.market-stat-value .menu-dots:hover {
    color: rgba(255, 255, 255, 0.8);
}

.chart-container {
    padding: 20px;
    height: 605.2px; /* 与电站管理卡片高度保持一致 */
    display: flex;
    flex-direction: column;
        }
    </style>
    <style>
        .custom-card {
            height: 600px;
            background: rgba(255,255,255,0.03);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }
        .market-map-card {
            height: 605.2px;
            min-height: 605.2px;
            max-height: 605.2px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 24px rgba(0,255,136,0.04);
            margin-bottom: 0;
            display: flex;
            flex-direction: column;
        }
    </style>
    <style>
        /* 右侧内容可滚动 */
        .right-panel-content {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* 隐藏右侧滚动条但允许滚动 */
        .right-panel-scroll {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        .right-panel-scroll::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Webkit */
        }
    </style>
</head>
<body>
    <!-- Header Container for HeaderNav Component -->
    <div id="headerContainer"></div>

    <!-- Main Container -->
    <div class="container">
        <!-- Region Selection Layer -->
        <div class="region-selection-layer" style="margin-bottom: 30px; margin-top: -5px; padding: 15px; background: var(--color-bg-card); border-radius: 20px; border: 1px solid var(--color-border); box-shadow: var(--color-shadow);">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div class="region-selection-tabs" style="display: flex; gap: 8px;">
                <button class="region-select-tab active" data-region="NSW" onclick="selectMainRegion('NSW', this)" style="padding: 12px 24px; background: var(--color-primary); color: #000; border: none; border-radius: 50px; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; min-width: 100px;">
                    <span>NSW</span>
                    <span class="region-status charging" style="font-size: 12px; margin-left: 8px;">充</span>
                </button>
                <button class="region-select-tab" data-region="QLD" onclick="selectMainRegion('QLD', this)" style="padding: 12px 24px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; min-width: 100px;">
                    <span>QLD</span>
                    <span class="region-status discharging" style="font-size: 12px; margin-left: 8px;">放</span>
                </button>
                <button class="region-select-tab" data-region="VIC" onclick="selectMainRegion('VIC', this)" style="padding: 12px 24px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; min-width: 100px;">
                    <span>VIC</span>
                    <span class="region-status charging" style="font-size: 12px; margin-left: 8px;">充</span>
                </button>
                <button class="region-select-tab" data-region="SA" onclick="selectMainRegion('SA', this)" style="padding: 12px 24px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: space-between; min-width: 100px;">
                    <span>SA</span>
                    <span class="region-status discharging" style="font-size: 12px; margin-left: 8px;">放</span>
                </button>
                <button class="region-select-tab" data-region="TAS" onclick="selectMainRegion('TAS', this)" style="padding: 12px 24px; background: transparent; color: var(--color-text-secondary); border: 1px solid var(--color-border); border-radius: 50px; font-weight: 500; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; min-width: 100px;">
                    <span>TAS</span>
                </button>
                </div>
                <!-- 最高价格区域显示 -->
                <div style="display: flex; align-items: center; gap: 12px; padding: 0 20px;">
                    <span style="font-size: 14px; color: var(--color-text-secondary); font-weight: 500;">
                        <span data-i18n-key="highestPrice">最高价</span>
                    </span>
                    <span id="highestPriceRegionDisplay" style="font-size: 16px; font-weight: 700; color: #00ff88;">NSW</span>
                    <span style="font-size: 18px; font-weight: 700; color: #00ff88;">$<span id="highestPriceValue">170</span></span>
                </div>
            </div>
        </div>
        
        <!-- Top Stats Row -->
        <div class="stats-row">
            <!-- Power Station Management -->
            <div class="card power-station-container" style="height: 600px;">
                <!-- Module Header -->
                <div class="station-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="station-title">
                        <span data-i18n-key="station">电站管理</span>
                    </h3>
                    <span id="regionStatusText" style="font-size: 12px; color: #00ff88; font-weight: 500; padding: 4px 12px; background: rgba(255, 255, 255, 0.05); border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1);"></span>
                </div>
                
                                                 <!-- Main Price Circle with Side Info -->
                <div class="price-circle-layout">
                    <!-- Left Side - Today's Low -->
                    <div class="price-side-info left-side">
                        <div class="side-label"><span data-i18n-key="todayLow">今日最低</span></div>
                        <div class="side-price low-price" id="todayLow">$120.50</div>
                </div>
                
                    <!-- Center Circle -->
                    <div class="main-price-circle">
                        <div class="circle-background"></div>
                        <div class="circle-content">
                            <div class="current-price" id="currentPrice">$163</div>
                            <div class="price-unit" id="regionIndicator">NSW</div>
                    </div>
                    </div>
                    
                    <!-- Right Side - Today's High -->
                    <div class="price-side-info right-side">
                        <div class="side-label"><span data-i18n-key="todayHigh">今日最高</span></div>
                        <div class="side-price high-price" id="todayHigh">$185.75</div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="action-btn charge-btn" id="chargeBtn" onclick="handleCharge()"><span data-i18n-key="charge">充电</span></button>
                    <button class="action-btn discharge-btn" id="dischargeBtn" onclick="handleDischarge()"><span data-i18n-key="discharge">放电</span></button>
                </div>
                
                <!-- 优化后：一排3个小毛玻璃卡片 -->
                <div style="display:flex; gap:10px; margin: 6px 0; justify-content: space-between;">
                    <div class="card" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px 0 8px 0; border-radius:10px; background:var(--color-bg-card); border:1px solid var(--color-border); box-shadow:var(--color-shadow);">
                        <div class="stat-icon" style="font-size:14px; margin-bottom:0;">🏠</div>
                        <div class="stat-label" style="font-size:10px; color:#bfc6d1; font-weight:500; margin-bottom:0; text-align:center; width:100%;"><span data-i18n-key="availableHomes">可放电家庭</span></div>
                        <div class="stat-value" style="font-size:13px; font-weight:700; color:#fff;" id="totalFamiliesCard">120</div>
                    </div>
                    <div class="card" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px 0 8px 0; border-radius:10px; background:var(--color-bg-card); border:1px solid var(--color-border); box-shadow:var(--color-shadow);">
                        <div class="stat-icon" style="font-size:14px; margin-bottom:0;">⚡</div>
                        <div class="stat-label" style="font-size:10px; color:#bfc6d1; font-weight:500; margin-bottom:0; text-align:center; width:100%;"><span data-i18n-key="availablePower">可放电量</span></div>
                        <div class="stat-value" style="font-size:13px; font-weight:700; color:#fff;">65MWh</div>
                    </div>
                    <div class="card" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:10px 0 8px 0; border-radius:10px; background:var(--color-bg-card); border:1px solid var(--color-border); box-shadow:var(--color-shadow);">
                        <div class="stat-icon" style="font-size:14px; margin-bottom:0;">💰</div>
                        <div class="stat-label" style="font-size:10px; color:#bfc6d1; font-weight:500; margin-bottom:0;"><span data-i18n-key="estimatedProfit">预计获利</span></div>
                        <div class="stat-value" style="font-size:13px; font-weight:700; color:#fff;">$3500</div>
                    </div>
                </div>
                

                <!-- Today's Data Card -->
                <div style="margin-top:16px; margin-bottom:0;">
                    <div class="card" style="padding:12px 14px; border-radius:10px; background:var(--color-bg-card); border:1px solid var(--color-border); box-shadow:var(--color-shadow); overflow:hidden;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                            <h4 style="margin:0; font-size:13px; font-weight:600; color:#fff; display:flex; align-items:center; gap:4px;">
                                <span style="font-size:14px;">📊</span>
                                <span data-i18n-key="todayData">今日数据</span>
                            </h4>
                            <span style="font-size:9px; color:rgba(255,255,255,0.4); background:rgba(255,255,255,0.05); padding:1px 6px; border-radius:8px;" data-i18n-key="realtime">实时</span>
                        </div>
                        <div style="display:flex; align-items:center; justify-content:space-around;">
                            <!-- 已放电家庭 -->
                            <div style="flex:1; text-align:center; padding:10px 0;">
                                <div style="font-size:16px; margin-bottom:2px;">🏠</div>
                                <div style="font-size:11px; color:#bfc6d1; font-weight:500; margin-bottom:2px;" data-i18n-key="dischargedFamilies">已放电家庭</div>
                                <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:2px;">235</div>
                                <div style="display:flex; align-items:center; justify-content:center; gap:1px;">
                                    <span style="font-size:9px; color:#00ff88;">↑</span>
                                    <span style="font-size:8px; color:rgba(255,255,255,0.5);" data-i18n-key="comparedToYesterday">比昨日</span>
                                    <span style="font-size:9px; font-weight:600; color:#00ff88;">+21%</span>
                                </div>
                            </div>
                            <!-- 分割线 -->
                            <div style="width:1px; height:50px; background:rgba(255,255,255,0.1);"></div>
                            <!-- 已放电量 -->
                            <div style="flex:1; text-align:center; padding:10px 0;">
                                <div style="font-size:16px; margin-bottom:2px;">⚡</div>
                                <div style="font-size:11px; color:#bfc6d1; font-weight:500; margin-bottom:2px;">
                                    <span data-i18n-key="discharged">已放电量</span>
                                </div>
                                <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:2px;">23547kWh</div>
                                <div style="display:flex; align-items:center; justify-content:center; gap:1px;">
                                    <span style="font-size:9px; color:#00ff88;">↑</span>
                                    <span style="font-size:8px; color:rgba(255,255,255,0.5);" data-i18n-key="comparedToYesterday">比昨日</span>
                                    <span style="font-size:9px; font-weight:600; color:#00ff88;">+21%</span>
                                </div>
                            </div>
                            <!-- 分割线 -->
                            <div style="width:1px; height:50px; background:rgba(255,255,255,0.1);"></div>
                            <!-- 已获利 -->
                            <div style="flex:1; text-align:center; padding:10px 0;">
                                <div style="font-size:16px; margin-bottom:2px;">💰</div>
                                <div style="font-size:11px; color:#bfc6d1; font-weight:500; margin-bottom:2px;">
                                    <span data-i18n-key="actualProfit">已获利($)</span>
                                </div>
                                <div style="font-size:14px; font-weight:700; color:#fff; margin-bottom:2px;">$23547</div>
                                <div style="display:flex; align-items:center; justify-content:center; gap:1px;">
                                    <span style="font-size:9px; color:#00ff88;">↑</span>
                                    <span style="font-size:8px; color:rgba(255,255,255,0.5);" data-i18n-key="comparedToYesterday">比昨日</span>
                                    <span style="font-size:9px; font-weight:600; color:#00ff88;">+21%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- 右侧卡片区 -->
            <div style="display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden;">
                <div class="right-panel-scroll" style="flex:1; overflow-y:auto; height:100%; padding-right:10px; padding-bottom: 20px;">
                    <!-- 自定义卡片 -->
                    <div class="custom-card" style="height: 600px;">
                        <div style="padding: 15px; position: relative; height: 100%; display: flex; flex-direction: column; overflow: visible;">
                            <!-- Tab Controls -->
                            <div class="panel-tabs">
                                <button class="panel-tab active" onclick="switchPanel('market', this)"><span data-i18n-key="market">行情</span></button>
                                <button class="panel-tab" onclick="switchPanel('map', this)"><span data-i18n-key="map">地图</span></button>
                            </div>

                            <!-- Market Panel -->
                            <div id="marketPanel" class="panel-content active">
                                <!-- Price Cards -->
                                <div class="market-section">
                                    <div class="price-cards" style="display: flex; gap: 20px;">
                                        <!-- Combined card for first 4 items -->
                                        <div class="price-card" style="flex: 1; display: flex; flex-direction: column; padding: 0; overflow: hidden; min-height: 120px;">
                                            <div style="display: flex; height: 100%;">
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('price')">
                                                    <div class="price-card-label" data-i18n-key="currentSpotPrice" style="font-size: 13px; font-weight: 500;">CURRENT SPOT PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh)</div>
                                                    <div class="price-card-value" id="spotPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('demand')">
                                                    <div class="price-card-label" data-i18n-key="currentDemand" style="font-size: 13px; font-weight: 500;">CURRENT DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW)</div>
                                                    <div class="price-card-value" id="currentDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,344</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecast')">
                                                    <div class="price-card-label" data-i18n-key="forecastPrice" style="font-size: 13px; font-weight: 500;">FORECAST PRICE</div>
                                                    <div class="price-card-label" style="font-size: 11px;">($/MWh - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastPrice" style="font-size: 28px; font-weight: 700; margin-top: 8px;">$162.73</div>
                                                </div>
                                                <div style="width: 1px; background: rgba(255, 255, 255, 0.1); margin: 16px 0;"></div>
                                                <div style="flex: 1; padding: 20px 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;" onclick="updateMainChart('forecastDemand')">
                                                    <div class="price-card-label" data-i18n-key="forecastDemand" style="font-size: 13px; font-weight: 500;">FORECAST DEMAND</div>
                                                    <div class="price-card-label" style="font-size: 11px;">(MW - NEXT 30MIN)</div>
                                                    <div class="price-card-value" id="forecastDemand" style="font-size: 28px; font-weight: 700; margin-top: 8px;">8,202</div>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- Demand vs Generation card -->
                                        <div class="price-card demand-gen-card" style="flex: 0 0 20%; padding: 16px 12px; display: flex; flex-direction: column; min-height: 120px;">
                                            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                                                <!-- Demand Row -->
                                                <div style="margin-bottom: 16px;">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n-key="demand">需求</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">9,692 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 3px; overflow: hidden;">
                                                        <div style="width: 100%; height: 100%; background: rgba(0, 255, 136, 0.5); border-radius: 3px; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">👤</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Generation Row -->
                                                <div>
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                                        <span style="font-size: 12px; color: rgba(255, 255, 255, 0.7);" data-i18n-key="generation">发电</span>
                                                        <span style="font-size: 15px; font-weight: 700; color: #fff;">8,319 <span style="font-size: 11px; font-weight: 500; color: rgba(255, 255, 255, 0.7);">kWh</span></span>
                                                    </div>
                                                    <div style="height: 16px; background: transparent; border-radius: 3px; overflow: hidden; position: relative;">
                                                        <!-- 闪电发电部分 60% -->
                                                        <div style="width: 60%; height: 100%; background: rgba(0, 170, 255, 0.5); position: absolute; left: 0; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">⚡</span>
                                                        </div>
                                                        <!-- 风力发电部分 20% -->
                                                        <div style="width: 20%; height: 100%; background: rgba(64, 224, 208, 0.5); position: absolute; left: 60%; top: 0; display: flex; align-items: center; justify-content: center;">
                                                            <span style="font-size: 12px;">💨</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Market Chart -->
                                <div id="marketChart" style="height: 400px; width: 100%; margin-top: 70px; margin-bottom: -20px;"></div>

                                <!-- Status Bar -->
                                <div style="margin-top: -10px; display: flex; justify-content: space-between; align-items: center;"></div>
                            </div>

                            <!-- Map Panel -->
                            <div id="mapPanel" class="panel-content">
                                <div id="australiaMap" style="height: 400px; max-height: 400px;"></div>
                                <div class="map-controls">
                                    <div class="map-stats">
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n-key="totalDevices">总设备数</span>
                                            <span class="map-stat-value" id="totalDevices">500</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n-key="activated">已下发</span>
                                            <span class="map-stat-value" id="activeDevices">0</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n-key="progress">执行进度</span>
                                            <span class="map-stat-value" id="progressPercent">0%</span>
                                        </div>
                                        <div class="map-stat">
                                            <span class="map-stat-label" data-i18n-key="currentOperation">当前操作</span>
                                            <span class="map-stat-value" id="currentOperationText" data-i18n-key="none">无</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 卡片2 -->
                <!-- 新增 卡片2 -->
                <div class="glass info-summary-card" style="height:140px; min-height:140px; max-height:140px; background:rgba(255,255,255,0.05); border-radius:16px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 4px 24px rgba(0,255,136,0.04); margin-top:15px; display:flex; align-items:center; justify-content:center; padding:0 20px;">
                    <div style="display:flex; width:100%; height:100%; align-items:center; justify-content:space-between;">
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div style="font-size:18px; margin-bottom:4px;">🏠</div>
                            <div style="font-size:13px; color:#bfc6d1; font-weight:500; margin-bottom:3px;" data-i18n-key="family">家庭</div>
                            <div style="font-size:18px; font-weight:700; color:#fff;" id="familySummaryCard">460</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div style="font-size:18px; margin-bottom:4px;">🔋</div>
                            <div style="font-size:13px; color:#bfc6d1; font-weight:500; margin-bottom:3px;" data-i18n-key="installedCapacity">装机量</div>
                            <div style="font-size:18px; font-weight:700; color:#fff;">235MWh</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div style="font-size:18px; margin-bottom:4px;">⚡</div>
                            <div style="font-size:13px; color:#bfc6d1; font-weight:500; margin-bottom:3px;" data-i18n-key="totalDischarge">累计放电</div>
                            <div style="font-size:18px; font-weight:700; color:#fff;">234kwh</div>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div style="font-size:18px; margin-bottom:4px;">💰</div>
                            <div style="font-size:13px; color:#bfc6d1; font-weight:500; margin-bottom:3px;" data-i18n-key="totalProfit">累计获利</div>
                            <div style="font-size:18px; font-weight:700; color:#fff;">$12435</div>
                        </div>
                    </div>
                </div>
                <!-- Discharge & Profit Chart 放电与收益 -->
                <div class="card" style="height:422px; min-height:422px; max-height:422px; margin-top:20px; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:24px;">
                    <div class="chart-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <div class="chart-title" data-i18n-key="profit.charts.dischargeAndProfit" style="font-size:18px; font-weight:500; color:var(--color-text);">放电与获利</div>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <!-- Time Period Dropdown (on left) -->
                            <select id="discharge-period-select" class="period-dropdown" onchange="handleDischargePeriodChange()" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; padding:6px 12px; color:#fff; font-size:13px; min-width:80px; cursor:pointer; outline:none;">
                                <option value="day" data-i18n="day">日</option>
                                <option value="month" data-i18n="month">月</option>
                                <option value="year" data-i18n="year">年</option>
                                <option value="cumulative" data-i18n="cumulative">累计</option>
                            </select>
                            <!-- Date Picker (shown on right when not cumulative) -->
                            <div id="discharge-date-picker" style="display:flex; align-items:center;">
                                <input type="date" id="discharge-date-input" class="date-input" style="background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); border-radius:8px; padding:6px 12px; color:#fff; font-size:13px; min-width:140px;">
                            </div>
                        </div>
                    </div>
                    <div id="powerRevenueChart" style="width:100%; height:calc(100% - 70px); min-height:0;"></div>
                </div>
                <!-- 新 卡片4 -->
                <div class="glass" style="height:620px; min-height:620px; max-height:620px; background:rgba(255,255,255,0.05); border-radius:20px; border:1px solid rgba(255,255,255,0.1); box-shadow:0 4px 24px rgba(0,255,136,0.04); margin-top:20px; display:flex; flex-direction:column; align-items:stretch; justify-content:flex-start; padding:0;">
                    <!-- 顶部标题 -->
                    <div style="display:flex; align-items:center; justify-content:space-between; padding:20px 32px 0 32px;">
                        <div style="font-size:18px; font-weight:700; color:#fff; letter-spacing:1px;" data-i18n-key="cumulativePrice">累计价格</div>
                    </div>
                    <!-- 关键数字区（完全参考custom-card的price-cards横向卡片组） -->
                    <div style="display:flex; gap:20px; margin:32px 32px 0 32px;">
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n-key="currentCumulativePrice">当前累计价格</span></div>
                            <div class="price-card-value" style="font-size:18px; font-weight:600; color:#fff;">$746,630</div>
                        </div>
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n-key="forecastCumulativePrice5min">预测累计价格(5min)</span></div>
                            <div class="price-card-value" style="font-size:18px; font-weight:600; color:#fff;">$746,622</div>
                        </div>
                        <div class="price-card" style="flex:1; min-width:0; padding:12px 0 8px 0; background:rgba(255,255,255,0.10); border-radius:12px; border:1px solid rgba(255,255,255,0.10); display:flex; flex-direction:column; align-items:center; justify-content:center;">
                            <div class="price-card-label" style="font-size:11px; color:rgba(255,255,255,0.6); margin-bottom:6px; line-height:1.2; height:2.4em; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;"><span data-i18n-key="thresholdStatus">阈值状态</span></div>
                            <div class="price-card-value" data-threshold-status="not_exceeded" style="font-size:18px; font-weight:600; color:#fff;"><span data-i18n-key="notExceeded">未超阈</span></div>
                        </div>
                    </div>
                    <!-- 图表区（复制行情marketChart结构和样式） -->
                    <div style="flex:1; display:flex; flex-direction:column; justify-content:flex-end; align-items:stretch; padding:0 32px 32px 32px; margin-top:24px;">
                        <div id="cumulativeMarketChart" style="flex:1; min-height:0; width:100%; margin-top:20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics Section -->
        

        <!-- System Overview -->
        <div class="glass system-overview" style="display:none;">
            <div class="chart-header">
                <h3 class="chart-title" data-i18n-key="systemOverview">系统概览</h3>
            </div>
            
            <div class="overview-stats">
                <div class="overview-item">
                    <div class="overview-label" data-i18n-key="totalCapacity">总容量</div>
                    <div class="overview-value">1,200 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n-key="onlineDevices">在线设备</div>
                    <div class="overview-value" id="onlineDevices">196/200</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label" data-i18n-key="networkStatus">网络状态</div>
                    <div class="overview-value status-active" data-i18n-key="normal">正常</div>
                </div>
            </div>

            <div class="performance-chart" id="systemPerformance"></div>
            
            <div class="overview-footer">
                <div class="overview-item">
                    <div class="overview-label">累计放电</div>
                    <div class="overview-value" id="totalDischargeOverview">445.2 MWh</div>
                </div>
                <div class="overview-item">
                    <div class="overview-label">累计收益</div>
                    <div class="overview-value" id="totalRevenueOverview">$186,430</div>
                </div>
            </div>

            <!-- Stats Overview Grid -->
            <div class="metrics-grid">
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">🏠</div>
                    <div class="stat-overview-label" data-i18n-key="family">家庭</div>
                    <div class="stat-overview-value" id="totalHomes">235</div>
                </div>
                
                <div class="stat-overview-card">
                    <div class="stat-overview-icon">🔋</div>
                    <div class="stat-overview-label" data-i18n-key="installedCapacity">装机量</div>
                    <div class="stat-overview-value" id="installedCapacity">235MWh</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">⚡</div>
                    <div class="stat-overview-label">累计放电</div>
                    <div class="stat-overview-value" id="totalDischarge">234kwh</div>
                </div>

                <div class="stat-overview-card">
                    <div class="stat-overview-icon">💰</div>
                    <div class="stat-overview-label">累计获利</div>
                    <div class="stat-overview-value" id="totalProfit">$12,435</div>
                </div>
            </div>
            
            <!-- Analysis Page Modules: Discharge Statistics & Price Statistics -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 32px;">
                <!-- Discharge Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n-key="dischargeStatistics">Discharge Statistics</span>
                    </h3>
                    
                    <!-- Top Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n-key="actualDischargeAmount">Actual Discharge Amount</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">18.50</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">kWh</span>
                                <span style="color: #00ff88; font-size: 12px; font-weight: 600;">8.0%</span>
                            </div>
                        </div>
                        <div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 4px;">
                                <span data-i18n-key="actualDischargeEfficiency">Actual Discharge Efficiency</span>
                            </div>
                            <div style="display: flex; align-items: baseline; gap: 8px;">
                                <span style="color: #fff; font-size: 28px; font-weight: 700;">89.0</span>
                                <span style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">%</span>
                                <span style="color: #00ff88; font-size: 12px; font-weight: 600;">2.0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bottom Stats Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.2); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: #00ff88; font-size: 32px; font-weight: 700; margin-bottom: 8px;">3</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n-key="usersExceedingTarget">Users Exceeding Target</span>
                            </div>
                        </div>
                        <div style="background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.2); border-radius: 12px; padding: 20px; text-align: center;">
                            <div style="color: #ff6b6b; font-size: 32px; font-weight: 700; margin-bottom: 8px;">17</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n-key="usersNotExceedingTarget">Users Not Exceeding Target</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Price Statistics Module -->
                <div class="card" style="padding: 24px; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: #fff; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">
                        <span data-i18n-key="priceStatistics">Price Statistics</span>
                    </h3>
                    
                    <!-- Top Prices Row -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$185</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n-key="todaysPrice">Today's Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +5.2%
                            </div>
                        </div>
                        <div>
                            <div style="color: #fff; font-size: 28px; font-weight: 700; margin-bottom: 4px;">$152</div>
                            <div style="color: rgba(255, 255, 255, 0.6); font-size: 13px; margin-bottom: 8px;">
                                <span data-i18n-key="avgDischargePrice">Avg Discharge Price</span>
                            </div>
                            <div style="background: rgba(0, 255, 136, 0.2); color: #00ff88; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; display: inline-block;">
                                +3.8%
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Details Section -->
                    <div style="background: rgba(255, 255, 255, 0.05); border-radius: 12px; padding: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="background: #00ff88; color: #000; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600;">
                                <span data-i18n-key="sellPrice">Sell Price</span>
                            </span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n-key="todaysLowest">Today's Lowest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$120</span>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n-key="todaysHighest">Today's Highest</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$220</span>
                        </div>
                        
                        <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 8px;">
                            <span style="color: rgba(255, 255, 255, 0.6); font-size: 13px;">
                                <span data-i18n-key="sellPrice">Sell Price</span>
                            </span>
                            <span style="color: #fff; font-size: 14px; font-weight: 600; float: right;">$185</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for operation verification -->
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
        <div class="modal-content" style="background: linear-gradient(145deg, #1e1e2e 0%, #252535 100%); border: none; padding: 0; overflow: hidden; width: 480px; max-width: 90%; border-radius: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8), 0 0 1px rgba(255, 255, 255, 0.1);">
            <div class="modal-header" style="padding: 32px 36px 28px; border-bottom: 1px solid rgba(255, 255, 255, 0.08); display: flex; align-items: center; justify-content: flex-start; background: rgba(255, 255, 255, 0.02);">
                <div class="modal-icon" style="width: 56px; height: 56px; background: linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 4px 12px rgba(0, 255, 136, 0.15);">
                    <span id="confirmIcon" style="font-size: 28px;">⚡</span>
                </div>
                <h3 class="modal-title" id="confirmTitle" style="margin: 0; font-size: 24px; font-weight: 700; color: #fff; letter-spacing: 0.5px;">确认充电操作</h3>
            </div>
            
            <div class="modal-body" style="padding: 36px;">
                <p id="confirmMessage" style="font-size: 16px; color: rgba(255, 255, 255, 0.7); margin: 0 0 32px 0; font-weight: 400; line-height: 1.6;">您确定要执行充电操作吗？</p>
                
                <div class="modal-info-grid" id="confirmInfoGrid" style="display: flex; flex-direction: column; gap: 0; margin-bottom: 32px;">
                    <div style="display: flex; gap: 20px;">
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n-key="operationType">操作类型</div>
                            <div class="modal-info-value" id="confirmOperationType" style="color: #00ff88; font-size: 20px; font-weight: 600; letter-spacing: 0.5px;">充电</div>
                        </div>
                        <div class="modal-info-item" style="flex: 1; background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s;">
                            <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;" data-i18n-key="targetDevices">影响设备</div>
                            <div class="modal-info-value" id="confirmTargetDevices" style="color: #fff; font-size: 20px; font-weight: 600;">500个</div>
                        </div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n-key="estimatedPower">预计功率</div>
                        <div class="modal-info-value" id="confirmEstimatedPower">3.0MW</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n-key="currentPrice">当前电价</div>
                        <div class="modal-info-value" id="confirmCurrentPrice">$85/MWh</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n-key="estimatedDuration">预计时间</div>
                        <div class="modal-info-value" id="confirmDuration">15-30分钟</div>
                    </div>
                    <div class="modal-info-item" style="display: none;">
                        <div class="modal-info-label" data-i18n-key="estimatedProfit">预计获利</div>
                        <div class="modal-info-value" id="confirmCostBenefit">+$178</div>
                    </div>
                </div>
                
                <div class="warning-notice" style="padding: 20px; background: linear-gradient(145deg, rgba(255, 152, 0, 0.08), rgba(255, 152, 0, 0.04)); border: 1px solid rgba(255, 152, 0, 0.15); border-radius: 16px; backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: flex-start; gap: 16px;">
                        <div style="width: 32px; height: 32px; background: rgba(255, 152, 0, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <span style="font-size: 18px;">⚠️</span>
                        </div>
                        <span id="warningText" style="color: rgba(255, 255, 255, 0.8); font-size: 14px; line-height: 1.8; flex: 1;">将开始对所有连接设备进行充电操作，此过程将消耗电网电力。</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer" style="padding: 28px 36px 32px; background: rgba(0, 0, 0, 0.2); border-top: 1px solid rgba(255, 255, 255, 0.08); display: flex; justify-content: flex-end; gap: 16px;">
                <button class="modal-btn modal-cancel-btn" onclick="closeConfirmationModal()" style="background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.8); border: 1px solid rgba(255, 255, 255, 0.1); padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.3s; backdrop-filter: blur(10px); letter-spacing: 0.5px;" onmouseover="this.style.background='rgba(255, 255, 255, 0.12)'; this.style.borderColor='rgba(255, 255, 255, 0.2)'" onmouseout="this.style.background='rgba(255, 255, 255, 0.08)'; this.style.borderColor='rgba(255, 255, 255, 0.1)'" data-i18n-key="cancel">取消</button>
                <button class="modal-btn modal-confirm-btn" onclick="executeConfirmedOperation()" id="confirmExecuteBtn" style="background: linear-gradient(135deg, #00ff88, #00dd77); color: #000; padding: 14px 36px; border-radius: 999px; font-size: 15px; font-weight: 700; cursor: pointer; transition: all 0.3s; border: none; box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3); letter-spacing: 0.5px;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(0, 255, 136, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 16px rgba(0, 255, 136, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'">确认充电</button>
            </div>
        </div>
    </div>

    <!-- Modal for operation result -->
    <div id="operationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            
            <div class="modal-header" style="text-align: left; justify-content: flex-start;">
                <div class="modal-icon success">
                    <span id="modalIcon">✓</span>
                </div>
                <div style="margin-left: 12px;">
                    <h3 class="modal-title" id="modalTitle" data-i18n-key="commandSentSuccess">指令下发成功</h3>
                </div>
            </div>
            
            <div class="modal-body">
                <p id="modalMessage" data-i18n-key="systemExecuting">系统正在执行您的操作指令...</p>
                
                <div class="modal-info-grid">
                    <div class="modal-info-item">
                        <div class="modal-info-label" data-i18n-key="operationType">操作类型</div>
                        <div class="modal-info-value" id="operationType">充电</div>
                    </div>
                    <div class="modal-info-item">
                        <div class="modal-info-label" data-i18n-key="targetDevices">影响设备</div>
                        <div class="modal-info-value" id="targetDevices">500个</div>
                    </div>
                </div>
                
                <div class="status-summary" id="statusSummary" style="display: none;">
                    <div class="status-summary-title" data-i18n-key="deviceResponseStatistics">设备响应统计</div>
                    <div class="status-stats">
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesDispatched">500</div>
                            <div class="status-stat-label" data-i18n-key="commandsSent">指令下发</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesReceived">477</div>
                            <div class="status-stat-label" data-i18n-key="commandsReceived">指令接收</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="devicesActivated">445</div>
                            <div class="status-stat-label" data-i18n-key="devicesActivated">成功激活</div>
                        </div>
                        <div class="status-stat">
                            <div class="status-stat-value" id="successRate">89%</div>
                            <div class="status-stat-label" data-i18n-key="successRate">成功率</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="openOperationDrawer()" style="width: 100%;">
                    <span data-i18n-key="viewDetails">查看详情</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Operation Details Panel -->
    <div class="details-panel" id="operationDetailsPanel" style="display: none;">
        <div class="details-panel-header">
            <h3 data-i18n-key="operationDetails">Operation Details</h3>
            <button class="details-close-btn" onclick="closeDetailsPanel()">×</button>
        </div>
        <div class="details-content">
            <div class="details-section">
                <h4 data-i18n-key="basicInfo">Basic Information</h4>
                <div class="details-grid">
                    <div class="details-item">
                        <span class="details-label" data-i18n-key="operationType">Operation Type:</span>
                        <span class="details-value" id="detailsOperationType">Charge</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n-key="targetDevices">Target Devices:</span>
                        <span class="details-value" id="detailsTargetDevices">500 devices</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n-key="estimatedProfit">Estimated Profit:</span>
                        <span class="details-value" id="detailsEstimatedProfit">+$340</span>
                    </div>
                    <div class="details-item">
                        <span class="details-label" data-i18n-key="operationTime">Operation Time:</span>
                        <span class="details-value" id="detailsOperationTime">2024-06-26 14:30:00</span>
                    </div>
                </div>
            </div>
            
            <div class="details-section">
                <h4 data-i18n-key="executionStatus">Execution Status</h4>
                <div class="status-overview">
                    <div class="status-item">
                        <div class="status-number" id="detailsDispatched">500</div>
                        <div class="status-label" data-i18n-key="devicesDispatched">Commands Sent</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" id="detailsReceived">477</div>
                        <div class="status-label" data-i18n-key="devicesReceived">Commands Received</div>
                    </div>
                    <div class="status-item">
                        <div class="status-number" id="detailsActivated">445</div>
                        <div class="status-label" data-i18n-key="devicesActivated">Devices Activated</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let marketChart, powerChart, performanceChart, mapChart, cumulativeMarketChart;
        let powerChartTimeSelector, currentOperation = null;
        let activatedDevices = 0, totalDevices = 500, chartUpdateInterval;
        let pendingOperation = null, previousPanel = null;
        
        // Performance utilities (inline to avoid CORS issues)
        function throttle(func, limit) {
            let inThrottle;
            let lastFunc;
            let lastRan;
            
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    lastRan = Date.now();
                    inThrottle = true;
                } else {
                    clearTimeout(lastFunc);
                    lastFunc = setTimeout(() => {
                        if ((Date.now() - lastRan) >= limit) {
                            func.apply(this, args);
                            lastRan = Date.now();
                        }
                    }, Math.max(limit - (Date.now() - lastRan), 0));
                }
                
                setTimeout(() => {
                    inThrottle = false;
                }, limit);
            };
        }

        // Data cache class
        class DataCache {
            constructor(ttl = 5 * 60 * 1000, maxSize = 100) {
                this.cache = new Map();
                this.ttl = ttl;
                this.maxSize = maxSize;
            }
            
            set(key, data) {
                if (this.cache.size >= this.maxSize) {
                    const firstKey = this.cache.keys().next().value;
                    this.cache.delete(firstKey);
                }
                
                this.cache.set(key, {
                    data,
                    timestamp: Date.now()
                });
            }
            
            get(key) {
                const cached = this.cache.get(key);
                if (!cached) return null;
                
                if (Date.now() - cached.timestamp > this.ttl) {
                    this.cache.delete(key);
                    return null;
                }
                
                return cached.data;
            }
            
            clear() {
                this.cache.clear();
            }
        }

        // Chart manager class
        class ChartManager {
            constructor() {
                this.charts = new Map();
            }
            
            register(name, chart) {
                if (this.charts.has(name)) {
                    this.dispose(name);
                }
                this.charts.set(name, chart);
            }
            
            dispose(name) {
                const chart = this.charts.get(name);
                if (chart && typeof chart.dispose === 'function') {
                    chart.dispose();
                }
                this.charts.delete(name);
            }
        }
        
        // Create instances
        const dataCache = new DataCache();
        const chartManager = new ChartManager();
        
        // Initialize additional variables 
        let currentRegion = 'NSW';
        let selectedMainRegion = 'NSW'; // 新增：主地区选择
        let chartType = 'both';
        let autoSwitchInterval;
        let mapAnimationInterval;
        let deviceLocations = []; // Fixed device locations


        // Initialize all charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting initialization...');
            
            // Use setTimeout to ensure all dependencies are loaded
            setTimeout(() => {
                try {
                    // Initialize HeaderNav component FIRST
                    console.log('Initializing HeaderNav...');
                    if (typeof HeaderNav === 'undefined') {
                        console.error('HeaderNav class not found!');
                        return;
                    }
                    
                    const headerNav = new HeaderNav({
                        currentPage: 'home',
                        containerId: 'headerContainer'
                    });
                    console.log('HeaderNav initialized successfully');
                    // HeaderNav initialized successfully
                    
                    // 启动z-index监控器
                    startDrawerZIndexMonitor();
                    
                    // Initialize i18n system if not already initialized by HeaderNav
                    if (!window.i18n && typeof I18n !== 'undefined') {
                        window.i18n = new I18n({
                            defaultLanguage: 'zh',
                            containerId: 'languageSelector'
                        });
                        console.log('i18n system initialized for homepage');
                    }
                    
                    // Add language change listener for dynamic content
                    if (window.i18n) {
                        window.i18n.addObserver((newLanguage, oldLanguage) => {
                            updateDynamicContent(newLanguage);
                            
                            // Refresh all charts with new language
                            if (marketChart) {
                                updateMarketChart();
                            }
                            if (powerChart && powerChartTimeSelector) {
                                const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                                const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                                updatePowerChartWithData(labels, power, revenue, currentPeriod);
                            }
                            if (mapChart) {
                                updateMapStatistics();
                            }
                            // Refresh cumulative chart
                            const activeRegionBtn = document.querySelector('.region-switch-glow .time-tab.active');
                            if (activeRegionBtn) {
                                const region = activeRegionBtn.textContent.trim();
                                renderCumulativeChart(region);
                            }
                        });
                    }
                } catch (error) {
                    console.error('HeaderNav failed to initialize:', error);
                }
            }, 10);
            
            // Add keyboard and click listeners for modal
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const confirmModal = document.getElementById('confirmationModal');
                    if (confirmModal && confirmModal.style.display === 'block') {
                        closeConfirmationModal();
                    }
                }
                
                // 添加强制刷新快捷键 Ctrl+Shift+R
                if (event.ctrlKey && event.shiftKey && event.key === 'R') {
                    event.preventDefault();
                    console.log('Force refresh triggered');
                    window.location.reload(true);
                }
                
                // 添加F5强制刷新
                if (event.key === 'F5') {
                    event.preventDefault();
                    console.log('F5 force refresh triggered');
                    window.location.reload(true);
                }
            });
            
            // Add click outside to close functionality
            const confirmationModal = document.getElementById('confirmationModal');
            if (confirmationModal) {
                confirmationModal.addEventListener('click', function(event) {
                    if (event.target === confirmationModal) {
                        closeConfirmationModal();
                    }
                });
            }
            
            try {
                // Generate fixed device locations once (exactly 500 devices)
                deviceLocations = generateDeviceLocations();
                
                // 初始化地区状态指示器
                updateRegionStatusIndicators();
                
                // 设置默认选中NSW地区
                const defaultRegion = document.querySelector('.region-select-tab[data-region="NSW"]');
                if (defaultRegion) {
                    selectMainRegion('NSW', defaultRegion);
                }
                
                // 定期更新地区状态（模拟实时数据）
                setInterval(updateRegionStatusIndicators, 30000); // 每30秒更新一次
                
                // Initialize UI with correct device count
                document.getElementById('totalDevices').textContent = '500';
                document.getElementById('activeDevices').textContent = '0';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('currentOperationText').textContent = '无';
                
                console.log('Starting chart initialization...');
                console.log('ECharts available:', typeof echarts !== 'undefined');
                
                // Check if chart containers exist
                const containers = ['powerRevenueChart', 'systemPerformance', 'marketChart', 'australiaMap'];
                containers.forEach(id => {
                    const element = document.getElementById(id);
                    console.log(`Container ${id}:`, element ? 'Found' : 'NOT FOUND');
                    if (element) {
                        console.log(`Container ${id} dimensions:`, element.offsetWidth, 'x', element.offsetHeight);
                    }
                });
                
                console.log('Initializing charts...');
                
                try {
                    initPowerRevenueChart();
                    console.log('Power chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize power chart:', e);
                }
                
                try {
                    initSystemPerformanceChart();
                    console.log('Performance chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize performance chart:', e);
                }
                
                try {
                    initMarketChart();
                    console.log('Market chart initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize market chart:', e);
                }
                
                try {
                    initMap();
                    console.log('Map initialized successfully');
                } catch (e) {
                    console.error('Failed to initialize map:', e);
                }
                
                console.log('All charts initialization attempted');
                
                // Verify chart objects created
                setTimeout(() => {
                    console.log('Chart objects status:');
                    console.log('marketChart:', !!marketChart);
                    console.log('mapChart:', !!mapChart);
                    console.log('powerChart:', !!powerChart);
                    console.log('performanceChart:', !!performanceChart);
                    
                    // Force resize all charts after initialization
                    if (marketChart) {
                        console.log('Force resizing marketChart');
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                    if (mapChart) {
                        console.log('Force resizing mapChart');
                        if (mapChart && typeof mapChart.resize === 'function') {
                            mapChart.resize();
                        }
                    }
                    if (powerChart) {
                        if (powerChart && typeof powerChart.resize === 'function') {
                            powerChart.resize();
                        }
                    }
                    if (performanceChart) {
                        if (performanceChart && typeof performanceChart.resize === 'function') {
                            performanceChart.resize();
                        }
                    }
                }, 300);
                
                // Initialize time selector after charts are ready
                setTimeout(() => {
                    try {
                        initPowerChartTimeSelector();
                    } catch (error) {
                        console.error('TimeSelector initialization failed:', error);
                    }
                }, 100);
                
                // Initialize with NSW region
                updatePriceCircleRegion('NSW');
                
                // Initialize cumulative chart
                renderCumulativeChart('NSW');
                
                // Force apply button styles
                forceButtonStyles();
                // Apply styles periodically to ensure they stick  
                setInterval(forceButtonStyles, 3000);
                
                // Add device response modal click handlers
                setTimeout(() => {
                    const statusSummary = document.querySelector('.status-summary');
                    if (statusSummary) {
                        statusSummary.style.cursor = 'pointer';
                        statusSummary.addEventListener('click', showDeviceResponseModal);
                    }
                    
                    // Also check for any analytics cards with device response text
                    const allCards = document.querySelectorAll('.card, .metric-card, .stat-card');
                    allCards.forEach(card => {
                        const text = card.textContent;
                        if (text && (text.includes('设备响应') || text.includes('Device Response'))) {
                            card.style.cursor = 'pointer';
                            card.addEventListener('click', showDeviceResponseModal);
                        }
                    });
                }, 1000);
                
                // Initialize highest price region display
                updateHighestPriceRegion();
                
                // Initialize other station data
                document.getElementById('availableHomes').textContent = '235';
                document.getElementById('availablePower').textContent = '23547kWh';
                document.getElementById('estimatedProfit').textContent = '$12435';
                
                // Start real-time updates
                setInterval(updateRealtimeData, 5000);
            } catch (error) {
                console.error('Chart initialization failed:', error);
            }
            
            // Start auto switch if enabled
            const autoSwitchElement = document.getElementById('autoSwitch');
            if (autoSwitchElement && autoSwitchElement.checked) {
                startAutoSwitch();
            }
            
            // Add i18n observer to update charts when language changes
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Update power chart
                    if (powerChart) {
                        const dischargeLabel = window.i18n.getText('discharge');
                        const revenueLabel = window.i18n.getText('totalRevenue');
                        powerChart.setOption({
                            legend: {
                                data: [dischargeLabel, revenueLabel]
                            },
                            yAxis: [
                                {
                                    name: newLanguage === 'en' ? 'Power (kWh)' : 'kWh'
                                },
                                {
                                    name: newLanguage === 'en' ? 'Revenue ($)' : '$'
                                }
                            ],
                            series: [
                                {
                                    name: dischargeLabel
                                },
                                {
                                    name: revenueLabel
                                }
                            ]
                        });
                    }
                    
                    // Update market chart
                    if (marketChart) {
                        marketChart.setOption({
                            legend: {
                                data: [
                                    window.i18n.getText('historicalPrice'),
                                    window.i18n.getText('demand'),
                                    window.i18n.getText('predictedPrice'),
                                    window.i18n.getText('predictedDemand')
                                ]
                            },
                            yAxis: [
                                {
                                    name: window.i18n.getText('price')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                }
                            ],
                            series: [
                                {
                                    name: window.i18n.getText('historicalPrice')
                                },
                                {
                                    name: window.i18n.getText('demand')
                                },
                                {
                                    name: window.i18n.getText('predictedPrice')
                                },
                                {
                                    name: window.i18n.getText('predictedDemand')
                                }
                            ]
                        });
                    }
                    
                    // Re-init system performance chart to update series names
                    if (document.getElementById('systemPerformance')) {
                        initSystemPerformanceChart();
                    }
                    
                    // Update time selector labels for charts
                    const currentPeriod = powerChartTimeSelector ? powerChartTimeSelector.getCurrentPeriod() : 'month';
                    const { labels, power, revenue } = generateAnalyticsData(currentPeriod);
                    updatePowerChartWithData(labels, power, revenue, currentPeriod);
                });
            }
        });
        
        // 显示强制刷新通知
        function showRefreshNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #00ff88, #00aaff);
                color: #000;
                padding: 20px 40px;
                border-radius: 12px;
                font-size: 18px;
                font-weight: 600;
                z-index: 999999;
                box-shadow: 0 8px 32px rgba(0, 255, 136, 0.5);
                animation: pulse 0.5s ease-in-out;
            `;
            notification.textContent = '正在强制刷新页面...';
            document.body.appendChild(notification);
        }

        // System Performance Chart (Simplified Overview)
        function initSystemPerformanceChart() {
            performanceChart = echarts.init(document.getElementById('systemPerformance'));
            
            const hours = [];
            const efficiency = [];
            const availability = [];
            
            // Generate last 12 hours of system performance data
            for (let i = 11; i >= 0; i--) {
                const time = new Date();
                time.setHours(time.getHours() - i);
                hours.push(`${time.getHours()}:00`);
                
                // Generate realistic performance metrics
                efficiency.push(92 + Math.random() * 8); // 92-100% efficiency
                availability.push(95 + Math.random() * 5); // 95-100% availability
            }

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: { color: '#fff' },
                    formatter: function(params) {
                        let result = params[0].name + '<br/>';
                        params.forEach(function(item) {
                            result += item.marker + ' ' + item.seriesName + ': ' + item.value.toFixed(1) + '%<br/>';
                        });
                        return result;
                    }
                },
                grid: {
                    left: '5%',
                    right: '5%',
                    bottom: '15%',
                    top: '10%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 }
                },
                yAxis: {
                    type: 'value',
                    min: 85,
                    max: 100,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', fontSize: 10 },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.05)' } }
                },
                series: [
                    {
                        name: window.i18n ? window.i18n.getText('executionEfficiency') : '执行效率',
                        type: 'line',
                        data: efficiency,
                        smooth: true,
                        lineStyle: { color: '#00ff88', width: 2 },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.2)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                            ])
                        },
                        symbol: 'none'
                    },
                    {
                        name: window.i18n ? window.i18n.getText('systemAvailability') : '系统可用性',
                        type: 'line',
                        data: availability,
                        smooth: true,
                        lineStyle: { color: '#00aaff', width: 2 },
                        symbol: 'none'
                    }
                ]
            };

            performanceChart.setOption(option);
            window.addEventListener('resize', throttle(() => {
                if (performanceChart && typeof performanceChart.resize === 'function') {
                    performanceChart.resize();
                }
            }, 250));
        }

        // Discharge & Profit chart
        // powerRevenueChart is already declared globally above
        function initPowerRevenueChart() {
            powerRevenueChart = echarts.init(document.getElementById('powerRevenueChart'));
            
            const options = {
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0,0,0,0.9)',
                    borderColor: 'rgba(255,255,255,0.1)',
                    textStyle: { color: '#fff' },
                    axisPointer: {
                        type: 'cross',
                        crossStyle: {
                            color: 'var(--color-text-secondary)'
                        }
                    }
                },
                legend: {
                    data: [window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量', window.i18n ? window.i18n.getText('profit') : '获利'],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 0
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: ['0:00', '6:00', '12:00', '18:00', '24:00'],
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' }
                },
                yAxis: [{
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('discharge') : '放电量',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                }, {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('profit') : '获利',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    min: 0,
                    max: 250,
                    interval: 50,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { 
                        color: 'rgba(255, 255, 255, 0.6)',
                        formatter: '${value}'
                    },
                    splitLine: { show: false }
                }],
                series: [{
                    name: window.i18n ? window.i18n.getText('actualDischarge') : '实时放电量',
                    type: 'bar',
                    data: [100, 120, 240, 80, 110],
                    itemStyle: {
                        color: '#00ff88',
                        opacity: 0.8
                    },
                    barWidth: '40%'
                }, {
                    name: window.i18n ? window.i18n.getText('profit') : '获利',
                    type: 'line',
                    yAxisIndex: 1,
                    data: [150, 180, 240, 120, 165],
                    lineStyle: {
                        width: 3,
                        color: '#ffd700'
                    },
                    itemStyle: { color: '#ffd700' },
                    symbol: 'circle',
                    symbolSize: 8,
                    smooth: true
                }]
            };
            
            powerRevenueChart.setOption(options);
            window.addEventListener('resize', throttle(() => {
                if (powerRevenueChart && typeof powerRevenueChart.resize === 'function') {
                    powerRevenueChart.resize();
                }
            }, 250));
        }


        // 地区操作状态存储
        const regionOperationStatus = {
            'NSW': 'charging',
            'QLD': 'discharging',
            'VIC': 'charging',
            'SA': 'discharging',
            'TAS': 'none'
        };
        
        // 获取地区操作状态
        function getRegionOperationStatus(region) {
            return regionOperationStatus[region] || 'none';
        }
        
        // 更新地区操作状态
        function updateRegionOperationStatus(region, status) {
            regionOperationStatus[region] = status;
        }

        // 更新地区按钮状态指示器
        function updateRegionStatusIndicators() {
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                const region = tab.getAttribute('data-region');
                const status = getRegionOperationStatus(region);
                let statusElement = tab.querySelector('.region-status');
                
                // 先移除所有可能的占位元素
                const lastChild = tab.lastElementChild;
                if (lastChild && lastChild.tagName === 'SPAN' && !lastChild.classList.contains('region-status') && lastChild.style.width === '20px') {
                    lastChild.remove();
                }
                
                if (statusElement) {
                    // 移除现有状态类
                    statusElement.classList.remove('charging', 'discharging');
                    
                    // 根据状态更新显示
                    if (status === 'charging') {
                        statusElement.style.display = 'inline-flex';
                        statusElement.classList.add('charging');
                        statusElement.textContent = '充';
                    } else if (status === 'discharging') {
                        statusElement.style.display = 'inline-flex';
                        statusElement.classList.add('discharging');
                        statusElement.textContent = '放';
                    } else {
                        // 无状态，移除状态元素并添加占位
                        statusElement.remove();
                        const placeholder = document.createElement('span');
                        placeholder.style.width = '20px';
                        tab.appendChild(placeholder);
                    }
                } else {
                    // 没有状态元素
                    if (status !== 'none') {
                        // 创建新的状态元素
                        const newStatus = document.createElement('span');
                        newStatus.className = 'region-status ' + status;
                        newStatus.style.fontSize = '12px';
                        newStatus.style.marginLeft = '8px';
                        newStatus.textContent = status === 'charging' ? '充' : '放';
                        tab.appendChild(newStatus);
                    } else {
                        // 确保有占位元素
                        const placeholder = document.createElement('span');
                        placeholder.style.width = '20px';
                        tab.appendChild(placeholder);
                    }
                }
            });
        }

        // 主地区选择函数
        function selectMainRegion(region, button) {
            selectedMainRegion = region;
            
            // 更新按钮状态
            document.querySelectorAll('.region-select-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.style.background = 'transparent';
                tab.style.color = 'var(--color-text-secondary)';
                tab.style.border = '1px solid var(--color-border)';
                tab.style.borderRadius = '50px';
            });
            button.classList.add('active');
            button.style.background = 'var(--color-primary)';
            button.style.color = '#000';
            button.style.border = 'none';
            button.style.borderRadius = '50px';
            
            // 获取该地区的操作状态
            const status = getRegionOperationStatus(region);
            console.log(`Selected region: ${region}, Status: ${status}`); // Debug log
            
            // 更新电站管理标题的状态文字
            const statusText = document.getElementById('regionStatusText');
            if (statusText) {
                if (status === 'charging') {
                    statusText.textContent = window.i18n ? window.i18n.getText('charging') : '充电中';
                    statusText.style.color = '#00ff88';
                    statusText.style.display = 'inline-block';
                } else if (status === 'discharging') {
                    statusText.textContent = window.i18n ? window.i18n.getText('discharging') : '放电中';
                    statusText.style.color = '#ffd700';
                    statusText.style.display = 'inline-block';
                } else {
                    // 无状态时隐藏状态文字
                    statusText.textContent = '';
                    statusText.style.display = 'none';
                }
            }
            
            // 根据状态切换面板和按钮
            if (status === 'charging' || status === 'discharging') {
                // 有充放电标记的地区，显示地图，按钮变成停止
                switchPanel('map');
                updateActionButtonsToStop();
            } else {
                // 无标记的地区（status === 'none'），显示行情，只显示充放电按钮
                switchPanel('market');
                updateActionButtonsToChargeDis();
            }
            
            // 更新页面数据
            updatePageDataByRegion(region);
        }
        
        // 更新操作按钮为停止状态
        function updateActionButtonsToStop() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // 添加operating类
            actionButtonsContainer.classList.add('operating');
            
            // 隐藏充放电按钮，显示停止按钮
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn) chargeBtn.style.display = 'none';
            if (dischargeBtn) dischargeBtn.style.display = 'none';
            
            // 检查是否已有停止按钮
            let stopBtn = document.querySelector('.stop-btn');
            
            if (!stopBtn) {
                stopBtn = document.createElement('button');
                stopBtn.className = 'action-btn stop-btn';
                stopBtn.innerHTML = '<span data-i18n-key="stop">停止</span>';
                stopBtn.onclick = handleStop;
                actionButtonsContainer.appendChild(stopBtn);
            } else {
                stopBtn.style.display = 'flex';
            }
        }
        
        // 更新操作按钮为充放电状态
        function updateActionButtonsToChargeDis() {
            const actionButtonsContainer = document.querySelector('.action-buttons');
            if (!actionButtonsContainer) return;
            
            // 移除operating类
            actionButtonsContainer.classList.remove('operating');
            
            // 显示充放电按钮
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn) chargeBtn.style.display = 'flex';
            if (dischargeBtn) dischargeBtn.style.display = 'flex';
            
            // 移除停止按钮（而不仅是隐藏）
            const stopBtn = document.querySelector('.stop-btn');
            if (stopBtn) {
                stopBtn.remove();
            }
        }
        
        // 根据地区更新页面数据
        function updatePageDataByRegion(region) {
            // 更新电站管理数据
            updatePowerStationData(region);
            
            // 更新市场数据
            updateMarketDataByRegion(region);
            
            // 更新统计卡片
            updateStatisticsCards(region);
            
            // 更新图表
            if (marketChart) {
                updateMarketChart();
            }
            if (powerRevenueChart) {
                updateDischargeChart(currentDischargePeriod, document.getElementById('discharge-date-input').value);
            }
            
            // 更新地图显示
            if (mapChart) {
                updateMapByRegion(region);
            }
        }
        
        // 更新电站管理数据
        function updatePowerStationData(region) {
            const regionData = {
                'NSW': { price: '$163', low: '$120.50', high: '$185.75', families: 120, power: '65MWh', profit: '$3500' },
                'QLD': { price: '$145', low: '$110.00', high: '$170.00', families: 90, power: '48MWh', profit: '$2800' },
                'VIC': { price: '$155', low: '$115.50', high: '$175.50', families: 100, power: '52MWh', profit: '$3100' },
                'SA': { price: '$170', low: '$125.00', high: '$190.00', families: 70, power: '38MWh', profit: '$2200' },
                'TAS': { price: '$135', low: '$100.00', high: '$160.00', families: 80, power: '32MWh', profit: '$1835' }
            };
            
            const data = regionData[region] || regionData['NSW'];
            
            // 更新价格显示
            document.getElementById('currentPrice').textContent = data.price;
            document.getElementById('todayLow').textContent = data.low;
            document.getElementById('todayHigh').textContent = data.high;
            document.getElementById('regionIndicator').textContent = region;
            
            // 更新统计数据
            document.getElementById('totalFamiliesCard').textContent = data.families;
            // 更新电站管理中的三个小卡片
            const powerStationCards = document.querySelectorAll('.power-station-container .stat-value');
            if (powerStationCards.length >= 3) {
                powerStationCards[0].textContent = data.families;  // 家庭数
                powerStationCards[1].textContent = data.power + 'kWh';  // 可放电量
                powerStationCards[2].textContent = data.profit;  // 预计获利
            }
            
            // 更新最高价格区域显示
            const highestPriceRegionElement = document.getElementById('highestPriceRegion') || document.getElementById('highestPriceRegionDisplay');
            if (highestPriceRegionElement) {
                highestPriceRegionElement.textContent = region;
            }
        }
        
        // 更新市场数据
        function updateMarketDataByRegion(region) {
            // 触发市场面板的地区切换
            const marketRegionTab = document.querySelector(`.region-tab[onclick*="${region}"]`);
            if (marketRegionTab) {
                switchMarketRegion(region, marketRegionTab);
            }
        }
        
        // 更新统计卡片
        function updateStatisticsCards(region) {
            const summaryData = {
                'NSW': { families: 120, capacity: '65MWh', discharge: '89kwh', profit: '$3500' },
                'QLD': { families: 90, capacity: '48MWh', discharge: '45kwh', profit: '$2800' },
                'VIC': { families: 100, capacity: '52MWh', discharge: '51kwh', profit: '$3100' },
                'SA': { families: 70, capacity: '38MWh', discharge: '32kwh', profit: '$2200' },
                'TAS': { families: 80, capacity: '32MWh', discharge: '17kwh', profit: '$1835' }
            };
            
            const data = summaryData[region] || summaryData['NSW'];
            
            // 更新汇总卡片
            const familySummary = document.getElementById('familySummaryCard');
            if (familySummary) familySummary.textContent = data.families;
            
            // 更新其他汇总数据
            const summaryElements = document.querySelectorAll('.info-summary-card .stat-value');
            if (summaryElements.length >= 4) {
                summaryElements[1].textContent = data.capacity;
                summaryElements[2].textContent = data.discharge;
                summaryElements[3].textContent = data.profit;
            }
        }
        
        // 更新地图显示
        function updateMapByRegion(region) {
            if (!mapChart) return;
            
            // 只显示选定地区的设备
            if (deviceLocations && deviceLocations.length > 0) {
                // 过滤选中地区的设备
                const filteredDevices = deviceLocations.filter(device => device.region === region);
                const seriesData = filteredDevices.map(device => ({
                    value: device.value,
                    id: device.id,
                    status: device.status,
                    region: device.region
                }));
                
                mapChart.setOption({
                    series: [{
                        data: seriesData
                    }]
                });
            }
            
            updateMapStatistics();
        }
        
        // Update functions
        function switchRegion(region, button) {
            currentRegion = region;
            
            // Update active button
            document.querySelectorAll('.chart-controls .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update chart with new data
            updateMainChart('both');
        }

        function switchPriceRegion(region, button) {
            // Update active button
            const parent = button.parentElement;
            parent.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update price data
            updatePriceData(region);
        }

        // Discharge & Profit time period switching
        let currentDischargePeriod = 'day';
        
        function handleDischargePeriodChange() {
            const periodSelect = document.getElementById('discharge-period-select');
            const period = periodSelect.value;
            currentDischargePeriod = period;
            
            // Handle date picker visibility and type
            const datePicker = document.getElementById('discharge-date-picker');
            const dateInput = document.getElementById('discharge-date-input');
            
            if (period === 'cumulative') {
                // Hide date picker for cumulative
                datePicker.style.display = 'none';
            } else {
                // Show date picker
                datePicker.style.display = 'flex';
                
                // Set appropriate input type and default value
                const today = new Date();
                switch(period) {
                    case 'day':
                        dateInput.type = 'date';
                        dateInput.value = today.toISOString().split('T')[0];
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'month':
                        dateInput.type = 'month';
                        dateInput.value = today.toISOString().slice(0, 7);
                        dateInput.style.minWidth = '140px';
                        dateInput.style.width = '';
                        break;
                    case 'year':
                        // For year, we'll use a number input
                        dateInput.type = 'number';
                        dateInput.min = '2020';
                        dateInput.max = today.getFullYear().toString();
                        dateInput.value = today.getFullYear().toString();
                        dateInput.style.minWidth = '100px';
                        dateInput.style.width = '100px';
                        break;
                }
            }
            
            // Update chart data based on period
            updateDischargeChart(period, dateInput.value);
        }
        
        function updateDischargeChart(period, dateValue) {
            if (!powerRevenueChart) return;
            
            let xAxisData, dischargeData, profitData;
            
            switch(period) {
                case 'day':
                    // Hourly data for selected day
                    xAxisData = Array.from({length: 24}, (_, i) => i.toString());
                    dischargeData = Array.from({length: 24}, () => Math.floor(Math.random() * 200) + 50);
                    profitData = Array.from({length: 24}, () => Math.floor(Math.random() * 200) + 50);
                    break;
                case 'month':
                    // Daily data for selected month
                    const daysInMonth = new Date(dateValue.split('-')[0], dateValue.split('-')[1], 0).getDate();
                    xAxisData = Array.from({length: daysInMonth}, (_, i) => (i + 1).toString());
                    dischargeData = Array.from({length: daysInMonth}, () => Math.floor(Math.random() * 200) + 50);
                    profitData = Array.from({length: daysInMonth}, () => Math.floor(Math.random() * 200) + 50);
                    break;
                case 'year':
                    // Monthly data for selected year
                    xAxisData = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                    dischargeData = Array.from({length: 12}, () => Math.floor(Math.random() * 2000) + 500);
                    profitData = Array.from({length: 12}, () => Math.floor(Math.random() * 2000) + 500);
                    break;
                case 'cumulative':
                    // Cumulative data over time
                    xAxisData = ['2020', '2021', '2022', '2023', '2024'];
                    dischargeData = [5000, 12000, 25000, 45000, 78000];
                    profitData = [8000, 18000, 35000, 62000, 98000];
                    break;
            }
            
            // Update chart
            powerRevenueChart.setOption({
                xAxis: { data: xAxisData },
                series: [
                    { data: dischargeData },
                    { data: profitData }
                ]
            });
        }
        
        // Initialize discharge chart date input listener
        document.addEventListener('DOMContentLoaded', function() {
            const dateInput = document.getElementById('discharge-date-input');
            if (dateInput) {
                // Set today's date as default
                const today = new Date();
                dateInput.value = today.toISOString().split('T')[0];
                
                dateInput.addEventListener('change', function() {
                    updateDischargeChart(currentDischargePeriod, this.value);
                });
            }
        });


        // Update power chart title with current time period
        function updatePowerChartTitle() {
            const chartTitle = document.getElementById('powerChartTitle');
            if (chartTitle) {
                chartTitle.textContent = window.i18n ? window.i18n.getText('powerRevenueTrend') : '放电与收益趋势';
            }
        }

        // Initialize time selector for power chart
        function initPowerChartTimeSelector() {
            if (typeof TimeSelector === 'undefined') {
                console.error('TimeSelector class not loaded');
                return;
            }
            powerChartTimeSelector = new TimeSelector({
                containerId: 'power-chart-time-selector',
                onPeriodChange: handlePowerChartPeriodChange,
                onCustomDateApply: handlePowerChartCustomDate,
                enableAutoRefresh: true,
                autoRefreshInterval: 30000,
                periods: [
                    { id: 'month', label: window.i18n ? window.i18n.getText('month') : '本月', shortcut: '1' },
                    { id: 'week', label: window.i18n ? window.i18n.getText('week') : '本周', shortcut: '2' },
                    { id: 'today', label: window.i18n ? window.i18n.getText('today') : '今日', shortcut: '3' },
                    { id: 'custom', label: window.i18n ? window.i18n.getText('custom') : '自定义', shortcut: '4' }
                ],
                quickSelectOptions: [
                    { label: window.i18n ? window.i18n.getText('last7Days') : '最近7天', days: 7 },
                    { label: window.i18n ? window.i18n.getText('last30Days') : '最近30天', days: 30 },
                    { label: window.i18n ? window.i18n.getText('last90Days') : '最近90天', days: 90 }
                ]
            });
            
            // Add language change observer to update TimeSelector
            if (window.i18n) {
                window.i18n.addObserver((newLanguage, oldLanguage) => {
                    // Re-initialize TimeSelector with new language
                    if (powerChartTimeSelector) {
                        const currentPeriod = powerChartTimeSelector.getCurrentPeriod();
                        powerChartTimeSelector.destroy();
                        initPowerChartTimeSelector();
                        // Restore current period
                        setTimeout(() => {
                            if (powerChartTimeSelector && currentPeriod !== 'today') {
                                powerChartTimeSelector.setCurrentPeriod(currentPeriod);
                            }
                        }, 100);
                    }
                });
            }
            
            // Set initial title to show default period (today)
            updatePowerChartTitle();
            
            // Force initial data load for today to ensure display
            setTimeout(() => {
                const { labels, power, revenue } = generateAnalyticsData('month');
                updatePowerChartWithData(labels, power, revenue, 'month');
            }, 200);
        }

        // Handle period change from time selector
        function handlePowerChartPeriodChange(period, data) {
            console.log('Power chart period changed to:', period, data);
            
            // Update chart title with current period
            updatePowerChartTitle();
            
            // Generate data for the selected period
            const { labels, power, revenue } = generateAnalyticsData(period);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, period);
        }

        // Handle custom date range application
        function handlePowerChartCustomDate(startDate, endDate, dayCount) {
            console.log('Power chart custom date applied:', startDate, endDate, dayCount);
            
            // Format date range for display
            const startFormatted = new Date(startDate).toLocaleDateString('zh-CN');
            const endFormatted = new Date(endDate).toLocaleDateString('zh-CN');
            const customDateRange = `${startFormatted} 至 ${endFormatted}`;
            
            // Update chart title with custom date range
            updatePowerChartTitle();
            
            // Generate data for custom date range
            const { labels, power, revenue } = generateAnalyticsData('custom', startDate, endDate);
            
            // Update the power chart
            updatePowerChartWithData(labels, power, revenue, 'custom');
        }

        // Legacy function for backward compatibility
        function updateAnalytics(period) {
            if (powerChartTimeSelector) {
                // Map old period names to new ones
                const periodMap = {
                    'today': 'today',
                    'week': 'week', 
                    'month': 'month',
                    'custom': 'custom'
                };
                
                const mappedPeriod = periodMap[period] || period;
                powerChartTimeSelector.setCurrentPeriod(mappedPeriod);
            }
        }

        function generateAnalyticsData(period, startDate = null, endDate = null) {
            // Create cache key based on parameters
            const cacheKey = `analyticsData_${period}_${startDate || 'null'}_${endDate || 'null'}`;
            
            // Check cache first for standard periods (not custom with random data)
            if (period !== 'custom') {
                const cached = dataCache.get(cacheKey);
                if (cached) {
                    return cached;
                }
            }
            
            const labels = [];
            const power = [];
            const revenue = [];
            
            if (period === 'today') {
                for (let i = 0; i < 24; i += 2) {
                    labels.push(`${i}:00`);
                    power.push(Math.random() * 150 + 50);
                    revenue.push(Math.random() * 200 + 100);
                }
            } else if (period === 'week') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                let days;
                if (currentLang === 'en') {
                    days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                } else if (currentLang === 'ja') {
                    days = ['月', '火', '水', '木', '金', '土', '日'];
                } else if (currentLang === 'ko') {
                    days = ['월', '화', '수', '목', '금', '토', '일'];
                } else {
                    days = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
                }
                days.forEach(day => {
                    labels.push(day);
                    power.push(Math.random() * 2000 + 1000);
                    revenue.push(Math.random() * 2500 + 1200);
                });
            } else if (period === 'month') {
                const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
                for (let i = 1; i <= 30; i++) {
                    if (currentLang === 'en' || currentLang === 'ja' || currentLang === 'ko') {
                        labels.push(`${i}`);
                    } else {
                        labels.push(`${i}日`);
                    }
                    power.push(Math.random() * 3000 + 1500);
                    revenue.push(Math.random() * 4000 + 2000);
                }
            } else if (period === 'custom' && startDate && endDate) {
                // Generate data for custom date range
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                for (let i = 0; i < diffDays; i++) {
                    const currentDate = new Date(start);
                    currentDate.setDate(start.getDate() + i);
                    
                    if (diffDays <= 7) {
                        // Show date format for week or less
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    } else if (diffDays <= 31) {
                        // Show day format for month
                        labels.push(`${currentDate.getDate()}日`);
                    } else {
                        // Show month/day for longer periods
                        labels.push(`${currentDate.getMonth() + 1}/${currentDate.getDate()}`);
                    }
                    
                    // Generate realistic historical data with some trend
                    const basePower = 1000 + Math.sin(i * 0.1) * 500;
                    const baseRevenue = 1500 + Math.sin(i * 0.15) * 700;
                    
                    power.push(Math.max(50, basePower + (Math.random() - 0.5) * 400));
                    revenue.push(Math.max(100, baseRevenue + (Math.random() - 0.5) * 600));
                }
            }
            
            const result = { labels, power, revenue };
            
            // Cache the result for standard periods
            if (period !== 'custom') {
                dataCache.set(cacheKey, result);
            }
            
            return result;
        }

        function updatePowerChartWithData(labels, power, revenue, period) {
            // Get updated translated labels
            const dischargeLabel = window.i18n ? window.i18n.getText('discharge') : '放电';
            const revenueLabel = window.i18n ? window.i18n.getText('totalRevenue') : '收益';
            
            powerChart.setOption({
                legend: {
                    data: [dischargeLabel, revenueLabel]
                },
                xAxis: { 
                    data: labels,
                    axisLabel: {
                        color: 'rgba(255, 255, 255, 0.6)',
                        interval: labels.length > 15 ? Math.floor(labels.length / 10) : 0
                    }
                },
                series: [
                    { 
                        name: dischargeLabel,
                        data: power 
                    },
                    { 
                        name: revenueLabel,
                        data: revenue 
                    }
                ]
            });
        }


        // Legacy functions for backward compatibility
        function applyCustomDateRange() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.applyCustomDateRange();
            }
        }

        function resetToToday() {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.resetToDefault();
            }
        }

        function setQuickRange(days) {
            if (powerChartTimeSelector) {
                powerChartTimeSelector.setQuickRange(days);
            }
        }

        function initializeDateInputs() {
            // This is now handled by the TimeSelector component
            console.log('Date inputs are now managed by TimeSelector component');
        }


        function updatePowerChart() {
            const date = document.getElementById('dateSelect').value;
            
            // Generate new data based on selected date
            const newData = [
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50,
                Math.random() * 150 + 50
            ];
            
            powerChart.setOption({
                series: [{ data: newData }]
            });
        }

        function updatePriceData(region) {
            // Simulate data update based on region
            const basePrice = Math.random() * 100000 + 700000;
            document.getElementById('cumulativePrice').textContent = '$' + Math.floor(basePrice).toLocaleString();
            document.getElementById('forecastCumulative').textContent = '$' + Math.floor(basePrice - 8).toLocaleString();
            
        }

        // Real-time data updates
        function updateRealtimeData() {
            // Get current region from the price circle indicator
            const currentDisplayRegion = document.getElementById('regionIndicator').textContent;
            
            // Update price data based on current region
            updatePriceCircleRegion(currentDisplayRegion);
            
            // Update spot price with animation
            const spotPrice = Math.floor(Math.random() * 100 + 100);
            document.getElementById('spotPrice').textContent = '$' + spotPrice + '.73';
            
            // Update demand
            const demand = Math.floor(Math.random() * 1000 + 7500);
            document.getElementById('currentDemand').textContent = demand.toLocaleString();
            
            // Update power station management data with realistic values
            const baseHomes = 235;
            const basePower = 23547;
            const baseProfit = 12435;
            
            // Add small realistic variations
            const homesVariation = Math.floor((Math.random() - 0.5) * 10); // ±5 homes
            const powerVariation = Math.floor((Math.random() - 0.5) * 500); // ±250 kWh
            const profitVariation = Math.floor((Math.random() - 0.5) * 200); // ±100 dollars
            
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            const unit = currentLang === 'en' ? '' : 
                        currentLang === 'ja' ? '個' :
                        currentLang === 'ko' ? '개' : '个';
            document.getElementById('availableHomes').textContent = (baseHomes + homesVariation);
            document.getElementById('availablePower').textContent = (basePower + powerVariation) + 'kWh';
            document.getElementById('estimatedProfit').textContent = '$' + (baseProfit + profitVariation);
            
            // Add pulse effect to updated values (excluding today's high/low to avoid constant color change)
            const elements = ['currentPrice', 'spotPrice', 'currentDemand'];
            elements.forEach(id => {
                const elem = document.getElementById(id);
                elem.style.transition = 'color 0.3s';
                elem.style.color = '#00ff88';
                setTimeout(() => {
                    elem.style.color = '';
                }, 300);
            });
            
            // Update highest price region
            updateHighestPriceRegion();
        }

        // Update highest price region display
        function updateHighestPriceRegion() {
            // 使用实际的地区价格数据
            const regionPrices = {
                'NSW': 163,
                'QLD': 145,
                'VIC': 155,
                'SA': 170,
                'TAS': 135
            };
            
            // Find region with highest price
            let highestRegion = 'NSW';
            let highestPrice = regionPrices['NSW'];
            
            for (const [region, price] of Object.entries(regionPrices)) {
                if (price > highestPrice) {
                    highestPrice = price;
                    highestRegion = region;
                }
            }
            
            // Update both displays
            const highestPriceElement = document.getElementById('highestPriceRegion');
            if (highestPriceElement) {
                highestPriceElement.textContent = highestRegion;
            }
            
            // Update the new display in region selection layer
            const highestRegionDisplay = document.getElementById('highestPriceRegionDisplay');
            if (highestRegionDisplay) {
                highestRegionDisplay.textContent = highestRegion;
            }
            
            const highestPriceValueDisplay = document.getElementById('highestPriceValue');
            if (highestPriceValueDisplay) {
                highestPriceValueDisplay.textContent = highestPrice;
            }
        }

        // Initialize Market Chart - Simplified and Reliable Version
        function initMarketChart() {
            const container = document.getElementById('marketChart');
            if (!container) {
                console.error('Market chart container not found!');
                return;
            }
            
            // Dispose existing instance if any
            if (marketChart) {
                marketChart.dispose();
            }
            
            // Wait for container to be visible
            setTimeout(() => {
                // Initialize chart
                marketChart = echarts.init(container, 'dark');
                
                // Force container to have proper dimensions
                container.style.width = '100%';
                container.style.height = '400px';
                
                // Force a reflow to apply the new dimensions
                container.offsetHeight;
            
            const hours = [];
            const prices = [];
            const demands = [];
            const forecastPrices = [];
            const forecastDemands = [];
            const currentTime = new Date().getHours();
            
            // Generate all hours
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
            }
            
            // Generate historical data and track last values
            let lastPrice = 150;
            let lastDemand = 7500;
            
            for (let i = 0; i < 24; i++) {
                if (i < currentTime) {
                    // Historical data before current time
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    prices.push(price);
                    demands.push(demand);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else if (i === currentTime) {
                    // Current time - both actual and forecast start here for seamless connection
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    prices.push(price);
                    demands.push(demand);
                    forecastPrices.push(price); // Start forecast from current actual value
                    forecastDemands.push(demand); // Start forecast from current actual value
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else {
                    // Future time - only forecast data
                    prices.push(null);
                    demands.push(null);
                    
                    // Generate realistic forecast with market characteristics
                    const hoursAhead = i - currentTime;
                    
                    // Price forecast with increasing uncertainty
                    const priceBaseVariation = (Math.random() - 0.5) * (20 + hoursAhead * 3); // Uncertainty increases over time
                    const priceTrendVariation = Math.cos((i / 24) * 2 * Math.PI) * 25; // Daily pricing cycle
                    const priceVolatilitySpike = Math.random() < 0.2 ? (Math.random() - 0.5) * 80 : 0; // 20% chance of price spike
                    const priceSeasonalFactor = Math.sin((i / 12) * Math.PI) * 15; // Peak/off-peak pricing
                    
                    const totalPriceVariation = priceBaseVariation + priceTrendVariation + priceVolatilitySpike + priceSeasonalFactor;
                    const prevForecastPrice = forecastPrices[i-1];
                    
                    // Demand forecast with different patterns
                    const demandBaseVariation = (Math.random() - 0.5) * (400 + hoursAhead * 50);
                    const demandCycleFactor = Math.sin(((i - 6) / 24) * 2 * Math.PI) * 800; // Business hours demand
                    const demandWeatherFactor = (Math.random() - 0.5) * 600; // Weather impact
                    const demandEventFactor = Math.random() < 0.1 ? (Math.random() - 0.5) * 1500 : 0; // 10% chance of demand event
                    
                    const totalDemandVariation = demandBaseVariation + demandCycleFactor + demandWeatherFactor + demandEventFactor;
                    const prevForecastDemand = forecastDemands[i-1];
                    
                    forecastPrices.push(Math.max(30, prevForecastPrice + totalPriceVariation));
                    forecastDemands.push(Math.max(4000, prevForecastDemand + totalDemandVariation));
                }
            }

                // Get translations
                const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
                const translations = {
                    en: {
                        historicalPrice: 'Historical Price',
                        predictedPrice: 'Predicted Price',
                        demand: 'Demand',
                        predictedDemand: 'Predicted Demand',
                        price: 'Price ($/MWh)',
                        demandUnit: 'Demand (MW)'
                    },
                    zh: {
                        historicalPrice: '历史价格',
                        predictedPrice: '预测价格',
                        demand: '需求',
                        predictedDemand: '预测需求',
                        price: '价格 ($/MWh)',
                        demandUnit: '需求 (MW)'
                    }
                };
                
                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'axis',
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        borderColor: '#00ff88',
                        borderWidth: 1,
                        textStyle: { color: '#fff' },
                        formatter: function(params) {
                            let result = `<div style="font-weight: bold; margin-bottom: 5px;">${params[0].axisValue}</div>`;
                            params.forEach(param => {
                                if (param.value !== null && param.value !== undefined) {
                                    const color = param.color;
                                    const value = param.seriesName.includes(getText('price')) || param.seriesName.includes('Price') 
                                        ? `$${param.value.toFixed ? param.value.toFixed(2) : param.value}` 
                                        : `${param.value.toFixed ? param.value.toFixed(0) : param.value} MW`;
                                    result += `<div>${param.marker} ${param.seriesName}: <strong>${value}</strong></div>`;
                                }
                            });
                            return result;
                        }
                    },
                    legend: {
                        data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')],
                        textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                        top: 10
                    },
                    grid: {
                        left: '60',
                        right: '60',
                        bottom: '40',
                        top: '50',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: hours,
                        axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                        axisLabel: { 
                            color: 'rgba(255, 255, 255, 0.7)',
                            interval: 2,
                            fontSize: 12
                        },
                        splitLine: { show: false }
                    },
                    yAxis: [
                        {
                            type: 'value',
                            name: getText('price'),
                            nameTextStyle: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'left',
                            axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                            axisLabel: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '${value}'
                            },
                            splitLine: { 
                                lineStyle: { 
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    type: 'dashed'
                                } 
                            }
                        },
                        {
                            type: 'value',
                            name: getText('demandUnit'),
                            nameTextStyle: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                fontSize: 12
                            },
                            position: 'right',
                            axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.3)' } },
                            axisLabel: { 
                                color: 'rgba(255, 255, 255, 0.7)',
                                formatter: '{value} MW'
                            },
                        splitLine: { show: false }
                    }
                ],
                    series: [
                        {
                            name: getText('historicalPrice'),
                            type: 'line',
                            data: prices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#00ff88', 
                                width: 3
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.3)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.05)' }
                                ])
                            }
                        },
                        {
                            name: getText('demand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: demands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#ffd700', 
                                width: 2
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        },
                        {
                            name: getText('predictedPrice'),
                            type: 'line',
                            data: forecastPrices,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: { 
                                color: '#00ff88', 
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#00ff88'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    { offset: 0, color: 'rgba(0, 255, 136, 0.15)' },
                                    { offset: 1, color: 'rgba(0, 255, 136, 0.02)' }
                                ])
                            }
                        },
                        {
                            name: getText('predictedDemand'),
                            type: 'line',
                            yAxisIndex: 1,
                            data: forecastDemands,
                            smooth: true,
                            symbol: 'circle',
                            symbolSize: 4,
                            lineStyle: {
                                color: '#ffd700',
                                width: 2,
                                type: 'dashed'
                            },
                            itemStyle: {
                                color: '#ffd700'
                            }
                        }
                    ]
                };

                // Apply configuration
                marketChart.setOption(option);
                
                // Force resize after setting option
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                        console.log('Market chart resized to:', container.offsetWidth, 'x', container.offsetHeight);
                    }
                }, 100);
                
                // Handle resize
                window.addEventListener('resize', () => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                    }
                });
                
                // Force initial resize
                setTimeout(() => {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                }, 100);
                
                console.log('Market chart initialized successfully');
            }, 50); // Small delay to ensure container is ready
        }

        // Initialize Australian States Map 
        function initMap() {
            console.log('initMap called');
            const container = document.getElementById('australiaMap');
            if (!container) {
                console.error('australiaMap container not found!');
                return;
            }
            console.log('australiaMap container found, dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            
            try {
                mapChart = echarts.init(container);
                console.log('mapChart initialized successfully');
            } catch (error) {
                console.error('Failed to initialize mapChart:', error);
                return;
            }
            
            // Define Australian states with proper coordinates
            const australianStates = [
                // Main states
                { name: 'NSW', center: [147, -32], color: '#00ff88', radius: 25, deviceCount: 120 },
                { name: 'VIC', center: [144, -37], color: '#00aaff', radius: 20, deviceCount: 100 },
                { name: 'QLD', center: [145, -22], color: '#8A4AFF', radius: 28, deviceCount: 90 },
                { name: 'WA', center: [122, -26], color: '#ffaa00', radius: 30, deviceCount: 70 },
                { name: 'SA', center: [135, -30], color: '#9c27b0', radius: 22, deviceCount: 60 },
                { name: 'TAS', center: [147, -42], color: '#4caf50', radius: 12, deviceCount: 30 },
                { name: 'NT', center: [133, -19], color: '#2196f3', radius: 20, deviceCount: 20 },
                { name: 'ACT', center: [149, -35.3], color: '#ff9800', radius: 8, deviceCount: 10 }
            ];

            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'item',
                    backgroundColor: 'rgba(0, 0, 0, 0.9)',
                    borderColor: 'rgba(0, 255, 136, 0.5)',
                    borderWidth: 1,
                    textStyle: { color: '#fff', fontSize: 12 },
                    formatter: function(params) {
                        if (params.seriesType === 'scatter') {
                            if (params.seriesIndex === 1) {
                                // Device points
                                const getStatusText = (status) => {
                                    if (!window.i18n) {
                                        const statusMap = {
                                            'inactive': '待机',
                                            'active': '激活',
                                            'charging': '充电中',
                                            'discharging': '放电中',
                                            'offline': '离线'
                                        };
                                        return statusMap[status] || status;
                                    }
                                    
                                    const statusKeys = {
                                        'inactive': 'inactive',
                                        'active': 'active',
                                        'charging': 'charging',
                                        'discharging': 'discharging',
                                        'offline': 'offline'
                                    };
                                    
                                    return window.i18n.getText(statusKeys[status]) || status;
                                };
                                const deviceText = window.i18n ? window.i18n.getText('device') : '设备';
                                const statusText = window.i18n ? window.i18n.getText('status') : '状态';
                                const regionText = window.i18n ? window.i18n.getText('region') : '区域';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 8px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: #00ff88; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${deviceText} ${params.data.id}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${getStatusText(params.data.status)}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${regionText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.region}</span>
                                    </div>
                                </div>`;
                            } else if (params.seriesIndex === 0) {
                                // State centers
                                const stateText = window.i18n ? window.i18n.getText('state') : '州';
                                const deviceCountText = window.i18n ? window.i18n.getText('deviceCount') : '设备数量';
                                const statusText = window.i18n ? window.i18n.getText('status') : '状态';
                                const normalText = window.i18n ? window.i18n.getText('normalOperation') : '正常运行';
                                
                                return `<div style="padding: 12px; background: rgba(0,0,0,0.8); border-radius: 8px; color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <div style="color: ${params.data.color}; font-weight: 600; font-size: 14px; margin-bottom: 8px;">${params.data.name} ${stateText}</div>
                                    <div style="margin: 4px 0; font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${deviceCountText}:</span> 
                                        <span style="color: #fff; font-weight: 500;">${params.data.deviceCount}</span>
                                    </div>
                                    <div style="font-size: 13px; display: flex; justify-content: space-between;">
                                        <span style="color: rgba(255,255,255,0.8);">${statusText}:</span> 
                                        <span style="color: #00ff88; font-weight: 500;">${normalText}</span>
                                    </div>
                                </div>`;
                            }
                        }
                        return '';
                    }
                },
                graphic: [],
                xAxis: {
                    type: 'value',
                    min: 110,
                    max: 160,
                    show: false
                },
                yAxis: {
                    type: 'value',
                    min: -45,
                    max: -10,
                    show: false
                },
                grid: {
                    left: 0,
                    right: 0,
                    top: 0,
                    bottom: 0
                },
                series: [
                    // Region centers with glowing effect
                    {
                        name: 'States',
                        type: 'scatter',
                        data: australianStates.map(state => ({
                            value: state.center,
                            name: state.name,
                            color: state.color,
                            deviceCount: state.deviceCount,
                            symbolSize: state.radius * 2
                        })),
                        symbol: 'circle',
                        symbolSize: function(value, params) {
                            return params.data.symbolSize;
                        },
                        label: {
                            show: true,
                            formatter: function(params) {
                                return params.data.name;
                            },
                            position: 'inside',
                            color: '#000',
                            fontSize: 14,
                            fontWeight: 'bold'
                        },
                        itemStyle: {
                            color: function(params) {
                                return {
                                    type: 'radial',
                                    x: 0.5,
                                    y: 0.5,
                                    r: 0.5,
                                    colorStops: [
                                        { offset: 0, color: params.data.color },
                                        { offset: 0.7, color: params.data.color },
                                        { offset: 1, color: 'rgba(255, 255, 255, 0.3)' }
                                    ]
                                };
                            },
                            opacity: 0.8,
                            borderColor: function(params) {
                                return params.data.color;
                            },
                            borderWidth: 3,
                            shadowBlur: 20,
                            shadowColor: function(params) {
                                return params.data.color;
                            }
                        },
                        emphasis: {
                            scale: 1.1,
                            label: {
                                fontSize: 16
                            },
                            itemStyle: {
                                opacity: 1,
                                shadowBlur: 30
                            }
                        },
                        z: 1
                    },
                    // Device network points
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: deviceLocations.map(device => ({
                            value: device.value,
                            id: device.id,
                            status: device.status,
                            region: device.region
                        })),
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            if (status === 'active' || status === 'charging' || status === 'discharging') {
                                return 8;
                            }
                            return status === 'offline' ? 3 : 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging': 
                                    case 'active':
                                        return currentOperation === 'charge' ? '#00ff88' : '#FFD700';
                                    case 'discharging': 
                                        return '#FFD700';
                                    case 'offline': 
                                        return 'rgba(255, 255, 255, 0.2)';
                                    default: 
                                        return 'rgba(255, 255, 255, 0.5)';
                                }
                            },
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                return (status === 'active' || status === 'charging' || status === 'discharging') ? 10 : 3;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                switch (status) {
                                    case 'charging':
                                    case 'active':
                                        return currentOperation === 'charge' ? 'rgba(0, 255, 136, 0.8)' : 'rgba(255, 215, 0, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.5,
                            itemStyle: {
                                shadowBlur: 20,
                                shadowColor: 'rgba(0, 255, 136, 0.9)'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut',
                        z: 2
                    }
                ]
            };

            try {
                mapChart.setOption(option);
                console.log('mapChart option set successfully');
            } catch (error) {
                console.error('Failed to set mapChart option:', error);
                return;
            }
            
            // Update status statistics
            updateMapStatistics();
            
            window.addEventListener('resize', throttle(() => {
                if (mapChart && typeof mapChart.resize === 'function') {
                    mapChart.resize();
                }
            }, 250));
        }
        

        // Generate Australian state device locations (exactly 500 devices)
        function generateDeviceLocations() {
            const locations = [];
            
            const australianStates = [
                { 
                    center: [147, -32], 
                    weight: 120, 
                    name: 'NSW', 
                    spread: 4,
                    cities: ['Sydney', 'Newcastle', 'Wollongong', 'Central Coast', 'Coffs Harbour']
                },
                { 
                    center: [144, -37], 
                    weight: 100, 
                    name: 'VIC', 
                    spread: 3,
                    cities: ['Melbourne', 'Geelong', 'Ballarat', 'Bendigo', 'Shepparton']
                },
                { 
                    center: [145, -22], 
                    weight: 90, 
                    name: 'QLD', 
                    spread: 6,
                    cities: ['Brisbane', 'Gold Coast', 'Townsville', 'Cairns', 'Sunshine Coast']
                },
                { 
                    center: [122, -26], 
                    weight: 70, 
                    name: 'WA', 
                    spread: 8,
                    cities: ['Perth', 'Fremantle', 'Bunbury', 'Albany', 'Kalgoorlie']
                },
                { 
                    center: [135, -30], 
                    weight: 60, 
                    name: 'SA', 
                    spread: 4,
                    cities: ['Adelaide', 'Mount Gambier', 'Whyalla', 'Murray Bridge', 'Port Lincoln']
                },
                { 
                    center: [147, -42], 
                    weight: 30, 
                    name: 'TAS', 
                    spread: 2,
                    cities: ['Hobart', 'Launceston', 'Devonport', 'Burnie', 'Ulverstone']
                },
                { 
                    center: [133, -19], 
                    weight: 20, 
                    name: 'NT', 
                    spread: 5,
                    cities: ['Darwin', 'Alice Springs', 'Katherine', 'Palmerston', 'Tennant Creek']
                },
                { 
                    center: [149, -35.3], 
                    weight: 10, 
                    name: 'ACT', 
                    spread: 0.5,
                    cities: ['Canberra', 'Queanbeyan', 'Belconnen', 'Tuggeranong', 'Gungahlin']
                }
            ];
            
            // Calculate total weight for distribution
            const totalWeight = australianStates.reduce((sum, state) => sum + state.weight, 0);
            
            // Generate exactly 500 devices
            for (let i = 0; i < 500; i++) {
                // Select state based on weight distribution
                let randomWeight = Math.random() * totalWeight;
                let selectedState = australianStates[0];
                
                for (const state of australianStates) {
                    randomWeight -= state.weight;
                    if (randomWeight <= 0) {
                        selectedState = state;
                        break;
                    }
                }
                
                // Generate random point within state spread
                const angle = Math.random() * 2 * Math.PI;
                const distance = Math.random() * selectedState.spread;
                
                const longitude = selectedState.center[0] + distance * Math.cos(angle);
                const latitude = selectedState.center[1] + distance * Math.sin(angle);
                
                // Assign random initial status for realistic distribution
                let initialStatus = 'inactive'; // Default
                const rand = Math.random();
                if (rand < 0.05) {
                    initialStatus = 'offline';  // 5% offline
                } else if (rand < 0.12) {
                    initialStatus = 'discharging';  // 7% discharging
                } else if (rand < 0.18) {
                    initialStatus = 'charging';  // 6% charging
                }
                // 82% remain as inactive/standby

                // Select random city from state
                const randomCity = selectedState.cities[Math.floor(Math.random() * selectedState.cities.length)];

                locations.push({
                    value: [longitude, latitude],
                    id: i,
                    status: initialStatus,
                    region: selectedState.name,
                    city: randomCity
                });
            }
            
            return locations;
        }

        // Interactive functions with proper state management and confirmation
        function handleCharge() {
            console.log('handleCharge called, currentOperation:', currentOperation);
            if (currentOperation === 'charge') {
                // 当前正在充电，显示停止确认
                showStopConfirmation();
            } else if (currentOperation === 'discharge') {
                // 正在放电时不能充电
                return;
            } else {
                // 显示充电确认弹窗
                showOperationConfirmation('charge');
            }
        }

        function handleDischarge() {
            console.log('handleDischarge called, currentOperation:', currentOperation);
            if (currentOperation === 'discharge') {
                // 当前正在放电，显示停止确认
                showStopConfirmation();
            } else if (currentOperation === 'charge') {
                // 正在充电时不能放电
                return;
            } else {
                // 显示放电确认弹窗
                showOperationConfirmation('discharge');
            }
        }

        // 新的操作启动函数
        function startOperation(operationType) {
            console.log('Starting operation:', operationType);
            
            // 设置当前操作
            currentOperation = operationType;
            
            // 更新当前地区的操作状态
            updateRegionOperationStatus(selectedMainRegion, operationType === 'charge' ? 'charging' : 'discharging');
            
            // 更新地区状态指示器
            updateRegionStatusIndicators();
            
            // 更新电站管理标题的状态文字
            const statusText = document.getElementById('regionStatusText');
            if (statusText) {
                if (operationType === 'charge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('charging') : '充电中';
                    statusText.style.color = '#00ff88';
                    statusText.style.display = 'inline-block';
                } else if (operationType === 'discharge') {
                    statusText.textContent = window.i18n ? window.i18n.getText('discharging') : '放电中';
                    statusText.style.color = '#ffd700';
                    statusText.style.display = 'inline-block';
                }
            }
            
            // 更新按钮状态
            updateButtonsForOperation(operationType);
            
            // 切换到地图视图
            switchPanel('map');
            
            // 启动设备动画
            setTimeout(() => {
                startDeviceAnimation();
            }, 300);
        }
        
        // 更新按钮状态
        function updateButtonsForOperation(operationType) {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge') {
                // 充电状态：只显示停止按钮
                chargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                chargeBtn.className = 'action-btn stop-btn';
                chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                chargeBtn.style.setProperty('color', '#fff', 'important');
                chargeBtn.style.setProperty('flex', '1', 'important');
                chargeBtn.style.setProperty('max-width', '200px', 'important');
                
                dischargeBtn.style.display = 'none';
                actionButtons.classList.add('operating');
            } else if (operationType === 'discharge') {
                // 放电状态：只显示停止按钮
                dischargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                dischargeBtn.className = 'action-btn stop-btn';
                dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                dischargeBtn.style.setProperty('color', '#fff', 'important');
                dischargeBtn.style.setProperty('flex', '1', 'important');
                dischargeBtn.style.setProperty('max-width', '200px', 'important');
                
                chargeBtn.style.display = 'none';
                actionButtons.classList.add('operating');
            }
        }

        // 停止确认弹窗
        function showStopConfirmation() {
            const operationName = currentOperation === 'charge' ? '充电' : '放电';
            showOperationConfirmation(`stop_${currentOperation}`);
        }
        
        // 停止操作
        function stopOperation() {
            console.log('Stopping operation:', currentOperation);
            
            // 停止动画
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
                console.log('Map animation interval cleared');
            }
            
            // 强制立即切换到行情页面
            console.log('Force switching to market panel immediately');
            
            // 手动激活行情页面
            document.querySelectorAll('.panel-content').forEach(p => {
                p.classList.remove('active');
            });
            const marketPanel = document.getElementById('marketPanel');
            if (marketPanel) {
                marketPanel.classList.add('active');
                console.log('Market panel activated');
            }
            
            // 手动激活行情tab
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const marketTab = Array.from(document.querySelectorAll('.panel-tab')).find(tab => {
                const onclick = tab.getAttribute('onclick');
                return onclick && onclick.includes("'market'");
            });
            if (marketTab) {
                marketTab.classList.add('active');
                console.log('Market tab activated');
            }
            
            // 重置按钮状态
            resetButtons();
            
            // 显示操作统计
            setTimeout(() => {
                console.log('Showing operation statistics after stop');
                showOperationStatistics();
            }, 200);
        }

        // Show operation confirmation modal
        function showOperationConfirmation(operationType) {
            pendingOperation = operationType;
            
            // Store current panel state before showing confirmation
            const activePanel = document.querySelector('.panel-content.active');
            if (activePanel) {
                if (activePanel.id === 'marketPanel') {
                    previousPanel = 'market';
                } else if (activePanel.id === 'mapPanel') {
                    previousPanel = 'map';
                }
            }
            
            // Get current data for confirmation
            const currentPrice = document.getElementById('currentPrice').textContent;
            const deviceCount = 500;
            const estimatedPower = (deviceCount * 6) / 1000; // 6kW per device, convert to MW
            
            // Update confirmation modal content
            const confirmModal = document.getElementById('confirmationModal');
            // 使用i18n获取操作名称
            const getOperationName = (type) => {
                return window.i18n ? window.i18n.getText(type) : (type === 'charge' ? '充电' : '放电');
            };
            
            const operationColors = {
                'charge': '#00ff88',
                'discharge': '#ffd700'
            };
            
            // Update modal icon and color based on operation type
            const confirmIcon = document.getElementById('confirmIcon');
            const modalIcon = confirmIcon.parentElement;
            
            if (operationType === 'charge') {
                confirmIcon.textContent = '⚡';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(0, 255, 136, 0.15), rgba(0, 255, 136, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(0, 255, 136, 0.15)';
            } else if (operationType === 'discharge') {
                confirmIcon.textContent = '🔋';
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 215, 0, 0.15), rgba(255, 215, 0, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 215, 0, 0.15)';
                document.getElementById('confirmOperationType').style.color = '#ffd700';
            }
            
            // 使用i18n获取警告消息
            const getWarningMessage = (type) => {
                if (!window.i18n) {
                    return type === 'charge' ? 
                        '将开始对所有连接设备进行充电操作，此过程将消耗电网电力。' :
                        '将开始对所有连接设备进行放电操作，向电网输送电力以获取收益。';
                }
                
                const messages = {
                    'zh': {
                        'charge': '将开始对所有连接设备进行充电操作，此过程将消耗电网电力。',
                        'discharge': '将开始对所有连接设备进行放电操作，向电网输送电力以获取收益。'
                    },
                    'en': {
                        'charge': 'Will start charging all connected devices, this process will consume grid power.',
                        'discharge': 'Will start discharging all connected devices, sending power to the grid for revenue.'
                    },
                    'ja': {
                        'charge': '接続されたすべてのデバイスの充電を開始します。このプロセスでは電力網の電力を消費します。',
                        'discharge': '接続されたすべてのデバイスの放電を開始し、収益のために電力網に電力を送信します。'
                    },
                    'ko': {
                        'charge': '연결된 모든 장치의 충전을 시작합니다. 이 과정에서 전력망 전력을 소모합니다.',
                        'discharge': '연결된 모든 장치의 방전을 시작하여 수익을 위해 전력망에 전력을 보냅니다.'
                    }
                };
                
                const currentLang = window.i18n.getCurrentLanguage();
                return messages[currentLang] && messages[currentLang][type] ? 
                    messages[currentLang][type] : messages['zh'][type];
            };
            
            const operationName = getOperationName(operationType);
            const confirmTitleTexts = {
                'zh': `确认${operationName}操作`,
                'en': `Confirm ${operationName} Operation`,
                'ja': `${operationName}操作を確認`,
                'ko': `${operationName} 작업 확인`
            };
            const confirmMessageTexts = {
                'zh': `您确定要执行${operationName}操作吗？`,
                'en': `Are you sure to execute ${operationName} operation?`,
                'ja': `${operationName}操作を実行してもよろしいですか？`,
                'ko': `${operationName} 작업을 실행하시겠습니까?`
            };
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            
            document.getElementById('confirmTitle').textContent = confirmTitleTexts[currentLang] || confirmTitleTexts['zh'];
            document.getElementById('confirmMessage').textContent = confirmMessageTexts[currentLang] || confirmMessageTexts['zh'];
            document.getElementById('confirmOperationType').textContent = operationName;
            
            const deviceTexts = {
                'zh': deviceCount + '个',
                'en': deviceCount + ' devices',
                'ja': deviceCount + '台',
                'ko': deviceCount + '대'
            };
            document.getElementById('confirmTargetDevices').textContent = deviceTexts[currentLang] || deviceTexts['zh'];
            
            // 首先重置所有信息项为可见状态
            const allInfoItems = confirmModal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // Remove any dynamically added rows from previous operations
            const confirmInfoGrid = document.getElementById('confirmInfoGrid');
            const dynamicRows = confirmInfoGrid.querySelectorAll('div[style*="margin-top"]');
            dynamicRows.forEach(row => row.remove());
            
            // Hide/show fields based on user requirements
            const estimatedPowerItem = document.getElementById('confirmEstimatedPower').parentElement;
            const currentPriceItem = document.getElementById('confirmCurrentPrice').parentElement;
            const durationItem = document.getElementById('confirmDuration').parentElement;
            const costBenefitItem = document.getElementById('confirmCostBenefit').parentElement;
            
            if (operationType === 'charge') {
                // For charge: remove 预计功率, 预计时间, 当前电价, 预计获利
                estimatedPowerItem.style.display = 'none';
                currentPriceItem.style.display = 'none';
                durationItem.style.display = 'none';
                costBenefitItem.style.display = 'none';
            } else if (operationType === 'discharge') {
                // For discharge: show predicted profit in a new row
                estimatedPowerItem.style.display = 'none';
                currentPriceItem.style.display = 'none';
                durationItem.style.display = 'none';
                costBenefitItem.style.display = 'none';
                
                // Add predicted profit as a new row
                const profitRow = document.createElement('div');
                profitRow.style.cssText = 'display: flex; gap: 20px; margin-top: 20px;';
                profitRow.innerHTML = `
                    <div class="modal-info-item" style="flex: 1; max-width: calc(50% - 10px); background: rgba(255, 255, 255, 0.04); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 16px; padding: 20px 24px; transition: all 0.3s; display: flex; flex-direction: column;">
                        <div class="modal-info-label" style="color: rgba(255, 255, 255, 0.6); font-size: 14px; margin-bottom: 8px; font-weight: 400;">预计收益</div>
                        <div class="modal-info-value" style="color: #ffd700; font-size: 20px; font-weight: 600;">+$${Math.floor(estimatedPower * parseInt(currentPrice.replace('$', '')) * 0.7)}</div>
                    </div>
                    <div style="flex: 1;"></div>
                `;
                confirmInfoGrid.appendChild(profitRow);
            }
            
            // Update warning message
            document.getElementById('warningText').textContent = getWarningMessage(operationType);
            
            // Update execute button
            const executeBtn = document.getElementById('confirmExecuteBtn');
            const executeBtnTexts = {
                'zh': `确认${operationName}`,
                'en': `Confirm ${operationName}`,
                'ja': `${operationName}確認`,
                'ko': `${operationName} 확인`
            };
            executeBtn.textContent = executeBtnTexts[currentLang] || executeBtnTexts['zh'];
            
            if (operationType === 'discharge') {
                executeBtn.style.background = 'linear-gradient(135deg, #ffd700, #ffcc00)';
                executeBtn.style.color = '#000';
                executeBtn.onmouseover = function() { 
                    this.style.transform='translateY(-1px)'; 
                    this.style.boxShadow='0 6px 20px rgba(255, 215, 0, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
                executeBtn.onmouseout = function() { 
                    this.style.transform='translateY(0)'; 
                    this.style.boxShadow='0 4px 16px rgba(255, 215, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                };
            } else {
                executeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00dd77)';
                executeBtn.style.color = '#000';
            }
            
            // Show modal with animation
            confirmModal.classList.add('show');
            confirmModal.style.display = 'flex';
            
            // Add fade-in animation
            setTimeout(() => {
                confirmModal.style.opacity = '1';
            }, 10);
        }

        // Show stop operation confirmation
        function showStopConfirmation(operationType) {
            pendingOperation = 'stop_' + operationType;
            
            // Store current panel state before showing confirmation
            const activePanel = document.querySelector('.panel-content.active');
            if (activePanel) {
                if (activePanel.id === 'marketPanel') {
                    previousPanel = 'market';
                } else if (activePanel.id === 'mapPanel') {
                    previousPanel = 'map';
                }
            }
            
            const confirmModal = document.getElementById('confirmationModal');
            // 定义getOperationName函数
            const getOperationName = (type) => {
                return window.i18n ? window.i18n.getText(type) : (type === 'charge' ? '充电' : '放电');
            };
            const operationName = getOperationName(operationType);
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            
            const stopTitleTexts = {
                'zh': `停止${operationName}`,
                'en': `Stop ${operationName}`,
                'ja': `${operationName}停止`,
                'ko': `${operationName} 중지`
            };
            const stopMessageTexts = {
                'zh': `确定要停止当前的${operationName}操作吗？`,
                'en': `Are you sure to stop current ${operationName} operation?`,
                'ja': `現在の${operationName}操作を停止してもよろしいですか？`,
                'ko': `현재 ${operationName} 작업을 중지하시겠습니까?`
            };
            const stopOperationTexts = {
                'zh': `停止${operationName}`,
                'en': `Stop ${operationName}`,
                'ja': `${operationName}停止`,
                'ko': `${operationName} 중지`
            };
            const allDevicesTexts = {
                'zh': '所有设备',
                'en': 'All devices',
                'ja': 'すべてのデバイス',
                'ko': '모든 장치'
            };
            
            document.getElementById('confirmTitle').textContent = stopTitleTexts[currentLang] || stopTitleTexts['zh'];
            document.getElementById('confirmMessage').textContent = stopMessageTexts[currentLang] || stopMessageTexts['zh'];
            document.getElementById('confirmOperationType').textContent = stopOperationTexts[currentLang] || stopOperationTexts['zh'];
            document.getElementById('confirmTargetDevices').textContent = allDevicesTexts[currentLang] || allDevicesTexts['zh'];
            
            // Show only basic fields for stop operations
            const estimatedPowerItem = document.getElementById('confirmEstimatedPower').parentElement;
            const currentPriceItem = document.getElementById('confirmCurrentPrice').parentElement;
            const durationItem = document.getElementById('confirmDuration').parentElement;
            const costBenefitItem = document.getElementById('confirmCostBenefit').parentElement;
            
            // Hide all optional fields for stop operations
            estimatedPowerItem.style.display = 'none';
            currentPriceItem.style.display = 'none';
            durationItem.style.display = 'none';
            costBenefitItem.style.display = 'none';
            
            // Update warning message
            const stopWarningTexts = {
                'zh': operationType === 'charge' ? 
                    `停止操作将立即终止所有设备的Charge状态，设备将恢复到待机模式。` :
                    `停止操作将立即终止所有设备的${operationName}状态，设备将恢复到待机模式。`,
                'en': `Stop operation will immediately terminate ${operationName} state of all devices, devices will return to standby mode.`,
                'ja': `停止操作により、すべてのデバイスの${operationName}状態が即座に終了し、デバイスはスタンバイモードに戻ります。`,
                'ko': `중지 작업은 모든 장치의 ${operationName} 상태를 즉시 종료하고 장치는 대기 모드로 돌아겉니다.`
            };
            document.getElementById('warningText').textContent = stopWarningTexts[currentLang] || stopWarningTexts['zh'];
            
            // Update execute button
            const executeBtn = document.getElementById('confirmExecuteBtn');
            const confirmStopTexts = {
                'zh': '确认停止',
                'en': 'Confirm Stop',
                'ja': '停止確認',
                'ko': '중지 확인'
            };
            executeBtn.textContent = confirmStopTexts[currentLang] || confirmStopTexts['zh'];
            executeBtn.style.background = 'linear-gradient(135deg, #00ff88, #00ff88dd)';
            
            // Show modal with animation
            confirmModal.classList.add('show');
            confirmModal.style.display = 'flex';
            
            // Add fade-in animation
            setTimeout(() => {
                confirmModal.style.opacity = '1';
            }, 10);
        }

        // Close confirmation modal
        function closeConfirmationModal() {
            const modal = document.getElementById('confirmationModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
            pendingOperation = null;
            
            // Don't change panel view when canceling - keep current state
            // This ensures the UI stays in the same state when user cancels
        }

        // Execute confirmed operation
        function executeConfirmedOperation() {
            if (!pendingOperation) return;
            
            const operationType = pendingOperation;
            closeConfirmationModal();
            
            console.log('Executing confirmed operation:', operationType);
            
            if (operationType === 'stop' || operationType.startsWith('stop_')) {
                // Execute stop operation
                executeStopOperation();
            } else {
                // Execute start operation
                startOperation(operationType);
            }
            
            pendingOperation = null;
        }

        // Execute the actual operation after confirmation
        function executeOperation(operationType) {
            console.log('executeOperation called with:', operationType); // Debug log
            
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            currentOperation = operationType;
            console.log('currentOperation set to:', currentOperation); // Debug log
            
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operationType === 'charge') {
                // Update button states for charging - 只显示停止按钮
                chargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                chargeBtn.classList.remove('charge-btn');
                chargeBtn.classList.add('stop-btn');
                
                // Force apply stop button styles
                chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                chargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                chargeBtn.style.setProperty('color', '#fff', 'important');
                chargeBtn.style.removeProperty('width');
                chargeBtn.style.setProperty('flex', '1', 'important');
                chargeBtn.style.setProperty('max-width', '200px', 'important');
                chargeBtn.style.setProperty('margin', '0', 'important');
                chargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(255, 68, 68, 0.3)', 'important');
                
                // 隐藏放电按钮，设置容器为居中模式
                dischargeBtn.style.display = 'none';
                actionButtons.classList.add('operating');
                
                // Switch to map view only after confirmation
                console.log('Switching to map panel...'); // Debug log
                switchPanel('map');
                console.log('Map panel switched, starting device animation...'); // Debug log
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            } else if (operationType === 'discharge') {
                // Update button states for discharging - 只显示停止按钮
                dischargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                dischargeBtn.classList.remove('discharge-btn');
                dischargeBtn.classList.add('stop-btn');
                
                // Force apply stop button styles
                dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                dischargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                dischargeBtn.style.setProperty('color', '#fff', 'important');
                dischargeBtn.style.removeProperty('width');
                dischargeBtn.style.setProperty('flex', '1', 'important');
                dischargeBtn.style.setProperty('max-width', '200px', 'important');
                dischargeBtn.style.setProperty('margin', '0', 'important');
                dischargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(255, 68, 68, 0.3)', 'important');
                
                // 隐藏充电按钮，设置容器为居中模式
                chargeBtn.style.display = 'none';
                actionButtons.classList.add('operating');
                
                // Switch to map view only after confirmation
                console.log('Switching to map panel...'); // Debug log
                switchPanel('map');
                console.log('Map panel switched, starting device animation...'); // Debug log
                setTimeout(() => {
                    startDeviceAnimation();
                }, 200);
            }
        }


        function showDetail(type) {
            console.log('Showing detail for:', type);
            // Add detail view logic here
        }

        // Panel switching functions
        function switchPanel(panel, button) {
            console.log('switchPanel called with panel:', panel); // Debug log
            // Update panel visibility
            document.querySelectorAll('.panel-content').forEach(p => {
                p.classList.remove('active');
            });
            
            const targetPanel = document.getElementById(panel + 'Panel');
            console.log('Target panel found:', !!targetPanel); // Debug log
            if (targetPanel) {
                targetPanel.classList.add('active');
                console.log('Panel', panel, 'activated successfully'); // Debug log
            }
            
            // Update button states - always update, even if button not provided
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Find and activate the correct tab button
            if (button) {
                button.classList.add('active');
            } else {
                // If no button provided, find the tab by panel name
                const targetTab = Array.from(document.querySelectorAll('.panel-tab')).find(tab => {
                    const onclick = tab.getAttribute('onclick');
                    return onclick && onclick.includes(`'${panel}'`);
                });
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('Auto-selected tab for panel:', panel);
                }
            }
            
            // Resize charts after switching
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 100);
            
            // Additional resize with longer delay to ensure proper rendering
            setTimeout(() => {
                if (panel === 'market' && marketChart) {
                    if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                } else if (panel === 'map' && mapChart) {
                    mapChart.resize();
                }
            }, 300);
        }

        // Market region switching
        function switchMarketRegion(region, button) {
            // Update active button
            document.querySelectorAll('#marketPanel .region-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            button.classList.add('active');
            
            // Update current region
            currentRegion = region;
            
            // Update market chart with new data
            updateMarketChart(region);
            
            // Update power station management module prices
            updatePriceCircleRegion(region);
            
            // Sync cumulative price region selector
            const cumulativeTabs = document.querySelectorAll('.glass .region-tab');
            cumulativeTabs.forEach(tab => {
                if (tab.textContent === region) {
                    tab.classList.add('active');
                    // Trigger cumulative region update
                    switchCumulativeRegion(region, tab);
                } else {
                    tab.classList.remove('active');
                }
            });
        }
        
        // Update price circle region
        function updatePriceCircleRegion(region) {
            document.getElementById('regionIndicator').textContent = region;
            
            // Generate realistic price ranges for each region
            const regionPriceRanges = {
                'NSW': { base: 160, variance: 25, lowMultiplier: 0.7, highMultiplier: 1.4 },
                'QLD': { base: 145, variance: 20, lowMultiplier: 0.65, highMultiplier: 1.5 },
                'VIC': { base: 155, variance: 30, lowMultiplier: 0.6, highMultiplier: 1.6 },
                'SA': { base: 180, variance: 35, lowMultiplier: 0.55, highMultiplier: 1.7 },
                'TAS': { base: 135, variance: 15, lowMultiplier: 0.75, highMultiplier: 1.3 }
            };
            
            const priceRange = regionPriceRanges[region] || regionPriceRanges['NSW'];
            
            // Generate current price with some randomness
            const currentPrice = Math.floor(priceRange.base + (Math.random() - 0.5) * priceRange.variance);
            
            // Generate realistic daily range
            const todayLow = Math.floor(currentPrice * priceRange.lowMultiplier);
            const todayHigh = Math.floor(currentPrice * priceRange.highMultiplier);
            
            // Update main price circle
            document.getElementById('currentPrice').textContent = '$' + currentPrice;
            
            // Update price range
            document.getElementById('todayLow').textContent = '$' + todayLow;
            document.getElementById('todayHigh').textContent = '$' + todayHigh;
            
            // Add smooth transition effect
            const priceElement = document.getElementById('currentPrice');
            priceElement.style.transition = 'color 0.3s ease';
            priceElement.style.color = '#00ff88';
            setTimeout(() => {
                priceElement.style.color = '#fff';
            }, 300);
        }

        function updateMarketChart(region) {
            // Check cache first
            const currentHour = new Date().getHours();
            const cacheKey = `marketChart_${region}_${currentHour}`;
            
            const cached = dataCache.get(cacheKey);
            if (cached) {
                marketChart.setOption(cached);
                return;
            }
            
            // Generate new data based on region
            const hours = [];
            const actualPrices = [];
            const actualDemands = [];
            const forecastPrices = [];
            const forecastDemands = [];
            const currentTime = new Date().getHours();
            
            let lastPrice = 150;
            let lastDemand = 7500;
            
            // Single loop to handle all data generation correctly
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
                
                if (i < currentTime) {
                    // Historical data before current time
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    actualPrices.push(price);
                    actualDemands.push(demand);
                    forecastPrices.push(null);
                    forecastDemands.push(null);
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else if (i === currentTime) {
                    // Current time - both actual and forecast data for seamless connection
                    const price = Math.random() * 200 + 100;
                    const demand = Math.random() * 2000 + 7000;
                    
                    actualPrices.push(price);
                    actualDemands.push(demand);
                    forecastPrices.push(price); // Start forecast from current actual value
                    forecastDemands.push(demand); // Start forecast from current actual value
                    
                    lastPrice = price;
                    lastDemand = demand;
                } else {
                    // Future data - no actual data, only forecast
                    actualPrices.push(null);
                    actualDemands.push(null);
                    
                    // Generate realistic market forecast with regional characteristics
                    const hoursAhead = i - currentTime;
                    const uncertaintyMultiplier = 1 + (hoursAhead * 0.15); // Uncertainty grows over time
                    
                    // Regional price characteristics
                    const regionMultipliers = {
                        'NSW': { volatility: 1.2, trend: 0.05 },
                        'QLD': { volatility: 0.9, trend: -0.02 },
                        'VIC': { volatility: 1.1, trend: 0.03 },
                        'SA': { volatility: 1.4, trend: 0.08 },
                        'TAS': { volatility: 0.7, trend: -0.01 }
                    };
                    
                    const currentRegionData = regionMultipliers[region] || regionMultipliers['NSW'];
                    
                    // Price forecast with market dynamics
                    const priceBaseVariation = (Math.random() - 0.5) * 25 * uncertaintyMultiplier * currentRegionData.volatility;
                    const priceMarketTrend = currentRegionData.trend * hoursAhead * 10;
                    const pricePeakHours = i >= 17 && i <= 21 ? 15 + Math.random() * 20 : 0; // Evening peak
                    const priceVolatilityEvent = Math.random() < 0.15 ? (Math.random() - 0.5) * 100 : 0;
                    
                    const totalPriceVariation = priceBaseVariation + priceMarketTrend + pricePeakHours + priceVolatilityEvent;
                    const prevForecastPrice = forecastPrices[i-1];
                    
                    // Demand forecast with consumption patterns
                    const demandBaseVariation = (Math.random() - 0.5) * 500 * uncertaintyMultiplier;
                    const demandBusinessHours = (i >= 8 && i <= 18) ? 300 + Math.random() * 400 : -(Math.random() * 200);
                    const demandTemperatureFactor = (Math.random() - 0.5) * 800;
                    const demandIndustrialEvent = Math.random() < 0.12 ? (Math.random() - 0.5) * 1200 : 0;
                    
                    const totalDemandVariation = demandBaseVariation + demandBusinessHours + demandTemperatureFactor + demandIndustrialEvent;
                    const prevForecastDemand = forecastDemands[i-1];
                    
                    forecastPrices.push(Math.max(25, Math.min(500, prevForecastPrice + totalPriceVariation)));
                    forecastDemands.push(Math.max(3000, Math.min(15000, prevForecastDemand + totalDemandVariation)));
                }
            }
            
            const chartOption = {
                xAxis: { data: hours },
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('price') : '价格',
                        window.i18n ? window.i18n.getText('demand') : '需求', 
                        window.i18n ? window.i18n.getText('predictedPrice') : '预测价格',
                        window.i18n ? window.i18n.getText('predictedDemand') : '预测需求'
                    ],
                    textStyle: { color: 'rgba(255, 255, 255, 0.7)' },
                    top: 0
                },
                series: [
                    { 
                        data: actualPrices,
                        name: window.i18n ? window.i18n.getText('price') : 'Price'
                    },      // Historical prices
                    { 
                        data: actualDemands,
                        name: window.i18n ? window.i18n.getText('demand') : 'Demand'
                    },     // Historical demands  
                    { 
                        data: forecastPrices,
                        name: window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price'
                    },    // Forecast prices
                    { 
                        data: forecastDemands,
                        name: window.i18n ? window.i18n.getText('predictedDemand') : 'Predicted Demand'
                    }    // Forecast demands
                ]
            };
            
            // Cache the chart option (cache for 1 hour since market data changes)
            dataCache.set(cacheKey, chartOption);
            marketChart.setOption(chartOption);
        }

        // Auto switch functionality
        // 自动切换功能已移除
        // function toggleAutoSwitch() { }
        // function startAutoSwitch() { }
        // function stopAutoSwitch() { }

        // 处理停止操作
        function handleStop() {
            // 显示停止确认弹窗
            showStopConfirmationModal();
        }
        
        function showStopConfirmationModal() {
            // 根据当前操作确定停止类型
            const currentOp = currentOperation || 'charge'; // 默认为充电
            const isCharging = currentOp === 'charge';
            
            // 使用 confirmationModal 以保持与充电弹窗一致的样式
            const modal = document.getElementById('confirmationModal');
            if (!modal) {
                console.error('confirmationModal not found');
                return;
            }
            
            // 首先重置所有信息项为可见状态
            const allInfoItems = modal.querySelectorAll('.modal-info-item');
            allInfoItems.forEach(item => {
                item.style.display = 'flex';
                item.style.flexDirection = 'column';
            });
            
            // 设置弹窗内容
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmOperationType = document.getElementById('confirmOperationType');
            const confirmTargetDevices = document.getElementById('confirmTargetDevices');
            const warningText = document.getElementById('warningText');
            const confirmExecuteBtn = document.getElementById('confirmExecuteBtn');
            const confirmIcon = document.getElementById('confirmIcon');
            
            // 设置图标和标题
            if (confirmIcon) confirmIcon.textContent = '🛑';
            
            // Update modal icon style for stop operation
            const modalIcon = confirmIcon.parentElement;
            if (modalIcon) {
                modalIcon.style.background = 'linear-gradient(145deg, rgba(255, 68, 68, 0.15), rgba(255, 68, 68, 0.05))';
                modalIcon.style.boxShadow = '0 4px 12px rgba(255, 68, 68, 0.15)';
            }
            
            // Update operation type card color for stop
            const operationTypeElement = document.getElementById('confirmOperationType');
            if (operationTypeElement) {
                operationTypeElement.style.color = '#ff4444';
            }
            
            if (isCharging) {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopChargeTitle') : '确认停止充电';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopChargeMessage') : '您确定要停止充电操作吗？';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopCharge') : '停止充电';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopCharge') : '确认停止充电';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopChargeWarning') : '停止操作将立即终止所有设备的充电状态，设备将恢复到待机模式。';
            } else {
                if (confirmTitle) confirmTitle.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeTitle') : '确认停止放电';
                if (confirmMessage) confirmMessage.textContent = window.i18n ? window.i18n.getText('confirmStopDischargeMessage') : '您确定要停止放电操作吗？';
                if (confirmOperationType) confirmOperationType.textContent = window.i18n ? window.i18n.getText('stopDischarge') : '停止放电';
                if (confirmExecuteBtn) {
                    confirmExecuteBtn.textContent = window.i18n ? window.i18n.getText('confirmStopDischarge') : '确认停止放电';
                    confirmExecuteBtn.style.background = 'linear-gradient(135deg, #ff4444, #ff3333)';
                    confirmExecuteBtn.style.color = '#fff';
                    confirmExecuteBtn.style.boxShadow = '0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)';
                    confirmExecuteBtn.onmouseover = function() { 
                        this.style.transform='translateY(-1px)'; 
                        this.style.boxShadow='0 6px 20px rgba(255, 68, 68, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                    confirmExecuteBtn.onmouseout = function() { 
                        this.style.transform='translateY(0)'; 
                        this.style.boxShadow='0 4px 16px rgba(255, 68, 68, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.3)'; 
                    };
                }
                if (warningText) warningText.textContent = window.i18n ? window.i18n.getText('stopDischargeWarning') : '停止操作将立即终止所有设备的放电状态，设备将恢复到待机模式。';
            }
            
            // 设置影响设备数量
            if (confirmTargetDevices) confirmTargetDevices.textContent = '500个';
            
            // 隐藏其他不需要的信息项
            const estimatedPowerItem = document.getElementById('confirmEstimatedPower');
            const currentPriceItem = document.getElementById('confirmCurrentPrice');
            const durationItem = document.getElementById('confirmDuration');
            const costBenefitItem = document.getElementById('confirmCostBenefit');
            
            if (estimatedPowerItem && estimatedPowerItem.parentElement) {
                estimatedPowerItem.parentElement.style.display = 'none';
            }
            if (currentPriceItem && currentPriceItem.parentElement) {
                currentPriceItem.parentElement.style.display = 'none';
            }
            if (durationItem && durationItem.parentElement) {
                durationItem.parentElement.style.display = 'none';
            }
            if (costBenefitItem && costBenefitItem.parentElement) {
                costBenefitItem.parentElement.style.display = 'none';
            }
            
            // 设置pending operation为停止操作
            pendingOperation = 'stop';
            
            // 显示弹窗
            modal.classList.add('show');
            modal.style.display = 'flex';
            
            // 添加模态框打开动画
            setTimeout(() => {
                modal.style.opacity = '1';
            }, 10);
        }
        
        function executeStopOperation() {
            console.log('执行停止操作');
            
            // 停止设备动画
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
                mapAnimationInterval = null;
            }
            
            // 重置所有设备状态
            if (deviceLocations && deviceLocations.length > 0) {
                deviceLocations.forEach(device => {
                    device.status = 'idle';
                });
                
                // 更新地图显示
                if (mapChart) {
                    updateMapByRegion(selectedMainRegion);
                }
            }
            
            // 清除当前操作状态
            currentOperation = null;
            
            // 恢复充放电按钮
            updateActionButtonsToChargeDis();
            
            // 切换到行情页面
            switchPanel('market');
            
            // 更新地区状态 - 移除当前地区的充放电标记
            updateRegionOperationStatus(selectedMainRegion, 'none');
            
            // 更新地区状态指示器
            updateRegionStatusIndicators();
            
            // 清除电站管理标题的状态文字
            const statusText = document.getElementById('regionStatusText');
            if (statusText) {
                statusText.textContent = '';
                statusText.style.display = 'none';
            }
            
            // 显示停止确认消息
            showNotification('操作已停止', 'success');
        }
        
        // Enhanced device animation with wave effect
        function startDeviceAnimation() {
            console.log('startDeviceAnimation called'); // Debug log
            console.log('mapChart exists:', !!mapChart); // Debug log
            console.log('deviceLocations length:', deviceLocations.length); // Debug log
            
            activatedDevices = 0;
            const totalDevices = 500;
            
            // Clear previous animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
                console.log('Cleared previous animation interval'); // Debug log
            }
            
            // Update UI
            document.getElementById('totalDevices').textContent = totalDevices;
            document.getElementById('activeDevices').textContent = activatedDevices;
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentOperationText').textContent = 
                currentOperation === 'charge' ? 
                (window.i18n ? window.i18n.getText('charging') : '充电中') : 
                (window.i18n ? window.i18n.getText('discharging') : '放电中');
            
            let animationStep = 0;
            const maxSteps = totalDevices / 3; // Complete animation in ~167 steps
            
            // Start wave animation
            mapAnimationInterval = setInterval(() => {
                if (animationStep < maxSteps) {
                    // Create wave effect - activate 2-4 devices per step with some randomness
                    const baseActivation = Math.floor(3 + Math.random() * 2); // 3-4 devices
                    const waveBonus = Math.sin((animationStep / maxSteps) * Math.PI * 2) * 2; // Wave pattern
                    const actualActivation = Math.max(1, Math.floor(baseActivation + waveBonus));
                    
                    activatedDevices = Math.min(activatedDevices + actualActivation, totalDevices);
                    animationStep++;
                    
                    // Update UI with smooth progress
                    document.getElementById('activeDevices').textContent = activatedDevices;
                    document.getElementById('progressPercent').textContent = 
                        Math.floor((activatedDevices / totalDevices) * 100) + '%';
                    
                    // Update map with animation - this will sync the statistics
                    try {
                        updateMapDevicesWithAnimation(activatedDevices);
                    } catch (error) {
                        console.error('Error updating map devices:', error);
                    }
                    
                    // Add some visual effects for special milestones
                    if (activatedDevices % 50 === 0) {
                        createEnergyWave();
                    }
                    
                } else {
                    // Animation complete
                    clearInterval(mapAnimationInterval);
                    
                    // Final update to ensure all devices are activated
                    activatedDevices = totalDevices;
                    document.getElementById('activeDevices').textContent = activatedDevices;
                    document.getElementById('progressPercent').textContent = '100%';
                    
                    // 动画完成后显示统计
                    setTimeout(() => {
                        console.log('Animation complete, showing statistics for:', currentOperation);
                        showOperationStatistics();
                    }, 1000);
                }
            }, 80); // Slightly faster updates for smoother animation
        }

        function updateMapDevicesWithAnimation(activeCount) {
            if (!mapChart || !deviceLocations.length) return;
            
            // Update actual device statuses based on command progress
            // Simulate devices receiving commands and changing their real status
            const successRate = 0.85; // 85% of devices successfully receive and execute commands
            const executedDevices = Math.floor(activeCount * successRate);
            
            // Update device statuses to reflect real execution
            for (let i = 0; i < deviceLocations.length; i++) {
                const device = deviceLocations[i];
                
                if (device.status === 'offline') {
                    // Offline devices stay offline
                    continue;
                }
                
                if (i < executedDevices && currentOperation) {
                    // These devices have successfully received and executed the command
                    if (currentOperation === 'charge') {
                        device.status = 'charging';
                    } else if (currentOperation === 'discharge') {
                        device.status = 'discharging';
                    }
                } else if (i < activeCount) {
                    // These devices received command but haven't executed yet (processing)
                    device.status = 'active';
                } else {
                    // These devices are inactive/standby
                    if (device.status === 'charging' || device.status === 'discharging' || device.status === 'active') {
                        device.status = 'inactive';
                    }
                }
            }
            
            // Create animated device data based on real status
            const data = deviceLocations.map((device, index) => {
                const justActivated = index >= activeCount - 5 && index < activeCount; // Last 5 devices that got commands
                
                return {
                    value: device.value,
                    id: device.id,
                    status: device.status, // Use actual device status
                    region: device.region,
                    city: device.city,
                    justActivated: justActivated
                };
            });
            
            // Update the device series with enhanced styling
            console.log('Updating map with', data.length, 'devices'); // Debug log
            mapChart.setOption({
                series: [
                    {}, // Keep region centers unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data,
                        symbolSize: function(value, params) {
                            const status = params.data.status;
                            const justActivated = params.data.justActivated;
                            
                            if (justActivated) {
                                return 14; // Larger for just activated
                            } else if (status === 'charging' || status === 'discharging') {
                                return 8; // Larger for operational devices
                            } else if (status === 'active') {
                                return 6;
                            } else if (status === 'offline') {
                                return 4;
                            }
                            return 5;
                        },
                        itemStyle: {
                            color: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    // Bright pulse effect for just activated devices
                                    if (status === 'charging') return '#00ff88';
                                    if (status === 'discharging') return '#8A4AFF';
                                    if (status === 'active') return '#ffcc00';
                                }
                                
                                // Enhanced status colors with gradients
                                switch (status) {
                                    case 'charging': 
                                        return '#00ff88'; // Vibrant green for charging
                                    case 'discharging': 
                                        return '#FFD700'; // Yellow for discharging
                                    case 'active':
                                        return '#ffcc00'; // Bright yellow for active
                                    case 'offline': 
                                        return 'rgba(120, 120, 120, 0.4)'; // Gray for offline
                                    default:
                                        return 'rgba(255, 255, 255, 0.6)'; // Soft white for inactive
                                }
                            },
                            borderColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return '#ffffff';
                                }
                                
                                switch (status) {
                                    case 'charging': return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging': return 'rgba(255, 215, 0, 0.8)';
                                    case 'active': return 'rgba(255, 204, 0, 0.8)';
                                    default: return 'rgba(255, 255, 255, 0.4)';
                                }
                            },
                            borderWidth: function(params) {
                                const status = params.data.status;
                                if (params.data.justActivated) return 3;
                                if (status === 'charging' || status === 'discharging') return 2;
                                return 1;
                            },
                            shadowBlur: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    return 25; // Enhanced glow for new activations
                                } else if (status === 'charging' || status === 'discharging') {
                                    return 15; // Medium glow for operational devices
                                } else if (status === 'active') {
                                    return 8;
                                }
                                return 4;
                            },
                            shadowColor: function(params) {
                                const status = params.data.status;
                                const justActivated = params.data.justActivated;
                                
                                if (justActivated) {
                                    if (status === 'charging') return 'rgba(0, 255, 136, 0.9)';
                                    if (status === 'discharging') return 'rgba(255, 51, 102, 0.9)';
                                    if (status === 'active') return 'rgba(255, 204, 0, 0.9)';
                                }
                                
                                switch (status) {
                                    case 'charging':
                                        return 'rgba(0, 255, 136, 0.8)';
                                    case 'discharging':
                                        return 'rgba(255, 215, 0, 0.8)';
                                    case 'active':
                                        return 'rgba(255, 170, 0, 0.8)';
                                    default:
                                        return 'rgba(255, 255, 255, 0.3)';
                                }
                            }
                        },
                        emphasis: {
                            scale: 1.8,
                            itemStyle: {
                                shadowBlur: 30,
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': return 'rgba(0, 255, 136, 1)';
                                        case 'discharging': return 'rgba(255, 215, 0, 1)';
                                        case 'active': return 'rgba(255, 204, 0, 1)';
                                        default: return 'rgba(255, 255, 255, 0.8)';
                                    }
                                },
                                borderWidth: 3,
                                borderColor: '#ffffff'
                            }
                        },
                        animation: true,
                        animationDuration: 800,
                        animationEasing: 'cubicOut'
                    }
                ]
            });
            
            console.log('Map setOption completed successfully'); // Debug log
            
            // Update map statistics with current active count
            updateMapStatistics(activeCount);
        }

        function createEnergyWave() {
            // Visual effect for energy wave (could be enhanced with more sophisticated graphics)
            if (mapChart) {
                const option = mapChart.getOption();
                
                // Add temporary graphic element for wave effect
                const waveGraphic = {
                    type: 'circle',
                    shape: {
                        cx: 300,
                        cy: 250,
                        r: 50
                    },
                    style: {
                        stroke: currentOperation === 'charge' ? '#00ff88' : '#8A4AFF',
                        lineWidth: 3,
                        fill: 'transparent',
                        opacity: 0.8
                    },
                    z: 10
                };
                
                // Add wave and remove after animation
                setTimeout(() => {
                    if (mapChart) {
                        const currentGraphic = mapChart.getOption().graphic || [];
                        mapChart.setOption({
                            graphic: [...currentGraphic, waveGraphic]
                        });
                        
                        // Remove wave after 500ms
                        setTimeout(() => {
                            updateMapStatistics(); // This resets the graphic to just statistics
                        }, 500);
                    }
                }, 50);
            }
        }

        function updateMapDevices(activeCount) {
            if (!mapChart || !deviceLocations.length) return;
            
            // Create updated device data that works with both geo and cartesian2d
            const data = deviceLocations.map((device, index) => {
                const isActive = index < activeCount;
                
                return {
                    name: `设备${device.id}`,
                    value: device.value.concat ? device.value.concat([device.id]) : device.value,
                    id: device.id,
                    status: isActive ? 'active' : 'inactive',
                    city: device.city
                };
            });
            
            // Update the device series (series[1], after cities series[0])
            mapChart.setOption({
                series: [
                    {}, // Keep cities unchanged
                    {
                        name: 'Devices',
                        type: 'scatter',
                        data: data
                    }
                ]
            });
            
            // Update legend with new counts
            updateMapLegend();
        }

        function stopOperation() {
            // Stop animation
            if (mapAnimationInterval) {
                clearInterval(mapAnimationInterval);
            }
            
            // 立即切换到市场页面
            switchPanel('market');
            
            // 强制确保切换成功
            setTimeout(() => {
                const marketTab = document.querySelector('[onclick*="switchPanel(\'market\')"]');
                const mapTab = document.querySelector('[onclick*="switchPanel(\'map\')"]');
                
                if (marketTab && mapTab) {
                    marketTab.classList.add('active');
                    mapTab.classList.remove('active');
                }
                
                const marketPanel = document.getElementById('marketPanel');
                const mapPanel = document.getElementById('mapPanel');
                
                if (marketPanel && mapPanel) {
                    marketPanel.style.display = 'block';
                    mapPanel.style.display = 'none';
                }
            }, 10);
            
            // Show operation completion modal with device response statistics
            setTimeout(() => {
                showOperationStatistics();
            }, 500);
            
            // Start gradual device reset animation
            startDeviceResetAnimation();
            
            // Update UI to initial state
            document.getElementById('activeDevices').textContent = '0';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('currentOperationText').textContent = '无';
            document.getElementById('totalDevices').textContent = '500';
            
            // Reset buttons to original state
            resetButtons();
            
            // Don't reset currentOperation immediately - keep it for the modal
            // It will be reset when the modal is closed
            
            // Update map to show initial device distribution
            updateMapStatistics();
        }

        function startDeviceResetAnimation() {
            console.log('Starting device reset animation...');
            
            let resetStep = 0;
            const maxResetSteps = 50; // Reset animation over 50 steps
            const devicesPerStep = Math.ceil(deviceLocations.length / maxResetSteps);
            
            const resetInterval = setInterval(() => {
                if (resetStep >= maxResetSteps) {
                    clearInterval(resetInterval);
                    activatedDevices = 0;
                    console.log('Device reset animation completed');
                    return;
                }
                
                // Reset a batch of devices each step
                const startIndex = resetStep * devicesPerStep;
                const endIndex = Math.min(startIndex + devicesPerStep, deviceLocations.length);
                
                for (let i = startIndex; i < endIndex; i++) {
                    const device = deviceLocations[i];
                    // Gradually change to initial status distribution
                    const rand = Math.random();
                    if (rand < 0.05) {
                        device.status = 'offline';  // 5% offline
                    } else if (rand < 0.12) {
                        device.status = 'discharging';  // 7% discharging
                    } else if (rand < 0.18) {
                        device.status = 'charging';  // 6% charging
                    } else {
                        device.status = 'inactive';  // 82% inactive
                    }
                }
                
                // Update map display
                updateMapWithDeviceStates();
                
                resetStep++;
            }, 100); // Update every 100ms for smooth animation
        }

        function resetDevicesToInitialState() {
            // Reset all devices to their original initial status
            deviceLocations.forEach(device => {
                const rand = Math.random();
                if (rand < 0.05) {
                    device.status = 'offline';  // 5% offline
                } else if (rand < 0.12) {
                    device.status = 'discharging';  // 7% discharging
                } else if (rand < 0.18) {
                    device.status = 'charging';  // 6% charging
                } else {
                    device.status = 'inactive';  // 82% inactive
                }
            });
            
            // Update the map with initial device states
            if (mapChart && deviceLocations.length) {
                const data = deviceLocations.map(device => ({
                    value: device.value,
                    id: device.id,
                    status: device.status,
                    region: device.region,
                    city: device.city
                }));
                
                mapChart.setOption({
                    series: [
                        {}, // Keep state centers unchanged
                        {
                            name: 'Devices',
                            type: 'scatter',
                            data: data,
                            symbolSize: function(value, params) {
                                const status = params.data.status;
                                if (status === 'charging' || status === 'discharging') {
                                    return 8;
                                } else if (status === 'offline') {
                                    return 3;
                                }
                                return 5;
                            },
                            itemStyle: {
                                color: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging': 
                                            return '#00ff88';
                                        case 'discharging': 
                                            return '#FFD700';
                                        case 'offline': 
                                            return 'rgba(255, 255, 255, 0.2)';
                                        default: 
                                            return 'rgba(255, 255, 255, 0.5)';
                                    }
                                },
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 1,
                                shadowBlur: function(params) {
                                    const status = params.data.status;
                                    return (status === 'charging' || status === 'discharging') ? 10 : 3;
                                },
                                shadowColor: function(params) {
                                    const status = params.data.status;
                                    switch (status) {
                                        case 'charging':
                                            return 'rgba(0, 255, 136, 0.8)';
                                        case 'discharging':
                                            return 'rgba(255, 215, 0, 0.8)';
                                        default:
                                            return 'rgba(255, 255, 255, 0.3)';
                                    }
                                }
                            },
                            animation: true,
                            animationDuration: 800,
                            animationEasing: 'cubicOut'
                        }
                    ]
                });
            }
        }

        function resetButtons() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            const actionButtons = document.querySelector('.action-buttons');
            
            // Reset charge button
            chargeBtn.textContent = window.i18n ? window.i18n.getText('charge') : '充电';
            chargeBtn.classList.remove('stop-btn');
            chargeBtn.classList.add('charge-btn');
            chargeBtn.style.display = 'block';
            
            // Reset discharge button
            dischargeBtn.textContent = window.i18n ? window.i18n.getText('discharge') : '放电';
            dischargeBtn.classList.remove('stop-btn');
            dischargeBtn.classList.add('discharge-btn');
            dischargeBtn.style.display = 'block';
            
            // Reset container
            actionButtons.classList.remove('operating');
        }

        // Update map statistics display (shows actual device status, not command status)
        function updateMapStatistics(activeCount = 0) {
            if (!deviceLocations || !mapChart) return;
            
            // Always count actual device statuses regardless of command progress
            let counts = {
                charging: 0,
                discharging: 0,
                processing: 0, // Devices that received command but not executing yet
                inactive: 0,
                offline: 0
            };
            
            // Count actual device statuses
            deviceLocations.forEach(device => {
                switch (device.status) {
                    case 'charging':
                        counts.charging++;
                        break;
                    case 'discharging':
                        counts.discharging++;
                        break;
                    case 'active': // Command received, processing
                        counts.processing++;
                        break;
                    case 'offline':
                        counts.offline++;
                        break;
                    case 'inactive':
                    default:
                        counts.inactive++;
                        break;
                }
            });

            // Update statistics display without background box
            const statisticsGraphic = [
                {
                    type: 'group',
                    right: 20,
                    top: 20,
                    children: [
                        // Charging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#00ff88' },
                            position: [-15, 6],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('charging') : '充电中'}: ${counts.charging}`,
                                fill: '#00ff88',
                                fontSize: 12
                            },
                            position: [0, 0],
                            z: 101
                        },
                        // Discharging indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: '#FFD700' },
                            position: [-15, 26],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('discharging') : '放电中'}: ${counts.discharging}`,
                                fill: '#FFD700',
                                fontSize: 12
                            },
                            position: [0, 20],
                            z: 101
                        },
                        // Standby indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: 'rgba(255, 255, 255, 0.8)' },
                            position: [-15, 46],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('standby') : '待机'}: ${counts.inactive}`,
                                fill: 'rgba(255, 255, 255, 0.8)',
                                fontSize: 12
                            },
                            position: [0, 40],
                            z: 101
                        },
                        // Offline indicator
                        {
                            type: 'circle',
                            shape: { r: 5 },
                            style: { fill: 'rgba(255, 255, 255, 0.3)' },
                            position: [-15, 66],
                            z: 101
                        },
                        {
                            type: 'text',
                            style: {
                                text: `${window.i18n ? window.i18n.getText('offline') : '离线'}: ${counts.offline}`,
                                fill: 'rgba(255, 255, 255, 0.5)',
                                fontSize: 12
                            },
                            position: [0, 60],
                            z: 101
                        }
                    ]
                }
            ];

            // Update the chart with new statistics
            mapChart.setOption({
                graphic: statisticsGraphic
            });
        }

        function fullReset() {
            resetButtons();
            currentOperation = null;
        }

        // 新的操作统计显示函数
        function showOperationStatistics() {
            console.log('Showing operation statistics for:', currentOperation);
            
            const modal = document.getElementById('operationModal');
            const title = document.getElementById('modalTitle');
            const message = document.getElementById('modalMessage');
            const statusSummary = document.getElementById('statusSummary');
            const modalInfoGrid = document.querySelector('.modal-info-grid');
            const operationType = document.getElementById('operationType');
            const targetDevices = document.getElementById('targetDevices');
            
            if (!modal) {
                console.error('操作统计模态框未找到！');
                return;
            }
            
            // 设置标题和消息
            let operationName = '';
            let messageText = '';
            
            if (currentOperation === 'charge') {
                operationName = window.i18n ? window.i18n.getText('charge') : '充电';
                messageText = window.i18n ? window.i18n.getText('chargeCompleteMessage') : '充电指令下发完成，以下是设备响应统计报告：';
            } else if (currentOperation === 'discharge') {
                operationName = window.i18n ? window.i18n.getText('discharge') : '放电';
                messageText = window.i18n ? window.i18n.getText('dischargeCompleteMessage') : '放电指令下发完成，以下是设备响应统计报告：';
            } else {
                // 停止操作时，显示停止充电/放电
                operationName = window.i18n ? window.i18n.getText('stopChargeDischarge') : '停止充电/放电';
                messageText = window.i18n ? window.i18n.getText('stopCompleteMessage') : '停止指令下发完成，以下是设备响应统计报告：';
            }
            
            if (title) title.textContent = window.i18n ? window.i18n.getText('deviceResponseStatistics') : '设备响应统计';
            if (message) message.textContent = messageText;
            
            // 设置基本信息
            if (operationType) operationType.textContent = operationName;
            if (targetDevices) {
                const unit = window.i18n && window.i18n.getCurrentLanguage() === 'en' ? ' units' : '个';
                targetDevices.textContent = '500' + unit;
            }
            
            // 显示基本信息和统计信息
            if (modalInfoGrid) modalInfoGrid.style.display = 'grid';
            if (statusSummary) statusSummary.style.display = 'block';
            
            // 设置统计数据
            const stats = {
                dispatched: 500,
                received: Math.floor(Math.random() * 30) + 470, // 470-499
                activated: Math.floor(Math.random() * 30) + 440, // 440-469
            };
            stats.successRate = Math.floor((stats.activated / stats.dispatched) * 100);
            
            // 更新统计显示
            const dispatchedEl = document.getElementById('devicesDispatched');
            const receivedEl = document.getElementById('devicesReceived');
            const activatedEl = document.getElementById('devicesActivated');
            const successRateEl = document.getElementById('successRate');
            
            if (dispatchedEl) dispatchedEl.textContent = stats.dispatched;
            if (receivedEl) receivedEl.textContent = stats.received;
            if (activatedEl) activatedEl.textContent = stats.activated;
            if (successRateEl) successRateEl.textContent = stats.successRate + '%';
            
            // 强制显示模态框
            modal.style.setProperty('display', 'block', 'important');
            modal.style.setProperty('z-index', '9999', 'important');
            
            console.log('操作统计模态框已显示');
        }

        // 直接复制操作记录页面的抽屉组件
        class HomeOperationDrawer extends DrawerComponent {
            constructor() {
                super({
                    containerId: 'homeOperationDrawer',
                    title: window.i18n ? window.i18n.getText('operationDetails') : '操作记录详情',
                    width: '500px',
                    tabs: [
                        { key: 'basic', label: window.i18n ? window.i18n.getText('basicInfo') : '基本信息' },
                        { key: 'stations', label: window.i18n ? window.i18n.getText('stationDetails') : '电站详情' },
                        { key: 'timeline', label: window.i18n ? window.i18n.getText('executionTimeline') : '执行时间线' }
                    ],
                    onClose: () => {
                        console.log('操作记录抽屉关闭');
                    },
                    onTabSwitch: (tabKey, data) => {
                        this.setContent(data, tabKey);
                    }
                });
                
                // 在创建后立即设置z-index
                this.forceTopZIndex();
            }
            
            forceTopZIndex() {
                // 使用定时器确保DOM已经创建
                const attempts = 0;
                const maxAttempts = 10;
                
                const setZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // 设置抽屉的z-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // 设置内部元素的z-index
                        const allElements = drawer.querySelectorAll('*');
                        allElements.forEach(el => {
                            el.style.setProperty('z-index', '2147483647', 'important');
                        });
                        
                        console.log('Drawer z-index force set to maximum');
                        return true;
                    }
                    return false;
                };
                
                // 立即尝试一次
                if (!setZIndex() && attempts < maxAttempts) {
                    // 如果失败，使用定时器重试
                    const interval = setInterval(() => {
                        if (setZIndex() || attempts >= maxAttempts) {
                            clearInterval(interval);
                        }
                        attempts++;
                    }, 100);
                }
            }
            
            // 重写open方法确保z-index最高
            open(data = null) {
                super.open(data);
                
                // 多次确保z-index设置
                const ensureZIndex = () => {
                    const drawer = document.getElementById(this.containerId);
                    if (drawer) {
                        // 设置容器z-index
                        drawer.style.setProperty('z-index', '2147483647', 'important');
                        drawer.style.setProperty('position', 'fixed', 'important');
                        
                        // 设置所有子元素
                        const overlay = drawer.querySelector('.drawer-overlay');
                        const container = drawer.querySelector('.drawer-container');
                        
                        if (overlay) {
                            overlay.style.setProperty('z-index', '2147483647', 'important');
                            overlay.style.setProperty('position', 'fixed', 'important');
                        }
                        
                        if (container) {
                            container.style.setProperty('z-index', '2147483647', 'important');
                            container.style.setProperty('position', 'fixed', 'important');
                        }
                    }
                };
                
                // 立即执行
                ensureZIndex();
                
                // 延迟执行多次以确保
                [10, 50, 100, 200, 500].forEach(delay => {
                    setTimeout(ensureZIndex, delay);
                });
                
                // 再次强制设置z-index
                this.forceTopZIndex();
            }
            
            generateContent(operation, tabKey) {
                if (!operation) return `<div>Loading data...</div>`;
                
                const commandInfo = this.getCommandInfo(operation.command);
                
                switch(tabKey) {
                    case 'basic':
                        return this.generateBasicInfo(operation, commandInfo);
                    case 'stations':
                        return this.generateStationDetails(operation);
                    case 'timeline':
                        return this.generateTimeline(operation);
                    default:
                        return this.generateBasicInfo(operation, commandInfo);
                }
            }
            
            getCommandInfo(command) {
                const commandTexts = {
                    'charge': window.i18n ? window.i18n.getText('charge') : '充电',
                    'discharge': window.i18n ? window.i18n.getText('discharge') : '放电',
                    'stop': window.i18n ? window.i18n.getText('stop') : '停止'
                };
                const commandMap = {
                    'charge': { text: commandTexts['charge'], class: 'charge' },
                    'discharge': { text: commandTexts['discharge'], class: 'discharge' },
                    'stop': { text: commandTexts['stop'], class: 'stop' }
                };
                return commandMap[command] || { text: command, class: 'default' };
            }

            generateBasicInfo(operation, commandInfo) {
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📊</span>
                            ${window.i18n ? window.i18n.getText('operationOverview') : '操作概览'}
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value">${operation.stations || operation.dispatched}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('totalStations') : '总电站数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.success || operation.activated}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successCount') : '成功数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.failed || (operation.dispatched - operation.activated)}</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('failedCount') : '失败数'}</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${operation.successRate || Math.round((operation.activated / operation.dispatched) * 100)}%</div>
                                <div class="stat-label">${window.i18n ? window.i18n.getText('successRate') : '成功率'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>📝</span>
                            ${window.i18n ? window.i18n.getText('basicInfo') : '基本信息'}
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationTime') : '操作时间'}</span>
                            <span class="detail-value">${operation.time || new Date().toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationCommand') : '操作命令'}</span>
                            <span class="detail-value">
                                <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                            </span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operator') : '操作人员'}</span>
                            <span class="detail-value">${window.i18n ? window.i18n.getText('systemAdmin') : '系统管理员'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('operationId') : '操作编号'}</span>
                            <span class="detail-value">#${operation.id ? operation.id.toString().padStart(8, '0') : Date.now().toString().slice(-8)}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${window.i18n ? window.i18n.getText('executionStatus') : '执行状态'}</span>
                            <span class="detail-value">
                                <span class="status-tag success">${window.i18n ? window.i18n.getText('allSuccess') : '全部成功'}</span>
                            </span>
                        </div>
                    </div>
                `;
            }

            generateStationDetails(operation) {
                // 生成模拟的电站数据
                const stationCount = operation.stations || operation.dispatched || 500;
                const successCount = operation.success || operation.activated || 450;
                const stations = [];
                for (let i = 0; i < Math.min(stationCount, 10); i++) {
                    const isSuccess = i < successCount;
                    stations.push({
                        id: `ST${(1000 + i).toString()}`,
                        name: `${window.i18n ? window.i18n.getText('station') : '电站'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                        status: isSuccess ? 'success' : 'failed',
                        location: `${window.i18n ? window.i18n.getText('area') : '区域'}${Math.floor(i / 10) + 1}`,
                        executeTime: new Date(new Date().getTime() + i * 1000).toLocaleTimeString('zh-CN')
                    });
                }
                
                return `
                    <div class="detail-section flex-fill">
                        <div class="detail-section-title">
                            <span>⚡</span>
                            ${window.i18n ? window.i18n.getText('stationExecutionDetails') : '电站执行详情'}
                        </div>
                        <div class="scrollable-list">
                            ${stations.map(station => `
                                <div class="detail-row">
                                    <div>
                                        <div class="detail-label">${station.name} (${station.id})</div>
                                        <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                            ${station.location} • ${station.executeTime}
                                        </div>
                                    </div>
                                    <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                        ${station.status === 'success' ? (window.i18n ? window.i18n.getText('success') : '成功') : (window.i18n ? window.i18n.getText('failed') : '失败')}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            generateTimeline(operation) {
                const startTime = new Date(operation.time || Date.now());
                const successCount = operation.success || operation.activated || 450;
                const failedCount = operation.failed || (operation.dispatched - operation.activated) || 50;
                const timeline = [
                    { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('commandCreated') : '操作命令创建', status: 'success' },
                    { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('validationPassed') : '命令验证通过', status: 'success' },
                    { time: startTime, event: window.i18n ? window.i18n.getText('executionStarted') : '开始执行命令', status: 'success' },
                    { time: new Date(startTime.getTime() + 30000), event: `${successCount}${window.i18n ? window.i18n.getText('stationsSuccess') : '个电站执行成功'}`, status: 'success' },
                ];
                
                if (failedCount > 0) {
                    timeline.push({
                        time: new Date(startTime.getTime() + 45000),
                        event: `${failedCount}${window.i18n ? window.i18n.getText('stationsFailed') : '个电站执行失败'}`,
                        status: 'danger'
                    });
                }
                
                timeline.push({
                    time: new Date(startTime.getTime() + 60000),
                    event: window.i18n ? window.i18n.getText('executionCompleted') : '操作执行完成',
                    status: failedCount === 0 ? 'success' : 'warning'
                });
                
                return `
                    <div class="detail-section">
                        <div class="detail-section-title">
                            <span>🕰️</span>
                            ${window.i18n ? window.i18n.getText('executionTimeline') : '执行时间线'}
                        </div>
                        <div style="position: relative; padding-left: 24px;">
                            <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                            ${timeline.map((item, index) => `
                                <div style="position: relative; margin-bottom: 24px;">
                                    <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                    <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                        <span class="detail-label">${item.event}</span>
                                        <span class="status-tag ${item.status}">
                                            ${item.status === 'success' ? (window.i18n ? window.i18n.getText('normal') : '正常') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('warning') : '警告') : (window.i18n ? window.i18n.getText('error') : '错误')}
                                        </span>
                                    </div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                        ${item.time.toLocaleString('zh-CN')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        // 初始化抽屉组件
        let homeOperationDrawer;

        // 打开操作详情抽屉
        function openOperationDrawer() {
            console.log('Opening operation drawer');
            
            if (!homeOperationDrawer) {
                homeOperationDrawer = new HomeOperationDrawer();
            }

            // 构造操作记录格式的数据
            const dispatched = parseInt(document.getElementById('devicesDispatched')?.textContent || '500');
            const activated = parseInt(document.getElementById('devicesActivated')?.textContent || '452');
            const operation = {
                id: Date.now() % 100000000,
                time: new Date().toLocaleString('zh-CN'),
                command: currentOperation || 'charge',
                operator: 'admin',
                stations: dispatched,
                success: activated,
                failed: dispatched - activated,
                dispatched: dispatched,
                activated: activated,
                successRate: Math.round((activated / dispatched) * 100)
            };

            console.log('Drawer operation data:', operation);
            
            // 直接打开抽屉并设置内容
            homeOperationDrawer.open();
            
            // 强制确保抽屉在最顶层
            setTimeout(() => {
                const drawerElement = document.getElementById('homeOperationDrawer');
                if (drawerElement) {
                    // 设置最高z-index
                    drawerElement.style.setProperty('z-index', '2147483647', 'important');
                    drawerElement.style.setProperty('position', 'fixed', 'important');
                    
                    // 查找并设置overlay的z-index
                    const overlay = document.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483646', 'important');
                        overlay.style.setProperty('position', 'fixed', 'important');
                    }
                    
                    // 查找抽屉容器
                    const container = drawerElement.querySelector('.drawer-container') || 
                                    document.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                        container.style.setProperty('position', 'fixed', 'important');
                    }
                    
                    console.log('Force set all drawer elements to maximum z-index');
                }
            }, 100);
            
            // 设置内容数据
            homeOperationDrawer.setContent(operation, 'basic');
        }

        // 全局z-index监控器
        function startDrawerZIndexMonitor() {
            setInterval(() => {
                const drawer = document.getElementById('homeOperationDrawer');
                if (drawer && drawer.style.display !== 'none') {
                    // 确保抽屉始终在最顶层
                    drawer.style.setProperty('z-index', '2147483647', 'important');
                    drawer.style.setProperty('position', 'fixed', 'important');
                    
                    const overlay = drawer.querySelector('.drawer-overlay');
                    if (overlay) {
                        overlay.style.setProperty('z-index', '2147483647', 'important');
                    }
                    
                    const container = drawer.querySelector('.drawer-container');
                    if (container) {
                        container.style.setProperty('z-index', '2147483647', 'important');
                    }
                }
            }, 100);
        }

        // 关闭模态框函数
        function closeModal() {
            const modal = document.getElementById('operationModal');
            const statusSummary = document.getElementById('statusSummary');
            const infoGrid = document.querySelector('.modal-info-grid');
            
            modal.style.display = 'none';
            
            // Reset modal display states
            statusSummary.style.display = 'none';
            infoGrid.style.display = 'grid';
            
            // Reset current operation after modal is closed
            currentOperation = null;
        }

        function viewDetails() {
            // Close the modal
            closeModal();
            
            // Update details panel with current operation data
            const detailsPanel = document.getElementById('operationDetailsPanel');
            const operationType = document.getElementById('operationType').textContent;
            const targetDevices = document.getElementById('targetDevices').textContent;
            const estimatedProfit = document.getElementById('estimatedProfit').textContent;
            
            // Update details panel content
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = targetDevices;
            document.getElementById('detailsEstimatedProfit').textContent = estimatedProfit;
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
            
            // Update execution status numbers
            document.getElementById('detailsDispatched').textContent = document.getElementById('devicesDispatched').textContent;
            document.getElementById('detailsReceived').textContent = document.getElementById('devicesReceived').textContent;
            document.getElementById('detailsActivated').textContent = document.getElementById('devicesActivated').textContent;
            
            // Show the details panel
            detailsPanel.style.display = 'block';
            setTimeout(() => {
                detailsPanel.classList.add('show');
            }, 10);
        }
        
        // Remove duplicate function - using the one at line 5875 instead

        function closeDetailsPanel() {
            const detailsPanel = document.getElementById('operationDetailsPanel');
            detailsPanel.classList.remove('show');
            setTimeout(() => {
                detailsPanel.style.display = 'none';
            }, 300);
        }

        function populateOperationDrawerData() {
            console.log('populateOperationDrawerData called with currentOperation:', currentOperation);
            // Update basic information
            const operationType = currentOperation === 'charge' ? '充电' : (currentOperation === 'discharge' ? '放电' : '停止操作');
            document.getElementById('detailsOperationType').textContent = operationType;
            document.getElementById('detailsTargetDevices').textContent = '500个设备';
            document.getElementById('detailsEstimatedProfit').textContent = '+$340';
            document.getElementById('detailsOperationTime').textContent = new Date().toLocaleString();
            console.log('Operation drawer data populated successfully');
        }

        // Operation Details Tabs Functions (copied from OperationDrawer)
        let currentOperationData = null;
        let activeOperationTab = 'basic';

        function switchOperationTab(tabKey) {
            // Update active tab
            document.querySelectorAll('.operation-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabKey}"]`).classList.add('active');
            
            activeOperationTab = tabKey;
            
            // Generate content for the selected tab
            if (currentOperationData) {
                generateOperationTabContent(currentOperationData, tabKey);
            }
        }

        function generateOperationTabContent(operation, tabKey) {
            const contentContainer = document.getElementById('operationTabContent');
            
            switch(tabKey) {
                case 'basic':
                    contentContainer.innerHTML = generateBasicInfo(operation);
                    break;
                case 'stations':
                    contentContainer.innerHTML = generateStationDetails(operation);
                    break;
                case 'timeline':
                    contentContainer.innerHTML = generateTimeline(operation);
                    break;
                default:
                    contentContainer.innerHTML = generateBasicInfo(operation);
            }
        }

        function generateBasicInfo(operation) {
            const commandInfo = getCommandInfo(operation.command);
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>📊</span>
                        ${window.i18n ? window.i18n.getText('operationLog.overview.title') : '操作概览'}
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${operation.stations}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.totalStations') : '总电站数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.success}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successCount') : '成功数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${operation.failed}</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.failedCount') : '失败数'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${Math.round((operation.success / operation.stations) * 100)}%</div>
                            <div class="stat-label">${window.i18n ? window.i18n.getText('operationLog.overview.successRate') : '成功率'}</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>📝</span>
                        ${window.i18n ? window.i18n.getText('operationLog.basicInfo.title') : '基本信息'}
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationTime') : '操作时间'}</span>
                        <span class="detail-value">${operation.time}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationCommand') : '操作命令'}</span>
                        <span class="detail-value">
                            <span class="command-tag ${commandInfo.class}">${commandInfo.text}</span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operator') : '操作人员'}</span>
                        <span class="detail-value">${getOperatorName(operation.operator)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.operationId') : '操作编号'}</span>
                        <span class="detail-value">#${operation.id.toString().padStart(8, '0')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">${window.i18n ? window.i18n.getText('operationLog.basicInfo.executionStatus') : '执行状态'}</span>
                        <span class="detail-value">
                            <span class="status-tag ${operation.failed === 0 ? 'success' : operation.success > operation.failed ? 'warning' : 'danger'}">
                                ${operation.failed === 0 ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.allSuccess') : '全部成功') : operation.success > operation.failed ? (window.i18n ? window.i18n.getText('operationLog.basicInfo.partialSuccess') : '部分成功') : (window.i18n ? window.i18n.getText('operationLog.basicInfo.mostlyFailed') : '多数失败')}
                            </span>
                        </span>
                    </div>
                </div>
            `;
        }

        function generateStationDetails(operation) {
            // Generate simulated station data
            const stations = [];
            for (let i = 0; i < operation.stations; i++) {
                const isSuccess = i < operation.success;
                stations.push({
                    id: `ST${(1000 + i).toString()}`,
                    name: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.station') : '电站'}${String.fromCharCode(65 + (i % 26))}${Math.floor(i / 26) + 1}`,
                    status: isSuccess ? 'success' : 'failed',
                    location: `${window.i18n ? window.i18n.getText('operationLog.stationDetails.area') : '区域'}${Math.floor(i / 10) + 1}`,
                    executeTime: new Date(new Date(operation.time).getTime() + i * 1000).toLocaleTimeString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')
                });
            }
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>⚡</span>
                        ${window.i18n ? window.i18n.getText('operationLog.stationDetails.title') : '电站执行详情'}
                    </div>
                    <div class="scrollable-list">
                        ${stations.map(station => `
                            <div class="detail-row">
                                <div>
                                    <div class="detail-label">${station.name} (${station.id})</div>
                                    <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5); margin-top: 2px;">
                                        ${station.location} • ${station.executeTime}
                                    </div>
                                </div>
                                <span class="status-tag ${station.status === 'success' ? 'success' : 'danger'}">
                                    ${station.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.stationDetails.success') : '成功') : (window.i18n ? window.i18n.getText('operationLog.stationDetails.failed') : '失败')}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function generateTimeline(operation) {
            const startTime = new Date(operation.time);
            const timeline = [
                { time: new Date(startTime.getTime() - 60000), event: window.i18n ? window.i18n.getText('operationLog.timeline.commandCreated') : '操作命令创建', status: 'success' },
                { time: new Date(startTime.getTime() - 30000), event: window.i18n ? window.i18n.getText('operationLog.timeline.validationPassed') : '命令验证通过', status: 'success' },
                { time: startTime, event: window.i18n ? window.i18n.getText('operationLog.timeline.executionStarted') : '开始执行命令', status: 'success' },
                { time: new Date(startTime.getTime() + 30000), event: `${operation.success}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsSuccess') : '个电站执行成功'}`, status: 'success' },
            ];
            
            if (operation.failed > 0) {
                timeline.push({
                    time: new Date(startTime.getTime() + 45000),
                    event: `${operation.failed}${window.i18n ? window.i18n.getText('operationLog.timeline.stationsFailed') : '个电站执行失败'}`,
                    status: 'danger'
                });
            }
            
            timeline.push({
                time: new Date(startTime.getTime() + 60000),
                event: window.i18n ? window.i18n.getText('operationLog.timeline.executionCompleted') : '操作执行完成',
                status: operation.failed === 0 ? 'success' : 'warning'
            });
            
            return `
                <div class="detail-section">
                    <div class="detail-section-title">
                        <span>🕰️</span>
                        ${window.i18n ? window.i18n.getText('operationLog.timeline.title') : '执行时间线'}
                    </div>
                    <div style="position: relative; padding-left: 24px;">
                        <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: rgba(255, 255, 255, 0.1);"></div>
                        ${timeline.map((item, index) => `
                            <div style="position: relative; margin-bottom: 24px;">
                                <div style="position: absolute; left: -20px; top: 2px; width: 12px; height: 12px; border-radius: 50%; background: ${item.status === 'success' ? '#34c759' : item.status === 'warning' ? '#ff9500' : '#ff3b30'};"></div>
                                <div class="detail-row" style="border: none; padding: 0; margin-bottom: 4px;">
                                    <span class="detail-label">${item.event}</span>
                                    <span class="status-tag ${item.status}">
                                        ${item.status === 'success' ? (window.i18n ? window.i18n.getText('operationLog.timeline.normal') : '正常') : item.status === 'warning' ? (window.i18n ? window.i18n.getText('operationLog.timeline.warning') : '警告') : (window.i18n ? window.i18n.getText('operationLog.timeline.error') : '错误')}
                                    </span>
                                </div>
                                <div style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">
                                    ${item.time.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Helper functions
        function getCommandInfo(command) {
            const commands = {
                'charge': { text: window.i18n ? window.i18n.getText('charge') : '充电', class: 'charge' },
                'discharge': { text: window.i18n ? window.i18n.getText('discharge') : '放电', class: 'discharge' }
            };
            return commands[command] || { text: command, class: 'charge' };
        }

        function getOperatorName(operator) {
            const operators = {
                'admin': window.i18n ? window.i18n.getText('systemAdmin') : '系统管理员',
                'user1': window.i18n ? window.i18n.getText('operatorA') : '操作员A',
                'user2': window.i18n ? window.i18n.getText('operatorB') : '操作员B'
            };
            return operators[operator] || operator;
        }

        // Initialize operation data when modal shows device response statistics
        function initializeOperationData() {
            const now = new Date();
            currentOperationData = {
                id: Math.floor(Math.random() * 1000000),
                time: now.toLocaleString(window.i18n ? (window.i18n.getCurrentLanguage() === 'zh' ? 'zh-CN' : 'en-US') : 'zh-CN'),
                command: currentOperation || 'discharge',
                operator: 'admin',
                stations: parseInt(document.getElementById('devicesDispatched')?.textContent || '500'),
                success: parseInt(document.getElementById('devicesActivated')?.textContent || '445'),
                failed: parseInt(document.getElementById('devicesDispatched')?.textContent || '500') - parseInt(document.getElementById('devicesActivated')?.textContent || '445')
            };
            
            // Generate initial content for the basic tab
            generateOperationTabContent(currentOperationData, 'basic');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('operationModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        updateRealtimeData();
                        break;
                    case '1':
                        e.preventDefault();
                        switchRegion('NSW', document.querySelector('.tab.active'));
                        break;
                    case '2':
                        e.preventDefault();
                        switchRegion('QLD', document.querySelectorAll('.tab')[1]);
                        break;
                }
            }
        });

        // Touch gestures for mobile
        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        });

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        });

        function handleSwipe() {
            if (touchEndX < touchStartX - 50) {
                // Swipe left - next region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex < tabs.length - 1) {
                    tabs[activeIndex + 1].click();
                }
            }
            if (touchEndX > touchStartX + 50) {
                // Swipe right - previous region
                const tabs = document.querySelectorAll('.chart-controls .tab');
                const activeIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
                if (activeIndex > 0) {
                    tabs[activeIndex - 1].click();
                }
            }
        }

        // Header functions
        function toggleMessages() {
            alert('消息中心：\n• 系统维护通知 (2小时前)\n• 电价波动提醒 (4小时前)\n• 设备状态报告 (1天前)');
        }

        function toggleLanguage() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function changeLanguage(langCode, langName) {
            document.getElementById('currentLang').textContent = langName;
            document.getElementById('languageDropdown').style.display = 'none';
            // 这里可以添加实际的语言切换逻辑
            console.log('Language changed to:', langCode);
        }

        function toggleUserMenu() {
            alert('用户菜单：\n• 个人设置\n• 账户管理\n• 退出登录');
        }

        // 点击其他地方关闭下拉菜单
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('languageDropdown').style.display = 'none';
            }
        });

        // 累计价格卡片图表和区域切换联动
        function renderCumulativeChart(region) {
            if (!window.echarts || !document.getElementById('cumulativeMarketChart')) return;
            const chart = echarts.init(document.getElementById('cumulativeMarketChart'));
            // 区域参数影响数据生成
            const regionBase = {
                'NSW': 200,
                'QLD': 180,
                'VIC': 160,
                'SA': 140,
                'TAS': 120
            };
            const base = regionBase[region] || 200;
            const hours = [];
            const prices = [];
            const forecastPrices = [];
            const currentTime = new Date().getHours();
            for (let i = 0; i < 24; i++) {
                hours.push(`${i}:00`);
            }
            let lastPrice = base;
            for (let i = 0; i < 24; i++) {
                if (i < currentTime) {
                    const price = lastPrice + (Math.random() - 0.5) * 20;
                    prices.push(price);
                    forecastPrices.push(null);
                    lastPrice = price;
                } else if (i === currentTime) {
                    const price = lastPrice + (Math.random() - 0.5) * 20;
                    prices.push(price);
                    forecastPrices.push(price);
                    lastPrice = price;
                } else {
                    prices.push(null);
                    const price = lastPrice + (Math.random() - 0.5) * 30;
                    forecastPrices.push(price);
                    lastPrice = price;
                }
            }
            const option = {
                backgroundColor: 'transparent',
                tooltip: {
                    trigger: 'axis',
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    textStyle: { color: '#fff' }
                },
                legend: {
                    data: [
                        window.i18n ? window.i18n.getText('historicalPrice') : 'Historical Price',
                        window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price'
                    ],
                    textStyle: { color: 'rgba(255,255,255,0.7)', fontWeight: 600 },
                    top: 0,
                    itemWidth: 18,
                    itemHeight: 8,
                    selectedMode: false,
                    formatter: function(name) {
                        return name;
                    }
                },
                grid: {
                    left: '3%',
                    right: '3%',
                    bottom: '3%',
                    top: '15%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: hours,
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)', interval: 2 }
                },
                yAxis: {
                    type: 'value',
                    name: window.i18n ? window.i18n.getText('price') : 'Price',
                    nameTextStyle: { color: 'rgba(255, 255, 255, 0.6)' },
                    axisLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.2)' } },
                    axisLabel: { color: 'rgba(255, 255, 255, 0.6)' },
                    splitLine: { lineStyle: { color: 'rgba(255, 255, 255, 0.1)' } }
                },
                series: [
                    {
                        name: window.i18n ? window.i18n.getText('historicalPrice') : 'Historical Price',
                        type: 'line',
                        data: prices,
                        smooth: true,
                        lineStyle: { color: '#00ff88', width: 2 },
                        itemStyle: { color: '#00ff88' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.2)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0)' }
                            ])
                        },
                        symbol: 'circle',
                        showSymbol: false
                    },
                    {
                        name: window.i18n ? window.i18n.getText('predictedPrice') : 'Predicted Price',
                        type: 'line',
                        data: forecastPrices,
                        smooth: false,
                        lineStyle: { color: '#00ff88', width: 2, type: 'dashed', opacity: 0.85 },
                        itemStyle: { color: '#00ff88' },
                        areaStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: 'rgba(0, 255, 136, 0.15)' },
                                { offset: 1, color: 'rgba(0, 255, 136, 0)' }
                            ])
                        },
                        symbol: 'circle',
                        showSymbol: false
                    }
                ]
            };
            chart.setOption(option);
            window.addEventListener('resize', throttle(() => chart.resize(), 250));
        }

        // 区域切换时累计价格卡片所有数据切换
        function switchCumulativeRegion(region, btn) {
            // 按钮高亮 - 更新选择器以匹配新的HTML结构
            const cumulativeContainer = btn.closest('.glass');
            cumulativeContainer.querySelectorAll('.region-tab').forEach(tab => tab.classList.remove('active'));
            btn.classList.add('active');
            
            // 同步市场区域选择
            currentRegion = region;
            
            // 切换大数字区数据（模拟）
            const baseMap = { 'NSW': 746630, 'QLD': 623800, 'VIC': 512400, 'SA': 401200, 'TAS': 312000 };
            const forecastMap = { 'NSW': 746622, 'QLD': 623790, 'VIC': 512390, 'SA': 401180, 'TAS': 311980 };
            const notExceededText = window.i18n ? window.i18n.getText('notExceeded') : '未超阈';
            const statusMap = { 'NSW': notExceededText, 'QLD': notExceededText, 'VIC': notExceededText, 'SA': notExceededText, 'TAS': notExceededText };
            
            // 更新累计价格卡片中的值
            const priceCards = cumulativeContainer.querySelectorAll('.price-card-value');
            if (priceCards.length >= 3) {
                priceCards[0].textContent = `$${baseMap[region].toLocaleString()}`;
                priceCards[1].textContent = `$${forecastMap[region].toLocaleString()}`;
                priceCards[2].textContent = statusMap[region];
            }
            
            // 切换图表
            renderCumulativeChart(region);
        }

        // 页面加载时默认渲染 NSW - 这个功能已在主初始化代码中处理
        
        // Force apply button colors
        function forceButtonStyles() {
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            
            if (chargeBtn && !chargeBtn.classList.contains('stop-btn')) {
                chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #00D67A, #00FF88)', 'important');
                chargeBtn.style.setProperty('border', '2px solid rgba(0, 255, 136, 0.3)', 'important');
                chargeBtn.style.setProperty('color', '#000', 'important');
                chargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(0, 255, 136, 0.3)', 'important');
            }
            
            if (dischargeBtn && !dischargeBtn.classList.contains('stop-btn')) {
                dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #FFA500, #FFD700)', 'important');
                dischargeBtn.style.setProperty('border', '2px solid rgba(255, 215, 0, 0.3)', 'important');
                dischargeBtn.style.setProperty('color', '#000', 'important');
                dischargeBtn.style.setProperty('box-shadow', '0 4px 12px rgba(255, 215, 0, 0.3)', 'important');
            }
            
            console.log('Button styles applied with !important!');
        }
        

        // 主题切换按钮逻辑
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.onclick = function() {
                document.body.classList.toggle('theme-dark');
                this.textContent = document.body.classList.contains('theme-dark') ? '☀️' : '🌙';
            }
        }
        
        // 更新动态内容的函数
        function updateDynamicContent(language) {
            if (!window.i18n) return;
            
            try {
                // 更新所有i18n元素
                window.i18n.updatePageTexts();
                
                // 更新页面标题
                const pageTitles = {
                    'zh': '能源管理中心',
                    'en': 'Energy Management Center',
                    'ja': 'エネルギー管理センター',
                    'ko': '에너지 관리 센터'
                };
                document.title = pageTitles[language] || pageTitles['zh'];
                
                // 更新确认按钮文本 (动态设置的)
                const confirmBtn = document.getElementById('confirmExecuteBtn');
                if (confirmBtn) {
                    const confirmText = window.i18n.getText('confirmExecute');
                    if (confirmText !== 'confirmExecute') {
                        confirmBtn.innerHTML = '<span data-i18n-key="confirmExecute">' + confirmText + '</span>';
                    }
                }
                
                // 更新当前操作文本
                const currentOpText = document.getElementById('currentOperationText');
                if (currentOpText && currentOpText.textContent === '无') {
                    const noneText = window.i18n.getText('none');
                    if (noneText !== 'none') {
                        currentOpText.textContent = noneText;
                    }
                }
                
                // 更新图表标题和图例
                updateChartTitles(language);
                
                // 更新阈值状态文本
                const thresholdStatus = document.querySelector('[data-threshold-status]');
                if (thresholdStatus) {
                    const statusKey = thresholdStatus.getAttribute('data-threshold-status');
                    if (statusKey) {
                        const translations = {
                            'zh': { 'not_exceeded': '未超阈', 'exceeded': '已超阈', 'warning': '警告' },
                            'en': { 'not_exceeded': 'Below Threshold', 'exceeded': 'Exceeded', 'warning': 'Warning' },
                            'ja': { 'not_exceeded': '閾値未満', 'exceeded': '閾値超過', 'warning': '警告' },
                            'ko': { 'not_exceeded': '임계값 미만', 'exceeded': '임계값 초과', 'warning': '경고' }
                        };
                        const text = translations[language] && translations[language][statusKey];
                        if (text) {
                            thresholdStatus.textContent = text;
                        }
                    }
                }
                
                // 更新价格统计文本
                const priceLabels = document.querySelectorAll('[data-price-label]');
                priceLabels.forEach(label => {
                    const labelKey = label.getAttribute('data-price-label');
                    if (labelKey === 'current-cumulative') {
                        const text = language === 'en' ? 'Current Cumulative Price' :
                                   language === 'ja' ? '現在の累積価格' :
                                   language === 'ko' ? '현재 누적 가격' : '当前累计价格';
                        label.textContent = text;
                    } else if (labelKey === 'forecast-cumulative') {
                        const text = language === 'en' ? 'Forecast Cumulative Price (5min)' :
                                   language === 'ja' ? '予測累積価格（5分）' :
                                   language === 'ko' ? '예측 누적 가격 (5분)' : '预测累计价格(5min)';
                        label.textContent = text;
                    } else if (labelKey === 'threshold-status') {
                        const text = language === 'en' ? 'Threshold Status' :
                                   language === 'ja' ? '閾値状態' :
                                   language === 'ko' ? '임계값 상태' : '阈值状态';
                        label.textContent = text;
                    }
                });
                
                // 更新百分比变化文本
                const changeElements = document.querySelectorAll('[data-change-text]');
                changeElements.forEach(elem => {
                    const changeValue = elem.getAttribute('data-change-text');
                    if (changeValue) {
                        const changeText = language === 'en' ? `↑ ${changeValue}% vs Yesterday` :
                                         language === 'ja' ? `↑ 昨日比${changeValue}%` :
                                         language === 'ko' ? `↑ 어제대비 ${changeValue}%` : `↑ 比昨日${changeValue}%`;
                        elem.textContent = changeText;
                    }
                });
                
                // 更新数量单位 (个 -> units)
                const countElements = ['totalHomes', 'confirmTargetDevices', 'targetDevices', 'totalFamiliesCard', 'todayDischargeFamilies', 'familySummaryCard'];
                countElements.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem && elem.textContent.includes('个')) {
                        const number = elem.textContent.replace('个', '');
                        const unit = language === 'en' ? '' : 
                                   language === 'ja' ? '個' :
                                   language === 'ko' ? '개' : '个';
                        elem.textContent = number + unit;
                    }
                });
                
                // 家庭单位已删除，不需要更新
                
                // 更新家庭/Family显示切换
                const chineseTexts = document.querySelectorAll('.chinese-text');
                const englishTexts = document.querySelectorAll('.english-text');
                
                if (language === 'en') {
                    chineseTexts.forEach(elem => elem.style.display = 'none');
                    englishTexts.forEach(elem => elem.style.display = 'inline');
                } else {
                    chineseTexts.forEach(elem => elem.style.display = 'inline');
                    englishTexts.forEach(elem => elem.style.display = 'none');
                }
                
                console.log('Dynamic content updated for language:', language);
            } catch (error) {
                console.error('Error updating dynamic content:', error);
            }
        }
        
        // 更新图表标题
        function updateChartTitles(language) {
            // 更新市场图表
            if (marketChart) {
                const option = marketChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('historicalPrice'),
                        window.i18n.getText('demand'),
                        window.i18n.getText('predictedPrice'),
                        window.i18n.getText('predictedDemand')
                    ];
                }
                if (option && option.yAxis) {
                    option.yAxis[0].name = window.i18n.getText('price');
                    option.yAxis[1].name = window.i18n.getText('demand');
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('historicalPrice');
                    option.series[1].name = window.i18n.getText('demand');
                    option.series[2].name = window.i18n.getText('predictedPrice');
                    option.series[3].name = window.i18n.getText('predictedDemand');
                }
                marketChart.setOption(option, true);
            }
            
            // 更新功率图表
            if (powerChart) {
                const option = powerChart.getOption();
                if (option && option.legend && option.legend[0]) {
                    option.legend[0].data = [
                        window.i18n.getText('actualDischarge'),
                        window.i18n.getText('profit')
                    ];
                }
                if (option && option.series) {
                    option.series[0].name = window.i18n.getText('actualDischarge');
                    option.series[1].name = window.i18n.getText('profit');
                }
                powerChart.setOption(option, true);
                
                // Force chart refresh for 'month' period to fix display issue
                if (powerChartTimeSelector && powerChartTimeSelector.getCurrentPeriod() === 'month') {
                    const { labels, power, revenue } = generateAnalyticsData('month');
                    updatePowerChartWithData(labels, power, revenue, 'month');
                }
            }
            
            // 更新图表标题
            const powerChartTitle = document.getElementById('powerChartTitle');
            if (powerChartTitle) {
                powerChartTitle.textContent = window.i18n.getText('powerRevenueTrend');
            }
        }
    </script>
    
    <!-- Device Command Modal -->
    <div id="deviceCommandModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeviceCommandModal()"></div>
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n-key="deviceCommand">设备指令</h3>
                <button class="modal-close" onclick="closeDeviceCommandModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="command-info">
                    <div class="info-row">
                        <label data-i18n-key="operationType">操作类型</label>
                        <span id="commandOperationType" class="operation-type"></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n-key="targetDevices">目标设备</label>
                        <span id="commandTargetDevices">235 <span data-i18n-key="devices">设备</span></span>
                    </div>
                    <div class="info-row">
                        <label data-i18n-key="executionTime">预计执行时间</label>
                        <span id="commandExecutionTime"><span data-i18n-key="immediately">立即</span></span>
                    </div>
                    <div class="info-row" id="estimatedRevenueRow" style="display: none;">
                        <label data-i18n-key="estimatedProfit">预计获利</label>
                        <span id="commandEstimatedRevenue" style="color: #00ff88; font-weight: 600;">+$340</span>
                    </div>
                </div>
                <div class="warning-message">
                    <span data-i18n-key="operationWarning">此操作将影响所有选中的设备，请确认后继续。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeviceCommandModal()" data-i18n-key="cancel">取消</button>
                <button class="btn btn-primary" id="confirmCommandBtn" onclick="executeDeviceCommand()" data-i18n-key="confirmExecute">确认执行</button>
            </div>
        </div>
    </div>
    
    <!-- Operation Result Modal (shown after charge/discharge command) -->
    <div id="operationResultModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeOperationResultModal()"></div>
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: rgba(0, 255, 136, 0.2); display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 24px;">📊</span>
                    </div>
                    <h3 class="modal-title" data-i18n-key="deviceResponseStatisticsTitle">设备响应统计</h3>
                </div>
                <button class="modal-close" onclick="closeOperationResultModal()">×</button>
            </div>
            <div class="modal-body">
                <p id="operationResultMessage" style="color: rgba(255, 255, 255, 0.8); margin-bottom: 24px;"></p>
                
                <div class="result-info-grid">
                    <div class="result-info-item">
                        <label data-i18n-key="operationType">操作类型</label>
                        <span id="resultOperationType" class="operation-type"></span>
                    </div>
                    <div class="result-info-item">
                        <label data-i18n-key="targetDevices">目标设备</label>
                        <span id="resultTargetDevices">500 units</span>
                    </div>
                    <div class="result-info-item">
                        <label data-i18n-key="estimatedDuration">预计时长</label>
                        <span>15-30 <span data-i18n-key="minutes">分钟</span></span>
                    </div>
                </div>
                
                <div class="device-stats-container" style="background: rgba(0, 255, 136, 0.1); border-radius: 16px; padding: 24px; margin-top: 24px;">
                    <h4 style="color: #00ff88; margin: 0 0 20px 0; text-align: center;" data-i18n-key="deviceResponseStatistics">Device Response Statistics</h4>
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                        <div class="stat-item" style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">500</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n-key="commandsSent">Commands Sent</div>
                        </div>
                        <div class="stat-item" style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">477</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n-key="commandsReceived">Commands Received</div>
                        </div>
                        <div class="stat-item" style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">445</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n-key="devicesActivated">Devices Activated</div>
                        </div>
                        <div class="stat-item" style="text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #00ff88;">89%</div>
                            <div style="color: rgba(255, 255, 255, 0.7); font-size: 14px;" data-i18n-key="successRate">Success Rate</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeOperationResultModal()" data-i18n-key="close">关闭</button>
                <button class="btn btn-primary" onclick="viewDetailsFromResult()" style="background: #00ff88; color: #000;">
                    <span data-i18n-key="viewDetails">查看详情</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Device Response Statistics Modal (for clicking device response) -->
    <div id="deviceResponseModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeDeviceResponseModal()"></div>
        <div class="modal-content" style="max-width: 900px; max-height: 80vh;">
            <div class="modal-header">
                <h3 class="modal-title" data-i18n-key="operationDetails">操作详情</h3>
                <button class="modal-close" onclick="closeDeviceResponseModal()">×</button>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Tabs -->
                <div class="modal-tabs">
                    <button class="modal-tab active" onclick="switchDeviceResponseTab('stationInfo', this)" data-i18n-key="stationInformation">电站信息</button>
                    <button class="modal-tab" onclick="switchDeviceResponseTab('stationDetails', this)" data-i18n-key="stationDetails">电站详情</button>
                    <button class="modal-tab" onclick="switchDeviceResponseTab('timeline', this)" data-i18n-key="executionTimeline">执行时间线</button>
                </div>
                
                <!-- Tab Contents -->
                <div class="tab-content active" id="stationInfoTab">
                    <div class="station-grid">
                        <div class="station-card">
                            <div class="station-header">
                                <span class="station-name">NSW-001</span>
                                <span class="station-status status-active" data-i18n-key="online">在线</span>
                            </div>
                            <div class="station-details">
                                <div class="detail-row">
                                    <span class="detail-label" data-i18n-key="location">位置</span>
                                    <span class="detail-value">Sydney, NSW</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label" data-i18n-key="capacity">容量</span>
                                    <span class="detail-value">250 kWh</span>
                                </div>
                                <div class="detail-row">
                                    <span class="detail-label" data-i18n-key="status">状态</span>
                                    <span class="detail-value status-active" data-i18n-key="charging">充电中</span>
                                </div>
                            </div>
                        </div>
                        <!-- More station cards would be dynamically generated -->
                    </div>
                </div>
                
                <div class="tab-content" id="stationDetailsTab" style="display: none;">
                    <div class="details-content">
                        <div class="details-summary">
                            <div class="summary-item">
                                <label data-i18n-key="totalStations">总电站数</label>
                                <span class="summary-value">235</span>
                            </div>
                            <div class="summary-item">
                                <label data-i18n-key="onlineStations">在线电站</label>
                                <span class="summary-value">230</span>
                            </div>
                            <div class="summary-item">
                                <label data-i18n-key="executingStations">执行中</label>
                                <span class="summary-value">225</span>
                            </div>
                        </div>
                        <div class="details-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-i18n-key="stationName">电站名称</th>
                                        <th data-i18n-key="region">区域</th>
                                        <th data-i18n-key="status">状态</th>
                                        <th data-i18n-key="power">功率</th>
                                        <th data-i18n-key="soc">SOC</th>
                                    </tr>
                                </thead>
                                <tbody id="stationDetailsTableBody">
                                    <!-- Table rows would be dynamically generated -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="tab-content" id="timelineTab" style="display: none;">
                    <div class="timeline">
                        <div class="timeline-item completed">
                            <div class="timeline-time">10:30:00</div>
                            <div class="timeline-content">
                                <div class="timeline-title" data-i18n-key="commandIssued">指令下发</div>
                                <div class="timeline-desc" data-i18n-key="commandIssuedDesc">系统向所有设备发送充电指令</div>
                            </div>
                        </div>
                        <div class="timeline-item completed">
                            <div class="timeline-time">10:30:05</div>
                            <div class="timeline-content">
                                <div class="timeline-title" data-i18n-key="devicesResponded">设备响应</div>
                                <div class="timeline-desc" data-i18n-key="devicesRespondedDesc">230个设备确认收到指令</div>
                            </div>
                        </div>
                        <div class="timeline-item active">
                            <div class="timeline-time">10:30:15</div>
                            <div class="timeline-content">
                                <div class="timeline-title" data-i18n-key="executionStarted">开始执行</div>
                                <div class="timeline-desc" data-i18n-key="executionStartedDesc">设备开始执行充电操作</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            position: relative;
            background: #1a1f2e;
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #fff;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .command-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-row label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        .info-row span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
        
        .operation-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .operation-type.charge {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .operation-type.discharge {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
        }
        
        .operation-type.stop {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .warning-message {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 16px;
            color: #ffc107;
            font-size: 14px;
            line-height: 1.5;
        }
        
        
        .btn {
            padding: 10px 24px;
            border-radius: 22px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            min-width: 100px;
            height: 44px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00D67A, #00FF88);
            color: #000;
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(0, 255, 136, 0.3);
        }
        
        /* Device Response Modal Styles */
        .modal-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.02);
        }
        
        .modal-tab {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .modal-tab.active {
            color: #fff;
        }
        
        .modal-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }
        
        .tab-content {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .station-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }
        
        .station-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .station-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .station-name {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }
        
        .station-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .status-active {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .detail-label {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .detail-value {
            color: #fff;
        }
        
        .timeline {
            position: relative;
            padding-left: 40px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 32px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -28px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #1a1f2e;
        }
        
        .timeline-item.completed::before {
            background: #00ff88;
        }
        
        .timeline-item.active::before {
            background: #ffa500;
            box-shadow: 0 0 0 4px rgba(255, 165, 0, 0.2);
        }
        
        .timeline-time {
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .timeline-title {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .timeline-desc {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
        }
        
        /* Result Modal Styles */
        .result-info-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }
        
        .result-info-item {
            text-align: center;
        }
        
        .result-info-item label {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .result-info-item span {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }
    </style>
    
    <script>
        // Device Command Modal Functions
        let isOperationActive = false;
        
        // 移除重复的函数定义，使用主要的handleCharge和handleDischarge函数
        
        function showStopConfirmation(newOperation) {
            const stopText = window.i18n ? window.i18n.getText('stop') : '停止';
            const currentOpText = currentOperation === 'charge' ? 
                (window.i18n ? window.i18n.getText('charging') : '充电中') : 
                (window.i18n ? window.i18n.getText('discharging') : '放电中');
            
            showDeviceCommandModal('stop', currentOpText);
        }
        
        function showDeviceCommandModal(operation, currentOpText) {
            const modal = document.getElementById('deviceCommandModal');
            const modalTitle = modal.querySelector('.modal-title');
            const operationType = document.getElementById('commandOperationType');
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const warningMessage = modal.querySelector('.warning-message span');
            const executionTime = document.getElementById('commandExecutionTime');
            
            // Update modal based on operation type
            if (operation === 'charge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmCharge') : '确认充电';
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : '充电';
                operationType.className = 'operation-type charge';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : '此操作将影响所有选中的设备，请确认后继续。';
                
                // Hide estimated revenue for charge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            } else if (operation === 'discharge') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmDischarge') : '确认放电';
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : '放电';
                operationType.className = 'operation-type discharge';
                warningMessage.textContent = window.i18n ? window.i18n.getText('operationWarning') : '此操作将影响所有选中的设备，请确认后继续。';
                
                // Show estimated revenue for discharge
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) {
                    revenueRow.style.display = 'flex';
                    document.getElementById('commandEstimatedRevenue').textContent = '+$340';
                }
            } else if (operation === 'stop') {
                modalTitle.textContent = window.i18n ? window.i18n.getText('confirmStop') : '确认停止';
                const stopText = window.i18n ? window.i18n.getText('stopOperation') : '停止操作';
                operationType.textContent = stopText;
                operationType.className = 'operation-type stop';
                warningMessage.textContent = window.i18n ? window.i18n.getText('stopWarning') : '停止操作将立即终止所有设备的充电/放电状态，设备将恢复到待机模式。';
                
                // Hide estimated revenue for stop
                const revenueRow = document.getElementById('estimatedRevenueRow');
                if (revenueRow) revenueRow.style.display = 'none';
            }
            
            // Store operation for execution
            confirmBtn.setAttribute('data-operation', operation);
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closeDeviceCommandModal() {
            const modal = document.getElementById('deviceCommandModal');
            if (modal) {
                modal.classList.remove('show');
                modal.style.display = 'none';
                modal.style.opacity = '0';
            }
        }
        
        function executeDeviceCommand() {
            const confirmBtn = document.getElementById('confirmCommandBtn');
            const operation = confirmBtn.getAttribute('data-operation');
            
            closeDeviceCommandModal();
            
            // Update button states
            const chargeBtn = document.getElementById('chargeBtn');
            const dischargeBtn = document.getElementById('dischargeBtn');
            const actionButtons = document.querySelector('.action-buttons');
            
            if (operation === 'stop') {
                // 执行停止操作
                console.log('Stop operation confirmed, executing stop...');
                executeStopOperation();
            } else {
                // Set active operation
                isOperationActive = true;
                currentOperation = operation;
                
                // Add operating class to container for centering
                actionButtons.classList.add('operating');
                
                // Update buttons - only show one centered stop button
                if (operation === 'charge') {
                    chargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                    chargeBtn.classList.remove('charge-btn');
                    chargeBtn.classList.add('stop-btn');
                    chargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    chargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    chargeBtn.style.setProperty('color', '#fff', 'important');
                    chargeBtn.style.setProperty('flex', '1', 'important');
                    chargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide discharge button
                    dischargeBtn.style.display = 'none';
                } else if (operation === 'discharge') {
                    dischargeBtn.innerHTML = `<span data-i18n-key="stop">${window.i18n ? window.i18n.getText('stop') : '停止'}</span>`;
                    dischargeBtn.classList.remove('discharge-btn');
                    dischargeBtn.classList.add('stop-btn');
                    dischargeBtn.style.setProperty('background', 'linear-gradient(135deg, #ff4444, #ff6b6b)', 'important');
                    dischargeBtn.style.setProperty('border', '2px solid rgba(255, 68, 68, 0.3)', 'important');
                    dischargeBtn.style.setProperty('color', '#fff', 'important');
                    dischargeBtn.style.setProperty('flex', '1', 'important');
                    dischargeBtn.style.setProperty('max-width', '200px', 'important');
                    
                    // Hide charge button
                    chargeBtn.style.display = 'none';
                }
            }
            
            // Only show modal immediately for stop operation
            // For charge/discharge, the animation will handle showing the modal when complete
            if (operation === 'stop') {
                setTimeout(() => {
                    // 不再自动打开详情抽屉
                    console.log('Stop operation complete');
                }, 1500);
            }
        }
        
        function showNotification(message, type = 'info') {
            // Simple notification (you can enhance this)
            console.log(`${type}: ${message}`);
        }
        
        // Operation Result Modal Functions
        function showOperationResultModal(operation) {
            const modal = document.getElementById('operationResultModal');
            const message = document.getElementById('operationResultMessage');
            const operationType = document.getElementById('resultOperationType');
            const targetDevices = document.getElementById('resultTargetDevices');
            
            // Set operation type
            if (operation === 'charge') {
                operationType.textContent = window.i18n ? window.i18n.getText('charge') : '充电';
                operationType.className = 'operation-type charge';
                message.textContent = window.i18n ? window.i18n.getText('chargingCompleteMessage') : '充电指令下发完成，以下是设备响应统计报告：';
            } else if (operation === 'discharge') {
                operationType.textContent = window.i18n ? window.i18n.getText('discharge') : '放电';
                operationType.className = 'operation-type discharge';
                message.textContent = window.i18n ? window.i18n.getText('dischargingCompleteMessage') : '放电指令下发完成，以下是设备响应统计报告：';
            }
            
            // Set target devices with proper unit
            const currentLang = window.i18n ? window.i18n.getCurrentLanguage() : 'zh';
            const unit = currentLang === 'en' ? ' units' : 
                        currentLang === 'ja' ? '個' :
                        currentLang === 'ko' ? '개' : '个';
            targetDevices.textContent = '500' + unit;
            
            // Show modal
            modal.style.display = 'flex';
        }
        
        function closeOperationResultModal() {
            document.getElementById('operationResultModal').style.display = 'none';
        }
        
        function viewDetailsFromResult() {
            closeOperationResultModal();
            showDeviceResponseModal();
        }
        
        // Device Response Modal Functions
        function showDeviceResponseModal() {
            document.getElementById('deviceResponseModal').style.display = 'flex';
            // Load data for the modal
            loadDeviceResponseData();
        }
        
        function closeDeviceResponseModal() {
            document.getElementById('deviceResponseModal').style.display = 'none';
        }
        
        function switchDeviceResponseTab(tabName, tabElement) {
            // Update active tab
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            tabElement.classList.add('active');
            
            // Show corresponding content
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');
            document.getElementById(tabName + 'Tab').style.display = 'block';
        }
        
        function loadDeviceResponseData() {
            // This would load real data in production
            // For now, using static demo data
        }
        
        // Update the device response statistics click handler
        
        // 添加全局强制切换到市场页面的命令
        window.forceMarket = function() {
            console.log('Force switching to market page');
            switchPanel('market');
            
            // 更新按钮状态
            const marketTab = document.querySelector('[onclick*="switchPanel(\'market\')"]');
            const mapTab = document.querySelector('[onclick*="switchPanel(\'map\')"]');
            if (marketTab) marketTab.classList.add('active');
            if (mapTab) mapTab.classList.remove('active');
            
            // 更新面板显示
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            if (marketPanel) {
                marketPanel.style.display = 'block';
                marketPanel.classList.add('active');
            }
            if (mapPanel) {
                mapPanel.style.display = 'none';
                mapPanel.classList.remove('active');
            }
            
            console.log('Switched to market page successfully');
        };
        
        // 在控制台输出帮助信息
        console.log('💡 Tip: Use window.forceMarket() to force switch to market page');
        
        // 添加手动测试函数
        window.testMarketChart = function() {
            console.log('Testing market chart...');
            const container = document.getElementById('marketChart');
            if (!container) {
                console.error('Market chart container not found!');
                return;
            }
            
            console.log('Container found:', container);
            console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
            console.log('Container parent:', container.parentElement);
            console.log('Panel active:', document.getElementById('marketPanel').classList.contains('active'));
            
            // 销毁旧实例
            if (marketChart) {
                marketChart.dispose();
            }
            
            // 创建新实例
            marketChart = echarts.init(container);
            
            // 使用最简单的配置
            const option = {
                title: { text: 'Market Test' },
                xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                yAxis: { type: 'value' },
                series: [{ data: [120, 200, 150], type: 'line' }]
            };
            
            marketChart.setOption(option);
            console.log('Test chart created:', marketChart);
        };
        
        window.testMapChart = function() {
            console.log('Testing map chart...');
            const container = document.getElementById('australiaMap');
            if (!container) {
                console.error('Map chart container not found!');
                return;
            }
            
            // 切换到地图面板
            switchPanel('map');
            
            setTimeout(() => {
                console.log('Container found:', container);
                console.log('Container dimensions:', container.offsetWidth, 'x', container.offsetHeight);
                
                // 销毁旧实例
                if (mapChart) {
                    mapChart.dispose();
                }
                
                // 创建新实例
                mapChart = echarts.init(container);
                
                // 使用最简单的配置
                const option = {
                    title: { text: 'Map Test' },
                    xAxis: { type: 'category', data: ['A', 'B', 'C'] },
                    yAxis: { type: 'value' },
                    series: [{ data: [120, 200, 150], type: 'bar' }]
                };
                
                mapChart.setOption(option);
                console.log('Test chart created:', mapChart);
            }, 300);
        };
        
        console.log('💡 Use window.testMarketChart() or window.testMapChart() to test charts');
        
        // 修复函数 - 重新初始化所有图表
        window.fixCharts = function() {
            console.log('Fixing charts...');
            
            // 确保容器可见
            const marketPanel = document.getElementById('marketPanel');
            const mapPanel = document.getElementById('mapPanel');
            
            // 激活市场面板
            marketPanel.classList.add('active');
            marketPanel.style.display = 'flex';
            mapPanel.classList.remove('active');
            mapPanel.style.display = 'none';
            
            // 重新初始化市场图表
            setTimeout(() => {
                if (marketChart) {
                    marketChart.dispose();
                }
                initMarketChart();
                
                // 切换到地图面板并初始化
                setTimeout(() => {
                    mapPanel.classList.add('active');
                    mapPanel.style.display = 'flex';
                    marketPanel.classList.remove('active');
                    marketPanel.style.display = 'none';
                    
                    if (mapChart) {
                        mapChart.dispose();
                    }
                    initMap();
                    
                    // 切回市场面板
                    setTimeout(() => {
                        marketPanel.classList.add('active');
                        marketPanel.style.display = 'flex';
                        mapPanel.classList.remove('active');
                        mapPanel.style.display = 'none';
                        
                        if (marketChart) {
                            if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                        }
                        
                        console.log('Charts fixed!');
                    }, 500);
                }, 500);
            }, 100);
        };
        
        console.log('💡 Use window.fixCharts() to reinitialize all charts');
        
        // Update power revenue chart when language changes
        window.updatePowerRevenueChartLanguage = function() {
            if (!powerRevenueChart) return;
            
            powerRevenueChart.setOption({
                legend: {
                    data: [window.i18n.getText('actualDischarge'), window.i18n.getText('profit')]
                },
                yAxis: [
                    {
                        name: window.i18n.getText('discharge')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ],
                series: [
                    {
                        name: window.i18n.getText('actualDischarge')
                    },
                    {
                        name: window.i18n.getText('profit')
                    }
                ]
            });
        };
        
        // Update market chart when language changes
        window.updateMarketChartLanguage = function() {
            if (!marketChart) return;
            
            const getText = (key) => window.i18n ? window.i18n.getText(key) : translations.en[key];
            const translations = {
                en: {
                    historicalPrice: 'Historical Price',
                    predictedPrice: 'Predicted Price',
                    demand: 'Demand',
                    predictedDemand: 'Predicted Demand',
                    price: 'Price ($/MWh)',
                    demandUnit: 'Demand (MW)'
                },
                zh: {
                    historicalPrice: '历史价格',
                    predictedPrice: '预测价格',
                    demand: '需求',
                    predictedDemand: '预测需求',
                    price: '价格 ($/MWh)',
                    demandUnit: '需求 (MW)'
                }
            };
            
            marketChart.setOption({
                legend: {
                    data: [getText('historicalPrice'), getText('demand'), getText('predictedPrice'), getText('predictedDemand')]
                },
                yAxis: [
                    {
                        name: getText('price')
                    },
                    {
                        name: getText('demandUnit')
                    }
                ],
                series: [
                    {
                        name: getText('historicalPrice')
                    },
                    {
                        name: getText('demand')
                    },
                    {
                        name: getText('predictedPrice')
                    },
                    {
                        name: getText('predictedDemand')
                    }
                ]
            });
        };
        
        // Force re-initialization when page is fully loaded
        window.addEventListener('load', function() {
            console.log('Window fully loaded, final chart check...');
            setTimeout(() => {
                // Force reinitialize market chart if it's not visible
                const marketPanel = document.getElementById('marketPanel');
                if (marketPanel && marketPanel.classList.contains('active')) {
                    const marketContainer = document.getElementById('marketChart');
                    if (marketContainer && (!marketChart || marketContainer.offsetHeight === 0)) {
                        console.log('Market chart needs reinitialization');
                        initMarketChart();
                    } else if (marketChart) {
                        if (marketChart && typeof marketChart.resize === 'function') {
                            if (marketChart && typeof marketChart.resize === 'function') {
                        marketChart.resize();
                    }
                        }
                    }
                }
            }, 1000);
        });
        
        // Debug function to force market chart initialization
        window.forceInitMarketChart = function() {
            console.log('Force initializing market chart...');
            const panel = document.getElementById('marketPanel');
            const container = document.getElementById('marketChart');
            
            if (!panel || !container) {
                console.error('Panel or container not found');
                return;
            }
            
            // Make sure panel is visible
            panel.classList.add('active');
            panel.style.display = 'flex';
            
            // Ensure container has dimensions
            if (container.offsetHeight === 0) {
                container.style.height = '400px';
            }
            
            // Reinitialize
            setTimeout(() => {
                initMarketChart();
                console.log('Market chart reinitialized');
            }, 100);
        };
        
        console.log('💡 Use window.forceInitMarketChart() to force initialize market chart');
        
        // Debug function to force update translations
        window.forceUpdateTranslations = function() {
            if (window.i18n) {
                window.i18n.updatePageTexts();
                console.log('Translations updated');
            } else {
                console.error('i18n not initialized');
            }
        };
        
        console.log('💡 Use window.forceUpdateTranslations() to force update all translations');
    </script>
    
    <style>
        /* 最终强制覆盖 - 确保抽屉在绝对最顶层 */
        #homeOperationDrawer,
        #homeOperationDrawer .drawer-overlay,
        #homeOperationDrawer .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
        }
        
        .drawer-overlay {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        .drawer-overlay.show .drawer-container {
            z-index: 2147483647 !important;
            position: fixed !important;
            top: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            pointer-events: auto !important;
        }
        
        /* 降低首页其他元素的z-index */
        .hero-section, .hero-section * {
            z-index: 1 !important;
        }
        
        .dashboard-content, .dashboard-content * {
            z-index: 1 !important;
        }
        
        .panel-content {
            z-index: 1 !important;
        }
        
        .container, .container * {
            z-index: 1 !important;
        }
        
        /* 确保操作统计模态框也在合理层级 */
        #operationModal {
            z-index: 9999 !important;
        }
        
        /* 确保所有其他模态框在抽屉下方 */
        .modal:not(#homeOperationDrawer) {
            z-index: 1000 !important;
        }
        
        /* 特定元素层级覆盖 */
        .modal-content,
        .price-card,
        .chart-container,
        .info-card,
        .glass {
            z-index: 1 !important;
        }
    </style>
</body>
</html>